<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bioscan ATM | Patient Portal</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Orbitron:wght@400;500;700&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/css/intlTelInput.css">
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/intlTelInput.min.js"></script>

    <style>
        /* --- 1. SETUP & VARIABLES --- */
        :root {
            --primary-neon: #00f2ff;
            --secondary-neon: #7000ff;
            --bg-dark: #020408;
            --glass-panel: rgba(5, 12, 22, 0.9);
            --border-color: rgba(0, 242, 255, 0.4);
            --text-main: #e0f7fa;
            --error: #ff2a2a;
            --success: #00ff88;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            margin: 0; padding: 0;
            font-family: 'Rajdhani', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* --- 2. BACKGROUND (Your original style preserved) --- */
        #bio-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(circle at center, #0f1c2e 0%, #000000 90%);
        }
        .bio-symbol {
            position: absolute; color: var(--primary-neon); opacity: 0;
            animation: floatOrganic linear infinite; pointer-events: none;
            filter: blur(1px);
        }
        @keyframes floatOrganic {
            0% { transform: translate(0, 110vh) rotate(0deg) scale(0.5); opacity: 0; }
            10% { opacity: 0.15; }
            100% { transform: translate(-20px, -10vh) rotate(360deg) scale(0.5); opacity: 0; }
        }

        header {
            position: absolute; top: 0; width: 100%; padding: 15px 40px;
            display: flex; justify-content: space-between; align-items: center; z-index: 10;
        }

        /* --- 3. HUD CARD & INPUTS --- */
        .main-container { position: relative; z-index: 5; width: 100%; max-width: 450px; padding: 20px; }
        .hud-card {
            background: var(--glass-panel); backdrop-filter: blur(25px);
            border: 1px solid var(--border-color); border-radius: 25px; padding: 40px 30px;
            text-align: center; box-shadow: 0 0 30px rgba(0, 242, 255, 0.15);
            animation: cardBreath 4s infinite ease-in-out;
        }
        @keyframes cardBreath {
            0%, 100% { border-color: rgba(0, 242, 255, 0.3); }
            50% { border-color: rgba(0, 242, 255, 0.6); box-shadow: 0 0 40px rgba(0, 242, 255, 0.2); }
        }

        /* Country Code & Phone Input Styling */
        .iti { width: 100%; margin-bottom: 15px; }
        .iti__country-list { background-color: #0b101a; color: #fff; border: 1px solid var(--primary-neon); }
        
        .input-field {
            width: 100%; background: rgba(0, 0, 0, 0.5); border: 2px solid rgba(255, 255, 255, 0.1);
            padding: 15px; font-size: 1.2rem; color: #fff; border-radius: 12px;
            font-family: 'Orbitron', sans-serif; transition: 0.3s;
        }
        .input-field.valid { border-color: var(--success); box-shadow: 0 0 15px rgba(0, 255, 136, 0.2); }
        .input-field.invalid { border-color: var(--error); }

        .remember-group {
            display: flex; align-items: center; gap: 10px; margin-bottom: 25px;
            font-size: 0.85rem; color: #aaa; cursor: pointer;
        }

        /* --- 4. BUTTONS --- */
        .action-btn {
            width: 100%; padding: 16px; border: none; border-radius: 50px;
            background: linear-gradient(90deg, var(--primary-neon), #0066ff);
            color: #000; font-family: 'Orbitron', sans-serif; font-weight: bold;
            font-size: 1rem; cursor: pointer; transition: 0.3s;
        }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        .action-btn:hover:not(:disabled) { transform: scale(1.02); box-shadow: 0 0 30px var(--primary-neon); }

        /* --- 5. PROFESSIONAL MODALS --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            display: none; justify-content: center; align-items: center; z-index: 1000;
            backdrop-filter: blur(15px); padding: 20px; opacity: 0; transition: 0.3s;
        }
        .modal-overlay.active { display: flex; opacity: 1; }
        
        .modal-box {
            background: #080d16; border: 1px solid var(--primary-neon);
            padding: 30px; border-radius: 20px; width: 100%; max-width: 500px;
            box-shadow: 0 0 50px rgba(0, 242, 255, 0.15); transform: translateY(20px); transition: 0.3s;
        }
        .modal-overlay.active .modal-box { transform: translateY(0); }

        .consent-content { 
            text-align: left; max-height: 300px; overflow-y: auto; margin-bottom: 20px;
            padding-right: 10px; font-size: 0.9rem; line-height: 1.6; color: #ccc;
        }
        body.rtl .consent-content { text-align: right; }
        .consent-content ul { padding-left: 20px; margin: 10px 0; }
        .consent-content li { margin-bottom: 8px; }

        .checkbox-container {
            display: flex; align-items: flex-start; gap: 12px;
            font-size: 0.85rem; color: #fff; margin-bottom: 25px; text-align: left; cursor: pointer;
        }
        body.rtl .checkbox-container { text-align: right; }

        /* Toast Messages */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 5000; }
        .toast {
            background: rgba(5, 11, 20, 0.95); border-left: 4px solid var(--primary-neon);
            padding: 15px 25px; margin-bottom: 10px; border-radius: 8px;
            display: flex; align-items: center; gap: 12px; color: #fff;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4); animation: slideIn 0.4s ease;
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .lang-select {
            background: rgba(0,0,0,0.6); color: #fff; border: 1px solid var(--primary-neon);
            padding: 5px 12px; border-radius: 20px; cursor: pointer;
        }
    </style>
</head>

<body>

    <div id="bio-background"></div>
    <div class="toast-container" id="toast-container"></div>

    <header>
        <div class="brand">
            <img src="https://cdn-icons-png.flaticon.com/512/2966/2966487.png" style="width: 40px;" alt="Logo">
        </div>
        <select class="lang-select" id="lang-select" onchange="changeLanguage()">
            <option value="en">English</option>
            <option value="ar">العربية</option>
        </select>
    </header>

    <div class="main-container">
        <div class="hud-card">
            <h2 id="ui-title" style="font-family:'Orbitron'; letter-spacing:2px;">USER LOGIN</h2>
            <div style="height:2px; background:linear-gradient(90deg,transparent,var(--primary-neon),transparent); margin:20px 0 35px;"></div>

            <div id="login-view">
                <div class="input-wrapper">
                    <input type="tel" id="phoneInput" class="input-field" oninput="validatePhoneLive()">
                </div>

                <label class="remember-group">
                    <input type="checkbox" id="remCheck"> <span id="lbl-remember">Remember me</span>
                </label>

                <button class="action-btn" id="loginBtn" onclick="startAuthProcess()">
                    <i class="fas fa-fingerprint"></i> <span id="lbl-btn">INITIALIZE SCAN</span>
                </button>
            </div>
        </div>
    </div>

    <div id="consentModal" class="modal-overlay">
        <div class="modal-box">
            <h2 id="con-title" style="color:var(--primary-neon); font-family:'Orbitron'; font-size:1.2rem;">Terms of Use</h2>
            <div class="consent-content" id="con-body">
                </div>
            <label class="checkbox-container">
                <input type="checkbox" id="agreeCheck" onchange="toggleConsentBtn()">
                <span id="lbl-agree">I agree to the terms and data processing policy.</span>
            </label>
            <button class="action-btn" id="consentBtn" onclick="openVerifyModal()" disabled>
                <span id="lbl-send-code">SEND VERIFICATION CODE</span>
            </button>
        </div>
    </div>

    <div id="verifyModal" class="modal-overlay">
        <div class="modal-box">
            <h2 id="ver-title" style="color:var(--primary-neon); font-family:'Orbitron'; font-size:1.2rem;">Identity Setup</h2>
            <p id="ver-sub" style="color:#888; font-size:0.8rem; margin-bottom:20px;">Please complete your profile to register.</p>
            
            <input type="text" id="nameInput" class="input-field" style="margin-bottom:15px; font-size:1rem;" placeholder="Your Full Name">
            <input type="number" id="codeInput" class="input-field" style="margin-bottom:25px; font-size:1rem;" placeholder="4-Digit Code">

            <button class="action-btn" onclick="completeRegistration()">
                <span id="lbl-finish">REGISTER & LOGIN</span>
            </button>
        </div>
    </div>

    <script>
        // --- 1. INITIALIZATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAOwMQhsRM2PdD_FLjW_8Oi1WlFS3EO5pY",
            authDomain: "smart-a76a0.firebaseapp.com",
            databaseURL: "https://smart-a76a0-default-rtdb.firebaseio.com",
            projectId: "smart-a76a0",
            messagingSenderId: "343693501983",
            appId: "1:343693501983:web:10ea3fce9d990a2455172a"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Phone Input
        const phoneInputField = document.querySelector("#phoneInput");
        const iti = window.intlTelInput(phoneInputField, {
            preferredCountries: ["eg", "sa", "ae"],
            utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js",
        });

        // Setup Background
        const icons = ['fa-dna', 'fa-heartbeat', 'fa-notes-medical', 'fa-lungs', 'fa-brain'];
        for(let i=0; i<25; i++) {
            const el = document.createElement('i');
            el.className = `fas ${icons[Math.floor(Math.random()*icons.length)]} bio-symbol`;
            el.style.left = Math.random()*100 + 'vw';
            el.style.fontSize = (Math.random()*2 + 1) + 'rem';
            el.style.animationDuration = (Math.random()*15 + 15) + 's';
            el.style.animationDelay = (Math.random()*10) + 's';
            document.getElementById('bio-background').appendChild(el);
        }

        // --- 2. LOCALIZATION ---
        const translations = {
            en: {
                uiTitle: "USER LOGIN", lblRem: "Remember me", lblBtn: "INITIALIZE SCAN",
                conTitle: "Terms of Use & Privacy",
                conBody: "<ul><li><b>Medical Guidance Only:</b> This system is informational and NOT a substitute for diagnosis.</li><li><b>Emergency:</b> Call emergency services immediately for critical cases.</li><li><b>Data Security:</b> Your signs are stored securely on Firebase Cloud.</li><li><b>AI Analysis:</b> Trends are statistical and require doctor verification.</li></ul>",
                lblAgree: "I agree to the terms and data processing policy.",
                lblSend: "SEND VERIFICATION CODE",
                verTitle: "Identity Setup", verSub: "Tell us your name to begin.",
                phName: "Your Full Name", phCode: "4-Digit Code", lblFinish: "REGISTER & LOGIN",
                msgInvalid: "Invalid Phone Format", msgRate: "Too many attempts. Wait 60s."
            },
            ar: {
                uiTitle: "تسجيل الدخول", lblRem: "تذكرني", lblBtn: "بدء الفحص",
                conTitle: "شروط الاستخدام والخصوصية",
                conBody: "<ul><li><b>غرض إرشادي فقط:</b> النظام ليس بديلاً عن التشخيص الطبي المتخصص.</li><li><b>حالات الطوارئ:</b> توجه للمستشفى فوراً في الحالات الحرجة.</li><li><b>خصوصية البيانات:</b> يتم تخزين بياناتك بشكل آمن على خوادمنا السحابية.</li><li><b>الذكاء الاصطناعي:</b> التحليلات إحصائية ويجب مراجعتها طبياً.</li></ul>",
                lblAgree: "أقر بأنني قرأت الشروط وأوافق على معالجة بياناتي.",
                lblSend: "إرسال كود التحقق",
                verTitle: "إكمال الملف الشخصي", verSub: "أدخل اسمك بالكامل لبدء الاستخدام.",
                phName: "الاسم بالكامل", phCode: "كود التحقق (4 أرقام)", lblFinish: "تسجيل ودخول",
                msgInvalid: "رقم هاتف غير صحيح", msgRate: "محاولات كثيرة. انتظر دقيقة."
            }
        };

        let currentLang = localStorage.getItem("language") || "en";

        function changeLanguage() {
            currentLang = document.getElementById('lang-select').value;
            localStorage.setItem("language", currentLang);
            updateUI();
        }

        function updateUI() {
            const t = translations[currentLang];
            document.body.classList.toggle('rtl', currentLang === 'ar');
            document.getElementById('ui-title').innerText = t.uiTitle;
            document.getElementById('lbl-remember').innerText = t.lblRem;
            document.getElementById('lbl-btn').innerText = t.lblBtn;
            document.getElementById('con-title').innerText = t.conTitle;
            document.getElementById('con-body').innerHTML = t.conBody;
            document.getElementById('lbl-agree').innerText = t.lblAgree;
            document.getElementById('lbl-send-code').innerText = t.lblSend;
            document.getElementById('ver-title').innerText = t.verTitle;
            document.getElementById('ver-sub').innerText = t.verSub;
            document.getElementById('nameInput').placeholder = t.phName;
            document.getElementById('codeInput').placeholder = t.phCode;
            document.getElementById('lbl-finish').innerText = t.lblFinish;
        }

        // --- 3. LOGIC & AUTH ---
        function validatePhoneLive() {
            if (iti.isValidNumber()) phoneInputField.classList.add('valid');
            else phoneInputField.classList.remove('valid');
        }

        function startAuthProcess() {
            if (!iti.isValidNumber()) {
                showToast(translations[currentLang].msgInvalid, "error");
                phoneInputField.classList.add('shake');
                setTimeout(() => phoneInputField.classList.remove('shake'), 400);
                return;
            }

            // Check Rate Limiting
            const lastAttempt = localStorage.getItem("last_otp_attempt");
            if (lastAttempt && Date.now() - lastAttempt < 60000) {
                showToast(translations[currentLang].msgRate, "error");
                return;
            }

            const phone = iti.getNumber();
            database.ref('PatientData/' + phone).once('value').then(snap => {
                if (snap.exists()) {
                    // User Exists -> Login directly
                    finalizeLogin(phone);
                } else {
                    // New User -> Show Consent
                    document.getElementById('consentModal').classList.add('active');
                }
            });
        }

        function toggleConsentBtn() {
            document.getElementById('consentBtn').disabled = !document.getElementById('agreeCheck').checked;
        }

        function openVerifyModal() {
            document.getElementById('consentModal').classList.remove('active');
            document.getElementById('verifyModal').classList.add('active');
            // Log attempt for rate limiting
            localStorage.setItem("last_otp_attempt", Date.now());
            console.log("OTP Sent to: " + iti.getNumber()); // Simulate SMS sending
        }

        function completeRegistration() {
            const name = document.getElementById('nameInput').value.trim();
            const code = document.getElementById('codeInput').value;
            const phone = iti.getNumber();

            if (name.length < 3) return showToast("Enter your full name", "error");
            if (code !== "1234") return showToast("Wrong Code (Try 1234)", "error"); // Simulation code

            database.ref('PatientData/' + phone).set({
                FullName: name,
                Phone: phone,
                RegistrationDate: new Date().toLocaleString(),
                SensorData: "No measurement recorded yet"
            }).then(() => {
                finalizeLogin(phone);
            });
        }

        function finalizeLogin(phone) {
            if (document.getElementById('remCheck').checked) {
                localStorage.setItem("saved_phone", phone);
            } else {
                localStorage.removeItem("saved_phone");
            }
            localStorage.setItem("selectedUserId", phone);
            window.location.href = "measurements.html";
        }

        function showToast(msg, type) {
            const toast = document.createElement("div");
            toast.className = "toast";
            if(type === 'error') toast.style.borderLeftColor = 'var(--error)';
            toast.innerHTML = `<i class="fas fa-info-circle"></i> ${msg}`;
            document.getElementById('toast-container').appendChild(toast);
            setTimeout(() => toast.remove(), 3500);
        }

        window.onload = () => {
            updateUI();
            const saved = localStorage.getItem("saved_phone");
            if(saved) {
                phoneInputField.value = saved;
                document.getElementById('remCheck').checked = true;
                validatePhoneLive();
            }
        };
    </script>
</body>
</html>
