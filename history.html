<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bioscan | Medical History</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    :root {
      --bg-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --text-color: #ffffff;
      --primary-color: #00d2ff;
      --success-color: #00ff88;
      --error-color: #ff416c;
      --whatsapp-color: #25D366;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 10px; }
    ::-webkit-scrollbar-track { background: #1a1a1a; }
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, var(--primary-color), #a18cd1); 
      border-radius: 10px; border: 2px solid #1a1a1a;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-gradient);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      min-height: 100vh;
      margin: 0; padding: 20px;
      display: flex; flex-direction: column; align-items: center;
      color: var(--text-color);
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* Header */
    header {
      width: 100%; max-width: 900px;
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 30px;
      background: var(--glass-bg); backdrop-filter: blur(10px);
      padding: 15px 25px; border-radius: 20px; border: 1px solid var(--glass-border);
    }

    .header-title h2 { margin: 0; font-weight: 600; font-size: 1.5rem; }
    .header-title span { font-size: 0.9rem; color: #ccc; }

    .actions { display: flex; gap: 10px; }

    .btn {
      border: none; padding: 10px 15px; border-radius: 10px; cursor: pointer;
      font-size: 1rem; color: white; transition: 0.3s; display: flex; align-items: center; gap: 8px;
    }
    .back-btn { background: rgba(255,255,255,0.1); }
    .back-btn:hover { background: var(--primary-color); }

    .print-btn { background: linear-gradient(45deg, #ff9966, #ff5e62); }
    .print-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(255, 94, 98, 0.5); }

    .whatsapp-btn { background: linear-gradient(45deg, #25D366, #128C7E); }
    .whatsapp-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(37, 211, 102, 0.5); }

    /* Table Container */
    .table-container {
      width: 100%; max-width: 900px;
      background: rgba(0, 0, 0, 0.3); border-radius: 20px;
      overflow: hidden; border: 1px solid var(--glass-border);
      max-height: 70vh; overflow-y: auto;
    }

    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    
    th, td { padding: 15px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
    
    th {
      background: rgba(0, 210, 255, 0.2); color: var(--primary-color);
      position: sticky; top: 0; backdrop-filter: blur(5px);
      font-weight: 600; text-transform: uppercase; font-size: 0.9rem;
    }

    tr:hover { background: rgba(255,255,255,0.05); }
    
    /* Loading & Empty States */
    .status-msg { margin-top: 50px; font-size: 1.2rem; color: #aaa; }

    /* Toast */
    .toast-container {
      position: fixed; top: 20px; right: 20px; z-index: 3000;
    }
    .toast {
      background: rgba(16, 30, 40, 0.95); color: white; padding: 15px 25px;
      border-radius: 12px; display: flex; align-items: center; gap: 12px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.4); border-left: 5px solid var(--primary-color);
      animation: slideIn 0.4s ease, fadeOut 0.5s ease 3s forwards;
    }
    @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

  </style>
</head>
<body>

  <div class="toast-container" id="toastContainer"></div>

  <header>
    <div class="header-title">
      <h2 id="pageTitle">Medical History</h2>
      <span id="userSubtitle">User: --</span>
    </div>
    <div class="actions">
      <button class="btn whatsapp-btn" onclick="sendHistoryToWhatsApp()" title="Send Report">
        <i class="fab fa-whatsapp"></i>
      </button>
      
      <button class="btn print-btn" onclick="window.print()" title="Print / Save PDF">
        <i class="fas fa-print"></i>
      </button>
      
      <button class="btn back-btn" onclick="goBack()">
        <i class="fas fa-arrow-left"></i>
      </button>
    </div>
  </header>

  <div class="table-container">
    <table id="historyTable">
      <thead>
        <tr>
          <th id="th-date">Date & Time</th>
          <th id="th-temp">Temp (¬∞C)</th>
          <th id="th-pulse">Pulse (BPM)</th>
          <th id="th-bp">Pressure</th>
          <th id="th-spo2">Oxygen (%)</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        </tbody>
    </table>
    <div id="loadingMsg" class="status-msg">Loading records...</div>
    <div id="emptyMsg" class="status-msg" style="display:none;">No records found.</div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAOwMQhsRM2PdD_FLjW_8Oi1WlFS3EO5pY",
      authDomain: "smart-a76a0.firebaseapp.com",
      databaseURL: "https://smart-a76a0-default-rtdb.firebaseio.com",
      projectId: "smart-a76a0",
      storageBucket: "smart-a76a0.firebasestorage.app",
      messagingSenderId: "343693501983",
      appId: "1:343693501983:web:10ea3fce9d990a2455172a"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const currentUserId = localStorage.getItem("selectedUserId");
    const lang = localStorage.getItem("language") || "en";

    // --- SETUP UI ---
    if(currentUserId) {
        document.getElementById("userSubtitle").innerText = (lang === "ar" ? "ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: " : "User: ") + currentUserId;
    } else {
        window.location.href = "index.html";
    }

    if(lang === "ar") {
        document.body.style.direction = "rtl";
        document.getElementById("pageTitle").innerText = "ÿßŸÑÿ≥ÿ¨ŸÑ ÿßŸÑÿ∑ÿ®Ÿä";
        document.querySelector(".back-btn i").className = "fas fa-arrow-right";
        document.getElementById("th-date").innerText = "ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸàŸÇÿ™";
        document.getElementById("th-temp").innerText = "ÿßŸÑÿ≠ÿ±ÿßÿ±ÿ©";
        document.getElementById("th-pulse").innerText = "ÿßŸÑŸÜÿ®ÿ∂";
        document.getElementById("th-bp").innerText = "ÿßŸÑÿ∂ÿ∫ÿ∑";
        document.getElementById("th-spo2").innerText = "ÿßŸÑÿ£ŸÉÿ≥ÿ¨ŸäŸÜ";
        document.getElementById("loadingMsg").innerText = "ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...";
        document.getElementById("emptyMsg").innerText = "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ≥ÿ¨ŸÑÿßÿ™ ÿ≥ÿßÿ®ŸÇÿ©.";
    }

    // --- FETCH DATA ---
    const records = []; // Store data for WhatsApp

    const userRef = db.ref("current users/" + currentUserId);
    userRef.on("value", (snapshot) => {
        const tbody = document.getElementById("tableBody");
        const loading = document.getElementById("loadingMsg");
        const empty = document.getElementById("emptyMsg");
        
        tbody.innerHTML = "";
        records.length = 0; // Clear array

        if (snapshot.exists()) {
            loading.style.display = "none";
            empty.style.display = "none";
            
            // Convert object to array and reverse to show newest first
            const dataList = [];
            snapshot.forEach(child => {
                dataList.push(child.val());
            });
            dataList.reverse();

            dataList.forEach(data => {
                // Check if data is valid (has at least one reading)
                if(data.temperature || data.bpm || data.pressure || data.spo2) {
                    records.push(data); // Add to local array
                    
                    const row = `
                        <tr>
                            <td>${data.createdAt || "N/A"}</td>
                            <td style="color:${getColor(data.temperature, 36, 37.5)}">${data.temperature || "--"}</td>
                            <td style="color:${getColor(data.bpm, 60, 100)}">${data.bpm || "--"}</td>
                            <td>${data.pressure || "--"}</td>
                            <td style="color:${getColor(data.spo2, 95, 100)}">${data.spo2 || "--"}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                }
            });
        } else {
            loading.style.display = "none";
            empty.style.display = "block";
        }
    });

    function getColor(val, min, max) {
        if(!val) return "#fff";
        val = parseFloat(val);
        if(val >= min && val <= max) return "#00ff88"; // Good
        return "#ff416c"; // Warning
    }

    // --- WHATSAPP LOGIC ---
    function sendHistoryToWhatsApp() {
        if (records.length === 0) {
            showToast(lang === "ar" ? "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑÿ•ÿ±ÿ≥ÿßŸÑŸáÿß!" : "No records to send!", "error");
            return;
        }

        let phone = "20" + currentUserId.substring(1);
        let report = lang === "ar" ? `üìÑ *ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ≥ÿ¨ŸÑ ÿßŸÑÿ∑ÿ®Ÿä - Bioscan ATM*%0A` : `üìÑ *Bioscan Medical History Report*%0A`;
        report += `üë§ ID: ${currentUserId}%0A`;
        report += `-----------------------------%0A`;

        // Loop through last 5 records max to keep message short
        const limit = Math.min(records.length, 5); 
        
        for(let i = 0; i < limit; i++) {
            const r = records[i];
            report += `üìÖ ${r.createdAt || "Date Unknown"}%0A`;
            if(r.temperature) report += `üå°Ô∏è Temp: ${r.temperature}¬∞C%0A`;
            if(r.bpm) report += `‚ù§Ô∏è Pulse: ${r.bpm} bpm%0A`;
            if(r.pressure) report += `ü©∏ BP: ${r.pressure}%0A`;
            if(r.spo2) report += `ü´Å SpO2: ${r.spo2}%%0A`;
            report += `-----------------------------%0A`;
        }

        if(records.length > 5) {
            report += lang === "ar" ? `... ŸàÿßŸÑŸÖÿ≤ŸäÿØ ŸÅŸä ÿßŸÑÿ≥ÿ¨ŸÑ ÿßŸÑŸÉÿßŸÖŸÑ.` : `... and more in full history.`;
        }

        report += lang === "ar" ? `%0A‚úÖ ÿ™ŸÖ ÿßŸÑÿ•ŸÜÿ¥ÿßÿ° ÿ®Ÿàÿßÿ≥ÿ∑ÿ© Bioscan ATM` : `%0A‚úÖ Generated by Bioscan ATM`;

        window.open(`https://wa.me/${phone}?text=${report}`, '_blank');
    }

    function goBack() {
      window.location.href = "measurements.html";
    }

    function showToast(message, type = "info") {
      const container = document.getElementById("toastContainer");
      const toast = document.createElement("div");
      toast.className = `toast`;
      toast.innerHTML = `<i class="fas fa-info-circle"></i> <span>${message}</span>`;
      container.appendChild(toast);
      setTimeout(() => { toast.remove(); }, 3000);
    }

  </script>
</body>
</html>
