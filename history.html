<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bioscan | Medical Report</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* --- SCREEN STYLES --- */
    :root {
      --bg-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --text-color: #ffffff;
      --primary-color: #00d2ff;
      --chart-bg: #ffffff;
      --delete-color: #ff416c;
      --safe-zone: rgba(46, 204, 113, 0.1);
      --danger-zone: rgba(231, 76, 60, 0.1);
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-gradient);
      min-height: 100vh;
      margin: 0; padding: 20px;
      display: flex; flex-direction: column; align-items: center;
      color: var(--text-color);
    }

    ::-webkit-scrollbar { width: 10px; }
    ::-webkit-scrollbar-track { background: #1a1a1a; }
    ::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 10px; }

    .screen-header {
      width: 100%; max-width: 900px;
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px;
      background: var(--glass-bg); backdrop-filter: blur(10px);
      padding: 15px 25px; border-radius: 20px; border: 1px solid var(--glass-border);
    }

    .header-title h2 { margin: 0; font-size: 1.4rem; }
    .header-title span { font-size: 0.9rem; color: #ccc; }

    .actions { display: flex; gap: 10px; flex-wrap: wrap; }

    .btn {
      border: none; padding: 10px 15px; border-radius: 10px; cursor: pointer;
      font-size: 1rem; color: white; transition: 0.3s; display: flex; align-items: center; gap: 8px;
    }
    .back-btn { background: rgba(255,255,255,0.1); }
    .back-btn:hover { background: var(--primary-color); }
    .print-btn { background: linear-gradient(45deg, #00d2ff, #3a7bd5); }
    .whatsapp-btn { background: linear-gradient(45deg, #25D366, #128C7E); }
    .qr-btn { background: linear-gradient(45deg, #8e44ad, #9b59b6); }
    .chart-btn { background: linear-gradient(45deg, #f39c12, #e67e22); }
    .btn:hover { transform: scale(1.05); }

    .table-container {
      width: 100%; max-width: 900px;
      background: rgba(0, 0, 0, 0.3); border-radius: 20px;
      overflow: hidden; border: 1px solid var(--glass-border);
      max-height: 75vh; overflow-y: auto;
    }

    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th, td { padding: 15px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
    th { background: rgba(0, 210, 255, 0.2); color: var(--primary-color); position: sticky; top: 0; backdrop-filter: blur(5px); }
    tr:hover { background: rgba(255,255,255,0.05); }

    .delete-btn { background: transparent; border: none; color: rgba(255, 255, 255, 0.6); cursor: pointer; font-size: 1.1rem; }
    .delete-btn:hover { color: var(--delete-color); transform: scale(1.2); }

    /* --- MODALS --- */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
      z-index: 4000; display: none; justify-content: center; align-items: center;
      opacity: 0; transition: opacity 0.3s;
    }
    .modal-overlay.active { display: flex; opacity: 1; }
    
    .qr-card, .delete-card {
      background: white; color: black; padding: 30px; border-radius: 20px;
      text-align: center; width: 300px; position: relative;
      transform: scale(0.8); transition: transform 0.3s;
    }
    .delete-card { background: linear-gradient(145deg, #2c0b0e, #1a0506); color: white; width: 90%; max-width: 400px; }
    .modal-overlay.active .qr-card, .modal-overlay.active .delete-card { transform: scale(1); }
    
    /* --- CHART CARD STYLES --- */
    .chart-card {
      background: #fff; color: #333; padding: 25px; border-radius: 20px;
      width: 95%; max-width: 800px; position: relative;
      box-shadow: 0 0 50px rgba(0,0,0,0.5); transform: scale(0.8); transition: transform 0.3s;
      max-height: 90vh; overflow-y: auto;
    }
    .modal-overlay.active .chart-card { transform: scale(1); }

    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .chart-select { padding: 8px; border-radius: 8px; border: 1px solid #ccc; font-family: 'Poppins', sans-serif; }
    
    .chart-wrapper { height: 350px; width: 100%; position: relative; }
    
    /* AI Summary Box */
    .ai-summary-box {
      margin-top: 20px;
      background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
      border-left: 5px solid #00d2ff;
      border-radius: 10px; padding: 15px;
      font-size: 0.95rem; line-height: 1.6;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .ai-title { font-weight: bold; color: #2c3e50; display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
    .ai-content { color: #555; }
    .status-badge { display: inline-block; padding: 3px 8px; border-radius: 5px; color: white; font-size: 0.8rem; font-weight: bold; }
    .status-good { background: #2ecc71; }
    .status-warning { background: #f39c12; }
    .status-danger { background: #e74c3c; }

    .close-qr { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #333; }
    
    /* Print & Toast (Existing) */
    @media print { 
      .screen-header, .btn, .modal-overlay, .delete-btn { display: none !important; } 
      body { background: white !important; color: black !important; display: block !important; }
      .table-container { background: white !important; border: none !important; width: 100% !important; max-height: none !important; overflow: visible !important; }
      #printHeader, #printFooter { display: block !important; }
    }
    #printHeader, #printFooter { display: none; }
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 3000; }
    .toast { background: rgba(16, 30, 40, 0.95); color: white; padding: 15px 25px; border-radius: 12px; display: flex; align-items: center; gap: 12px; border-left: 5px solid var(--primary-color); animation: slideIn 0.4s ease, fadeOut 0.5s ease 3s forwards; }
    @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
  </style>
</head>
<body>

  <div class="toast-container" id="toastContainer"></div>

  <div id="qrModal" class="modal-overlay">
    <div class="qr-card">
      <button class="close-qr" onclick="closeModal('qrModal')">&times;</button>
      <h3 style="margin-top:0; color:#8e44ad;">Doctor Scan</h3>
      <div id="qrcode" style="display:flex; justify-content:center; margin:20px 0;"></div>
    </div>
  </div>

  <div id="chartModal" class="modal-overlay">
    <div class="chart-card">
      <button class="close-qr" onclick="closeModal('chartModal')">&times;</button>
      
      <div class="chart-header">
        <h3 style="margin:0; color:#2c3e50;">ğŸ“Š Health Trends</h3>
        <select id="chartTypeSelector" class="chart-select" onchange="updateChartType()">
          <option value="bp">Cardio (BP & Pulse) / Ø§Ù„Ù‚Ù„Ø¨ ÙˆØ§Ù„Ø¶ØºØ·</option>
          <option value="vital">Vitals (Temp & Oxygen) / Ø§Ù„Ø­Ø±Ø§Ø±Ø© ÙˆØ§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†</option>
        </select>
      </div>

      <div class="chart-wrapper">
        <canvas id="healthChart"></canvas>
      </div>

      <div class="ai-summary-box">
        <div class="ai-title"><i class="fas fa-robot"></i> <span>Smart Analysis / ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</span></div>
        <div id="aiAnalysisText" class="ai-content">Analyzing data...</div>
      </div>
    </div>
  </div>

  <div id="deleteModal" class="modal-overlay">
    <div class="delete-card">
      <i class="fas fa-trash-alt del-icon" style="font-size:3rem; margin-bottom:15px; display:block;"></i>
      <h3>Delete Record?</h3>
      <div style="margin-top:20px; display:flex; justify-content:center; gap:10px;">
        <button style="padding:10px 20px; border-radius:20px; border:none;" onclick="closeModal('deleteModal')">Cancel</button>
        <button style="padding:10px 20px; border-radius:20px; border:none; background:#ff416c; color:white;" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <div id="printHeader">
    <div style="border-bottom:2px solid #00d2ff; padding-bottom:10px; margin-bottom:20px;">
      <h1>Medical Report</h1>
      <p>Patient ID: <span id="printUserId">--</span> | Date: <span id="printDate">--</span></p>
    </div>
  </div>

  <header class="screen-header">
    <div class="header-title">
      <h2 id="pageTitle">Medical History</h2>
      <span id="userSubtitle">User: --</span>
    </div>
    <div class="actions">
      <button class="btn chart-btn" onclick="openChartModal()">
        <i class="fas fa-chart-area"></i> <span>Analysis</span>
      </button>
      <button class="btn qr-btn" onclick="generateQR()">
        <i class="fas fa-qrcode"></i> <span>QR</span>
      </button>
      <button class="btn whatsapp-btn" onclick="sendHistoryToWhatsApp()">
        <i class="fab fa-whatsapp"></i>
      </button>
      <button class="btn print-btn" onclick="window.print()">
        <i class="fas fa-print"></i>
      </button>
      <button class="btn back-btn" onclick="goBack()">
        <i class="fas fa-arrow-left"></i>
      </button>
    </div>
  </header>

  <div class="table-container">
    <table id="historyTable">
      <thead>
        <tr>
          <th id="th-date">Date</th>
          <th id="th-temp">Temp</th>
          <th id="th-pulse">Pulse</th>
          <th id="th-spo2">SpO2</th>
          <th id="th-bp">BP</th>
          <th style="width:50px;"></th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
    <div id="loadingMsg" style="text-align:center; padding:20px; color:#aaa;">Loading...</div>
  </div>

  <div id="printFooter" style="display:none; text-align:center; font-size:0.8rem; margin-top:20px;">
    Generated by Bioscan ATM System
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAOwMQhsRM2PdD_FLjW_8Oi1WlFS3EO5pY",
      authDomain: "smart-a76a0.firebaseapp.com",
      databaseURL: "https://smart-a76a0-default-rtdb.firebaseio.com",
      projectId: "smart-a76a0",
      messagingSenderId: "343693501983",
      appId: "1:343693501983:web:10ea3fce9d990a2455172a"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    auth.signInAnonymously().catch(console.error);

    const currentUserId = localStorage.getItem("selectedUserId");
    const lang = localStorage.getItem("language") || "en";
    const PATIENT_DATA_PATH = "PatientData"; 

    // --- SETUP UI ---
    if(currentUserId) {
        document.getElementById("userSubtitle").innerText = (lang==="ar"?"Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ":"User: ") + currentUserId;
        document.getElementById("printUserId").innerText = currentUserId;
        document.getElementById("printDate").innerText = new Date().toLocaleDateString();
    } else window.location.href = "index.html";

    if(lang === "ar") {
        document.body.style.direction = "rtl";
        document.getElementById("pageTitle").innerText = "Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø·Ø¨ÙŠ";
        document.querySelector(".chart-btn span").innerText = "ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†ÙŠ";
        document.getElementById("th-date").innerText = "Ø§Ù„ØªØ§Ø±ÙŠØ®";
        document.getElementById("th-temp").innerText = "Ø§Ù„Ø­Ø±Ø§Ø±Ø©";
        document.getElementById("th-pulse").innerText = "Ø§Ù„Ù†Ø¨Ø¶";
        document.getElementById("th-bp").innerText = "Ø§Ù„Ø¶ØºØ·";
        document.getElementById("th-spo2").innerText = "Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†";
        document.getElementById("loadingMsg").innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
    }

    // --- DATA HANDLING ---
    function extractValues(str) {
        const v = {};
        if(str && str!=="No measurement recorded yet") {
            str.split(',').forEach(p => {
                const [k,val] = p.trim().split('=');
                if(k && val) {
                    const key = k.trim().toLowerCase();
                    if(key.includes('temp')) v.temp = val;
                    if(key.includes('hr')||key.includes('pulse')) v.bpm = val;
                    if(key.includes('bp')||key.includes('pressure')) v.bp = val;
                    if(key.includes('o2')||key.includes('spo2')) v.spo2 = val;
                }
            });
        }
        return v;
    }

    const records = [];
    const historyRef = db.ref(`${PATIENT_DATA_PATH}/${currentUserId}/History`);
    
    historyRef.on("value", (snapshot) => {
        const tbody = document.getElementById("tableBody");
        document.getElementById("loadingMsg").style.display = "none";
        tbody.innerHTML = "";
        records.length = 0;
        
        if (snapshot.exists()) {
            const raw = [];
            snapshot.forEach(c => raw.push({ key: c.key, ...c.val() }));
            
            // Sort: Oldest to Newest for Chart, Reverse for Table
            raw.sort((a,b) => new Date(a.createdAt||a.Timestamp) - new Date(b.createdAt||b.Timestamp));
            
            raw.forEach(item => {
                let d = item.createdAt || item.Timestamp;
                let t = item.temperature, b = item.bpm, p = item.pressure, s = item.spo2;
                if(item.SensorData) {
                    const ex = extractValues(item.SensorData);
                    if(ex.temp) t = ex.temp;
                    if(ex.bpm) b = ex.bpm;
                    if(ex.bp) p = ex.bp;
                    if(ex.spo2) s = ex.spo2;
                }
                if(t && b && p && s) records.push({ date: d, temp: t, bpm: b, bp: p, spo2: s, key: item.key });
            });

            // Populate Table (Newest First)
            [...records].reverse().forEach(r => {
                tbody.innerHTML += `
                    <tr>
                        <td>${r.date}</td><td>${r.temp}</td><td>${r.bpm}</td><td>${r.spo2}</td><td>${r.bp}</td>
                        <td><button class="delete-btn" onclick="askToDelete('${r.key}')"><i class="fas fa-trash-alt"></i></button></td>
                    </tr>`;
            });
        } else {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">${lang==="ar"?"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª":"No Data"}</td></tr>`;
        }
    });

    // --- CHART & AI LOGIC ---
    let myChart = null;

    function openChartModal() {
        if(records.length < 2) return showToast(lang==="ar"?"ÙŠØ¬Ø¨ ØªÙˆÙØ± Ù‚Ø±Ø§Ø¡ØªÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„":"Need 2+ records", "error");
        document.getElementById("chartModal").classList.add("active");
        updateChartType();
    }

    function updateChartType() {
        const type = document.getElementById("chartTypeSelector").value;
        const ctx = document.getElementById('healthChart').getContext('2d');
        if(myChart) myChart.destroy();

        const labels = records.map(r => r.date.split(',')[0]); // Short date
        let datasets = [];
        
        // --- 1. CARDIO CHART (BP & Pulse) ---
        if(type === 'bp') {
            const sys = records.map(r => parseInt(r.bp.split('/')[0]) || 0);
            const dia = records.map(r => parseInt(r.bp.split('/')[1]) || 0);
            const pulse = records.map(r => parseInt(r.bpm));

            datasets = [
                { label: 'Systolic (High)', data: sys, borderColor: '#e74c3c', backgroundColor: 'rgba(231,76,60,0.1)', fill: true, tension: 0.4 },
                { label: 'Diastolic (Low)', data: dia, borderColor: '#3498db', backgroundColor: 'rgba(52,152,219,0.1)', fill: true, tension: 0.4 },
                { label: 'Pulse', data: pulse, borderColor: '#2ecc71', borderDash: [5,5], tension: 0.4 }
            ];
            generateReport('bp', sys, dia, pulse);
        } 
        // --- 2. VITALS CHART (Temp & Oxygen) ---
        else {
            const temp = records.map(r => parseFloat(r.temp));
            const spo2 = records.map(r => parseFloat(r.spo2));

            datasets = [
                { label: 'Temperature (Â°C)', data: temp, borderColor: '#f39c12', backgroundColor: 'rgba(243,156,18,0.1)', yAxisID: 'y', tension: 0.4 },
                { label: 'Oxygen (%)', data: spo2, borderColor: '#9b59b6', backgroundColor: 'rgba(155,89,182,0.1)', yAxisID: 'y1', tension: 0.4 }
            ];
            generateReport('vital', temp, spo2);
        }

        myChart = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: type === 'vital' ? {
                    y: { type: 'linear', display: true, position: 'left', title: {display:true, text:'Temp'} },
                    y1: { type: 'linear', display: true, position: 'right', grid: {drawOnChartArea: false}, title: {display:true, text:'Oxygen %'} }
                } : { y: { beginAtZero: false } },
                plugins: {
                    annotation: {
                        annotations: type === 'bp' ? {
                            line1: { type: 'line', yMin: 140, yMax: 140, borderColor: 'red', borderWidth: 1, label: { content: 'Max Limit', enabled: true } }
                        } : {}
                    }
                }
            }
        });
    }

    // --- AI REPORT GENERATOR ---
    function generateReport(type, data1, data2, data3) {
        let html = "";
        const lastIdx = records.length - 1;
        
        if(type === 'bp') {
            const avgSys = (data1.reduce((a,b)=>a+b,0)/data1.length).toFixed(0);
            const highReadings = data1.filter(v => v > 140).length;
            
            html += `<span class="status-badge ${highReadings>0?'status-warning':'status-good'}">${highReadings>0?'âš ï¸ Warning':'âœ… Stable'}</span><br>`;
            html += lang==="ar" 
                ? `Ù…ØªÙˆØ³Ø· Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ù„Ø¯ÙŠÙƒ Ù‡Ùˆ <b>${avgSys}</b>. ØªÙ… Ø±ØµØ¯ <b>${highReadings}</b> Ù‚Ø±Ø§Ø¡Ø§Øª Ù…Ø±ØªÙØ¹Ø©.` 
                : `Your average systolic BP is <b>${avgSys}</b>. We detected <b>${highReadings}</b> high readings above limit.`;
            
            if(highReadings > 0) html += lang==="ar" 
                ? `<br>ğŸ’¡ <b>Ù†ØµÙŠØ­Ø©:</b> Ù‚Ù„Ù„ Ù…Ù† Ø§Ù„Ù…Ù„Ø­ ÙÙŠ Ø·Ø¹Ø§Ù…Ùƒ ÙˆØ­Ø§ÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ±Ø®Ø§Ø¡.` 
                : `<br>ğŸ’¡ <b>Tip:</b> Reduce salt intake and try to monitor daily.`;
                
        } else {
            const avgTemp = (data1.reduce((a,b)=>a+b,0)/data1.length).toFixed(1);
            const lowO2 = data2.filter(v => v < 95).length;
            
            html += `<span class="status-badge ${avgTemp>37.5?'status-danger':'status-good'}">${avgTemp>37.5?'ğŸ”¥ Fever':'âœ… Normal Temp'}</span> `;
            html += `<span class="status-badge ${lowO2>0?'status-warning':'status-good'}">${lowO2>0?'âš ï¸ Low Oxygen':'âœ… Good Oxygen'}</span><br>`;
            
            html += lang==="ar"
                ? `Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø±Ø§Ø±Ø©: <b>${avgTemp}Â°C</b>. Ù†Ø³Ø¨Ø© Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† Ø¬ÙŠØ¯Ø© ÙÙŠ Ù…Ø¹Ø¸Ù… Ø§Ù„Ø£ÙˆÙ‚Ø§Øª.`
                : `Average Temp: <b>${avgTemp}Â°C</b>. Oxygen saturation levels look stable.`;
                
            if(lowO2 > 0) html += lang==="ar" ? `<br>ğŸŒ¬ï¸ ØªÙ†ÙØ³ Ø¨Ø¹Ù…Ù‚ ÙˆØ§Ø¨Ù‚ ÙÙŠ Ù…ÙƒØ§Ù† Ø¬ÙŠØ¯ Ø§Ù„ØªÙ‡ÙˆÙŠØ©.` : `<br>ğŸŒ¬ï¸ Practice deep breathing exercises.`;
        }
        
        document.getElementById("aiAnalysisText").innerHTML = html;
    }

    // --- COMMON UTILS ---
    function closeModal(id) { document.getElementById(id).classList.remove("active"); }
    
    let delKey = null;
    function askToDelete(k) { delKey = k; document.getElementById("deleteModal").classList.add("active"); }
    function confirmDelete() { 
        if(delKey) db.ref(`${PATIENT_DATA_PATH}/${currentUserId}/History/${delKey}`).remove().then(()=>closeModal("deleteModal"));
    }

    function generateQR() {
        if(records.length===0) return showToast("No Data","error");
        document.getElementById("qrModal").classList.add("active");
        document.getElementById("qrcode").innerHTML = "";
        const r = records[records.length-1];
        new QRCode(document.getElementById("qrcode"), { text: `ID:${currentUserId}\nT:${r.temp}\nBP:${r.bp}`, width:150, height:150 });
    }

    function sendHistoryToWhatsApp() {
        if(records.length===0) return;
        let ph = currentUserId.replace(/\D/g,'');
        if(ph.startsWith('01')) ph = '20'+ph.substring(1);
        let txt = lang==="ar" ? "ØªÙ‚Ø±ÙŠØ± Ø·Ø¨ÙŠ:\n" : "Medical Report:\n";
        [...records].reverse().slice(0,5).forEach(r => txt += `${r.date}: T ${r.temp} | BP ${r.bp}\n`);
        window.open(`https://wa.me/${ph}?text=${encodeURIComponent(txt)}`);
    }

    function goBack() { window.location.href = "measurements.html"; }
    function showToast(m,t) {
        const d = document.createElement("div"); d.className="toast"; d.innerHTML = m;
        document.getElementById("toastContainer").appendChild(d);
        setTimeout(()=>d.remove(),3000);
    }
  </script>
</body>
</html>
