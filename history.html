<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bioscan | Medical Report</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    /* --- SCREEN STYLES (DARK MODE) --- */
    :root {
      --bg-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --text-color: #ffffff;
      --primary-color: #00d2ff;
      --whatsapp-color: #25D366;
      --qr-color: #8e44ad;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-gradient);
      min-height: 100vh;
      margin: 0; padding: 20px;
      display: flex; flex-direction: column; align-items: center;
      color: var(--text-color);
    }

    ::-webkit-scrollbar { width: 10px; }
    ::-webkit-scrollbar-track { background: #1a1a1a; }
    ::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 10px; }

    .screen-header {
      width: 100%; max-width: 900px;
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px;
      background: var(--glass-bg); backdrop-filter: blur(10px);
      padding: 15px 25px; border-radius: 20px; border: 1px solid var(--glass-border);
    }

    .header-title h2 { margin: 0; font-size: 1.4rem; }
    .header-title span { font-size: 0.9rem; color: #ccc; }

    .actions { display: flex; gap: 10px; }

    .btn {
      border: none; padding: 10px 15px; border-radius: 10px; cursor: pointer;
      font-size: 1rem; color: white; transition: 0.3s; display: flex; align-items: center; gap: 8px;
    }
    .back-btn { background: rgba(255,255,255,0.1); }
    .back-btn:hover { background: var(--primary-color); }

    .print-btn { background: linear-gradient(45deg, #00d2ff, #3a7bd5); }
    .print-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(0, 210, 255, 0.5); }

    .whatsapp-btn { background: linear-gradient(45deg, #25D366, #128C7E); }
    .whatsapp-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(37, 211, 102, 0.5); }

    .qr-btn { background: linear-gradient(45deg, #8e44ad, #9b59b6); }
    .qr-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(142, 68, 173, 0.5); }

    .table-container {
      width: 100%; max-width: 900px;
      background: rgba(0, 0, 0, 0.3); border-radius: 20px;
      overflow: hidden; border: 1px solid var(--glass-border);
      max-height: 75vh; overflow-y: auto;
    }

    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th, td { padding: 15px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
    th { background: rgba(0, 210, 255, 0.2); color: var(--primary-color); position: sticky; top: 0; backdrop-filter: blur(5px); }
    tr:hover { background: rgba(255,255,255,0.05); }

    .status-msg { margin-top: 50px; font-size: 1.2rem; color: #aaa; text-align: center; }

    #printHeader, #printFooter { display: none; }

    /* --- QR MODAL STYLES --- */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
      z-index: 4000; display: none; justify-content: center; align-items: center;
      opacity: 0; transition: opacity 0.3s;
    }
    .modal-overlay.active { display: flex; opacity: 1; }
    
    .qr-card {
      background: white; color: black; padding: 30px; border-radius: 20px;
      text-align: center; width: 300px; position: relative;
      box-shadow: 0 0 30px rgba(142, 68, 173, 0.5);
      transform: scale(0.8); transition: transform 0.3s;
    }
    .modal-overlay.active .qr-card { transform: scale(1); }
    
    #qrcode { display: flex; justify-content: center; margin: 20px 0; }
    
    .close-qr {
      position: absolute; top: 10px; right: 15px; background: none; border: none;
      font-size: 1.5rem; cursor: pointer; color: #333;
    }
    .close-qr:hover { color: red; }

    /* --- PRINT STYLES --- */
    @media print {
      @page { size: A4; margin: 10mm; }
      body { background: white !important; color: #333 !important; display: block !important; padding: 0 !important; font-family: 'Helvetica', sans-serif !important; }
      .screen-header, .back-btn, .whatsapp-btn, .print-btn, .qr-btn, ::-webkit-scrollbar, .toast-container, .modal-overlay { display: none !important; }
      #printHeader { display: flex !important; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 2px solid #00d2ff; }
      .report-info { text-align: left; font-size: 14px; line-height: 1.8; }
      .report-title { text-align: right; }
      .report-title h1 { font-size: 28px; color: #333; margin: 0; font-weight: 700; text-transform: uppercase; }
      .table-container { background: white !important; border: none !important; max-height: none !important; overflow: visible !important; box-shadow: none !important; width: 100% !important; margin-top: 20px; }
      table { width: 100%; border-collapse: collapse; }
      thead th { background-color: #00ced1 !important; color: white !important; padding: 12px 15px; text-align: left; font-size: 13px; text-transform: uppercase; border: none !important; -webkit-print-color-adjust: exact; }
      tbody td { padding: 12px 15px; border-bottom: 1px solid #eee !important; color: #444 !important; font-size: 13px; text-align: left; }
      tbody tr:nth-child(even) { background-color: #f9f9f9 !important; -webkit-print-color-adjust: exact; }
      #printFooter { display: block !important; position: fixed; bottom: 20px; left: 0; width: 100%; text-align: left; font-size: 11px; color: #999; border-top: 1px solid #ddd; padding-top: 10px; }
    }

    /* Toast */
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 3000; }
    .toast { background: rgba(16, 30, 40, 0.95); color: white; padding: 15px 25px; border-radius: 12px; display: flex; align-items: center; gap: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); border-left: 5px solid var(--primary-color); animation: slideIn 0.4s ease, fadeOut 0.5s ease 3s forwards; }
    @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

  </style>
</head>
<body>

  <div class="toast-container" id="toastContainer"></div>

  <div id="qrModal" class="modal-overlay">
    <div class="qr-card">
      <button class="close-qr" onclick="closeQR()">&times;</button>
      <h3 style="margin-top:0; color:#8e44ad;">Doctor Scan</h3>
      <p style="font-size:0.8rem; color:#666;">Scan to see latest reading</p>
      
      <div id="qrcode"></div>
      
      <p style="font-size:0.7rem; color:#999; margin-bottom:0;">Generated by Bioscan ATM</p>
    </div>
  </div>

  <div id="printHeader">
    <div class="report-info">
      <strong>Patient ID:</strong> <span id="printUserId">--</span><br>
      <strong>Date:</strong> <span id="printDate">--</span><br>
      <strong>Source:</strong> Generated via Bioscan ATM System
    </div>
    <div class="report-title">
      <h1>Medical Report</h1>
      <p>BioScan Health Monitor</p>
    </div>
  </div>

  <header class="screen-header">
    <div class="header-title">
      <h2 id="pageTitle">Medical History</h2>
      <span id="userSubtitle">User: --</span>
    </div>
    <div class="actions">
      <button class="btn qr-btn" onclick="generateQR()" title="Generate QR Code">
        <i class="fas fa-qrcode"></i> <span>QR Code</span>
      </button>

      <button class="btn whatsapp-btn" onclick="sendHistoryToWhatsApp()" title="Send to WhatsApp">
        <i class="fab fa-whatsapp"></i>
      </button>
      
      <button class="btn print-btn" onclick="window.print()" title="Download PDF">
        <i class="fas fa-print"></i>
      </button>
      
      <button class="btn back-btn" onclick="goBack()">
        <i class="fas fa-arrow-left"></i>
      </button>
    </div>
  </header>

  <div class="table-container">
    <table id="historyTable">
      <thead>
        <tr>
          <th id="th-date">Time / Date</th>
          <th id="th-temp">Temperature</th>
          <th id="th-pulse">Pulse (BPM)</th>
          <th id="th-spo2">Oxygen (%)</th>
          <th id="th-bp">Pressure</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        </tbody>
    </table>
    <div id="loadingMsg" class="status-msg">Loading records...</div>
    <div id="emptyMsg" class="status-msg" style="display:none;">No records found.</div>
  </div>

  <div id="printFooter">
    Disclaimer: This report is generated automatically by sensors. Please consult a doctor for official diagnosis.
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAOwMQhsRM2PdD_FLjW_8Oi1WlFS3EO5pY",
      authDomain: "smart-a76a0.firebaseapp.com",
      databaseURL: "https://smart-a76a0-default-rtdb.firebaseio.com",
      projectId: "smart-a76a0",
      messagingSenderId: "343693501983",
      appId: "1:343693501983:web:10ea3fce9d990a2455172a"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    auth.signInAnonymously().catch((error) => {
        console.error("Auth Error:", error);
    });

    const currentUserId = localStorage.getItem("selectedUserId");
    const lang = localStorage.getItem("language") || "en";
    const PATIENT_DATA_PATH = "PatientData"; 

    // --- SETUP UI ---
    if(currentUserId) {
        const userText = (lang === "ar" ? "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: " : "User: ") + currentUserId;
        document.getElementById("userSubtitle").innerText = userText;
        document.getElementById("printUserId").innerText = currentUserId;
        document.getElementById("printDate").innerText = new Date().toLocaleString();
    } else {
        window.location.href = "index.html";
    }

    if(lang === "ar") {
        document.body.style.direction = "rtl";
        document.getElementById("pageTitle").innerText = "Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø·Ø¨ÙŠ";
        document.querySelector(".back-btn i").className = "fas fa-arrow-right";
        document.querySelector(".qr-btn span").innerText = "ÙƒÙˆØ¯ Ø§Ù„Ø·Ø¨ÙŠØ¨";
        
        document.getElementById("th-date").innerText = "Ø§Ù„ÙˆÙ‚Øª / Ø§Ù„ØªØ§Ø±ÙŠØ®";
        document.getElementById("th-temp").innerText = "Ø§Ù„Ø­Ø±Ø§Ø±Ø©";
        document.getElementById("th-pulse").innerText = "Ø§Ù„Ù†Ø¨Ø¶";
        document.getElementById("th-bp").innerText = "Ø§Ù„Ø¶ØºØ·";
        document.getElementById("th-spo2").innerText = "Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†";
        document.getElementById("loadingMsg").innerText = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";
        document.getElementById("emptyMsg").innerText = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø³Ø§Ø¨Ù‚Ø©.";
        
        document.querySelector(".report-title h1").innerText = "ØªÙ‚Ø±ÙŠØ± Ø·Ø¨ÙŠ";
        document.querySelector(".report-title p").innerText = "Ù†Ø¸Ø§Ù… Ø¨Ø§ÙŠÙˆ Ø³ÙƒØ§Ù†";
        document.querySelector(".report-info").innerHTML = `
            <strong>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ÙŠØ¶:</strong> ${currentUserId}<br>
            <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date().toLocaleString()}<br>
            <strong>Ø§Ù„Ù…ØµØ¯Ø±:</strong> ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Bioscan ATM
        `;
        document.getElementById("printFooter").innerText = "ØªÙ†ÙˆÙŠÙ‡: Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¢Ù„ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø³ØªØ´Ø¹Ø±Ø§Øª. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ Ù„Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø±Ø³Ù…ÙŠ.";
    }

    function extractSensorValues(sensorString) {
        const values = {};
        if (sensorString && sensorString !== "No measurement recorded yet") {
            sensorString.split(',').forEach(item => {
                const parts = item.trim().split('=');
                if (parts.length === 2) {
                    const key = parts[0].trim().toLowerCase();
                    const value = parts[1].trim();
                    if (key.includes('temp')) values.temp = value;
                    else if (key === 'hr' || key.includes('pulse')) values.bpm = value;
                    else if (key === 'bp' || key.includes('pressure')) values.pressure = value;
                    else if (key.includes('o2') || key.includes('spo2')) values.spo2 = value;
                }
            });
        }
        return values;
    }

    const records = [];
    const historyRef = db.ref(`${PATIENT_DATA_PATH}/${currentUserId}/History`);
    
    historyRef.on("value", (snapshot) => {
        const tbody = document.getElementById("tableBody");
        const loading = document.getElementById("loadingMsg");
        const empty = document.getElementById("emptyMsg");
        
        tbody.innerHTML = "";
        records.length = 0;

        if (snapshot.exists()) {
            loading.style.display = "none";
            empty.style.display = "none";
            
            const dataList = [];
            snapshot.forEach(child => { 
                dataList.push(child.val()); 
            });
            dataList.reverse();

            dataList.forEach(data => {
                let temp = "--", bpm = "--", pressure = "--", spo2 = "--", date = "N/A";

                if (data.temperature) temp = data.temperature;
                if (data.bpm) bpm = data.bpm;
                if (data.pressure) pressure = data.pressure;
                if (data.spo2) spo2 = data.spo2;
                
                if (data.SensorData) {
                    const parsed = extractSensorValues(data.SensorData);
                    if(parsed.temp) temp = parsed.temp;
                    if(parsed.bpm) bpm = parsed.bpm;
                    if(parsed.pressure) pressure = parsed.pressure;
                    if(parsed.spo2) spo2 = parsed.spo2;
                }

                date = data.createdAt || data.Timestamp || "N/A";

                if(temp !== "--" || bpm !== "--" || pressure !== "--" || spo2 !== "--") {
                    const unifiedRecord = { temperature: temp, bpm: bpm, pressure: pressure, spo2: spo2, createdAt: date };
                    records.push(unifiedRecord);
                    
                    const row = `
                        <tr>
                            <td>${date}</td>
                            <td>${temp}</td>
                            <td>${bpm}</td>
                            <td>${spo2}</td>
                            <td>${pressure}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                }
            });
            
            if(records.length === 0) empty.style.display = "block";

        } else {
            loading.style.display = "none";
            empty.style.display = "block";
        }
    });

    function generateQR() {
        if(records.length === 0) {
            showToast(lang === "ar" ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª!" : "No data available!", "error");
            return;
        }

        const modal = document.getElementById("qrModal");
        modal.classList.add("active");
        modal.style.display = "flex"; 

        const qrContainer = document.getElementById("qrcode");
        qrContainer.innerHTML = "";

        const latest = records[0];
        
        const qrData = `Bioscan Report
ID: ${currentUserId}
Date: ${latest.createdAt}
Temp: ${latest.temperature || '--'}Â°C
Pulse: ${latest.bpm || '--'} bpm
BP: ${latest.pressure || '--'}
SpO2: ${latest.spo2 || '--'}%`;

        setTimeout(() => {
            try {
                new QRCode(qrContainer, {
                    text: qrData,
                    width: 180,
                    height: 180,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.M
                });
            } catch (e) {
                console.error("QR Error:", e);
                qrContainer.innerText = "Error generating QR";
            }
        }, 100);
    }

    // --- Fix: Ensure Modal hides correctly ---
    function closeQR() {
        const modal = document.getElementById("qrModal");
        modal.classList.remove("active");
        // Wait for CSS transition then hide
        setTimeout(() => {
            modal.style.display = "none";
        }, 300);
    }

    function sendHistoryToWhatsApp() {
        if (records.length === 0) {
            showToast(lang === "ar" ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª!" : "No records!", "error");
            return;
        }
        let phone = currentUserId;
        if (phone.startsWith('0')) phone = '20' + phone.substring(1);

        let report = lang === "ar" ? `ðŸ“„ *ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø·Ø¨ÙŠ*%0A` : `ðŸ“„ *Medical History Report*%0A`;
        report += `ðŸ‘¤ ID: ${currentUserId}%0AðŸ“… ${new Date().toLocaleDateString()}%0A-----------------%0A`;

        const limit = Math.min(records.length, 5); 
        for(let i = 0; i < limit; i++) {
            const r = records[i];
            report += `â° ${r.createdAt}%0AðŸŒ¡ï¸ ${r.temperature || '--'}Â°C | â¤ï¸ ${r.bpm || '--'} bpm%0AðŸ« ${r.spo2}% | ðŸ©¸ ${r.pressure || '--'}%0A-----------------%0A`;
        }
        window.open(`https://wa.me/${phone}?text=${report}`, '_blank');
    }

    function goBack() { window.location.href = "measurements.html"; }

    function showToast(message, type = "info") {
      const container = document.getElementById("toastContainer");
      const toast = document.createElement("div");
      toast.className = `toast`;
      toast.innerHTML = `<i class="fas fa-info-circle"></i> <span>${message}</span>`;
      container.appendChild(toast);
      setTimeout(() => { toast.remove(); }, 3000);
    }
  </script>
</body>
</html>
