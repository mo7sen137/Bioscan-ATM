<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bioscan | Medical Report</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    /* --- SCREEN STYLES (DARK MODE) --- */
    :root {
      --bg-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --text-color: #ffffff;
      --primary-color: #00d2ff; /* Cyan color matching the image */
      --whatsapp-color: #25D366;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-gradient);
      min-height: 100vh;
      margin: 0; padding: 20px;
      display: flex; flex-direction: column; align-items: center;
      color: var(--text-color);
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 10px; }
    ::-webkit-scrollbar-track { background: #1a1a1a; }
    ::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 10px; }

    /* Screen Header */
    .screen-header {
      width: 100%; max-width: 900px;
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px;
      background: var(--glass-bg); backdrop-filter: blur(10px);
      padding: 15px 25px; border-radius: 20px; border: 1px solid var(--glass-border);
    }

    .header-title h2 { margin: 0; font-size: 1.4rem; }
    .header-title span { font-size: 0.9rem; color: #ccc; }

    .actions { display: flex; gap: 10px; }

    .btn {
      border: none; padding: 10px 15px; border-radius: 10px; cursor: pointer;
      font-size: 1rem; color: white; transition: 0.3s; display: flex; align-items: center; gap: 8px;
    }
    .back-btn { background: rgba(255,255,255,0.1); }
    .back-btn:hover { background: var(--primary-color); }

    .print-btn { background: linear-gradient(45deg, #00d2ff, #3a7bd5); }
    .print-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(0, 210, 255, 0.5); }

    .whatsapp-btn { background: linear-gradient(45deg, #25D366, #128C7E); }
    .whatsapp-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(37, 211, 102, 0.5); }

    /* Table on Screen */
    .table-container {
      width: 100%; max-width: 900px;
      background: rgba(0, 0, 0, 0.3); border-radius: 20px;
      overflow: hidden; border: 1px solid var(--glass-border);
      max-height: 75vh; overflow-y: auto;
    }

    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th, td { padding: 15px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
    th { background: rgba(0, 210, 255, 0.2); color: var(--primary-color); position: sticky; top: 0; backdrop-filter: blur(5px); }
    tr:hover { background: rgba(255,255,255,0.05); }

    .status-msg { margin-top: 50px; font-size: 1.2rem; color: #aaa; text-align: center; }

    /* Print Header (Hidden on Screen) */
    #printHeader, #printFooter { display: none; }

    /* --- PRINT STYLES (MATCHING THE IMAGE) --- */
    @media print {
      @page {
        size: A4;
        margin: 10mm;
      }

      body {
        background: white !important;
        color: #333 !important;
        display: block !important;
        padding: 0 !important;
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif !important;
      }
      
      /* Hide Screen UI */
      .screen-header, .back-btn, .whatsapp-btn, .print-btn, ::-webkit-scrollbar, .toast-container {
        display: none !important;
      }

      /* Report Header */
      #printHeader {
        display: flex !important;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 40px;
        padding-bottom: 20px;
        border-bottom: 2px solid #00d2ff;
      }

      .report-info {
        text-align: left;
        font-size: 14px;
        line-height: 1.8;
      }
      .report-info strong { color: #555; }

      .report-title {
        text-align: right;
      }
      .report-title h1 {
        font-size: 28px; color: #333; margin: 0; font-weight: 700;
        text-transform: uppercase;
      }
      .report-title p { color: #888; margin: 5px 0 0 0; font-size: 14px; }

      /* Table Styles (Matching Image) */
      .table-container {
        background: white !important; border: none !important;
        max-height: none !important; overflow: visible !important;
        box-shadow: none !important; width: 100% !important;
        margin-top: 20px;
      }

      table { width: 100%; border-collapse: collapse; }
      
      /* The Teal Header */
      thead th {
        background-color: #00ced1 !important; /* Specific Teal Color */
        color: white !important;
        padding: 12px 15px;
        text-align: left;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: none !important;
        -webkit-print-color-adjust: exact; /* Force color print */
        print-color-adjust: exact;
      }

      tbody td {
        padding: 12px 15px;
        border-bottom: 1px solid #eee !important;
        color: #444 !important;
        font-size: 13px;
        text-align: left;
      }

      /* Zebra Striping (Optional, looks nice) */
      tbody tr:nth-child(even) {
        background-color: #f9f9f9 !important;
        -webkit-print-color-adjust: exact;
      }

      /* Footer */
      #printFooter {
        display: block !important;
        position: fixed; bottom: 20px; left: 0; width: 100%;
        text-align: left; font-size: 11px; color: #999;
        border-top: 1px solid #ddd; padding-top: 10px;
      }
    }

    /* Toast */
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 3000; }
    .toast {
      background: rgba(16, 30, 40, 0.95); color: white; padding: 15px 25px;
      border-radius: 12px; display: flex; align-items: center; gap: 12px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.4); border-left: 5px solid var(--primary-color);
      animation: slideIn 0.4s ease, fadeOut 0.5s ease 3s forwards;
    }
    @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

  </style>
</head>
<body>

  <div class="toast-container" id="toastContainer"></div>

  <div id="printHeader">
    <div class="report-info">
      <strong>Patient ID:</strong> <span id="printUserId">--</span><br>
      <strong>Date:</strong> <span id="printDate">--</span><br>
      <strong>Source:</strong> Generated via Bioscan ATM System
    </div>
    <div class="report-title">
      <h1>Medical Report</h1>
      <p>BioScan Health Monitor</p>
    </div>
  </div>

  <header class="screen-header">
    <div class="header-title">
      <h2 id="pageTitle">Medical History</h2>
      <span id="userSubtitle">User: --</span>
    </div>
    <div class="actions">
      <button class="btn whatsapp-btn" onclick="sendHistoryToWhatsApp()" title="Send via WhatsApp">
        <i class="fab fa-whatsapp"></i> <span>WhatsApp</span>
      </button>
      <button class="btn print-btn" onclick="window.print()" title="Print / PDF">
        <i class="fas fa-print"></i> <span>Print Report</span>
      </button>
      <button class="btn back-btn" onclick="goBack()">
        <i class="fas fa-arrow-left"></i>
      </button>
    </div>
  </header>

  <div class="table-container">
    <table id="historyTable">
      <thead>
        <tr>
          <th id="th-date">Time / Date</th>
          <th id="th-temp">Temperature</th>
          <th id="th-pulse">Pulse (BPM)</th>
          <th id="th-spo2">Oxygen (%)</th>
          <th id="th-bp">Pressure</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        </tbody>
    </table>
    <div id="loadingMsg" class="status-msg">Loading records...</div>
    <div id="emptyMsg" class="status-msg" style="display:none;">No records found.</div>
  </div>

  <div id="printFooter">
    Disclaimer: This report is generated automatically by sensors. Please consult a doctor for official diagnosis.
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAOwMQhsRM2PdD_FLjW_8Oi1WlFS3EO5pY",
      authDomain: "smart-a76a0.firebaseapp.com",
      databaseURL: "https://smart-a76a0-default-rtdb.firebaseio.com",
      projectId: "smart-a76a0",
      storageBucket: "smart-a76a0.firebasestorage.app",
      messagingSenderId: "343693501983",
      appId: "1:343693501983:web:10ea3fce9d990a2455172a"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const currentUserId = localStorage.getItem("selectedUserId");
    const lang = localStorage.getItem("language") || "en";

    // --- SETUP UI ---
    if(currentUserId) {
        document.getElementById("userSubtitle").innerText = (lang === "ar" ? "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: " : "User: ") + currentUserId;
        document.getElementById("printUserId").innerText = currentUserId;
        document.getElementById("printDate").innerText = new Date().toLocaleString();
    } else {
        window.location.href = "index.html";
    }

    if(lang === "ar") {
        document.body.style.direction = "rtl";
        document.getElementById("pageTitle").innerText = "Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø·Ø¨ÙŠ";
        document.querySelector(".back-btn i").className = "fas fa-arrow-right";
        document.querySelector(".whatsapp-btn span").innerText = "ÙˆØ§ØªØ³Ø§Ø¨";
        document.querySelector(".print-btn span").innerText = "Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ±";
        
        document.getElementById("th-date").innerText = "Ø§Ù„ÙˆÙ‚Øª / Ø§Ù„ØªØ§Ø±ÙŠØ®";
        document.getElementById("th-temp").innerText = "Ø§Ù„Ø­Ø±Ø§Ø±Ø©";
        document.getElementById("th-pulse").innerText = "Ø§Ù„Ù†Ø¨Ø¶";
        document.getElementById("th-bp").innerText = "Ø§Ù„Ø¶ØºØ·";
        document.getElementById("th-spo2").innerText = "Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†";
        document.getElementById("loadingMsg").innerText = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";
        document.getElementById("emptyMsg").innerText = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø³Ø§Ø¨Ù‚Ø©.";
        
        // Print Translations
        document.querySelector(".report-title h1").innerText = "ØªÙ‚Ø±ÙŠØ± Ø·Ø¨ÙŠ";
        document.querySelector(".report-title p").innerText = "Ù†Ø¸Ø§Ù… Ø¨Ø§ÙŠÙˆ Ø³ÙƒØ§Ù†";
        document.querySelector(".report-info").innerHTML = `
            <strong>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ÙŠØ¶:</strong> ${currentUserId}<br>
            <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date().toLocaleString()}<br>
            <strong>Ø§Ù„Ù…ØµØ¯Ø±:</strong> ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Bioscan ATM
        `;
        document.getElementById("printFooter").innerText = "ØªÙ†ÙˆÙŠÙ‡: Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¢Ù„ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø³ØªØ´Ø¹Ø±Ø§Øª. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ Ù„Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø±Ø³Ù…ÙŠ.";
    }

    // --- FETCH DATA ---
    const records = [];

    const userRef = db.ref("current users/" + currentUserId);
    userRef.on("value", (snapshot) => {
        const tbody = document.getElementById("tableBody");
        const loading = document.getElementById("loadingMsg");
        const empty = document.getElementById("emptyMsg");
        
        tbody.innerHTML = "";
        records.length = 0;

        if (snapshot.exists()) {
            loading.style.display = "none";
            empty.style.display = "none";
            
            const dataList = [];
            snapshot.forEach(child => { dataList.push(child.val()); });
            dataList.reverse();

            dataList.forEach(data => {
                if(data.temperature || data.bpm || data.pressure || data.spo2) {
                    records.push(data);
                    const row = `
                        <tr>
                            <td>${data.createdAt || "N/A"}</td>
                            <td>${data.temperature || "--"}</td>
                            <td>${data.bpm || "--"}</td>
                            <td>${data.spo2 || "--"}</td>
                            <td>${data.pressure || "--"}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                }
            });
        } else {
            loading.style.display = "none";
            empty.style.display = "block";
        }
    });

    // --- WHATSAPP ---
    function sendHistoryToWhatsApp() {
        if (records.length === 0) {
            showToast(lang === "ar" ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª!" : "No records!", "error");
            return;
        }
        let phone = "20" + currentUserId.substring(1);
        let report = lang === "ar" ? `ðŸ“„ *ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø·Ø¨ÙŠ*%0A` : `ðŸ“„ *Medical History Report*%0A`;
        report += `ðŸ‘¤ ID: ${currentUserId}%0AðŸ“… ${new Date().toLocaleDateString()}%0A-----------------%0A`;

        const limit = Math.min(records.length, 5); 
        for(let i = 0; i < limit; i++) {
            const r = records[i];
            report += `â° ${r.createdAt}%0AðŸŒ¡ï¸ ${r.temperature}Â°C | â¤ï¸ ${r.bpm} bpm%0AðŸ« ${r.spo2}% | ðŸ©¸ ${r.pressure}%0A-----------------%0A`;
        }
        window.open(`https://wa.me/${phone}?text=${report}`, '_blank');
    }

    function goBack() { window.location.href = "measurements.html"; }

    function showToast(message, type = "info") {
      const container = document.getElementById("toastContainer");
      const toast = document.createElement("div");
      toast.className = `toast`;
      toast.innerHTML = `<i class="fas fa-info-circle"></i> <span>${message}</span>`;
      container.appendChild(toast);
      setTimeout(() => { toast.remove(); }, 3000);
    }
  </script>
</body>
</html>
