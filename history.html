<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <title>Bioscan | Medical Report</title>
Â Â 
Â  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
Â  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
Â Â 
Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

Â  <style>
Â  Â  /* --- SCREEN STYLES (DARK MODE) --- */
Â  Â  :root {
Â  Â  Â  --bg-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
Â  Â  Â  --glass-bg: rgba(255, 255, 255, 0.1);
Â  Â  Â  --glass-border: rgba(255, 255, 255, 0.2);
Â  Â  Â  --text-color: #ffffff;
Â  Â  Â  --primary-color: #00d2ff;
Â  Â  Â  --whatsapp-color: #25D366;
Â  Â  Â  --qr-color: #8e44ad; /* Ù„ÙˆÙ† Ø²Ø±Ø§Ø± Ø§Ù„Ù€ QR */
Â  Â  }

Â  Â  body {
Â  Â  Â  font-family: 'Poppins', sans-serif;
Â  Â  Â  background: var(--bg-gradient);
Â  Â  Â  min-height: 100vh;
Â  Â  Â  margin: 0; padding: 20px;
Â  Â  Â  display: flex; flex-direction: column; align-items: center;
Â  Â  Â  color: var(--text-color);
Â  Â  }

Â  Â  /* Scrollbar */
Â  Â  ::-webkit-scrollbar { width: 10px; }
Â  Â  ::-webkit-scrollbar-track { background: #1a1a1a; }
Â  Â  ::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 10px; }

Â  Â  /* Screen Header */
Â  Â  .screen-header {
Â  Â  Â  width: 100%; max-width: 900px;
Â  Â  Â  display: flex; justify-content: space-between; align-items: center;
Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  background: var(--glass-bg); backdrop-filter: blur(10px);
Â  Â  Â  padding: 15px 25px; border-radius: 20px; border: 1px solid var(--glass-border);
Â  Â  }

Â  Â  .header-title h2 { margin: 0; font-size: 1.4rem; }
Â  Â  .header-title span { font-size: 0.9rem; color: #ccc; }

Â  Â  .actions { display: flex; gap: 10px; }

Â  Â  .btn {
Â  Â  Â  border: none; padding: 10px 15px; border-radius: 10px; cursor: pointer;
Â  Â  Â  font-size: 1rem; color: white; transition: 0.3s; display: flex; align-items: center; gap: 8px;
Â  Â  }
Â  Â  .back-btn { background: rgba(255,255,255,0.1); }
Â  Â  .back-btn:hover { background: var(--primary-color); }

Â  Â  .print-btn { background: linear-gradient(45deg, #00d2ff, #3a7bd5); }
Â  Â  .print-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(0, 210, 255, 0.5); }

Â  Â  .whatsapp-btn { background: linear-gradient(45deg, #25D366, #128C7E); }
Â  Â  .whatsapp-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(37, 211, 102, 0.5); }

Â  Â  .qr-btn { background: linear-gradient(45deg, #8e44ad, #9b59b6); }
Â  Â  .qr-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(142, 68, 173, 0.5); }

Â  Â  /* Table on Screen */
Â  Â  .table-container {
Â  Â  Â  width: 100%; max-width: 900px;
Â  Â  Â  background: rgba(0, 0, 0, 0.3); border-radius: 20px;
Â  Â  Â  overflow: hidden; border: 1px solid var(--glass-border);
Â  Â  Â  max-height: 75vh; overflow-y: auto;
Â  Â  }

Â  Â  table { width: 100%; border-collapse: collapse; min-width: 600px; }
Â  Â  th, td { padding: 15px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
Â  Â  th { background: rgba(0, 210, 255, 0.2); color: var(--primary-color); position: sticky; top: 0; backdrop-filter: blur(5px); }
Â  Â  tr:hover { background: rgba(255,255,255,0.05); }

Â  Â  .status-msg { margin-top: 50px; font-size: 1.2rem; color: #aaa; text-align: center; }

Â  Â  /* Print Header (Hidden on Screen) */
Â  Â  #printHeader, #printFooter { display: none; }

Â  Â  /* --- QR MODAL STYLES --- */
Â  Â  .modal-overlay {
Â  Â  Â  position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
Â  Â  Â  z-index: 4000; display: none; justify-content: center; align-items: center;
Â  Â  Â  opacity: 0; transition: opacity 0.3s;
Â  Â  }
Â  Â  .modal-overlay.active { display: flex; opacity: 1; }
Â  Â Â 
Â  Â  .qr-card {
Â  Â  Â  background: white; color: black; padding: 30px; border-radius: 20px;
Â  Â  Â  text-align: center; width: 300px; position: relative;
Â  Â  Â  box-shadow: 0 0 30px rgba(142, 68, 173, 0.5);
Â  Â  Â  transform: scale(0.8); transition: transform 0.3s;
Â  Â  }
Â  Â  .modal-overlay.active .qr-card { transform: scale(1); }
Â  Â Â 
Â  Â  #qrcode { display: flex; justify-content: center; margin: 20px 0; }
Â  Â Â 
Â  Â  .close-qr {
Â  Â  Â  position: absolute; top: 10px; right: 15px; background: none; border: none;
Â  Â  Â  font-size: 1.5rem; cursor: pointer; color: #333;
Â  Â  }
Â  Â  .close-qr:hover { color: red; }

Â  Â  /* --- PRINT STYLES --- */
Â  Â  @media print {
Â  Â  Â  @page { size: A4; margin: 10mm; }
Â  Â  Â  body { background: white !important; color: #333 !important; display: block !important; padding: 0 !important; font-family: 'Helvetica', sans-serif !important; }
Â  Â  Â  .screen-header, .back-btn, .whatsapp-btn, .print-btn, .qr-btn, ::-webkit-scrollbar, .toast-container, .modal-overlay { display: none !important; }
Â  Â  Â  #printHeader { display: flex !important; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 2px solid #00d2ff; }
Â  Â  Â  .report-info { text-align: left; font-size: 14px; line-height: 1.8; }
Â  Â  Â  .report-title { text-align: right; }
Â  Â  Â  .report-title h1 { font-size: 28px; color: #333; margin: 0; font-weight: 700; text-transform: uppercase; }
Â  Â  Â  .table-container { background: white !important; border: none !important; max-height: none !important; overflow: visible !important; box-shadow: none !important; width: 100% !important; margin-top: 20px; }
Â  Â  Â  table { width: 100%; border-collapse: collapse; }
Â  Â  Â  thead th { background-color: #00ced1 !important; color: white !important; padding: 12px 15px; text-align: left; font-size: 13px; text-transform: uppercase; border: none !important; -webkit-print-color-adjust: exact; }
Â  Â  Â  tbody td { padding: 12px 15px; border-bottom: 1px solid #eee !important; color: #444 !important; font-size: 13px; text-align: left; }
Â  Â  Â  tbody tr:nth-child(even) { background-color: #f9f9f9 !important; -webkit-print-color-adjust: exact; }
Â  Â  Â  #printFooter { display: block !important; position: fixed; bottom: 20px; left: 0; width: 100%; text-align: left; font-size: 11px; color: #999; border-top: 1px solid #ddd; padding-top: 10px; }
Â  Â  }

Â  Â  /* Toast */
Â  Â  .toast-container { position: fixed; top: 20px; right: 20px; z-index: 3000; }
Â  Â  .toast { background: rgba(16, 30, 40, 0.95); color: white; padding: 15px 25px; border-radius: 12px; display: flex; align-items: center; gap: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); border-left: 5px solid var(--primary-color); animation: slideIn 0.4s ease, fadeOut 0.5s ease 3s forwards; }
Â  Â  @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
Â  Â  @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

Â  </style>
</head>
<body>

Â  <div class="toast-container" id="toastContainer"></div>

Â  <div id="qrModal" class="modal-overlay">
Â  Â  <div class="qr-card">
Â  Â  Â  <button class="close-qr" onclick="closeQR()">&times;</button>
Â  Â  Â  <h3 style="margin-top:0; color:#8e44ad;">Doctor Scan</h3>
Â  Â  Â  <p style="font-size:0.8rem; color:#666;">Scan to see latest reading</p>
Â  Â  Â Â 
Â  Â  Â  <div id="qrcode"></div>
Â  Â  Â Â 
Â  Â  Â  <p style="font-size:0.7rem; color:#999; margin-bottom:0;">Generated by Bioscan ATM</p>
Â  Â  </div>
Â  </div>

Â  <div id="printHeader">
Â  Â  <div class="report-info">
Â  Â  Â  <strong>Patient ID:</strong> <span id="printUserId">--</span><br>
Â  Â  Â  <strong>Date:</strong> <span id="printDate">--</span><br>
Â  Â  Â  <strong>Source:</strong> Generated via Bioscan ATM System
Â  Â  </div>
Â  Â  <div class="report-title">
Â  Â  Â  <h1>Medical Report</h1>
Â  Â  Â  <p>BioScan Health Monitor</p>
Â  Â  </div>
Â  </div>

Â  <header class="screen-header">
Â  Â  <div class="header-title">
Â  Â  Â  <h2 id="pageTitle">Medical History</h2>
Â  Â  Â  <span id="userSubtitle">User: --</span>
Â  Â  </div>
Â  Â  <div class="actions">
Â  Â  Â  <button class="btn qr-btn" onclick="generateQR()" title="Generate QR Code">
Â  Â  Â  Â  <i class="fas fa-qrcode"></i> <span>QR Code</span>
Â  Â  Â  </button>

Â  Â  Â  <button class="btn whatsapp-btn" onclick="sendHistoryToWhatsApp()" title="Send to WhatsApp">
Â  Â  Â  Â  <i class="fab fa-whatsapp"></i>
Â  Â  Â  </button>
Â  Â  Â Â 
Â  Â  Â  <button class="btn print-btn" onclick="window.print()" title="Download PDF">
Â  Â  Â  Â  <i class="fas fa-print"></i>
Â  Â  Â  </button>
Â  Â  Â Â 
Â  Â  Â  <button class="btn back-btn" onclick="goBack()">
Â  Â  Â  Â  <i class="fas fa-arrow-left"></i>
Â  Â  Â  </button>
Â  Â  </div>
Â  </header>

Â  <div class="table-container">
Â  Â  <table id="historyTable">
Â  Â  Â  <thead>
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  <th id="th-date">Time / Date</th>
Â  Â  Â  Â  Â  <th id="th-temp">Temperature</th>
Â  Â  Â  Â  Â  <th id="th-pulse">Pulse (BPM)</th>
Â  Â  Â  Â  Â  <th id="th-spo2">Oxygen (%)</th>
Â  Â  Â  Â  Â  <th id="th-bp">Pressure</th>
Â  Â  Â  Â  </tr>
Â  Â  Â  </thead>
Â  Â  Â  <tbody id="tableBody">
Â  Â  Â  Â  </tbody>
Â  Â  </table>
Â  Â  <div id="loadingMsg" class="status-msg">Loading records...</div>
Â  Â  <div id="emptyMsg" class="status-msg" style="display:none;">No records found.</div>
Â  </div>

Â  <div id="printFooter">
Â  Â  Disclaimer: This report is generated automatically by sensors. Please consult a doctor for official diagnosis.
Â  </div>

Â  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

Â  <script>
Â  Â  // --- 1. FIREBASE CONFIGURATION (ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙØ§ØªÙŠØ­) ---
Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyAOwMQhsRM2PdD_FLjW_8Oi1WlFS3EO5pY",
Â  Â  Â  authDomain: "smart-a76a0.firebaseapp.com",
Â  Â  Â  databaseURL: "https://smart-a76a0-default-rtdb.firebaseio.com",
Â  Â  Â  projectId: "smart-a76a0",
Â  Â  Â  messagingSenderId: "343693501983",
Â  Â  Â  appId: "1:343693501983:web:10ea3fce9d990a2455172a"
Â  Â  };
Â  Â  // ØªÙ… Ø­Ø°Ù storageBucket Ùˆ measurementId Ù„Ø£Ù†Ù‡Ù…Ø§ ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØºÙŠØ± Ø¶Ø±ÙˆØ±ÙŠÙŠÙ† Ù„Ø¹Ù…Ù„ÙŠØ§Øª DB Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
Â  Â  // ÙˆØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù„ØªØ·Ø§Ø¨Ù‚ Ù…ÙØ§ØªÙŠØ­Ùƒ Ø§Ù„ØµØ­ÙŠØ­Ø©

Â  Â  firebase.initializeApp(firebaseConfig);
Â  Â  const db = firebase.database();

    // --- 2. ØªÙˆØ­ÙŠØ¯ Ù…ØµØ¯Ø± ID Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¥Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ù„Ù€ Patient ID) ---
Â  Â  const currentUserId = localStorage.getItem("selectedUserId"); 
    const lang = localStorage.getItem("language") || "en";
    
    // Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ (PatientData)
    const PATIENT_DATA_PATH = "PatientData"; 
    // Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø°ÙŠ ÙƒÙ†Ø§ Ù†Ø³ØªØ®Ø¯Ù…Ù‡ Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª (Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª ØªÙƒÙˆÙ† Ø¹Ø§Ø¯Ø©Ù‹ nested ØªØ­Øª Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ)
    const MEASUREMENTS_SUB_PATH = "Measurements"; 
    
    // ---------------------------------------------------------------
    // Ø¯Ø§Ù„Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØªØ­Øª Ù…ÙØªØ§Ø­ ÙØ±Ø¹ÙŠ)
    // ---------------------------------------------------------------
    function parseMeasurements(snapshot) {
        const dataList = [];
        // Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª Ø¥Ù…Ø§ ØªØ­Øª Ø§Ù„Ù…Ø³Ø§Ø± Ù…Ø¨Ø§Ø´Ø±Ø©ØŒ Ø£Ùˆ ØªØ­Øª Ù…Ø³Ø§Ø± ÙØ±Ø¹ÙŠ Ù…Ø«Ù„ 'Measurements'
        let measurementsRef = snapshot;
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø³Ø§Ø± ÙØ±Ø¹ÙŠ MeasurementsØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡
        if (snapshot.hasChild(MEASUREMENTS_SUB_PATH)) {
            measurementsRef = snapshot.child(MEASUREMENTS_SUB_PATH);
        }

        measurementsRef.forEach(child => {
            const data = child.val();
            // ÙŠØ¬Ø¨ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª Ù‡ÙŠ Ø­Ù‚ÙˆÙ„ Ù…ØªÙƒØ±Ø±Ø© ÙˆÙ„ÙŠØ³Øª Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
            if(data.temperature || data.bpm || data.pressure || data.spo2) {
                dataList.push(data);
            }
        });
        return dataList.reverse();
    }


Â  Â  // --- SETUP UI ---
Â  Â  if(currentUserId) {
Â  Â  Â  Â  const userText = (lang === "ar" ? "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: " : "User: ") + currentUserId;
Â  Â  Â  Â  document.getElementById("userSubtitle").innerText = userText;
Â  Â  Â  Â  document.getElementById("printUserId").innerText = currentUserId;
Â  Â  Â  Â  document.getElementById("printDate").innerText = new Date().toLocaleString();
Â  Â  } else {
Â  Â  Â  Â  // ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ IDØŒ Ù†Ø¹ÙˆØ¯ Ø¥Ù„Ù‰ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
Â  Â  Â  Â  window.location.href = "index.html";
Â  Â  }
    
    // ------------------------------------
    // Ø§Ù„ØªÙˆØ·ÙŠÙ† (Localization) (ØªÙ… ØªØ¨Ø³ÙŠØ· Ø§Ù„ÙƒÙˆØ¯ Ù„ÙŠÙƒÙˆÙ† ÙÙŠ Ù…ÙƒØ§Ù† ÙˆØ§Ø­Ø¯)
    // ------------------------------------
    if(lang === "ar") {
Â  Â  Â  Â  document.body.style.direction = "rtl";
Â  Â  Â  Â  document.getElementById("pageTitle").innerText = "Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø·Ø¨ÙŠ";
Â  Â  Â  Â  document.querySelector(".back-btn i").className = "fas fa-arrow-right";
Â  Â  Â  Â  document.querySelector(".qr-btn span").innerText = "ÙƒÙˆØ¯ Ø§Ù„Ø·Ø¨ÙŠØ¨";
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById("th-date").innerText = "Ø§Ù„ÙˆÙ‚Øª / Ø§Ù„ØªØ§Ø±ÙŠØ®";
Â  Â  Â  Â  document.getElementById("th-temp").innerText = "Ø§Ù„Ø­Ø±Ø§Ø±Ø©";
Â  Â  Â  Â  document.getElementById("th-pulse").innerText = "Ø§Ù„Ù†Ø¨Ø¶";
Â  Â  Â  Â  document.getElementById("th-bp").innerText = "Ø§Ù„Ø¶ØºØ·";
Â  Â  Â  Â  document.getElementById("th-spo2").innerText = "Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†";
Â  Â  Â  Â  document.getElementById("loadingMsg").innerText = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";
Â  Â  Â  Â  document.getElementById("emptyMsg").innerText = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø³Ø§Ø¨Ù‚Ø©.";
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.querySelector(".report-title h1").innerText = "ØªÙ‚Ø±ÙŠØ± Ø·Ø¨ÙŠ";
Â  Â  Â  Â  document.querySelector(".report-title p").innerText = "Ù†Ø¸Ø§Ù… Ø¨Ø§ÙŠÙˆ Ø³ÙƒØ§Ù†";
Â  Â  Â  Â  document.querySelector(".report-info").innerHTML = `
Â  Â  Â  Â  Â  Â  <strong>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ÙŠØ¶:</strong> ${currentUserId}<br>
Â  Â  Â  Â  Â  Â  <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date().toLocaleString()}<br>
Â  Â  Â  Â  Â  Â  <strong>Ø§Ù„Ù…ØµØ¯Ø±:</strong> ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Bioscan ATM
Â  Â  Â  Â  `;
Â  Â  Â  Â  document.getElementById("printFooter").innerText = "ØªÙ†ÙˆÙŠÙ‡: Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¢Ù„ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø³ØªØ´Ø¹Ø±Ø§Øª. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ Ù„Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø±Ø³Ù…ÙŠ.";
Â  Â  }

Â  Â  // --- FETCH DATA (ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø± Ø¥Ù„Ù‰ PatientData) ---
Â  Â  const records = [];

    // Ù†Ø³ØªØ®Ø¯Ù… currentUserId Ø§Ù„Ø°ÙŠ Ù‡Ùˆ Ø§Ù„Ø¢Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
Â  Â  const userRef = db.ref(`${PATIENT_DATA_PATH}/${currentUserId}`); 
    
Â  Â  userRef.on("value", (snapshot) => {
Â  Â  Â  Â  const tbody = document.getElementById("tableBody");
Â  Â  Â  Â  const loading = document.getElementById("loadingMsg");
Â  Â  Â  Â  const empty = document.getElementById("emptyMsg");
Â  Â  Â  Â Â 
Â  Â  Â  Â  tbody.innerHTML = "";
Â  Â  Â  Â  records.length = 0;

Â  Â  Â  Â  if (snapshot.exists()) {
Â  Â  Â  Â  Â  Â  loading.style.display = "none";
Â  Â  Â  Â  Â  Â  empty.style.display = "none";
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©
Â  Â  Â  Â  Â  Â  const dataList = parseMeasurements(snapshot);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  dataList.forEach(data => {
Â  Â  Â  Â  Â  Â  Â  Â  // ÙŠØªÙ… ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
Â  Â  Â  Â  Â  Â  Â  Â  if(data.temperature || data.bpm || data.pressure || data.spo2) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  records.push(data);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const row = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${data.createdAt || "N/A"}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${data.temperature || "--"}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${data.bpm || "--"}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${data.spo2 || "--"}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${data.pressure || "--"}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tbody.innerHTML += row;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  loading.style.display = "none";
Â  Â  Â  Â  Â  Â  empty.style.display = "block";
Â  Â  Â  Â  }
Â  Â  });

Â  Â  // --- QR CODE LOGIC ---
Â  Â  function generateQR() {
Â  Â  Â  Â  if(records.length === 0) {
Â  Â  Â  Â  Â  Â  showToast(lang === "ar" ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª!" : "No data available!", "error");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Get Latest Record
Â  Â  Â  Â  const latest = records[0];
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Prepare data string
Â  Â  Â  Â  const qrData = `Bioscan Report\nID: ${currentUserId}\nDate: ${latest.createdAt}\nTemp: ${latest.temperature}Â°C\nPulse: ${latest.bpm} bpm\nBP: ${latest.pressure}\nO2: ${latest.spo2}%`;

Â  Â  Â  Â  // Clear previous QR
Â  Â  Â  Â  document.getElementById("qrcode").innerHTML = "";

Â  Â  Â  Â  // Generate New QR
Â  Â  Â  Â  new QRCode(document.getElementById("qrcode"), {
Â  Â  Â  Â  Â  Â  text: qrData,
Â  Â  Â  Â  Â  Â  width: 180,
Â  Â  Â  Â  Â  Â  height: 180,
Â  Â  Â  Â  Â  Â  colorDark : "#000000",
Â  Â  Â  Â  Â  Â  colorLight : "#ffffff",
Â  Â  Â  Â  Â  Â  correctLevel : QRCode.CorrectLevel.H
Â  Â  Â  Â  });

Â  Â  Â  Â  // Show Modal
Â  Â  Â  Â  document.getElementById("qrModal").classList.add("active");
Â  Â  }

Â  Â  function closeQR() {
Â  Â  Â  Â  document.getElementById("qrModal").classList.remove("active");
Â  Â  }

Â  Â  // --- WHATSAPP LOGIC ---
Â  Â  function sendHistoryToWhatsApp() {
Â  Â  Â  Â  if (records.length === 0) {
Â  Â  Â  Â  Â  Â  showToast(lang === "ar" ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª!" : "No records!", "error");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  // Ù†Ø³ØªØ®Ø¯Ù… currentUserId Ù…Ø¨Ø§Ø´Ø±Ø© ÙƒØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
Â  Â  Â  Â  let phone = currentUserId; 
        
        // ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· Ù„Ø¶Ù…Ø§Ù† Ø£Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙŠØ¨Ø¯Ø£ Ø¨Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ (Ø§ÙØªØ±Ø§Ø¶Ø§Ù‹ Ù…ØµØ± +20)
        if (phone.startsWith('0')) {
            phone = '20' + phone.substring(1);
        }
        
Â  Â  Â  Â  let report = lang === "ar" ? `ğŸ“„ *ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø·Ø¨ÙŠ*%0A` : `ğŸ“„ *Medical History Report*%0A`;
Â  Â  Â  Â  report += `ğŸ‘¤ ID: ${currentUserId}%0AğŸ“… ${new Date().toLocaleDateString()}%0A-----------------%0A`;

Â  Â  Â  Â  const limit = Math.min(records.length, 5);Â 
Â  Â  Â  Â  for(let i = 0; i < limit; i++) {
Â  Â  Â  Â  Â  Â  const r = records[i];
Â  Â  Â  Â  Â  Â  report += `â° ${r.createdAt}%0AğŸŒ¡ï¸ ${r.temperature || '--'}Â°C | â¤ï¸ ${r.bpm || '--'} bpm%0AğŸ« ${r.spo2 || '--'}% | ğŸ©¸ ${r.pressure || '--'}%0A-----------------%0A`;
Â  Â  Â  Â  }
Â  Â  Â  Â  window.open(`https://wa.me/${phone}?text=${report}`, '_blank');
Â  Â  }

Â  Â  function goBack() { window.location.href = "measurements.html"; }

Â  Â  function showToast(message, type = "info") {
Â  Â  Â  const container = document.getElementById("toastContainer");
Â  Â  Â  const toast = document.createElement("div");
Â  Â  Â  toast.className = `toast`;
Â  Â  Â  toast.innerHTML = `<i class="fas fa-info-circle"></i> <span>${message}</span>`;
Â  Â  Â  container.appendChild(toast);
Â  Â  Â  setTimeout(() => { toast.remove(); }, 3000);
Â  Â  }
Â  </script>
</body>
</html>
