<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bioscan | Medical Report</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>

  <style>
    /* --- SCREEN STYLES --- */
    :root {
      --bg-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --text-color: #ffffff;
      --primary-color: #00d2ff;
      --delete-color: #ff416c;
    }

    body { font-family: 'Poppins', sans-serif; background: var(--bg-gradient); min-height: 100vh; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; color: var(--text-color); }
    ::-webkit-scrollbar { width: 10px; }
    ::-webkit-scrollbar-track { background: #1a1a1a; }
    ::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 10px; }

    .screen-header { width: 100%; max-width: 900px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--glass-bg); backdrop-filter: blur(10px); padding: 15px 25px; border-radius: 20px; border: 1px solid var(--glass-border); }
    .header-title h2 { margin: 0; font-size: 1.4rem; }
    .header-title span { font-size: 0.9rem; color: #ccc; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; }
    
    .btn { border: none; padding: 10px 15px; border-radius: 10px; cursor: pointer; font-size: 1rem; color: white; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
    .back-btn { background: rgba(255,255,255,0.1); } .back-btn:hover { background: var(--primary-color); }
    .print-btn { background: linear-gradient(45deg, #00d2ff, #3a7bd5); }
    .whatsapp-btn { background: linear-gradient(45deg, #25D366, #128C7E); }
    .qr-btn { background: linear-gradient(45deg, #8e44ad, #9b59b6); }
    .chart-btn { background: linear-gradient(45deg, #f39c12, #e67e22); }
    .btn:hover { transform: scale(1.05); }

    .table-container { width: 100%; max-width: 900px; background: rgba(0, 0, 0, 0.3); border-radius: 20px; overflow: hidden; border: 1px solid var(--glass-border); max-height: 75vh; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th, td { padding: 15px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
    th { background: rgba(0, 210, 255, 0.2); color: var(--primary-color); position: sticky; top: 0; backdrop-filter: blur(5px); }
    tr:hover { background: rgba(255,255,255,0.05); }
    .delete-btn { background: transparent; border: none; color: rgba(255, 255, 255, 0.6); cursor: pointer; font-size: 1.1rem; }
    .delete-btn:hover { color: var(--delete-color); transform: scale(1.2); }

    /* Modals */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 4000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
    .modal-overlay.active { display: flex; opacity: 1; }
    
    .chart-card { background: #fff; color: #333; padding: 20px; border-radius: 20px; width: 95%; max-width: 800px; transform: scale(0.8); transition: transform 0.3s; position: relative; }
    .modal-overlay.active .chart-card { transform: scale(1); }
    .chart-wrapper { height: 350px; width: 100%; }
    .ai-summary-box { margin-top: 15px; background: #f8f9fa; border-left: 5px solid #00d2ff; padding: 15px; border-radius: 8px; font-size: 0.9rem; }
    .close-qr { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #333; }

    /* Other Modals (QR & Delete) */
    .qr-card, .delete-card { background: white; color: black; padding: 30px; border-radius: 20px; text-align: center; width: 300px; transform: scale(0.8); transition: transform 0.3s; }
    .delete-card { background: #2c0b0e; color: white; }
    .modal-overlay.active .qr-card, .modal-overlay.active .delete-card { transform: scale(1); }

    @media print { .screen-header, .btn, .modal-overlay, .delete-btn { display: none !important; } body { background: white !important; color: black !important; } .table-container { background: white !important; border: none !important; max-height: none !important; } #printHeader, #printFooter { display: block !important; } }
    #printHeader, #printFooter { display: none; }
    
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 3000; }
    .toast { background: rgba(16, 30, 40, 0.95); color: white; padding: 15px 25px; border-radius: 12px; display: flex; align-items: center; gap: 12px; border-left: 5px solid var(--primary-color); animation: slideIn 0.4s ease, fadeOut 0.5s ease 3s forwards; }
    @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
  </style>
</head>
<body>

  <div class="toast-container" id="toastContainer"></div>

  <div id="qrModal" class="modal-overlay">
    <div class="qr-card">
      <button class="close-qr" onclick="closeModal('qrModal')">&times;</button>
      <h3 style="margin-top:0; color:#8e44ad;">Doctor Scan</h3>
      <div id="qrcode" style="display:flex; justify-content:center; margin:20px 0;"></div>
    </div>
  </div>

  <div id="chartModal" class="modal-overlay">
    <div class="chart-card">
      <button class="close-qr" onclick="closeModal('chartModal')">&times;</button>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 style="margin:0;">Analysis</h3>
        <select id="chartTypeSelector" onchange="updateChartType()" style="padding:5px;">
          <option value="bp">Cardio (BP & Pulse)</option>
          <option value="vital">Vitals (Temp & SpO2)</option>
        </select>
      </div>
      <div class="chart-wrapper"><canvas id="healthChart"></canvas></div>
      <div id="aiAnalysisText" class="ai-summary-box">Loading AI Analysis...</div>
    </div>
  </div>

  <div id="deleteModal" class="modal-overlay">
    <div class="delete-card">
      <h3>Delete Record?</h3>
      <div style="margin-top:20px;">
        <button style="padding:10px 20px;" onclick="closeModal('deleteModal')">Cancel</button>
        <button style="padding:10px 20px; background:#ff416c; color:white; border:none;" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <div id="printHeader">
    <div style="border-bottom:2px solid #00d2ff; padding-bottom:10px; margin-bottom:20px;">
      <h1>Medical Report</h1>
      <p>ID: <span id="printUserId">--</span> | Date: <span id="printDate">--</span></p>
    </div>
  </div>

  <header class="screen-header">
    <div class="header-title">
      <h2 id="pageTitle">History</h2>
      <span id="userSubtitle">User: --</span>
    </div>
    <div class="actions">
      <button class="btn chart-btn" onclick="openChartModal()"><i class="fas fa-chart-area"></i> <span>Analysis</span></button>
      <button class="btn qr-btn" onclick="generateQR()"><i class="fas fa-qrcode"></i> <span>QR</span></button>
      <button class="btn whatsapp-btn" onclick="sendHistoryToWhatsApp()"><i class="fab fa-whatsapp"></i></button>
      <button class="btn print-btn" onclick="window.print()"><i class="fas fa-print"></i></button>
      <button class="btn back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
    </div>
  </header>

  <div class="table-container">
    <table id="historyTable">
      <thead>
        <tr>
          <th id="th-date">Date</th>
          <th id="th-temp">Temp</th>
          <th id="th-pulse">Pulse</th>
          <th id="th-spo2">SpO2</th>
          <th id="th-bp">BP</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
    <div id="loadingMsg" style="text-align:center; padding:20px; color:#aaa;">Loading...</div>
  </div>

  <div id="printFooter">Generated by Bioscan ATM System</div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAOwMQhsRM2PdD_FLjW_8Oi1WlFS3EO5pY",
      authDomain: "smart-a76a0.firebaseapp.com",
      databaseURL: "https://smart-a76a0-default-rtdb.firebaseio.com",
      projectId: "smart-a76a0",
      messagingSenderId: "343693501983",
      appId: "1:343693501983:web:10ea3fce9d990a2455172a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    auth.signInAnonymously().catch(console.error);

    const currentUserId = localStorage.getItem("selectedUserId");
    const lang = localStorage.getItem("language") || "en";
    const PATIENT_DATA_PATH = "PatientData"; 

    if(currentUserId) {
        document.getElementById("userSubtitle").innerText = (lang==="ar"?"Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ":"User: ") + currentUserId;
        document.getElementById("printUserId").innerText = currentUserId;
        document.getElementById("printDate").innerText = new Date().toLocaleDateString();
    } else window.location.href = "index.html";

    if(lang === "ar") {
        document.body.style.direction = "rtl";
        document.getElementById("pageTitle").innerText = "Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø·Ø¨ÙŠ";
        document.querySelector(".chart-btn span").innerText = "ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†ÙŠ";
        document.getElementById("th-date").innerText = "Ø§Ù„ØªØ§Ø±ÙŠØ®";
        document.getElementById("th-temp").innerText = "Ø§Ù„Ø­Ø±Ø§Ø±Ø©";
        document.getElementById("th-pulse").innerText = "Ø§Ù„Ù†Ø¨Ø¶";
        document.getElementById("th-bp").innerText = "Ø§Ù„Ø¶ØºØ·";
        document.getElementById("th-spo2").innerText = "Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†";
        document.getElementById("loadingMsg").innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
    }

    const records = [];
    const historyRef = db.ref(`${PATIENT_DATA_PATH}/${currentUserId}/History`);
    
    // --- MAIN FIX FOR PARTIAL DATA ---
    historyRef.on("value", (snapshot) => {
        const tbody = document.getElementById("tableBody");
        document.getElementById("loadingMsg").style.display = "none";
        tbody.innerHTML = "";
        records.length = 0;
        
        if (snapshot.exists()) {
            const raw = [];
            snapshot.forEach(c => raw.push({ key: c.key, ...c.val() }));
            // Sort Chronological
            raw.sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt));
            
            raw.forEach(item => {
                let d = item.createdAt || "N/A";
                // FIX: Use '--' if property is undefined
                let t = item.temperature || "--";
                let b = item.bpm || "--";
                let p = item.pressure || "--";
                let s = item.spo2 || "--";

                // FIX: Check if AT LEAST ONE measurement exists
                if(t !== "--" || b !== "--" || p !== "--" || s !== "--") {
                    records.push({ date: d, temp: t, bpm: b, bp: p, spo2: s, key: item.key });
                }
            });

            // Display newest first
            [...records].reverse().forEach(r => {
                tbody.innerHTML += `
                    <tr>
                        <td style="font-size:0.8rem">${r.date}</td>
                        <td>${r.temp}</td><td>${r.bpm}</td><td>${r.spo2}</td><td>${r.bp}</td>
                        <td><button class="delete-btn" onclick="askToDelete('${r.key}')"><i class="fas fa-trash-alt"></i></button></td>
                    </tr>`;
            });
        } else {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">${lang==="ar"?"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª":"No Data"}</td></tr>`;
        }
    });

    // --- CHART LOGIC (Handle Missing Data) ---
    let myChart = null;
    function openChartModal() {
        if(records.length < 1) return alert(lang==="ar"?"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª":"No Data");
        document.getElementById("chartModal").classList.add("active");
        updateChartType();
    }

    function updateChartType() {
        const type = document.getElementById("chartTypeSelector").value;
        const ctx = document.getElementById('healthChart').getContext('2d');
        if(myChart) myChart.destroy();

        // Use records (chronological order is stored in array)
        const labels = records.map(r => r.date.split(',')[0]); // Date only
        let datasets = [];

        // Helper to parse or return null (so chart skips point)
        const getVal = (v) => (v === "--" ? null : parseFloat(v));

        if(type === 'bp') {
            const sys = records.map(r => r.bp !== "--" ? parseInt(r.bp.split('/')[0]) : null);
            const dia = records.map(r => r.bp !== "--" ? parseInt(r.bp.split('/')[1]) : null);
            const pulse = records.map(r => getVal(r.bpm));

            datasets = [
                { label: 'Systolic', data: sys, borderColor: '#e74c3c', spanGaps: true },
                { label: 'Diastolic', data: dia, borderColor: '#3498db', spanGaps: true },
                { label: 'Pulse', data: pulse, borderColor: '#2ecc71', borderDash:[5,5], spanGaps: true }
            ];
            generateReport('bp', sys, dia, pulse);
        } else {
            const temp = records.map(r => getVal(r.temp));
            const spo2 = records.map(r => getVal(r.spo2));

            datasets = [
                { label: 'Temp', data: temp, borderColor: '#f39c12', yAxisID: 'y', spanGaps: true },
                { label: 'SpO2', data: spo2, borderColor: '#9b59b6', yAxisID: 'y1', spanGaps: true }
            ];
            generateReport('vital', temp, spo2);
        }

        myChart = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: type === 'vital' ? {
                    y: { position: 'left', title: {display:true, text:'Temp'} },
                    y1: { position: 'right', title: {display:true, text:'SpO2'} }
                } : {}
            }
        });
    }

    function generateReport(type, d1, d2, d3) {
        // Simple logic: check latest valid value
        let msg = lang==="ar" ? "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " : "Analysis: ";
        // Filter out nulls
        const valid1 = d1.filter(v => v !== null);
        if(valid1.length > 0) {
            const latest = valid1[valid1.length-1];
            if(type==='bp' && latest > 140) msg += lang==="ar"?"âš ï¸ Ø¶ØºØ·Ùƒ Ù…Ø±ØªÙØ¹ Ù…Ø¤Ø®Ø±Ø§Ù‹.":"âš ï¸ Recent BP is High.";
            else if(type==='vital' && latest > 37.5) msg += lang==="ar"?"ðŸ”¥ Ø­Ø±Ø§Ø±ØªÙƒ Ù…Ø±ØªÙØ¹Ø©.":"ðŸ”¥ High Temp detected.";
            else msg += lang==="ar"?"âœ… Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ù…Ø³ØªÙ‚Ø±Ø©.":"âœ… Indicators stable.";
        } else {
            msg += lang==="ar"?"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø§Øª ÙƒØ§ÙÙŠØ©.":"Insufficient data.";
        }
        document.getElementById("aiAnalysisText").innerText = msg;
    }

    // --- UTILS ---
    function closeModal(id) { document.getElementById(id).classList.remove("active"); }
    
    let delKey = null;
    function askToDelete(k) { delKey = k; document.getElementById("deleteModal").classList.add("active"); }
    function confirmDelete() { 
        if(delKey) db.ref(`${PATIENT_DATA_PATH}/${currentUserId}/History/${delKey}`).remove().then(()=>closeModal("deleteModal"));
    }

    function generateQR() {
        if(records.length===0) return;
        document.getElementById("qrModal").classList.add("active");
        document.getElementById("qrcode").innerHTML = "";
        const r = records[records.length-1];
        new QRCode(document.getElementById("qrcode"), { text: `ID:${currentUserId}\nLast:${r.date}`, width:150, height:150 });
    }

    function sendHistoryToWhatsApp() {
        if(records.length===0) return;
        let ph = currentUserId.replace(/\D/g,'');
        if(ph.startsWith('01')) ph = '20'+ph.substring(1);
        let txt = lang==="ar" ? "Ø³Ø¬Ù„ÙŠ Ø§Ù„Ø·Ø¨ÙŠ:\n" : "My History:\n";
        [...records].reverse().slice(0,5).forEach(r => txt += `${r.date.split(',')[0]}: T${r.temp} BP${r.bp}\n`);
        window.open(`https://wa.me/${ph}?text=${encodeURIComponent(txt)}`);
    }

    function goBack() { window.location.href = "measurements.html"; }
  </script>
</body>
</html>
