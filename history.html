<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bioscan | Medical Report</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* --- SCREEN STYLES --- */
    :root {
      --bg-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --text-color: #ffffff;
      --primary-color: #00d2ff;
      --whatsapp-color: #25D366;
      --qr-color: #8e44ad;
      --chart-color: #f39c12; /* New Color for Analysis */
      --delete-color: #ff416c;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-gradient);
      min-height: 100vh;
      margin: 0; padding: 20px;
      display: flex; flex-direction: column; align-items: center;
      color: var(--text-color);
    }

    ::-webkit-scrollbar { width: 10px; }
    ::-webkit-scrollbar-track { background: #1a1a1a; }
    ::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 10px; }

    .screen-header {
      width: 100%; max-width: 900px;
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px;
      background: var(--glass-bg); backdrop-filter: blur(10px);
      padding: 15px 25px; border-radius: 20px; border: 1px solid var(--glass-border);
    }

    .header-title h2 { margin: 0; font-size: 1.4rem; }
    .header-title span { font-size: 0.9rem; color: #ccc; }

    .actions { display: flex; gap: 10px; flex-wrap: wrap; }

    .btn {
      border: none; padding: 10px 15px; border-radius: 10px; cursor: pointer;
      font-size: 1rem; color: white; transition: 0.3s; display: flex; align-items: center; gap: 8px;
    }
    .back-btn { background: rgba(255,255,255,0.1); }
    .back-btn:hover { background: var(--primary-color); }

    .print-btn { background: linear-gradient(45deg, #00d2ff, #3a7bd5); }
    .print-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(0, 210, 255, 0.5); }

    .whatsapp-btn { background: linear-gradient(45deg, #25D366, #128C7E); }
    .whatsapp-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(37, 211, 102, 0.5); }

    .qr-btn { background: linear-gradient(45deg, #8e44ad, #9b59b6); }
    .qr-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(142, 68, 173, 0.5); }

    /* New Analysis Button Style */
    .chart-btn { background: linear-gradient(45deg, #f39c12, #e67e22); }
    .chart-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(243, 156, 18, 0.5); }

    .table-container {
      width: 100%; max-width: 900px;
      background: rgba(0, 0, 0, 0.3); border-radius: 20px;
      overflow: hidden; border: 1px solid var(--glass-border);
      max-height: 75vh; overflow-y: auto;
    }

    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th, td { padding: 15px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
    th { background: rgba(0, 210, 255, 0.2); color: var(--primary-color); position: sticky; top: 0; backdrop-filter: blur(5px); }
    tr:hover { background: rgba(255,255,255,0.05); }

    .delete-btn {
      background: transparent; border: none; color: rgba(255, 255, 255, 0.6);
      cursor: pointer; font-size: 1.1rem; transition: 0.3s; padding: 5px;
    }
    .delete-btn:hover { color: var(--delete-color); transform: scale(1.2); }

    .status-msg { margin-top: 50px; font-size: 1.2rem; color: #aaa; text-align: center; }

    #printHeader, #printFooter { display: none; }

    /* --- COMMON MODAL STYLES --- */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
      z-index: 4000; display: none; justify-content: center; align-items: center;
      opacity: 0; transition: opacity 0.3s;
    }
    .modal-overlay.active { display: flex; opacity: 1; }
    
    /* QR Card */
    .qr-card {
      background: white; color: black; padding: 30px; border-radius: 20px;
      text-align: center; width: 300px; position: relative;
      box-shadow: 0 0 30px rgba(142, 68, 173, 0.5); transform: scale(0.8); transition: transform 0.3s;
    }
    .modal-overlay.active .qr-card { transform: scale(1); }
    #qrcode { display: flex; justify-content: center; margin: 20px 0; min-height: 150px; }
    .close-qr { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #333; }
    .close-qr:hover { color: red; }

    /* Chart Modal Card (New) */
    .chart-card {
      background: white; color: #333; padding: 20px; border-radius: 20px;
      width: 95%; max-width: 800px; position: relative;
      box-shadow: 0 0 40px rgba(243, 156, 18, 0.3); transform: scale(0.8); transition: transform 0.3s;
    }
    .modal-overlay.active .chart-card { transform: scale(1); }
    .chart-wrapper { height: 400px; width: 100%; }

    /* Delete Modal */
    .delete-card {
      background: linear-gradient(145deg, #2c0b0e, #1a0506);
      border: 1px solid var(--delete-color);
      padding: 30px; border-radius: 25px; text-align: center;
      width: 90%; max-width: 400px;
      box-shadow: 0 0 40px rgba(255, 65, 108, 0.2);
      transform: scale(0.8); transition: transform 0.3s;
    }
    .modal-overlay.active .delete-card { transform: scale(1); }
    .del-icon { font-size: 3rem; color: var(--delete-color); margin-bottom: 20px; animation: shake 0.5s; }
    @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } 100% { transform: translateX(0); } }
    .del-title { color: #fff; margin: 0 0 10px 0; font-size: 1.5rem; }
    .del-text { color: #ccc; margin-bottom: 25px; font-size: 0.9rem; }
    .del-actions { display: flex; justify-content: center; gap: 15px; }
    .btn-cancel, .btn-confirm { padding: 10px 25px; border-radius: 50px; border: none; font-size: 1rem; cursor: pointer; font-family: 'Poppins', sans-serif; transition: 0.3s; }
    .btn-cancel { background: rgba(255,255,255,0.1); color: #fff; }
    .btn-cancel:hover { background: rgba(255,255,255,0.2); }
    .btn-confirm { background: linear-gradient(45deg, #ff416c, #ff4b2b); color: white; font-weight: bold; box-shadow: 0 4px 15px rgba(255, 65, 108, 0.4); }
    .btn-confirm:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(255, 65, 108, 0.6); }

    /* Print Styles */
    @media print {
      @page { size: A4; margin: 10mm; }
      body { background: white !important; color: #333 !important; display: block !important; padding: 0 !important; font-family: 'Helvetica', sans-serif !important; }
      .screen-header, .back-btn, .whatsapp-btn, .print-btn, .qr-btn, .chart-btn, ::-webkit-scrollbar, .toast-container, .modal-overlay, .delete-btn, th:last-child, td:last-child { display: none !important; }
      #printHeader { display: flex !important; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 2px solid #00d2ff; }
      .report-info { text-align: left; font-size: 14px; line-height: 1.8; }
      .report-title { text-align: right; }
      .report-title h1 { font-size: 28px; color: #333; margin: 0; font-weight: 700; text-transform: uppercase; }
      .table-container { background: white !important; border: none !important; max-height: none !important; overflow: visible !important; box-shadow: none !important; width: 100% !important; margin-top: 20px; }
      table { width: 100%; border-collapse: collapse; }
      thead th { background-color: #00ced1 !important; color: white !important; padding: 12px 15px; text-align: left; font-size: 13px; text-transform: uppercase; border: none !important; -webkit-print-color-adjust: exact; }
      tbody td { padding: 12px 15px; border-bottom: 1px solid #eee !important; color: #444 !important; font-size: 13px; text-align: left; }
      tbody tr:nth-child(even) { background-color: #f9f9f9 !important; -webkit-print-color-adjust: exact; }
      #printFooter { display: block !important; position: fixed; bottom: 20px; left: 0; width: 100%; text-align: left; font-size: 11px; color: #999; border-top: 1px solid #ddd; padding-top: 10px; }
    }

    /* Toast */
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 3000; }
    .toast { background: rgba(16, 30, 40, 0.95); color: white; padding: 15px 25px; border-radius: 12px; display: flex; align-items: center; gap: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); border-left: 5px solid var(--primary-color); animation: slideIn 0.4s ease, fadeOut 0.5s ease 3s forwards; }
    @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

  </style>
</head>
<body>

  <div class="toast-container" id="toastContainer"></div>

  <div id="qrModal" class="modal-overlay">
    <div class="qr-card">
      <button class="close-qr" onclick="closeModal('qrModal')">&times;</button>
      <h3 style="margin-top:0; color:#8e44ad;">Doctor Scan</h3>
      <p style="font-size:0.8rem; color:#666;">Scan to see latest reading</p>
      <div id="qrcode"></div>
      <p style="font-size:0.7rem; color:#999; margin-bottom:0;">Generated by Bioscan ATM</p>
    </div>
  </div>

  <div id="chartModal" class="modal-overlay">
    <div class="chart-card">
      <button class="close-qr" onclick="closeModal('chartModal')">&times;</button>
      <h3 id="chartTitle" style="margin-top:0; color:#e67e22; text-align: center;">Health Trends Analysis</h3>
      <div class="chart-wrapper">
        <canvas id="healthChart"></canvas>
      </div>
    </div>
  </div>

  <div id="deleteModal" class="modal-overlay">
    <div class="delete-card">
      <i class="fas fa-trash-alt del-icon"></i>
      <h3 id="delTitle" class="del-title">Delete Record?</h3>
      <p id="delText" class="del-text">This action cannot be undone.</p>
      <div class="del-actions">
        <button class="btn-cancel" onclick="closeModal('deleteModal')">Cancel</button>
        <button class="btn-confirm" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <div id="printHeader">
    <div class="report-info">
      <strong>Patient ID:</strong> <span id="printUserId">--</span><br>
      <strong>Date:</strong> <span id="printDate">--</span><br>
      <strong>Source:</strong> Generated via Bioscan ATM System
    </div>
    <div class="report-title">
      <h1>Medical Report</h1>
      <p>BioScan Health Monitor</p>
    </div>
  </div>

  <header class="screen-header">
    <div class="header-title">
      <h2 id="pageTitle">Medical History</h2>
      <span id="userSubtitle">User: --</span>
    </div>
    <div class="actions">
      <button class="btn chart-btn" onclick="showChart()" title="View Analysis Chart">
        <i class="fas fa-chart-line"></i> <span>Analysis</span>
      </button>
      
      <button class="btn qr-btn" onclick="generateQR()" title="Generate QR Code">
        <i class="fas fa-qrcode"></i> <span>QR Code</span>
      </button>
      <button class="btn whatsapp-btn" onclick="sendHistoryToWhatsApp()" title="Send to WhatsApp">
        <i class="fab fa-whatsapp"></i>
      </button>
      <button class="btn print-btn" onclick="window.print()" title="Download PDF">
        <i class="fas fa-print"></i>
      </button>
      <button class="btn back-btn" onclick="goBack()">
        <i class="fas fa-arrow-left"></i>
      </button>
    </div>
  </header>

  <div class="table-container">
    <table id="historyTable">
      <thead>
        <tr>
          <th id="th-date">Time / Date</th>
          <th id="th-temp">Temperature</th>
          <th id="th-pulse">Pulse (BPM)</th>
          <th id="th-spo2">Oxygen (%)</th>
          <th id="th-bp">Pressure</th>
          <th id="th-action" style="width: 50px;"></th>
        </tr>
      </thead>
      <tbody id="tableBody">
        </tbody>
    </table>
    <div id="loadingMsg" class="status-msg">Loading records...</div>
    <div id="emptyMsg" class="status-msg" style="display:none;">No records found.</div>
  </div>

  <div id="printFooter">
    Disclaimer: This report is generated automatically by sensors. Please consult a doctor for official diagnosis.
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAOwMQhsRM2PdD_FLjW_8Oi1WlFS3EO5pY",
      authDomain: "smart-a76a0.firebaseapp.com",
      databaseURL: "https://smart-a76a0-default-rtdb.firebaseio.com",
      projectId: "smart-a76a0",
      messagingSenderId: "343693501983",
      appId: "1:343693501983:web:10ea3fce9d990a2455172a"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    auth.signInAnonymously().catch((error) => {
        console.error("Auth Error:", error);
    });

    const currentUserId = localStorage.getItem("selectedUserId");
    const lang = localStorage.getItem("language") || "en";
    const PATIENT_DATA_PATH = "PatientData"; 

    if(currentUserId) {
        const userText = (lang === "ar" ? "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: " : "User: ") + currentUserId;
        document.getElementById("userSubtitle").innerText = userText;
        document.getElementById("printUserId").innerText = currentUserId;
        document.getElementById("printDate").innerText = new Date().toLocaleString();
    } else {
        window.location.href = "index.html";
    }

    if(lang === "ar") {
        document.body.style.direction = "rtl";
        document.getElementById("pageTitle").innerText = "Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø·Ø¨ÙŠ";
        document.querySelector(".back-btn i").className = "fas fa-arrow-right";
        document.querySelector(".qr-btn span").innerText = "ÙƒÙˆØ¯ Ø§Ù„Ø·Ø¨ÙŠØ¨";
        document.querySelector(".chart-btn span").innerText = "ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†ÙŠ";
        document.getElementById("chartTitle").innerText = "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµØ­ÙŠ";
        
        document.getElementById("th-date").innerText = "Ø§Ù„ÙˆÙ‚Øª / Ø§Ù„ØªØ§Ø±ÙŠØ®";
        document.getElementById("th-temp").innerText = "Ø§Ù„Ø­Ø±Ø§Ø±Ø©";
        document.getElementById("th-pulse").innerText = "Ø§Ù„Ù†Ø¨Ø¶";
        document.getElementById("th-bp").innerText = "Ø§Ù„Ø¶ØºØ·";
        document.getElementById("th-spo2").innerText = "Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†";
        document.getElementById("th-action").innerHTML = '<i class="fas fa-trash-alt"></i>';
        
        document.getElementById("loadingMsg").innerText = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";
        document.getElementById("emptyMsg").innerText = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø³Ø§Ø¨Ù‚Ø©.";
        
        document.querySelector(".report-title h1").innerText = "ØªÙ‚Ø±ÙŠØ± Ø·Ø¨ÙŠ";
        document.querySelector(".report-title p").innerText = "Ù†Ø¸Ø§Ù… Ø¨Ø§ÙŠÙˆ Ø³ÙƒØ§Ù†";
        document.querySelector(".report-info").innerHTML = `<strong>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ÙŠØ¶:</strong> ${currentUserId}<br><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date().toLocaleString()}<br><strong>Ø§Ù„Ù…ØµØ¯Ø±:</strong> ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Bioscan ATM`;
        document.getElementById("printFooter").innerText = "ØªÙ†ÙˆÙŠÙ‡: Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¢Ù„ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø³ØªØ´Ø¹Ø±Ø§Øª. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ Ù„Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø±Ø³Ù…ÙŠ.";
        
        document.getElementById("delTitle").innerText = "Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ØŸ";
        document.getElementById("delText").innerText = "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.";
        document.querySelector(".btn-confirm").innerText = "Ø­Ø°Ù";
        document.querySelector(".btn-cancel").innerText = "Ø¥Ù„ØºØ§Ø¡";
    } else {
        document.getElementById("th-action").innerHTML = '<i class="fas fa-trash-alt"></i>';
    }

    function extractSensorValues(sensorString) {
        const values = {};
        if (sensorString && sensorString !== "No measurement recorded yet") {
            sensorString.split(',').forEach(item => {
                const parts = item.trim().split('=');
                if (parts.length === 2) {
                    const key = parts[0].trim().toLowerCase();
                    const value = parts[1].trim();
                    if (key.includes('temp')) values.temp = value;
                    else if (key === 'hr' || key.includes('pulse')) values.bpm = value;
                    else if (key === 'bp' || key.includes('pressure')) values.pressure = value;
                    else if (key.includes('o2') || key.includes('spo2')) values.spo2 = value;
                }
            });
        }
        return values;
    }

    const records = [];
    const historyRef = db.ref(`${PATIENT_DATA_PATH}/${currentUserId}/History`);
    
    historyRef.on("value", (snapshot) => {
        const tbody = document.getElementById("tableBody");
        const loading = document.getElementById("loadingMsg");
        const empty = document.getElementById("emptyMsg");
        
        tbody.innerHTML = "";
        records.length = 0;
        const rawList = [];

        if (snapshot.exists()) {
            loading.style.display = "none";
            empty.style.display = "none";
            
            snapshot.forEach(child => { 
                rawList.push({ key: child.key, ...child.val() }); 
            });
            // We want newest first in TABLE, but oldest first in CHART
            // So we process rawList as chronological (if it comes sorted) then reverse for table
            // Usually firebase returns chronological by key.
            
            // Let's process the list for display (Reversed)
            const displayList = [...rawList].reverse();

            displayList.forEach(item => {
                let temp = item.temperature;
                let bpm = item.bpm;
                let pressure = item.pressure;
                let spo2 = item.spo2;
                let date = item.createdAt || item.Timestamp;

                if (item.SensorData) {
                    const parsed = extractSensorValues(item.SensorData);
                    if(parsed.temp) temp = parsed.temp;
                    if(parsed.bpm) bpm = parsed.bpm;
                    if(parsed.pressure) pressure = parsed.pressure;
                    if(parsed.spo2) spo2 = parsed.spo2;
                }

                // Add to records array for logic
                // Ensure we only add valid records
                if(temp && bpm && pressure && spo2) {
                    // Push to global records (chronological for charts, so push to beginning since we iterate reverse)
                    records.unshift({ temperature: temp, bpm: bpm, pressure: pressure, spo2: spo2, createdAt: date, key: item.key });
                    
                    const row = `
                        <tr>
                            <td>${date}</td>
                            <td>${temp}</td>
                            <td>${bpm}</td>
                            <td>${spo2}</td>
                            <td>${pressure}</td>
                            <td class="action-cell">
                                <button class="delete-btn" onclick="askToDelete('${item.key}')" title="Delete">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                }
            });
            
            if(records.length === 0) empty.style.display = "block";
        } else {
            loading.style.display = "none";
            empty.style.display = "block";
        }
    });

    // --- CHART LOGIC (NEW) ---
    let myChart = null;

    function showChart() {
        if(records.length < 2) {
            showToast(lang === "ar" ? "ÙŠØ¬Ø¨ ØªÙˆÙØ± Ø³Ø¬Ù„ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„ØªØ­Ù„ÙŠÙ„" : "Need at least 2 records for analysis", "error");
            return;
        }

        const modal = document.getElementById("chartModal");
        modal.style.display = "flex";
        setTimeout(() => modal.classList.add("active"), 10);

        // Prepare Data
        // Sort records by date just in case (Oldest first for chart)
        const chartData = [...records].sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

        const labels = chartData.map(r => r.createdAt.split(',')[0]); // Just date part
        const sysData = [];
        const diaData = [];
        const pulseData = [];

        chartData.forEach(r => {
            // Split BP "120/80" -> 120, 80
            if(r.pressure.includes('/')) {
                const parts = r.pressure.split('/');
                sysData.push(parseInt(parts[0]));
                diaData.push(parseInt(parts[1]));
            } else {
                sysData.push(parseInt(r.pressure) || 0);
                diaData.push(0);
            }
            pulseData.push(parseInt(r.bpm));
        });

        const ctx = document.getElementById('healthChart').getContext('2d');
        
        // Destroy previous chart if exists to avoid overlay
        if(myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: lang==="ar" ? 'Ø§Ù„Ø¶ØºØ· Ø§Ù„Ø§Ù†Ù‚Ø¨Ø§Ø¶ÙŠ (Ø¹Ø§Ù„ÙŠ)' : 'Systolic BP (High)',
                        data: sysData,
                        borderColor: '#e74c3c', // Red
                        backgroundColor: 'rgba(231, 76, 60, 0.2)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: lang==="ar" ? 'Ø§Ù„Ø¶ØºØ· Ø§Ù„Ø§Ù†Ø¨Ø³Ø§Ø·ÙŠ (Ù…Ù†Ø®ÙØ¶)' : 'Diastolic BP (Low)',
                        data: diaData,
                        borderColor: '#3498db', // Blue
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: lang==="ar" ? 'Ù†Ø¨Ø¶ Ø§Ù„Ù‚Ù„Ø¨' : 'Heart Rate',
                        data: pulseData,
                        borderColor: '#2ecc71', // Green
                        borderDash: [5, 5], // Dashed line
                        borderWidth: 2,
                        tension: 0.3,
                        pointStyle: 'rectRot'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        title: { display: true, text: 'Value' }
                    }
                },
                plugins: {
                    legend: { position: 'top' }
                }
            }
        });
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.classList.remove("active");
        setTimeout(() => { modal.style.display = "none"; }, 300);
        
        // If closing QR, clear it
        if(modalId === 'qrModal') document.getElementById("qrcode").innerHTML = "";
    }

    // --- QR & Delete Logic (Existing) ---
    let recordToDelete = null;
    function askToDelete(key) {
        recordToDelete = key;
        const modal = document.getElementById("deleteModal");
        modal.style.display = "flex";
        setTimeout(() => modal.classList.add("active"), 10);
    }
    function confirmDelete() {
        if(recordToDelete) {
            db.ref(`${PATIENT_DATA_PATH}/${currentUserId}/History/${recordToDelete}`).remove()
            .then(() => showToast(lang === "ar" ? "ØªÙ… Ø§Ù„Ø­Ø°Ù" : "Deleted", "success"))
            .catch(() => showToast("Error", "error"));
        }
        closeModal('deleteModal');
    }

    function generateQR() {
        if(records.length === 0) return showToast(lang === "ar" ? "Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª!" : "No data!", "error");
        const modal = document.getElementById("qrModal");
        modal.style.display = "flex"; 
        void modal.offsetWidth; 
        modal.classList.add("active");
        const latest = records[records.length - 1]; // Latest is last in this array because we unshifted
        
        // Actually, records array has items unshifted (newest at index 0 because of reverse logic in loop?)
        // Let's check table loop: rawList (Old->New), Reversed (New->Old).
        // records.unshift puts newest at index 0 if we iterate reversed array. 
        // Wait, logic check:
        // displayList is Raw reversed (Newest first).
        // records.unshift(item) puts Newest item at BEGINNING of records. So records is Newest -> Oldest.
        // So records[0] is newest.
        
        const qrData = `ID:${currentUserId}\nD:${latest.createdAt}\nT:${latest.temperature}\nHR:${latest.bpm}\nBP:${latest.pressure}`;
        document.getElementById("qrcode").innerHTML = "";
        new QRCode(document.getElementById("qrcode"), {
            text: qrData, width: 150, height: 150
        });
    }

    function sendHistoryToWhatsApp() {
        if (records.length === 0) return showToast(lang === "ar" ? "Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª!" : "No data!", "error");
        let phone = currentUserId;
        if (phone.startsWith('0')) phone = '20' + phone.substring(1);
        let report = lang === "ar" ? `ğŸ“„ *ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø·Ø¨ÙŠ*\n` : `ğŸ“„ *Medical Report*\n`;
        // Send last 5 records (records[0] is newest)
        for(let i = 0; i < Math.min(records.length, 5); i++) {
            const r = records[i];
            report += `ğŸ“… ${r.createdAt}\nğŸŒ¡ï¸ ${r.temperature} | â¤ï¸ ${r.bpm}\nğŸ©¸ ${r.pressure} | ğŸ« ${r.spo2}\n-----------------\n`;
        }
        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(report)}`, '_blank');
    }

    function goBack() { window.location.href = "measurements.html"; }
    function showToast(message, type = "info") {
        const container = document.getElementById("toastContainer");
        const toast = document.createElement("div");
        toast.className = `toast`;
        toast.innerHTML = `<i class="fas fa-info-circle"></i> <span>${message}</span>`;
        container.appendChild(toast);
        setTimeout(() => { toast.remove(); }, 3000);
    }
  </script>
</body>
</html>
