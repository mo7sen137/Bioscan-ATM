<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bioscan | Vision Test</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
  :root {
    --primary-color: #00d2ff;
    --success-color: #00ff88;
    --danger-color: #ff416c;
    --bg-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
    --glass-bg: rgba(255, 255, 255, 0.1);
    --glass-border: rgba(255, 255, 255, 0.2);
    --text-color: #ffffff;
  }

  body {
    font-family: 'Poppins', sans-serif;
    background: var(--bg-gradient);
    background-size: 400% 400%;
    animation: gradientBG 15s ease infinite;
    min-height: 100vh;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    color: var(--text-color);
    overflow-x: hidden;
  }

  @keyframes gradientBG {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  /* Header */
  header {
    width: 100%;
    background: rgba(15, 32, 39, 0.9);
    backdrop-filter: blur(10px);
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: fixed;
    top: 0;
    z-index: 100;
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
    box-sizing: border-box;
  }

  header h1 {
    font-size: 1.2rem;
    margin: 0;
    font-weight: 600;
    letter-spacing: 1px;
    color: var(--primary-color);
    text-transform: uppercase;
  }

  .exit-btn {
    background: rgba(255, 65, 108, 0.2);
    border: 1px solid var(--danger-color);
    color: var(--danger-color);
    padding: 8px 16px;
    border-radius: 50px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: 0.3s;
    font-family: 'Poppins', sans-serif;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .exit-btn:hover {
    background: var(--danger-color);
    color: white;
    box-shadow: 0 0 15px rgba(255, 65, 108, 0.6);
  }

  /* Main Card */
  .container {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-grow: 1;
    width: 100%;
    padding: 20px;
    margin-top: 60px;
  }

  .card {
    background: var(--glass-bg);
    backdrop-filter: blur(16px);
    border: 1px solid var(--glass-border);
    border-radius: 25px;
    padding: 30px;
    max-width: 500px;
    width: 100%;
    text-align: center;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    animation: fadeIn 0.8s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Canvas Area */
  canvas {
    display: block;
    margin: 20px auto;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 50%;
    box-shadow: 0 0 20px rgba(0, 210, 255, 0.1);
    border: 1px solid rgba(0, 210, 255, 0.3);
    transition: transform 0.3s ease;
  }

  /* Progress Bar */
  .progress-container {
    width: 100%;
    background: rgba(255, 255, 255, 0.1);
    height: 8px;
    border-radius: 10px;
    margin: 15px 0;
    overflow: hidden;
  }

  .progress-bar-inner {
    width: 0%;
    height: 100%;
    background: linear-gradient(90deg, var(--primary-color), var(--success-color));
    transition: width 0.4s ease;
    box-shadow: 0 0 10px var(--primary-color);
  }

  .status {
    font-size: 14px;
    color: #ddd;
    margin-bottom: 20px;
    min-height: 20px;
  }

  /* Controls (Arrows) */
  .controls {
    display: grid;
    grid-template-columns: repeat(3, 60px);
    grid-template-rows: repeat(2, 60px);
    gap: 10px;
    justify-content: center;
    margin-top: 15px;
  }

  .controls button {
    width: 60px;
    height: 60px;
    font-size: 24px;
    border-radius: 15px;
    border: 1px solid var(--glass-border);
    background: rgba(255, 255, 255, 0.05);
    color: var(--primary-color);
    cursor: pointer;
    transition: 0.2s;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .controls button:hover {
    background: var(--primary-color);
    color: #000;
    transform: scale(1.1);
    box-shadow: 0 0 15px rgba(0, 210, 255, 0.4);
  }

  .btn-up { grid-column: 2; grid-row: 1; }
  .btn-left { grid-column: 1; grid-row: 2; }
  .btn-down { grid-column: 2; grid-row: 2; }
  .btn-right { grid-column: 3; grid-row: 2; }

  /* Input Voice Button */
  .voice-input-btn {
    margin-bottom: 15px;
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid var(--primary-color);
    color: var(--primary-color);
    padding: 10px 20px;
    border-radius: 50px;
    cursor: pointer;
    font-family: 'Poppins', sans-serif;
    font-weight: 600;
    transition: 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .voice-input-btn:hover { background: rgba(0, 210, 255, 0.1); }
  
  .voice-input-btn.active {
    background: var(--danger-color);
    border-color: var(--danger-color);
    color: white;
    animation: pulseRed 1.5s infinite;
  }

  @keyframes pulseRed {
    0% { box-shadow: 0 0 0 0 rgba(255, 65, 108, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(255, 65, 108, 0); }
    100% { box-shadow: 0 0 0 0 rgba(255, 65, 108, 0); }
  }

  /* Overlay (Popup) */
  .overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(5px);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 200;
  }

  .popup {
    background: linear-gradient(135deg, #1c2e36, #2c5364);
    border: 1px solid var(--primary-color);
    border-radius: 20px;
    padding: 30px;
    max-width: 400px;
    width: 90%;
    text-align: center;
    box-shadow: 0 0 30px rgba(0, 210, 255, 0.2);
    color: white;
    position: relative;
  }

  .popup h2 { color: var(--primary-color); margin-top: 0; }
  .popup .score { font-size: 3rem; font-weight: bold; margin: 10px 0; color: white; text-shadow: 0 0 10px var(--primary-color); }
  .popup .advice { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; margin: 15px 0; font-size: 0.95rem; line-height: 1.4; }

  .popup .actions { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
  
  .popup button {
    padding: 12px; border-radius: 50px; border: none; cursor: pointer; font-weight: 600; font-family: 'Poppins', sans-serif; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px;
  }

  .btn-retry { background: var(--success-color); color: #000; }
  .btn-download { background: var(--primary-color); color: #000; }
  .btn-close { background: transparent; border: 1px solid #fff; color: #fff; }
  
  /* Speaker Button inside Popup */
  .btn-speak-result {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid var(--primary-color);
    color: var(--primary-color);
    width: 40px; height: 40px;
    border-radius: 50%;
    display: flex; justify-content: center; align-items: center;
    cursor: pointer;
  }
  .btn-speak-result:hover { background: var(--primary-color); color: white; }

</style>
</head>

<body>

<header>
  <h1>BioScan Vision <i class="fas fa-eye"></i></h1>
  <button id="exitBtn" class="exit-btn"><i class="fas fa-sign-out-alt"></i> Exit</button>
</header>

<div class="container">
  <div class="card">
    
    <button id="voiceBtn" class="voice-input-btn"><i class="fas fa-microphone"></i> Voice Control</button>

    <div class="progress-container">
      <div class="progress-bar-inner" id="pbar"></div>
    </div>

    <canvas id="cv" width="300" height="300"></canvas>
    
    <div class="status" id="status">Level 1 of 12 — select the gap direction</div>

    <div class="controls">
      <button class="btn-up" data-dir="270"><i class="fas fa-arrow-up"></i></button>
      <button class="btn-left" data-dir="180"><i class="fas fa-arrow-left"></i></button>
      <button class="btn-down" data-dir="90"><i class="fas fa-arrow-down"></i></button>
      <button class="btn-right" data-dir="0"><i class="fas fa-arrow-right"></i></button>
    </div>

  </div>
</div>

<div class="overlay" id="overlay">
  <div class="popup">
    <button class="btn-speak-result" onclick="speakFinalResult()">
      <i class="fas fa-volume-up"></i>
    </button>

    <h2><i class="fas fa-clipboard-check"></i> Test Result</h2>
    <div id="popupText">Correct Answers:</div>
    <div id="popupScore" class="score"></div>
    <div id="popupAdvice" class="advice"></div>
    <div id="popupTime" style="font-size: 0.8rem; opacity: 0.7;"></div>
    
    <div class="actions">
      <button id="retryBtn" class="btn-retry"><i class="fas fa-redo"></i> Retry Test</button>
      <button id="downloadBtn" class="btn-download"><i class="fas fa-file-pdf"></i> Download Report</button>
      <button id="closeBtn" class="btn-close">Close</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  // DOM Elements
  const cv = document.getElementById('cv'), ctx = cv.getContext('2d');
  const status = document.getElementById('status');
  const controls = document.querySelectorAll('.controls button');
  const overlay = document.getElementById('overlay');
  const popupScore = document.getElementById('popupScore');
  const popupAdvice = document.getElementById('popupAdvice');
  const popupText = document.getElementById('popupText');
  const popupTime = document.getElementById('popupTime');
  const retryBtn = document.getElementById('retryBtn');
  const closeBtn = document.getElementById('closeBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const pbar = document.getElementById('pbar');
  const voiceBtn = document.getElementById('voiceBtn');
  const exitBtn = document.getElementById('exitBtn');

  // Game Variables
  const directions = [0, 90, 180, 270];
  let level = 1, totalLevels = 12, correct = 0, active = false;
  let baseRadius = Math.floor(cv.width * 0.36), radius = baseRadius;

  function drawLandolt(angle) {
    ctx.clearRect(0, 0, cv.width, cv.height);
    const cx = cv.width / 2, cy = cv.height / 2, lineW = Math.max(10, radius * 0.22);
    
    ctx.beginPath(); 
    ctx.lineWidth = lineW; 
    ctx.strokeStyle = "#00d2ff";
    ctx.lineCap = "round";
    ctx.shadowBlur = 15; ctx.shadowColor = "#00d2ff";
    ctx.arc(cx, cy, radius, 0, 2 * Math.PI); 
    ctx.stroke();
    ctx.shadowBlur = 0;

    const gap = Math.PI / 2, rad = angle * Math.PI / 180;
    ctx.save(); 
    ctx.globalCompositeOperation = "destination-out"; 
    ctx.beginPath(); 
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, radius + 2, rad - gap / 2, rad + gap / 2); 
    ctx.closePath(); 
    ctx.fill();
    ctx.restore();
    
    cv.style.transform = "scale(1.05)";
    setTimeout(() => cv.style.transform = "scale(1)", 300);
  }

  function updateProgress() {
    pbar.style.width = Math.round((level - 1) / totalLevels * 100) + '%';
  }

  function nextRound() {
    if (level > totalLevels) { finishTest(); return; }
    
    const angle = directions[Math.floor(Math.random() * 4)];
    drawLandolt(angle);
    cv.dataset.angle = angle;
    
    const lang = localStorage.getItem("language") || "en";
    if(lang === "ar"){
       status.textContent = `المستوى ${level} من ${totalLevels} — اختر اتجاه الفتحة`;
    } else {
       status.textContent = `Level ${level} of ${totalLevels} — select the gap direction`;
    }
    
    active = true;
    updateProgress();
  }

  function submitAnswer(ans) {
    if (!active) return;
    let current = parseInt(cv.dataset.angle);
    let diff = Math.abs((ans - current + 360) % 360); 
    if (diff > 180) diff = 360 - diff;
    
    const lang = localStorage.getItem("language") || "en";
    if (diff <= 45) { 
      correct++; 
      status.textContent = lang === "ar" ? "✅ إجابة صحيحة" : "✅ Correct";
      status.style.color = "var(--success-color)"; 
    } else { 
      status.textContent = lang === "ar" ? "❌ إجابة خاطئة" : "❌ Wrong";
      status.style.color = "var(--danger-color)"; 
    }
    
    radius = Math.max(8, radius * 0.72);
    level++; active = false;
    setTimeout(() => { status.style.color = "#ddd"; nextRound(); }, 500);
  }

  controls.forEach(btn => { 
      btn.addEventListener('click', () => submitAnswer(parseInt(btn.dataset.dir))); 
  });
  document.addEventListener('keydown', e => {
    if (!active) return;
    if (e.key === 'ArrowUp') submitAnswer(270);
    else if (e.key === 'ArrowRight') submitAnswer(0);
    else if (e.key === 'ArrowDown') submitAnswer(90);
    else if (e.key === 'ArrowLeft') submitAnswer(180);
  });

  function finishTest() {
    overlay.style.display = 'flex';
    let ratio = correct / totalLevels;
    const lang = localStorage.getItem("language") || "en";
    let acuity = '6/36', advice = '';

    if (ratio >= 0.86) { 
        acuity = '6/6'; 
        advice = lang === "ar" ? 'نظر ممتاز (20/20).' : 'Excellent vision (20/20).';
    } else if (ratio >= 0.70) { 
        acuity = '6/9'; 
        advice = lang === "ar" ? 'نظر جيد.' : 'Good vision.';
    } else if (ratio >= 0.55) { 
        acuity = '6/12'; 
        advice = lang === "ar" ? 'يفضل المتابعة.' : 'Follow up recommended.';
    } else { 
        acuity = '6/18'; 
        advice = lang === "ar" ? 'يجب زيارة طبيب العيون.' : 'Medical checkup advised.';
    }

    popupScore.textContent = acuity;
    popupAdvice.textContent = advice;
    
    if(lang === "ar"){
        popupText.textContent = `الإجابات الصحيحة: ${correct} من ${totalLevels}`;
        document.querySelector('.popup h2').innerHTML = '<i class="fas fa-clipboard-check"></i> نتيجة الفحص';
        retryBtn.innerHTML = '<i class="fas fa-redo"></i> إعادة';
        downloadBtn.innerHTML = '<i class="fas fa-file-pdf"></i> تحميل التقرير';
        closeBtn.innerText = 'إغلاق';
    } else {
        popupText.textContent = `Correct Answers: ${correct} of ${totalLevels}`;
    }
    
    popupTime.textContent = new Date().toLocaleString();

    // نطق النتيجة تلقائياً عند انتهاء الاختبار
    speakFinalResult();
  }

  // --- Voice Assistant Output (Result) ---
  function speakFinalResult() {
    const lang = localStorage.getItem("language") || "en";
    const scoreText = popupScore.textContent;
    const adviceText = popupAdvice.textContent;
    let textToSpeak = "";

    if (lang === "ar") {
      textToSpeak = `نتيجة فحص النظر هي ${scoreText}. ${adviceText}`;
    } else {
      textToSpeak = `Your vision test result is ${scoreText}. ${adviceText}`;
    }

    const utterance = new SpeechSynthesisUtterance(textToSpeak);
    utterance.lang = lang === "ar" ? 'ar-SA' : 'en-US';
    utterance.rate = 0.9;
    window.speechSynthesis.speak(utterance);
  }

  retryBtn.onclick = () => {
    overlay.style.display = 'none';
    level = 1; correct = 0; radius = baseRadius;
    nextRound();
  };
  closeBtn.onclick = () => overlay.style.display = 'none';

  downloadBtn.onclick = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(18); doc.text("BioScan Vision - Result", 20, 20);
    doc.setFontSize(14);
    doc.text(`Score: ${popupText.textContent}`, 20, 40);
    doc.text(`Acuity: ${popupScore.textContent}`, 20, 50);
    doc.text(`Advice: ${popupAdvice.textContent}`, 20, 60);
    doc.text(`Date: ${popupTime.textContent}`, 20, 70);
    doc.save("Bioscan_Vision_Test.pdf");
  };

  exitBtn.onclick = () => { window.location.href = "instruction.html"; };

  // --- Voice Recognition (Input) ---
  let recognition;
  let listening = false;

  if ("webkitSpeechRecognition" in window) {
    recognition = new webkitSpeechRecognition();
    recognition.lang = "en-US"; 
    recognition.continuous = true;
    recognition.interimResults = false;

    recognition.onresult = function(event) {
      let text = event.results[event.results.length - 1][0].transcript.toLowerCase().trim();
      if (text.includes("up") || text.includes("top")) submitAnswer(270);
      if (text.includes("right")) submitAnswer(0);
      if (text.includes("down") || text.includes("bottom")) submitAnswer(90);
      if (text.includes("left")) submitAnswer(180);
    };
    recognition.onend = function() { if (listening) recognition.start(); };
  }

  voiceBtn.onclick = function() {
    const lang = localStorage.getItem("language") || "en";
    if (!listening) {
      if(recognition) recognition.start();
      listening = true;
      voiceBtn.classList.add("active");
      voiceBtn.innerHTML = lang === "ar" ? '<i class="fas fa-microphone-alt"></i> استماع...' : '<i class="fas fa-microphone-alt"></i> Listening...';
    } else {
      if(recognition) recognition.stop();
      listening = false;
      voiceBtn.classList.remove("active");
      voiceBtn.innerHTML = lang === "ar" ? '<i class="fas fa-microphone"></i> تحكم صوتي' : '<i class="fas fa-microphone"></i> Voice Control';
    }
  };

  window.onload = () => {
    const lang = localStorage.getItem("language") || "en";
    if(lang === "ar"){
        document.body.style.direction = "rtl";
        document.querySelector('header h1').innerHTML = 'فحص النظر <i class="fas fa-eye"></i>';
        exitBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> خروج';
        voiceBtn.innerHTML = '<i class="fas fa-microphone"></i> تحكم صوتي';
    }
    nextRound();
  };
</script>

</body>
</html>