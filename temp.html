<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bioscan | Temperature</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
  /* --- CSS Styles (Ù†ÙØ³ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø£ØµÙ„ÙŠ) --- */
  :root {
    --primary-color: #ff7e5f; /* Coral/Orange */
    --danger-color: #ff0000;
    --bg-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
    --glass-bg: rgba(255, 255, 255, 0.1);
    --glass-border: rgba(255, 255, 255, 0.2);
    --text-color: #ffffff;
  }

  body {
    font-family: 'Poppins', sans-serif;
    background: var(--bg-gradient);
    background-size: 400% 400%;
    animation: gradientBG 15s ease infinite;
    min-height: 100vh;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    color: var(--text-color);
    overflow-x: hidden;
    transition: background 0.5s;
  }

  @keyframes gradientBG {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  /* --- SOS ANIMATION --- */
  @keyframes sos-flash {
    0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); border-color: red; }
    50% { box-shadow: 0 0 50px 20px rgba(255, 0, 0, 0.5); border-color: #ff4d4d; background: rgba(50, 0, 0, 0.6); }
    100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); border-color: red; }
  }

  .critical-state {
    animation: sos-flash 1s infinite;
    border: 2px solid red !important;
  }
   
  .critical-bg {
    background: radial-gradient(circle, #3a0000, #000) !important;
  }

  /* Header */
  header {
    width: 100%;
    background: rgba(15, 32, 39, 0.9);
    backdrop-filter: blur(10px);
    padding: 15px 0;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
    z-index: 100;
  }

  header h1 {
    font-size: 1.4rem;
    margin: 0;
    font-weight: 600;
    letter-spacing: 1px;
    color: var(--primary-color);
    text-transform: uppercase;
    pointer-events: none;
  }

  .back-btn {
    position: absolute;
    left: 20px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid var(--primary-color);
    color: white;
    padding: 8px 15px;
    border-radius: 50px;
    cursor: pointer;
    font-size: 14px;
    transition: 0.3s;
    display: flex;
    align-items: center;
    gap: 5px;
    z-index: 1000;
  }

  .back-btn:hover {
    background: var(--primary-color);
    color: #fff;
    box-shadow: 0 0 15px rgba(255, 126, 95, 0.5);
  }

  .container {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    flex-grow: 1;
    width: 100%;
    padding: 20px;
  }

  .card {
    background: var(--glass-bg);
    backdrop-filter: blur(16px);
    border: 1px solid var(--glass-border);
    border-radius: 25px;
    padding: 40px;
    width: 100%;
    max-width: 500px;
    text-align: center;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    transition: 0.3s;
  }

  /* SOS ALERT BANNER */
  .sos-banner {
    display: none;
    background: red; color: white; font-weight: bold; padding: 10px; border-radius: 10px; margin-bottom: 15px; animation: blink 0.5s infinite alternate;
  }
  @keyframes blink { from { opacity: 1; } to { opacity: 0.7; } }

  .icon-container { margin-bottom: 20px; }
  .icon-container i {
    font-size: 5rem;
    background: -webkit-linear-gradient(#feb47b, #ff7e5f);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 0 10px rgba(255, 126, 95, 0.4));
    animation: warmGlow 2s ease-in-out infinite;
  }

  @keyframes warmGlow {
    0%, 100% { transform: scale(1); filter: drop-shadow(0 0 10px rgba(255, 126, 95, 0.4)); }
    50% { transform: scale(1.1); filter: drop-shadow(0 0 25px rgba(255, 126, 95, 0.8)); }
  }

  .temp-box {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
    border: 1px solid rgba(255, 126, 95, 0.3);
  }

  #tempValue {
    font-size: 3rem; font-weight: 700; color: #fff;
    text-shadow: 0 0 15px var(--primary-color);
  }

  .unit { font-size: 1.5rem; color: var(--primary-color); }

  .instructions-list {
    list-style: none; padding: 0; text-align: left; margin-bottom: 30px;
  }

  .instructions-list li {
    margin-bottom: 12px; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; color: #e0e0e0;
  }

  .instructions-list li i { color: var(--primary-color); width: 25px; text-align: center; }

  /* Buttons Row */
  .actions-row {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap; /* Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ù†Ø²ÙˆÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ùˆ Ø§Ù„Ø´Ø§Ø´Ø© Ø¶ÙŠÙ‚Ø© */
  }

  .advice-btn, .voice-btn, .save-btn {
    padding: 12px 20px;
    border-radius: 50px;
    border: none;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    font-family: 'Poppins', sans-serif;
    transition: 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .advice-btn {
    flex: 2;
    background: linear-gradient(45deg, #ff7e5f, #feb47b);
    color: white;
    box-shadow: 0 4px 15px rgba(255, 126, 95, 0.4);
  }

  /* Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
  .save-btn {
    flex: 2;
    background: linear-gradient(45deg, #11998e, #38ef7d); /* Ù„ÙˆÙ† Ø£Ø®Ø¶Ø± Ù…Ù…ÙŠØ² */
    color: white;
    box-shadow: 0 4px 15px rgba(56, 239, 125, 0.4);
  }

  .voice-btn {
    flex: 1;
    background: rgba(255,255,255,0.1);
    border: 1px solid var(--primary-color);
    color: var(--primary-color);
  }

  .advice-btn:hover, .voice-btn:hover, .save-btn:hover { transform: translateY(-3px); }
  .voice-btn:hover { background: var(--primary-color); color: white; }

  .advice-box {
    background: rgba(255, 255, 255, 0.1);
    padding: 15px;
    border-radius: 15px;
    margin-top: 20px;
    display: none;
    font-size: 1.1rem;
    color: #fff;
    border-left: 4px solid var(--primary-color);
    animation: slideDown 0.5s ease;
  }

  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
</head>
<body>

<audio id="alarmSound" loop>
  <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
</audio>

<header>
  <button id="backBtn" class="back-btn" onclick="goBack()">
    <i class="fas fa-arrow-left"></i> <span>Back</span>
  </button>
  <h1 id="headerTitle">Temperature</h1>
</header>

<div class="container">
  
  <div id="sosBanner" class="sos-banner">
    <i class="fas fa-exclamation-triangle"></i> CRITICAL FEVER / ALERT
  </div>

  <div class="card" id="mainCard">
    <div class="icon-container">
      <i class="fas fa-thermometer-half"></i>
    </div>

    <div class="temp-box">
      <span id="tempValue">--</span> <span class="unit">Â°C</span>
    </div>

    <h3 id="instrTitle" style="color: var(--primary-color); font-weight: 400; margin-bottom: 15px;">Instructions</h3>
    <ul class="instructions-list" id="instructions">
      <li><i class="fas fa-bullseye"></i> Place the sensor close to the skin.</li>
      <li><i class="fas fa-user-clock"></i> Keep still (3-5s).</li>
      <li><i class="fas fa-wind"></i> Avoid sunlight.</li>
    </ul>

    <div class="actions-row">
      <button class="save-btn" id="saveBtn" onclick="saveMeasurement()">
        <i class="fas fa-save"></i> <span id="saveBtnText">Save</span>
      </button>

      <button class="advice-btn" id="adviceBtn" onclick="showAdvice()">
        <i class="fas fa-user-md"></i> <span id="btnText">Medical Advice</span>
      </button>
      
      <button class="voice-btn" onclick="speakResult()">
        <i class="fas fa-volume-up"></i>
      </button>
    </div>

    <div class="advice-box" id="adviceBox"></div>

  </div>
</div>

<script>
  // --- 1. Firebase Config ---
  const firebaseConfig = {
    apiKey: "AIzaSyAOwMQhsRM2PdD_FLjW_8Oi1WlFS3EO5pY",
    authDomain: "smart-a76a0.firebaseapp.com",
    databaseURL: "https://smart-a76a0-default-rtdb.firebaseio.com",
    projectId: "smart-a76a0",
    messagingSenderId: "343693501983",
    appId: "1:343693501983:web:10ea3fce9d990a2455172a"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();

  // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø®ÙÙŠ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ÙƒØªØ§Ø¨Ø©
  auth.signInAnonymously().catch(console.error);

  const tempBox = document.getElementById("tempValue");
  const adviceBox = document.getElementById("adviceBox");
  const sosBanner = document.getElementById("sosBanner");
  const mainCard = document.getElementById("mainCard");
  const alarmSound = document.getElementById("alarmSound");
  const userId = localStorage.getItem("selectedUserId");
  const PATIENT_DATA_PATH = "PatientData";

  let isCritical = false;

  // --- 2. Live Reading (Optional) ---
  // ÙŠÙ…ÙƒÙ† Ù‡Ù†Ø§ ÙˆØ¶Ø¹ ÙƒÙˆØ¯ Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø­Ø³Ø§Ø³ Ø§Ù„Ø­ÙŠ Ù„Ùˆ ÙˆØ¬Ø¯ØŒ Ø­Ø§Ù„ÙŠØ§Ù‹ Ù†Ø³ØªØ®Ø¯Ù… Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±

  // --- 3. Save Function (The Core Request) ---
  function saveMeasurement() {
    const val = tempBox.innerText;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© ØµØ§Ù„Ø­Ø©
    if (val === "--" || val === "") {
        alert(localStorage.getItem("language") === "ar" ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø© Ù„Ø­ÙØ¸Ù‡Ø§!" : "No reading to save!");
        return;
    }

    if (!userId) {
        alert("Error: User not logged in.");
        window.location.href = "index.html";
        return;
    }

    const timestamp = new Date().toLocaleString();

    // Ø£. Ø­ÙØ¸ ÙÙŠ History (Ù„Ù„Ø³Ø¬Ù„)
    db.ref(`${PATIENT_DATA_PATH}/${userId}/History`).push({
        temperature: val,
        createdAt: timestamp
    });

    // Ø¨. ØªØ­Ø¯ÙŠØ« SensorData (Ù„Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯)
    // Ù†Ø­ØªØ§Ø¬ Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¹Ø¯Ù… Ù…Ø³Ø­ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
    db.ref(`${PATIENT_DATA_PATH}/${userId}/SensorData`).once('value').then(snapshot => {
        let currentStr = snapshot.val() || "";
        
        // ØªØ­Ø¯ÙŠØ« Ø¬Ø²Ø¡ Temp ÙÙŠ Ø§Ù„Ù†Øµ
        if (currentStr.includes("Temp=")) {
            // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            currentStr = currentStr.replace(/Temp=[^,]+/, `Temp=${val}`);
        } else if (currentStr === "No measurement recorded yet") {
            currentStr = `Temp=${val}`;
        } else {
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚ÙŠÙ…Ø© Ù„Ù„Ù†Øµ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
            currentStr = currentStr ? `${currentStr}, Temp=${val}` : `Temp=${val}`;
        }

        // Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
        db.ref(`${PATIENT_DATA_PATH}/${userId}`).update({
            SensorData: currentStr,
            Timestamp: timestamp
        }).then(() => {
            alert(localStorage.getItem("language") === "ar" ? "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³ Ø¨Ù†Ø¬Ø§Ø­!" : "Measurement saved successfully!");
        }).catch(error => {
            console.error("Save Error:", error);
            alert("Error saving data.");
        });
    });
  }

  // --- SOS Functions ---
  function triggerSOS() {
    if(isCritical) return;
    isCritical = true;
    
    document.body.classList.add("critical-bg");
    mainCard.classList.add("critical-state");
    sosBanner.style.display = "block";
    
    alarmSound.play().catch(e => console.log("Audio waiting for interaction"));
    
    const lang = localStorage.getItem("language") || "en";
    sosBanner.innerText = lang === "ar" ? "ğŸš¨ ØªÙ†Ø¨ÙŠÙ‡: Ø­Ø±Ø§Ø±Ø© Ø­Ø±Ø¬Ø©! ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø­Ø°Ø±." : "ğŸš¨ CRITICAL ALERT: Dangerous Temperature!";
  }

  function clearSOS() {
    if(!isCritical) return;
    isCritical = false;
    
    document.body.classList.remove("critical-bg");
    mainCard.classList.remove("critical-state");
    sosBanner.style.display = "none";
    alarmSound.pause();
    alarmSound.currentTime = 0;
  }

  // --- Voice Assistant ---
  function speakResult() {
    let temp = parseFloat(tempBox.innerText);
    const lang = localStorage.getItem("language") || "en";
    let textToSpeak = "";

    if(tempBox.innerText === "--" || isNaN(temp)){
      textToSpeak = lang === "ar" ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø© Ù„Ù„Ø­Ø±Ø§Ø±Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†" : "No temperature reading available yet";
    } else {
      if(lang === "ar"){
        textToSpeak = `Ø¯Ø±Ø¬Ø© Ø­Ø±Ø§Ø±ØªÙƒ Ù‡ÙŠ ${temp}.`;
        if(temp > 38.5) textToSpeak += " ØªØ­Ø°ÙŠØ±! Ø­Ø±Ø§Ø±Ø© Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹.";
        else if(temp > 37.5) textToSpeak += " Ø­Ø±Ø§Ø±ØªÙƒ Ù…Ø±ØªÙØ¹Ø© Ù‚Ù„ÙŠÙ„Ø§Ù‹.";
        else if(temp < 35.5) textToSpeak += " Ø­Ø±Ø§Ø±ØªÙƒ Ù…Ù†Ø®ÙØ¶Ø© Ø¬Ø¯Ø§Ù‹.";
        else textToSpeak += " Ø­Ø±Ø§Ø±ØªÙƒ Ø·Ø¨ÙŠØ¹ÙŠØ©.";
      } else {
        textToSpeak = `Your temperature is ${temp} degrees.`;
        if(temp > 38.5) textToSpeak += " Warning! Very high fever.";
        else if(temp > 37.5) textToSpeak += " You have a slight fever.";
        else if(temp < 35.5) textToSpeak += " Your temperature is critically low.";
        else textToSpeak += " Your temperature is normal.";
      }
    }

    const utterance = new SpeechSynthesisUtterance(textToSpeak);
    utterance.lang = lang === "ar" ? 'ar-SA' : 'en-US';
    utterance.rate = 0.9;
    window.speechSynthesis.speak(utterance);
  }

  function showAdvice() {
    let temp = parseFloat(tempBox.innerText);
    const lang = localStorage.getItem("language") || "en";
    let adviceText = "";

    if (tempBox.innerText === "--" || isNaN(temp)) {
      adviceText = lang === "ar" ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª." : "No data available.";
      adviceBox.style.borderLeftColor = "#ccc";
    } else if (isCritical) {
      adviceText = lang === "ar" ? "ğŸš¨ Ø­Ø§Ù„Ø© Ø·ÙˆØ§Ø±Ø¦! Ø­Ø±Ø§Ø±Ø© ØºÙŠØ± Ø·Ø¨ÙŠØ¹ÙŠØ©." : "ğŸš¨ EMERGENCY! Critical temperature.";
      adviceBox.style.borderLeftColor = "#ff0000";
    } else if (temp < 35.5) {
      adviceText = lang === "ar" ? "âš  Ø­Ø±Ø§Ø±Ø© Ù…Ù†Ø®ÙØ¶Ø© â€” Ù‚Ù… Ø¨ØªØ¯ÙØ¦Ø© Ø§Ù„Ù…Ø±ÙŠØ¶." : "âš  Low temperature â€” warm the patient.";
      adviceBox.style.borderLeftColor = "#33ccff";
    } else if (temp >= 35.5 && temp <= 37.5) {
      adviceText = lang === "ar" ? "âœ” Ø­Ø±Ø§Ø±Ø© Ø·Ø¨ÙŠØ¹ÙŠØ©." : "âœ” Normal temperature.";
      adviceBox.style.borderLeftColor = "#00ff88";
    } else if (temp > 37.5) {
      adviceText = lang === "ar" ? "âš  Ø­Ù…Ù‰ Ø®ÙÙŠÙØ© â€” Ø§Ø³ØªØ±Ø­." : "âš  Mild Fever â€” please rest.";
      adviceBox.style.borderLeftColor = "#ff9900";
    }

    adviceBox.innerText = adviceText;
    adviceBox.style.display = "block";
    if(!isCritical) speakResult();
  }

  function goBack() { 
    clearSOS();
    window.location.href = "measurements.html"; 
  }

  const lang = localStorage.getItem("language") || "en";
  if (lang === "ar") {
    document.body.style.direction = "rtl";
    document.getElementById("headerTitle").innerText = "Ù‚ÙŠØ§Ø³ Ø§Ù„Ø­Ø±Ø§Ø±Ø©";
    const backBtn = document.getElementById("backBtn");
    backBtn.style.left = "auto"; backBtn.style.right = "20px";
    backBtn.innerHTML = '<i class="fas fa-arrow-right"></i> <span>Ø¹ÙˆØ¯Ø©</span>';
    document.getElementById("instrTitle").innerText = "ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³";
    document.getElementById("instructions").innerHTML = `
      <li><i class="fas fa-bullseye"></i> Ø¶Ø¹ Ø§Ù„Ù…Ø³ØªØ´Ø¹Ø± Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¬Ù„Ø¯.</li>
      <li><i class="fas fa-user-clock"></i> Ø§Ø«Ø¨Øª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù‚ÙŠØ§Ø³.</li>
    `;
    document.getElementById("btnText").innerText = "Ø§Ù„Ù†ØµÙŠØ­Ø© Ø§Ù„Ø·Ø¨ÙŠØ©";
    document.getElementById("saveBtnText").innerText = "Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³";
  }
</script>

<div style="position: fixed; bottom: 10px; left: 10px; z-index: 9999; display: flex; gap: 5px;">
  <button onclick="testCritical()" style="background: red; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 12px;">
    ğŸš¨ Test Fever
  </button>
  <button onclick="testNormal()" style="background: green; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 12px;">
    âœ… Test Normal
  </button>
</div>

<script>
  function testCritical() {
    document.getElementById("tempValue").innerText = "39.5";
    triggerSOS(); 
  }

  function testNormal() {
    document.getElementById("tempValue").innerText = "37.0";
    clearSOS();
  }
</script>
</body>
</html>
