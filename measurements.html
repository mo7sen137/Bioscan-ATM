<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bioscan | Command Center</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Orbitron:wght@400;500;700&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* --- 1. THEME VARIABLES --- */
    :root {
      --primary-neon: #00f2ff;
      --secondary-neon: #7000ff;
      --bg-dark: #020408;
      --glass-panel: rgba(8, 15, 25, 0.9);
      --border-color: rgba(0, 242, 255, 0.4);
      --text-main: #e0f7fa;
      --error: #ff2a2a;
      --success: #00ff88;
      --warning: #f39c12;
      
      /* Colors */
      --temp-color: #ff9f43;
      --pulse-color: #ff4757;
      --bp-color: #a29bfe;
      --ox-color: #48dbfb;
      --vision-color: #1dd1a1;
    }

    * { box-sizing: border-box; outline: none; user-select: none; }

    body {
      margin: 0; padding: 0;
      font-family: 'Rajdhani', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-main);
      min-height: 100vh;
      overflow-x: hidden;
      display: flex; flex-direction: column; align-items: center;
      padding-top: 90px;
      padding-bottom: 40px;
    }

    /* --- 2. SKELETON LOADING ANIMATION --- */
    .skeleton {
        color: transparent !important;
        background: linear-gradient(90deg, rgba(255,255,255,0.05), rgba(255,255,255,0.15), rgba(255,255,255,0.05));
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite linear;
        border-radius: 5px;
        display: inline-block;
        min-width: 60px;
        min-height: 20px;
    }
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

    /* --- 3. BIO BACKGROUND --- */
    #bio-background {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
        overflow: hidden; background: radial-gradient(circle at center, #0f1c2e 0%, #000000 100%);
    }
    .bio-symbol {
        position: absolute; color: var(--primary-neon); opacity: 0.15;
        animation: floatBio 20s linear infinite; pointer-events: none;
    }
    @keyframes floatBio {
        0% { transform: translateY(110vh) rotate(0deg) scale(0.8); opacity: 0; }
        50% { opacity: 0.2; }
        100% { transform: translateY(-10vh) rotate(360deg) scale(1.2); opacity: 0; }
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #050b14; }
    ::-webkit-scrollbar-thumb { background: var(--primary-neon); border-radius: 10px; }

    /* --- 4. HEADER --- */
    .user-card { 
      position: fixed; top: 0; left: 0; width: 100%; height: 75px;
      background: rgba(5, 10, 18, 0.98); backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--primary-neon); 
      box-shadow: 0 0 25px rgba(0, 242, 255, 0.15); 
      z-index: 100;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 30px; margin: 0; border-radius: 0;
    }

    .user-left { display: flex; align-items: center; gap: 15px; }
    .user-avatar { font-size: 2rem; color: var(--primary-neon); filter: drop-shadow(0 0 8px var(--primary-neon)); }
    .user-info h2 { margin: 0; font-family: 'Orbitron', sans-serif; font-size: 0.8rem; color: #888; letter-spacing: 1px; }
    .user-info span { font-size: 1.3rem; color: #fff; font-weight: 700; letter-spacing: 1px; }

    .top-actions { display: flex; align-items: center; gap: 12px; }
    .icon-btn { 
      background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); 
      color: var(--primary-neon); width: 40px; height: 40px; border-radius: 8px;
      cursor: pointer; transition: 0.3s; font-size: 1.1rem;
      display: flex; justify-content: center; align-items: center;
    }
    .icon-btn:hover { background: var(--primary-neon); color: #000; box-shadow: 0 0 15px var(--primary-neon); }
    .icon-btn.active { background: var(--success); color: #000; box-shadow: 0 0 15px var(--success); border-color: var(--success); }
    
    /* Voice Active State */
    .icon-btn.listening { background: var(--error); color: #fff; animation: pulseRed 1s infinite; border-color: var(--error); }
    @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(255, 65, 108, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 65, 108, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 65, 108, 0); } }

    .whatsapp-btn { color: #25D366; border-color: #25D366; }
    .whatsapp-btn:hover { background: #25D366; color: #fff; box-shadow: 0 0 15px #25D366; }

    .status-dot { width: 10px; height: 10px; border-radius: 50%; background-color: var(--success); box-shadow: 0 0 10px var(--success); transition: 0.3s; margin-left: 10px; }
    .status-dot.offline { background-color: var(--error); box-shadow: 0 0 10px var(--error); animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0.5; } }

    /* --- 5. AI CONSOLE (Restored Design + New Glow) --- */
    .ai-card { 
      width: 95%; max-width: 900px; margin-top: 10px;
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.05), rgba(58, 123, 213, 0.05)); /* Previous Subtle Gradient */
      border: 1px solid var(--primary-neon); border-radius: 20px; 
      padding: 25px; margin-bottom: 30px; 
      display: flex; align-items: flex-start; gap: 20px; 
      /* Dynamic Glow will be applied via JS */
      box-shadow: 0 0 20px rgba(0, 210, 255, 0.1); 
      position: relative; overflow: hidden; transition: all 0.5s ease;
    }
    
    .ai-icon { 
      font-size: 2.5rem; color: var(--primary-neon); 
      background: rgba(0, 0, 0, 0.3); width: 65px; height: 65px; 
      border-radius: 50%; display: flex; justify-content: center; align-items: center; 
      border: 1px solid var(--primary-neon);
      animation: pulseAI 2s infinite; flex-shrink: 0;
    }
    @keyframes pulseAI { 0% { box-shadow: 0 0 0 0 rgba(0, 242, 255, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(0, 242, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 242, 255, 0); } }

    .ai-content { z-index: 2; width: 100%; }
    .ai-content h3 { margin: 0 0 5px 0; font-size: 1.2rem; color: var(--primary-neon); font-family: 'Orbitron', sans-serif; }
    .ai-content div { font-size: 1rem; line-height: 1.6; color: #eee; }
    
    /* Detailed AI List */
    .ai-list { list-style: none; padding: 0; margin-top: 12px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
    .ai-list li {
        background: rgba(255,255,255,0.05); padding: 10px 15px; border-radius: 8px;
        border-left: 3px solid var(--primary-neon); font-size: 0.9rem; color: #fff;
    }

    /* --- 6. MODULES --- */
    .measure-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 20px; width: 95%; max-width: 900px; margin-bottom: 30px; }
    
    .measure-btn { 
      background: var(--glass-panel); backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; 
      padding: 20px 10px; cursor: pointer; position: relative; overflow: hidden; height: 180px;
      display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px;
      transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .measure-btn:hover { transform: translateY(-8px); background: rgba(20, 30, 45, 0.95); }
    
    .temp { border-bottom: 4px solid var(--temp-color); } .temp i { color: var(--temp-color); filter: drop-shadow(0 0 8px var(--temp-color)); }
    .pulse { border-bottom: 4px solid var(--pulse-color); } .pulse i { color: var(--pulse-color); animation: heartBeat 1.5s infinite; }
    @keyframes heartBeat { 0% { transform: scale(1); } 15% { transform: scale(1.2); } 30% { transform: scale(1); } 45% { transform: scale(1.1); } 60% { transform: scale(1); } }
    .pressure { border-bottom: 4px solid var(--bp-color); } .pressure i { color: var(--bp-color); }
    .oxygen { border-bottom: 4px solid var(--ox-color); } .oxygen i { color: var(--ox-color); animation: breathe 3s infinite ease-in-out; }
    @keyframes breathe { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }

    .measure-btn i { font-size: 2.5rem; margin-bottom: 5px; }
    .measure-btn span { font-size: 0.85rem; font-weight: 600; color: #888; text-transform: uppercase; letter-spacing: 1px; }
    .value-display { font-family: 'Orbitron', sans-serif; font-size: 1.5rem; font-weight: 700; color: #fff; margin-top: 5px; text-shadow: 0 0 10px rgba(255,255,255,0.2); }

    /* --- 7. DOCK & FOOTER --- */
    .dock-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 95%; max-width: 900px; margin-bottom: 30px; }
    .dock-btn {
        background: linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.06));
        border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;
        padding: 20px; display: flex; align-items: center; justify-content: center; gap: 15px;
        cursor: pointer; transition: 0.3s;
    }
    .dock-btn:hover { transform: scale(1.02); }
    .vision-dock { border-bottom: 3px solid var(--vision-color); } .vision-dock i { font-size: 1.8rem; color: var(--vision-color); }
    .history-dock { border-bottom: 3px solid var(--secondary-neon); } .history-dock i { font-size: 1.8rem; color: var(--secondary-neon); }
    .dock-text { text-align: left; }
    .dock-title { display: block; color: #fff; font-family: 'Orbitron', sans-serif; font-size: 1rem; }
    .dock-sub { display: block; color: #666; font-size: 0.8rem; margin-top: 2px; }

    .close-btn { 
      background: rgba(255, 42, 42, 0.1); color: var(--error); border: 1px solid var(--error);
      padding: 12px 30px; border-radius: 50px; font-size: 0.9rem; font-family: 'Orbitron', sans-serif; 
      cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 10px; margin-top: 20px;
    }
    .close-btn:hover { background: var(--error); color: #fff; box-shadow: 0 0 20px var(--error); }

    /* --- 8. FABs --- */
    .fab-container { position: fixed; bottom: 30px; z-index: 1000; display: flex; flex-direction: column; gap: 20px; }
    .fab-right { right: 30px; align-items: flex-end; }
    .fab-left { left: 30px; align-items: flex-start; }

    .sos-wrapper { position: relative; width: 70px; height: 70px; margin-top: 10px; }
    .sos-fab {
        width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #ff416c, #ff0000);
        color: white; border: 2px solid rgba(255,255,255,0.2); box-shadow: 0 0 20px rgba(255, 0, 0, 0.6);
        cursor: pointer; display: flex; align-items: center; justify-content: center; font-family: 'Orbitron', sans-serif; font-weight: bold; font-size: 18px;
        animation: sosPulse 2s infinite; transition: 0.3s;
    }
    .sos-fab:hover { transform: scale(1.1); }
    @keyframes sosPulse { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(255, 0, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); } }
    .sos-settings-btn { position: absolute; top: -5px; right: -5px; width: 28px; height: 28px; background: #111; border-radius: 50%; color: var(--error); border: 1px solid var(--error); font-size: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1002; transition: 0.3s; }
    .sos-settings-btn:hover { background: var(--error); color: #fff; }

    .hospital-fab, .analyze-fab { width: 60px; height: 60px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px; transition: 0.3s; backdrop-filter: blur(5px); }
    .hospital-fab { background: linear-gradient(135deg, #00d2ff, #3a7bd5); box-shadow: 0 0 15px rgba(0, 210, 255, 0.4); }
    .hospital-fab:hover { transform: scale(1.1); }
    .analyze-fab { background: linear-gradient(135deg, #6c5ce7, #a29bfe); box-shadow: 0 0 15px rgba(108, 92, 231, 0.5); }
    .analyze-fab:hover { transform: scale(1.1); }

    /* --- 9. SIDEBAR & MODALS (FIXED BLUR) --- */
    .sidebar-overlay, .custom-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 3000; display: none; justify-content: center; align-items: center; opacity: 0; transition: 0.3s; }
    .sidebar-overlay.active, .custom-modal-overlay.active { display: flex; opacity: 1; }
    
    .sidebar { 
        position: fixed; top: 0; left: -360px; width: 340px; height: 100%; 
        background: #0b101a; border-right: 1px solid var(--primary-neon); 
        box-shadow: 10px 0 50px rgba(0,0,0,0.8); z-index: 3001; /* Higher than overlay */
        transition: left 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); padding: 30px 20px; 
    }
    .sidebar.active { left: 0; }
    .sidebar-header { border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
    .sidebar-header h3 { color: var(--primary-neon); margin: 0; font-family: 'Orbitron', sans-serif; }
    .close-sidebar { background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; }
    
    .sidebar-input { width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; margin-bottom: 15px; text-align: center; font-size: 1.1rem; }
    .calc-btn { width: 100%; padding: 12px; background: var(--primary-neon); color: #000; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; font-family: 'Orbitron', sans-serif; }
    .result-box { margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 8px; border-left: 3px solid var(--primary-neon); display: none; }

    /* Centered Modals */
    .custom-modal-box { background: #0b101a; border: 1px solid var(--primary-neon); padding: 40px; border-radius: 20px; width: 90%; max-width: 450px; text-align: center; box-shadow: 0 0 60px rgba(0, 242, 255, 0.2); transform: scale(0.9); transition: 0.3s; z-index: 3002; }
    .custom-modal-overlay.active .custom-modal-box { transform: scale(1); }
    .modal-icon { font-size: 3rem; margin-bottom: 20px; color: var(--primary-neon); }
    .modal-input { width: 100%; padding: 15px; margin-bottom: 25px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; color: #fff; text-align: center; font-size: 1.3rem; font-family: 'Orbitron', sans-serif; }
    .modal-actions { display: flex; justify-content: center; gap: 15px; }
    .modal-btn { padding: 12px 30px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
    .btn-confirm { background: var(--primary-neon); color: #000; }
    .btn-danger { background: var(--error); color: #fff; }
    .btn-cancel { background: transparent; border: 1px solid #555; color: #aaa; }

    /* Toast */
    .toast-container { position: fixed; top: 100px; right: 20px; z-index: 4000; display: flex; flex-direction: column; gap: 10px; }
    .toast { background: rgba(5, 11, 20, 0.95); color: white; padding: 15px 25px; border-radius: 12px; display: flex; align-items: center; gap: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.6); border-left: 4px solid; animation: slideIn 0.4s ease, fadeOut 0.5s ease 4s forwards; }
    @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
    @keyframes fadeOut { to { opacity: 0; } }
    .toast-error { border-color: var(--error); } .toast-error i { color: var(--error); }
    .toast-info { border-color: var(--primary-neon); } .toast-info i { color: var(--primary-neon); }

    @media screen and (max-width: 768px) {
      body { padding: 90px 10px 40px; }
      .user-card { padding: 0 15px; }
      .measure-container { grid-template-columns: repeat(2, 1fr); gap: 12px; }
      .measure-btn { height: 150px; }
      .dock-container { grid-template-columns: 1fr; }
      .fab-right { right: 20px; bottom: 20px; }
      .fab-left { left: 20px; bottom: 20px; }
    }
  </style>
</head>
<body>

  <div id="bio-background"></div>
  <div class="toast-container" id="toastContainer"></div>

  <div class="user-card">
    <div class="user-left">
        <div class="user-avatar"><i class="fas fa-user"></i></div>
        <div class="user-info">
            <h2>USER ID</h2>
            <span id="currentUserName">Loading...</span>
        </div>
    </div>
    <div class="top-actions">
      <button class="icon-btn" id="micBtn" onclick="startListening()" title="Voice Commands">
        <i class="fas fa-microphone"></i>
      </button>
      <button class="icon-btn whatsapp-btn" id="whatsappBtn" onclick="sendWhatsAppReport()" title="Send Report">
        <i class="fab fa-whatsapp"></i>
      </button>
      <button class="icon-btn active" id="voiceToggle" onclick="toggleHoverVoice()" title="Voice Guide">
        <i class="fas fa-volume-up"></i>
      </button>
      <button class="icon-btn" onclick="toggleFullScreen()" title="Full Screen">
        <i class="fas fa-expand"></i>
      </button>
      <div id="connectionStatus" class="status-dot" title="Online"></div>
    </div>
  </div>

  <div class="ai-card">
    <div class="ai-icon"><i class="fas fa-robot"></i></div>
    <div class="ai-content">
      <h3 id="aiTitle">AI DIAGNOSTICS</h3>
      <div id="aiText">System Initializing... Awaiting sensor data.</div>
    </div>
    <div id="lastReadingTime" style="position: absolute; bottom: 10px; right: 20px; font-size: 0.75rem; color: #666; font-family: 'Orbitron', sans-serif;">Last updated: --</div>
  </div>

  <div class="measure-container">
    <div class="measure-btn temp" id="tempBtn" onclick="goToTemperature()">
      <i class="fas fa-thermometer-half"></i> <span>Temperature</span>
      <div class="value-display skeleton" id="tempValue">--</div>
    </div>
    <div class="measure-btn pulse" id="pulseBtn" onclick="goToPulse()">
      <i class="fas fa-heartbeat"></i> <span>Pulse Rate</span>
      <div class="value-display skeleton" id="pulseValue">--</div>
    </div>
    <div class="measure-btn pressure" id="bpBtn" onclick="goToPressure()">
      <i class="fas fa-stethoscope"></i> <span>Blood Pressure</span>
      <div class="value-display skeleton" id="bpValue">--</div>
    </div>
    <div class="measure-btn oxygen" id="oxygenBtn" onclick="goToOxygen()">
      <i class="fas fa-lungs"></i> <span>Oxygen (SpO2)</span>
      <div class="value-display skeleton" id="spo2Value">--</div>
    </div>
  </div>

  <div class="dock-container">
      <div class="dock-btn vision-dock" id="visionBtn" onclick="goToVisionPage()">
          <i class="fas fa-eye"></i>
          <div class="dock-text">
              <span class="dock-title">VISION TEST</span>
              <span class="dock-sub">Start eye exam</span>
          </div>
      </div>
      <div class="dock-btn history-dock" id="historyBtn" onclick="goToHistory()">
          <i class="fas fa-file-medical-alt"></i>
          <div class="dock-text">
              <span class="dock-title">HISTORY LOGS</span>
              <span class="dock-sub">View previous data</span>
          </div>
      </div>
  </div>

  <button class="close-btn" id="exitBtn" onclick="closeMeasurements()">
    <i class="fas fa-power-off"></i> TERMINATE SESSION
  </button>

  <div class="fab-container fab-right">
    <button class="hospital-fab" id="hospitalBtn" onclick="findHospitals()" title="Nearest Hospitals"><i class="fas fa-hospital"></i></button>
    <div class="sos-wrapper">
        <button class="sos-settings-btn" onclick="openContactModal()" title="Settings"><i class="fas fa-cog"></i></button>
        <button class="sos-fab" id="sosBtn" onclick="triggerSOS()">SOS</button>
    </div>
  </div>

  <div class="fab-container fab-left">
    <button class="analyze-fab" id="analyzeBtn" onclick="toggleSidebar(true)"><i class="fas fa-chart-pie"></i></button>
  </div>

  <div class="custom-modal-overlay" id="contactModal">
      <div class="custom-modal-box">
          <div class="modal-icon"><i class="fas fa-address-book"></i></div>
          <h3 class="modal-title" id="contactTitle">Emergency Contact</h3>
          <p id="contactText" class="modal-text" style="color:#aaa;">Enter phone number</p>
          <input type="number" id="emergencyInput" class="modal-input" placeholder="010xxxxxxxx">
          <div class="modal-actions"><button class="modal-btn btn-cancel" onclick="closeModals()">Cancel</button><button class="modal-btn btn-confirm" onclick="saveEmergencyContact()">Save</button></div>
      </div>
  </div>

  <div class="custom-modal-overlay" id="confirmModal">
      <div class="custom-modal-box">
          <div class="modal-icon warning" style="color:var(--error);"><i class="fas fa-exclamation-triangle"></i></div>
          <h3 class="modal-title" id="confirmTitle">Emergency Alert</h3>
          <p id="confirmText" class="modal-text" style="color:#aaa;">Confirm SOS?</p>
          <div class="modal-actions"><button class="modal-btn btn-cancel" onclick="closeModals()">Cancel</button><button class="modal-btn btn-danger" onclick="executeSOS()">YES, SEND HELP</button></div>
      </div>
  </div>

  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar(false)"></div>
  <div class="sidebar" id="smartSidebar">
    <div class="sidebar-header"><h3 id="sidebarTitle"><i class="fas fa-brain"></i> SMART CHECK</h3><button class="close-sidebar" onclick="toggleSidebar(false)">Ã—</button></div>
    <div class="sidebar-content">
      <label id="lblWeight" style="color:#aaa; display:block; margin-bottom:5px;">Weight (kg)</label><input type="number" id="inputWeight" class="sidebar-input" placeholder="e.g. 75">
      <label id="lblHeight" style="color:#aaa; display:block; margin-bottom:5px;">Height (cm)</label><input type="number" id="inputHeight" class="sidebar-input" placeholder="e.g. 175">
      <button class="calc-btn" onclick="calculateHealthRisk()" id="btnAnalyze">ANALYZE DATA</button>
      <div id="analysisResult" class="result-box"></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

  <script>
    // --- 1. SETUP BACKGROUND ---
    function createBioBackground() {
        const container = document.getElementById('bio-background');
        const icons = ['fa-dna', 'fa-heartbeat', 'fa-notes-medical', 'fa-pills', 'fa-virus', 'fa-microscope', 'fa-user-md', 'fa-syringe', 'fa-lungs', 'fa-brain'];
        const count = 30; 
        for (let i = 0; i < count; i++) {
            const el = document.createElement('i');
            el.classList.add('fas', icons[Math.floor(Math.random() * icons.length)], 'bio-symbol');
            el.style.left = Math.random() * 100 + 'vw';
            const size = Math.random() * 2 + 0.5;
            el.style.fontSize = size + 'rem';
            el.style.opacity = Math.random() * 0.2;
            el.style.animationDuration = (Math.random() * 20 + 15) + 's';
            el.style.animationDelay = (Math.random() * 10) + 's';
            container.appendChild(el);
        }
    }
    createBioBackground();

    // --- 2. CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyAOwMQhsRM2PdD_FLjW_8Oi1WlFS3EO5pY",
      authDomain: "smart-a76a0.firebaseapp.com",
      databaseURL: "https://smart-a76a0-default-rtdb.firebaseio.com",
      projectId: "smart-a76a0",
      messagingSenderId: "343693501983",
      appId: "1:343693501983:web:10ea3fce9d990a2455172a"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth(); 
    auth.signInAnonymously().catch(console.error);

    const PATIENT_DATA_PATH = 'PatientData';
    const currentUserId = localStorage.getItem("selectedUserId");
    const userSpan = document.getElementById('currentUserName');
    if(!currentUserId) window.location.href="index.html"; 
    else userSpan.innerText = currentUserId;

    // --- 3. NEW FEATURES: VOICE & SIDEBAR FIX ---
    
    // Toggle Sidebar
    function toggleSidebar(show) {
      const sidebar = document.getElementById("smartSidebar");
      const overlay = document.getElementById("sidebarOverlay");
      if(show) { 
          sidebar.classList.add("active"); 
          overlay.style.display = "block"; // Explicit display
          setTimeout(() => overlay.classList.add("active"), 10);
      } else { 
          sidebar.classList.remove("active"); 
          overlay.classList.remove("active");
          setTimeout(() => overlay.style.display = "none", 300);
      }
    }

    // Voice Command Logic
    function startListening() {
        if (!('webkitSpeechRecognition' in window)) {
            showToast("Voice control not supported in this browser.", "error");
            return;
        }
        
        const recognition = new webkitSpeechRecognition();
        recognition.lang = localStorage.getItem("language") === "ar" ? "ar-SA" : "en-US";
        recognition.start();
        
        const btn = document.getElementById('micBtn');
        btn.classList.add('listening');

        recognition.onresult = (event) => {
            const cmd = event.results[0][0].transcript.toLowerCase();
            showToast(`Heard: "${cmd}"`, "info");
            
            // Map commands
            if(cmd.includes('temp') || cmd.includes('Ø­Ø±Ø§Ø±Ø©')) goToTemperature();
            else if(cmd.includes('pulse') || cmd.includes('heart') || cmd.includes('Ù†Ø¨Ø¶') || cmd.includes('Ù‚Ù„Ø¨')) goToPulse();
            else if(cmd.includes('pressure') || cmd.includes('blood') || cmd.includes('Ø¶ØºØ·')) goToPressure();
            else if(cmd.includes('oxygen') || cmd.includes('Ø§ÙƒØ³Ø¬ÙŠÙ†')) goToOxygen();
            else if(cmd.includes('vision') || cmd.includes('eye') || cmd.includes('Ù†Ø¸Ø±') || cmd.includes('Ø¹ÙŠÙ†')) goToVisionPage();
            else if(cmd.includes('history') || cmd.includes('record') || cmd.includes('Ø³Ø¬Ù„')) goToHistory();
            else if(cmd.includes('emergency') || cmd.includes('help') || cmd.includes('Ø·ÙˆØ§Ø±Ø¦')) triggerSOS();
            
            btn.classList.remove('listening');
        };

        recognition.onerror = () => btn.classList.remove('listening');
        recognition.onend = () => btn.classList.remove('listening');
    }

    // --- 4. PRESERVED LOGIC ---
    function triggerSOS() {
        const savedNumber = localStorage.getItem("sosContactNumber");
        if (!savedNumber) { openContactModal(); } else { openConfirmModal(); }
    }

    function openContactModal() {
        const lang = localStorage.getItem("language") || "en";
        document.getElementById('contactTitle').innerText = lang === "ar" ? "Ø¥Ø¹Ø¯Ø§Ø¯ Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ù„Ù„Ø·ÙˆØ§Ø±Ø¦" : "Setup Emergency Contact";
        document.getElementById('contactText').innerText = lang === "ar" ? "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø«Ø§Ù„: 010xxxxxxxx)" : "Enter phone number (e.g., 010xxxxxxxx).";
        const saved = localStorage.getItem("sosContactNumber");
        if(saved) document.getElementById('emergencyInput').value = saved;
        document.getElementById('contactModal').classList.add('active');
    }

    function saveEmergencyContact() {
        const num = document.getElementById('emergencyInput').value;
        const lang = localStorage.getItem("language") || "en";
        if (num.length < 5) {
            showToast(lang==="ar"?"Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­!":"Invalid Number!", "error");
            return;
        }
        localStorage.setItem("sosContactNumber", num);
        closeModals();
        showToast(lang==="ar"?"ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ù‚Ù…":"Contact Saved", "info");
    }

    function openConfirmModal() {
        const lang = localStorage.getItem("language") || "en";
        document.getElementById('confirmTitle').innerText = lang === "ar" ? "ØªÙ†Ø¨ÙŠÙ‡ Ø·ÙˆØ§Ø±Ø¦" : "Emergency Alert";
        document.getElementById('confirmText').innerText = lang === "ar" ? "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ù†Ø¯Ø§Ø¡ Ø§Ø³ØªØºØ§Ø«Ø©ØŸ" : "Are you sure you want to send SOS?";
        document.getElementById('confirmModal').classList.add('active');
    }

    function closeModals() {
        document.getElementById('contactModal').classList.remove('active');
        document.getElementById('confirmModal').classList.remove('active');
    }

    function executeSOS() {
        closeModals();
        const lang = localStorage.getItem("language") || "en";
        if (navigator.geolocation) {
            showToast(lang==="ar"?"Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...":"Locating...", "info");
            navigator.geolocation.getCurrentPosition(sendPosition, showError);
        } else {
            alert(lang === "ar" ? "Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS." : "Geolocation not supported.");
        }
    }

    function sendPosition(position) {
        const lat = position.coords.latitude;
        const long = position.coords.longitude;
        const mapLink = `https://www.google.com/maps?q=${lat},${long}`;
        const lang = localStorage.getItem("language") || "en";
        let rawPhone = localStorage.getItem("sosContactNumber");
        let cleanPhone = rawPhone.replace(/\D/g, ''); 
        if (cleanPhone.startsWith('01')) cleanPhone = '20' + cleanPhone.substring(1);

        let msg = "";
        if(lang === "ar") msg = `ğŸš¨ *Ø§Ø³ØªØºØ§Ø«Ø© Ø·Ø§Ø±Ø¦Ø©!* ğŸš¨\nØ£Ø­ØªØ§Ø¬ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙˆØ±Ø§Ù‹.\nğŸ“ *Ø§Ù„Ù…ÙˆÙ‚Ø¹:* ${mapLink}\nğŸŒ¡ï¸ *Ø§Ù„Ø­Ø±Ø§Ø±Ø©:* ${currentData.temp}\nâ¤ï¸ *Ø§Ù„Ù†Ø¨Ø¶:* ${currentData.bpm}`;
        else msg = `ğŸš¨ *EMERGENCY SOS!* ğŸš¨\nI need help immediately.\nğŸ“ *Location:* ${mapLink}\nğŸŒ¡ï¸ *Temp:* ${currentData.temp}\nâ¤ï¸ *Pulse:* ${currentData.bpm}`;
        
        const finalUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(msg)}`;
        window.open(finalUrl, '_blank');
    }

    function showError(error) {
        const lang = localStorage.getItem("language") || "en";
        showToast(lang === "ar" ? "ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹" : "Location Error", "error");
    }

    function extractSensorValues(sensorString) {
        const values = {};
        if (sensorString && sensorString !== "No measurement recorded yet") {
            sensorString.split(',').forEach(item => {
                const parts = item.trim().split('=');
                if (parts.length === 2) {
                    const key = parts[0].trim().toLowerCase();
                    const value = parts[1].trim();
                    if (key.includes('temp')) values.temp = value;
                    else if (key === 'hr' || key.includes('pulse')) values.bpm = value;
                    else if (key === 'bp' || key.includes('pressure')) values.bp = value;
                    else if (key.includes('o2') || key.includes('spo2')) values.spo2 = value;
                }
            });
        }
        return values;
    }

    function calculateHealthRisk() {
      const weight = parseFloat(document.getElementById("inputWeight").value);
      const height = parseFloat(document.getElementById("inputHeight").value);
      const resultBox = document.getElementById("analysisResult");
      const lang = localStorage.getItem("language") || "en";

      if(!weight || !height) {
        resultBox.style.display = "block";
        resultBox.style.borderLeftColor = "#ff416c";
        resultBox.innerText = lang === "ar" ? "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª." : "Enter valid data.";
        return;
      }

      const h_m = height / 100;
      const bmi = (weight / (h_m * h_m)).toFixed(1);
      const waterNeed = (weight * 0.035).toFixed(1);

      let status = "", color = "", dietTip = "", exerciseTip = "";
      if(bmi < 18.5) { 
          status = lang==="ar"?"Ù†Ø­Ø§ÙØ©":"Underweight"; color="#3498db"; 
          dietTip = lang==="ar"?"ğŸ¥‘ Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ù…ÙƒØ³Ø±Ø§Øª ÙˆØ²Ø¨Ø¯Ø© Ø§Ù„ÙÙˆÙ„ Ø§Ù„Ø³ÙˆØ¯Ø§Ù†ÙŠ." : "ğŸ¥‘ Eat nuts & peanut butter.";
          exerciseTip = lang==="ar"?"ğŸ‹ï¸â€â™‚ï¸ Ø±ÙƒØ² Ø¹Ù„Ù‰ ØªÙ…Ø§Ø±ÙŠÙ† Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø© Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª." : "ğŸ‹ï¸â€â™‚ï¸ Focus on strength training.";
      } else if(bmi < 25) { 
          status = lang==="ar"?"ÙˆØ²Ù† Ù…Ø«Ø§Ù„ÙŠ":"Healthy"; color="#2ecc71"; 
          dietTip = lang==="ar"?"ğŸ¥— Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø·Ø¨Ù‚ Ø§Ù„Ø³Ù„Ø·Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹." : "ğŸ¥— Eat salad daily.";
          exerciseTip = lang==="ar"?"ğŸƒâ€â™‚ï¸ Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ù…Ø´ÙŠ Ø£Ùˆ Ø§Ù„Ø¬Ø±ÙŠ 30 Ø¯Ù‚ÙŠÙ‚Ø©." : "ğŸƒâ€â™‚ï¸ Jog/Walk 30 mins daily.";
      } else if(bmi < 30) { 
          status = lang==="ar"?"ÙˆØ²Ù† Ø²Ø§Ø¦Ø¯":"Overweight"; color="#f1c40f"; 
          dietTip = lang==="ar"?"ğŸ“‰ Ù‚Ù„Ù„ Ø§Ù„Ø³ÙƒØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø§Ù„ØºØ§Ø²ÙŠØ©." : "ğŸ“‰ Cut sugar & soda.";
          exerciseTip = lang==="ar"?"ğŸš´â€â™‚ï¸ Ø¬Ø±Ø¨ Ø±ÙƒÙˆØ¨ Ø§Ù„Ø¯Ø±Ø§Ø¬Ø© Ø£Ùˆ Ø§Ù„Ø³Ø¨Ø§Ø­Ø©." : "ğŸš´â€â™‚ï¸ Try cycling or swimming.";
      } else { 
          status = lang==="ar"?"Ø³Ù…Ù†Ø©":"Obese"; color="#e74c3c"; 
          dietTip = lang==="ar"?"ğŸš« Ø§Ø¨ØªØ¹Ø¯ Ø¹Ù† Ø§Ù„Ù…Ù‚Ù„ÙŠØ§Øª ÙˆØ§Ù„ÙˆØ¬Ø¨Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©." : "ğŸš« No fried/fast food.";
          exerciseTip = lang==="ar"?"ğŸš¶â€â™‚ï¸ Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ù…Ø´ÙŠ Ø§Ù„Ø®ÙÙŠÙ Ù„ØªØ¬Ù†Ø¨ Ø¢Ù„Ø§Ù… Ø§Ù„Ù…ÙØ§ØµÙ„." : "ğŸš¶â€â™‚ï¸ Start with light walking.";
      }

      const waterMsg = lang==="ar" ? `ğŸ’§ Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ù…Ø§Ø¡: ${waterNeed} Ù„ØªØ±` : `ğŸ’§ Water Need: ${waterNeed} L`;

      resultBox.style.display = "block";
      resultBox.style.borderLeftColor = color;
      resultBox.innerHTML = `
        <strong style="color:${color}; font-size:1.1rem;">BMI: ${bmi} (${status})</strong><br>
        <div style="margin-top:10px; font-size:0.9rem; color:#eee;">
            ${waterMsg}<br>
            ğŸ <b>${lang==="ar"?"ØºØ°Ø§Ø¡:":"Diet:"}</b> ${dietTip}<br>
            ğŸ’ª <b>${lang==="ar"?"Ø±ÙŠØ§Ø¶Ø©:":"Gym:"}</b> ${exerciseTip}
        </div>`;
      
      if(voiceEnabled) {
         const utterance = new SpeechSynthesisUtterance(lang==="ar" ? `Ù…Ø¤Ø´Ø± ÙƒØªÙ„Ø© Ø§Ù„Ø¬Ø³Ù… ${bmi}` : `BMI is ${bmi}`);
         utterance.lang = lang==="ar"?'ar-SA':'en-US';
         window.speechSynthesis.speak(utterance);
      }
    }

    let currentData = { temp: "--", bpm: "--", bp: "--", spo2: "--" };
    let lastTimestamp = "--";

    // --- ENHANCED AI LOGIC (Restored & Glowing) ---
    function updateAIAnalysis() {
      if(!currentUserId) return;
      const userRef = db.ref(PATIENT_DATA_PATH + '/' + currentUserId);
      userRef.on("value", (snapshot) => {
        if(snapshot.exists()) {
            const data = snapshot.val();
            const sensorDataString = data.SensorData || "No measurement recorded yet";
            const sensorValues = extractSensorValues(sensorDataString);
            
            currentData = {
                temp: sensorValues.temp || "--",
                bpm: sensorValues.bpm || "--",
                bp: sensorValues.bp || "--",
                spo2: sensorValues.spo2 || "--"
            };
            lastTimestamp = data.Timestamp || "--";

            // SKELETON HANDLING
            const elements = ['bpValue', 'spo2Value', 'tempValue', 'pulseValue'];
            const units = ['', '%', 'Â°C', ' bpm'];
            const vals = [currentData.bp, currentData.spo2, currentData.temp, currentData.bpm];
            
            elements.forEach((id, index) => {
                const el = document.getElementById(id);
                if (vals[index] !== "--") {
                    el.classList.remove('skeleton');
                    el.innerText = vals[index] + units[index];
                }
            });

            document.getElementById('lastReadingTime').innerText = (localStorage.getItem("language") === 'ar' ? 'Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ' : 'Last updated: ') + lastTimestamp;
            
            const temp = parseFloat(currentData.temp) || 0;
            const bpm = parseInt(currentData.bpm) || 0;
            const spo2 = parseFloat(currentData.spo2) || 0;
            let sys = 0;
            if(currentData.bp && currentData.bp.includes('/')) sys = parseInt(currentData.bp.split('/')[0]);

            let statusColor = "#00ff88"; 
            let adviceList = [];
            let headerMsg = localStorage.getItem("language") === "ar" ? "âœ… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù…Ø³ØªÙ‚Ø±Ø©." : "âœ… General condition is stable.";

            if (sensorDataString === "No measurement recorded yet") {
                headerMsg = localStorage.getItem("language") === "ar" ? "â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª..." : "â³ Waiting for measurements...";
            } else {
                if(sys > 140) {
                    statusColor = "#ff416c";
                    headerMsg = localStorage.getItem("language") === "ar" ? "âš ï¸ Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ù…Ø±ØªÙØ¹" : "âš ï¸ High Blood Pressure";
                    adviceList.push(localStorage.getItem("language")==="ar" ? "ğŸŒ <b>Ø£ÙƒÙ„:</b> ØªÙ†Ø§ÙˆÙ„ Ø§Ù„Ù…ÙˆØ²ØŒ Ø§Ù„Ø³Ø¨Ø§Ù†Ø®." : "ğŸŒ <b>Eat:</b> Bananas, Spinach (Potassium).");
                    adviceList.push(localStorage.getItem("language")==="ar" ? "ğŸµ <b>Ø´Ø±Ø¨:</b> Ø´Ø§ÙŠ Ø§Ù„ÙƒØ±ÙƒØ¯ÙŠÙ‡ Ø§Ù„Ø¨Ø§Ø±Ø¯." : "ğŸµ <b>Drink:</b> Hibiscus Tea.");
                    adviceList.push(localStorage.getItem("language")==="ar" ? "ğŸ§˜â€â™‚ï¸ <b>Ù†Ø´Ø§Ø·:</b> ØªÙ…Ø§Ø±ÙŠÙ† Ø§Ù„ØªÙ†ÙØ³." : "ğŸ§˜â€â™‚ï¸ <b>Do:</b> Deep Breathing.");
                } 
                else if (sys > 0 && sys < 90) {
                     statusColor = "#f1c40f";
                     headerMsg = localStorage.getItem("language") === "ar" ? "âš ï¸ Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ù…Ù†Ø®ÙØ¶" : "âš ï¸ Low Blood Pressure";
                     adviceList.push(localStorage.getItem("language")==="ar" ? "ğŸ§‚ <b>Ø£ÙƒÙ„:</b> ÙˆØ¬Ø¨Ø© Ø®ÙÙŠÙØ© Ù…Ø§Ù„Ø­Ø©." : "ğŸ§‚ <b>Eat:</b> Salty snack.");
                     adviceList.push(localStorage.getItem("language")==="ar" ? "ğŸ’§ <b>Ø´Ø±Ø¨:</b> Ø³ÙˆØ§Ø¦Ù„ ÙƒØ«ÙŠØ±Ø©." : "ğŸ’§ <b>Drink:</b> Fluids.");
                }

                if(temp > 37.5) {
                    statusColor = "#ff416c";
                    headerMsg = localStorage.getItem("language") === "ar" ? "ğŸŒ¡ï¸ Ø­Ø±Ø§Ø±Ø© Ù…Ø±ØªÙØ¹Ø© (Ø­Ù…Ù‰)" : "ğŸŒ¡ï¸ High Fever";
                    adviceList.push(localStorage.getItem("language")==="ar" ? "ğŸ§Š <b>Ø¥Ø¬Ø±Ø§Ø¡:</b> ÙƒÙ…Ø§Ø¯Ø§Øª Ø¨Ø§Ø±Ø¯Ø©." : "ğŸ§Š <b>Do:</b> Cold compresses.");
                    adviceList.push(localStorage.getItem("language")==="ar" ? "ğŸ‹ <b>Ø´Ø±Ø¨:</b> Ù„ÙŠÙ…ÙˆÙ† Ø¯Ø§ÙØ¦." : "ğŸ‹ <b>Drink:</b> Warm Lemon.");
                }

                if(spo2 > 0 && spo2 < 95) {
                    statusColor = "#ff416c";
                    headerMsg = localStorage.getItem("language") === "ar" ? "ğŸ« Ù†Ù‚Øµ ÙÙŠ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†" : "ğŸ« Low Oxygen Level";
                    adviceList.push(localStorage.getItem("language")==="ar" ? "ğŸªŸ <b>Ø¨ÙŠØ¦Ø©:</b> ÙØªØ­ Ø§Ù„Ù†ÙˆØ§ÙØ°." : "ğŸªŸ <b>Env:</b> Fresh Air.");
                    adviceList.push(localStorage.getItem("language")==="ar" ? "ğŸŒ¬ï¸ <b>ØªÙ…Ø±ÙŠÙ†:</b> Ø§Ù„ØªÙ†ÙØ³ Ø§Ù„Ø¹Ù…ÙŠÙ‚." : "ğŸŒ¬ï¸ <b>Do:</b> Deep breathing.");
                }
                
                if(adviceList.length === 0 && sensorDataString !== "No measurement recorded yet") {
                    adviceList.push(localStorage.getItem("language")==="ar" ? "ğŸ’§ Ø§Ø´Ø±Ø¨ 8 Ø£ÙƒÙˆØ§Ø¨ Ù…Ø§Ø¡." : "ğŸ’§ Drink 8 cups of water.");
                    adviceList.push(localStorage.getItem("language")==="ar" ? "ğŸš¶â€â™‚ï¸ Ø§Ù…Ø´ÙŠ 30 Ø¯Ù‚ÙŠÙ‚Ø©." : "ğŸš¶â€â™‚ï¸ Walk for 30 mins.");
                }
            }

            let finalHtml = `<strong style="color:${statusColor}; font-size:1.1rem;">${headerMsg}</strong>`;
            if(adviceList.length > 0) {
                finalHtml += `<ul class="ai-list">`;
                adviceList.forEach(tip => finalHtml += `<li>${tip}</li>`);
                finalHtml += `</ul>`;
            }

            document.getElementById("aiText").innerHTML = finalHtml;
            // HEAVY GLOW UPDATE
            document.querySelector(".ai-card").style.borderColor = statusColor;
            document.querySelector(".ai-card").style.boxShadow = `0 0 50px ${statusColor}40`;
        }
      });
    }

    async function checkInternetConnection() { try { await fetch("https://www.google.com/favicon.ico?"+new Date().getTime(),{mode:"no-cors"});return true;}catch(e){return false;}}
    async function updateStatus(){const d=document.getElementById('connectionStatus');if(await checkInternetConnection()){d.classList.remove('offline');d.title="Online";}else{d.classList.add('offline');d.title="Offline";}}
    setInterval(updateStatus,3000);

    function showToast(msg,type="info"){const c=document.getElementById("toastContainer");const t=document.createElement("div");t.className=`toast toast-${type}`;t.innerHTML=`<i class="fas fa-info-circle"></i><span>${msg}</span>`;c.appendChild(t);setTimeout(()=>t.remove(),3000);}

    function sendWhatsAppReport(){
        let phone = currentUserId; 
        if (phone.startsWith('0')) phone = '20' + phone.substring(1);
        let m=`ğŸ¥ *Bioscan Report*%0A- Temp: ${currentData.temp}%0A- Pulse: ${currentData.bpm}%0A- BP: ${currentData.bp}%0A- Ox: ${currentData.spo2}`;
        window.open(`https://wa.me/${phone}?text=${m}`,'_blank');
    }
    
    function findHospitals(){window.open("http://maps.google.com/maps?q=nearest+hospitals","_blank");}
    function toggleFullScreen(){if(!document.fullscreenElement)document.documentElement.requestFullscreen();else if(document.exitFullscreen)document.exitFullscreen();}
    function closeMeasurements(){localStorage.removeItem("selectedUserId");window.location.href="index.html";}
    
    let idle=0; setInterval(()=>{idle++;if(idle>=90)closeMeasurements();},1000);
    document.onmousemove=document.onkeypress=document.ontouchstart=document.onclick=()=>{idle=0;};

    let voiceEnabled=true;
    function toggleHoverVoice(){voiceEnabled=!voiceEnabled;document.getElementById('voiceToggle').classList.toggle('active');}
    function setupHoverVoice(){
        const map={
            'analyzeBtn':{ar:'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¬Ø³Ù…',en:'Body Analysis'},
            'hospitalBtn':{ar:'Ø£Ù‚Ø±Ø¨ Ù…Ø³ØªØ´ÙÙ‰',en:'Nearest Hospital'},
            'sosBtn':{ar:'Ù†Ø¯Ø§Ø¡ Ø§Ø³ØªØºØ§Ø«Ø©',en:'SOS Emergency'},
            'tempBtn':{ar:'Ø­Ø±Ø§Ø±Ø©',en:'Temperature'},
            'pulseBtn':{ar:'Ù†Ø¨Ø¶',en:'Pulse'},
            'bpBtn':{ar:'Ø¶ØºØ·',en:'Pressure'},
            'oxygenBtn':{ar:'Ø£ÙƒØ³Ø¬ÙŠÙ†',en:'Oxygen'},
            'visionBtn':{ar:'Ù†Ø¸Ø±',en:'Vision'},
            'historyBtn':{ar:'Ø§Ù„Ø³Ø¬Ù„',en:'History'}
        };
        Object.keys(map).forEach(id=>{
            const b=document.getElementById(id);
            if(b){
                b.onmouseenter=()=>{
                    if(!voiceEnabled) return;
                    window.speechSynthesis.cancel();
                    const u=new SpeechSynthesisUtterance(localStorage.getItem('language')==='ar'?map[id].ar:map[id].en);
                    u.lang=localStorage.getItem('language')==='ar'?'ar-SA':'en-US';
                    window.speechSynthesis.speak(u);
                };
                b.onmouseleave=()=>{ window.speechSynthesis.cancel(); }
            }
        });
    }

    function goToTemperature(){window.location.href="temp.html";}
    function goToPulse(){window.location.href="pulse.html";}
    function goToPressure(){window.location.href="pressure.html";}
    function goToOxygen(){window.location.href="oxygen.html";}
    function goToVisionPage(){window.location.href="instruction.html";}
    function goToHistory(){window.location.href="history.html";}

    function applyLanguage(){
        const lang = localStorage.getItem("language") || "en";
        if(lang==="ar"){
            document.body.style.direction="rtl";
            document.querySelector(".user-info h2").innerText="Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ";
            document.getElementById("aiTitle").innerText="Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ";
            document.getElementById("sidebarTitle").innerHTML='<i class="fas fa-brain"></i> Ø§Ù„ÙØ­Øµ Ø§Ù„Ø°ÙƒÙŠ';
            document.getElementById("lblWeight").innerText="Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)";
            document.getElementById("lblHeight").innerText="Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)";
            document.getElementById("btnAnalyze").innerText="ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬";
            document.getElementById("hospitalBtn").title="Ø£Ù‚Ø±Ø¨ Ù…Ø³ØªØ´ÙÙ‰";
            document.getElementById("analyzeBtn").title="ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¬Ø³Ù…";
            document.getElementById("sosBtn").title="Ø·ÙˆØ§Ø±Ø¦";
            document.querySelector("#tempBtn span").innerText="Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©";
            document.querySelector("#pulseBtn span").innerText="Ù†Ø¨Ø¶ Ø§Ù„Ù‚Ù„Ø¨";
            document.querySelector("#bpBtn span").innerText="Ø¶ØºØ· Ø§Ù„Ø¯Ù…";
            document.querySelector("#oxygenBtn span").innerText="Ù†Ø³Ø¨Ø© Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†";
            document.querySelector("#visionBtn .dock-title").innerText="ÙØ­Øµ Ø§Ù„Ù†Ø¸Ø±";
            document.querySelector("#visionBtn .dock-sub").innerText="Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ";
            document.querySelector("#historyBtn .dock-title").innerText="Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±";
            document.querySelector("#historyBtn .dock-sub").innerText="Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©";
            document.querySelector("#exitBtn").innerHTML='<i class="fas fa-power-off"></i> Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©';
        }
    }

    applyLanguage();
    window.onload = () => { 
        updateAIAnalysis(); 
        if ('speechSynthesis' in window) {
            window.speechSynthesis.onvoiceschanged = () => { setupHoverVoice(); };
            setTimeout(setupHoverVoice, 500);
        }
    };
  </script>
</body>
</html>
