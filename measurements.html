<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bioscan | Dashboard</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    :root {
      --bg-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --text-color: #ffffff;
      --history-color: #a18cd1;
      --ai-color: #00d2ff;
      --error-color: #ff416c;
      --success-color: #00ff88;
      --whatsapp-color: #25D366;
      --analyze-color: #6c5ce7; /* ŸÑŸàŸÜ ÿ≤ÿ± ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ */
    }

    /* --- CUSTOM SCROLLBAR --- */
    ::-webkit-scrollbar { width: 10px; }
    ::-webkit-scrollbar-track { background: #1a1a1a; }
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, var(--ai-color), var(--history-color)); 
      border-radius: 10px; border: 2px solid #1a1a1a;
    }
    ::-webkit-scrollbar-thumb:hover { background: var(--success-color); }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-gradient);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: var(--text-color);
      box-sizing: border-box;
      overflow-x: hidden;
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* User Welcome Card */
    .user-card {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      padding: 10px 30px;
      border-radius: 50px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      gap: 15px;
      width: 100%;
      max-width: 900px;
      box-sizing: border-box;
      animation: slideDown 0.8s ease;
    }

    @keyframes slideDown {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .user-card i.fa-user-circle { font-size: 1.5rem; color: #00d2ff; }
    .user-card h2 { margin: 0; font-size: 1.1rem; font-weight: 400; flex-grow: 1; }
    .user-card span { font-weight: 600; color: #00d2ff; text-transform: uppercase; }

    /* Top Buttons Group */
    .top-actions { display: flex; align-items: center; gap: 10px; }

    .icon-btn {
      background: transparent; border: none; color: white; cursor: pointer; font-size: 1.2rem;
      transition: 0.3s; padding: 5px; opacity: 0.8;
    }
    .icon-btn:hover { transform: scale(1.2); opacity: 1; color: var(--primary-color); }
    .icon-btn.active { color: var(--success-color); text-shadow: 0 0 10px var(--success-color); }
    .icon-btn.muted { color: var(--error-color); }
    
    .whatsapp-btn { color: var(--whatsapp-color) !important; }
    .whatsapp-btn:hover { text-shadow: 0 0 10px var(--whatsapp-color); }

    /* Status Dot */
    .status-dot {
      width: 12px; height: 12px; border-radius: 50%;
      background-color: var(--success-color);
      box-shadow: 0 0 10px var(--success-color);
      transition: all 0.3s ease; margin-left: 15px;
    }
    .status-dot.offline {
      background-color: var(--error-color) !important;
      box-shadow: 0 0 15px var(--error-color) !important;
      animation: blinkRed 1s infinite;
    }
    @keyframes blinkRed { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

    /* AI Analysis Card */
    .ai-card {
      width: 100%; max-width: 900px;
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.1), rgba(58, 123, 213, 0.1));
      border: 1px solid var(--ai-color);
      border-radius: 20px; padding: 20px;
      margin-bottom: 30px; display: flex; align-items: flex-start; gap: 20px;
      box-shadow: 0 0 20px rgba(0, 210, 255, 0.15);
      position: relative; overflow: hidden; box-sizing: border-box;
    }
    .ai-icon {
      font-size: 2.5rem; color: var(--ai-color); background: rgba(0, 0, 0, 0.2);
      width: 60px; height: 60px; border-radius: 50%;
      display: flex; justify-content: center; align-items: center; animation: pulseAI 2s infinite; flex-shrink: 0;
    }
    @keyframes pulseAI {
      0% { box-shadow: 0 0 0 0 rgba(0, 210, 255, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(0, 210, 255, 0); }
      100% { box-shadow: 0 0 0 0 rgba(0, 210, 255, 0); }
    }
    .ai-content h3 { margin: 0 0 5px 0; font-size: 1.1rem; color: var(--ai-color); }
    .ai-content p { margin: 0; font-size: 0.95rem; line-height: 1.5; color: #eee; }

    /* Grid Container */
    .measure-container {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px; width: 100%; max-width: 900px; margin-bottom: 30px;
    }
    .measure-btn {
      background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(5px);
      border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 25px 15px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 15px; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      position: relative; overflow: hidden; height: 160px;
    }
    .measure-btn:hover { transform: translateY(-10px); box-shadow: 0 15px 30px rgba(0,0,0,0.4); border-color: rgba(255,255,255,0.4); }
    .measure-btn i { font-size: 2.5rem; transition: 0.3s; }
    .measure-btn span { font-size: 1rem; font-weight: 600; text-align: center; color: #fff; }

    /* Colors */
    .temp { border-bottom: 4px solid #ff7e5f; } .temp i { color: #ff7e5f; }
    .pulse { border-bottom: 4px solid #ff416c; } .pulse i { color: #ff416c; }
    .pressure { border-bottom: 4px solid #6a11cb; } .pressure i { color: #6a11cb; }
    .oxygen { border-bottom: 4px solid #00c6ff; } .oxygen i { color: #00c6ff; }
    .vision { border-bottom: 4px solid #43e97b; } .vision i { color: #43e97b; }

    /* History Bar */
    .history-bar {
      width: 100%; max-width: 900px;
      background: linear-gradient(90deg, rgba(161, 140, 209, 0.1), rgba(251, 194, 235, 0.1));
      border: 1px solid rgba(161, 140, 209, 0.4); border-radius: 20px; padding: 20px;
      display: flex; align-items: center; justify-content: center; gap: 20px;
      cursor: pointer; margin-bottom: 40px; transition: 0.3s;
      backdrop-filter: blur(10px); box-sizing: border-box;
    }
    .history-bar:hover { transform: scale(1.02); border-color: var(--history-color); box-shadow: 0 0 25px rgba(161, 140, 209, 0.3); }
    .history-bar i { font-size: 2rem; color: var(--history-color); }
    .history-bar span { font-size: 1.2rem; font-weight: 600; color: #fff; text-transform: uppercase; }

    /* Exit Button */
    .close-btn {
      background: linear-gradient(45deg, #cb2d3e, #ef473a);
      color: white; border: none; padding: 12px 40px; border-radius: 50px;
      font-size: 16px; font-family: 'Poppins', sans-serif; font-weight: 600;
      cursor: pointer; box-shadow: 0 4px 15px rgba(239, 71, 58, 0.4);
      transition: 0.3s; display: flex; align-items: center; gap: 10px; margin-top: auto;
    }
    .close-btn:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(239, 71, 58, 0.6); }

    /* --- FLOATING BUTTONS (FABs) --- */
    .fab-container {
        position: fixed; bottom: 30px; display: flex; gap: 20px; z-index: 1000;
    }
    .fab-right { right: 30px; }
    .fab-left { left: 30px; }

    /* Hospital FAB */
    .hospital-fab {
      width: 65px; height: 65px; border-radius: 50%;
      background: linear-gradient(135deg, #ff416c, #ff4b2b);
      color: white; border: none; box-shadow: 0 4px 15px rgba(255, 65, 108, 0.5);
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      font-size: 28px; transition: 0.3s; animation: pulse-fab 2s infinite;
    }
    .hospital-fab:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(255, 65, 108, 0.7); }

    /* Analysis FAB (New) */
    .analyze-fab {
      width: 65px; height: 65px; border-radius: 50%;
      background: linear-gradient(135deg, #6c5ce7, #a29bfe);
      color: white; border: none; box-shadow: 0 4px 15px rgba(108, 92, 231, 0.5);
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      font-size: 28px; transition: 0.3s; animation: float-fab 3s ease-in-out infinite;
    }
    .analyze-fab:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(108, 92, 231, 0.7); }

    @keyframes pulse-fab {
      0% { box-shadow: 0 0 0 0 rgba(255, 65, 108, 0.7); }
      70% { box-shadow: 0 0 0 15px rgba(255, 65, 108, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 65, 108, 0); }
    }
    @keyframes float-fab {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }

    /* --- SLIDE-OUT SIDEBAR (For Analysis) --- */
    .sidebar-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1999;
        display: none; opacity: 0; transition: opacity 0.3s;
    }
    .sidebar-overlay.active { display: block; opacity: 1; }

    .sidebar {
        position: fixed; top: 0; left: -350px; width: 320px; height: 100%;
        background: rgba(15, 32, 39, 0.95); backdrop-filter: blur(15px);
        border-right: 1px solid var(--ai-color);
        box-shadow: 5px 0 30px rgba(0,0,0,0.5);
        z-index: 2000; transition: left 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        padding: 20px; box-sizing: border-box; display: flex; flex-direction: column;
    }
    .sidebar.active { left: 0; }

    .sidebar-header {
        display: flex; justify-content: space-between; align-items: center;
        border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 20px;
    }
    .sidebar-header h3 { margin: 0; color: var(--ai-color); font-size: 1.3rem; display: flex; gap: 10px; align-items: center; }
    .close-sidebar { background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; transition: 0.3s; }
    .close-sidebar:hover { color: var(--error-color); transform: rotate(90deg); }

    .sidebar-content label { display: block; color: #ccc; margin-bottom: 5px; font-size: 0.9rem; text-align: left; }
    .sidebar-input {
        width: 100%; padding: 12px; margin-bottom: 15px;
        background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
        border-radius: 10px; color: white; font-size: 1rem; box-sizing: border-box;
    }
    .sidebar-input:focus { outline: none; border-color: var(--ai-color); }

    .calc-btn {
        width: 100%; padding: 12px; background: var(--ai-color); color: white;
        border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px;
        transition: 0.3s;
    }
    .calc-btn:hover { background: #3a7bd5; transform: scale(1.02); }

    .result-box {
        margin-top: 25px; padding: 15px; background: rgba(255,255,255,0.05);
        border-radius: 10px; border-left: 4px solid var(--ai-color);
        font-size: 0.95rem; line-height: 1.5; color: #eee; display: none;
    }

    /* Toast */
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; }
    .toast { background: rgba(16, 30, 40, 0.95); color: white; padding: 15px 25px; border-radius: 12px; display: flex; align-items: center; gap: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); border-left: 5px solid; animation: slideIn 0.4s ease, fadeOut 0.5s ease 4s forwards; }
    @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    .toast-error { border-color: var(--error-color); } .toast-error i { color: var(--error-color); }
    .toast-info { border-color: var(--ai-color); } .toast-info i { color: var(--ai-color); }

  </style>
</head>
<body>

  <div class="toast-container" id="toastContainer"></div>

  <div class="fab-container fab-right">
    <button class="hospital-fab" id="hospitalBtn" onclick="findHospitals()" title="Nearest Hospitals">
      <i class="fas fa-ambulance"></i>
    </button>
  </div>

  <div class="fab-container fab-left">
    <button class="analyze-fab" id="analyzeBtn" onclick="toggleSidebar(true)" title="Smart Body Analysis">
      <i class="fas fa-chart-pie"></i>
    </button>
  </div>

  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar(false)"></div>
  <div class="sidebar" id="smartSidebar">
    <div class="sidebar-header">
      <h3 id="sidebarTitle"><i class="fas fa-brain"></i> Smart Check</h3>
      <button class="close-sidebar" onclick="toggleSidebar(false)">&times;</button>
    </div>
    <div class="sidebar-content">
      <label id="lblWeight">Weight (kg) / ÿßŸÑŸàÿ≤ŸÜ</label>
      <input type="number" id="inputWeight" class="sidebar-input" placeholder="e.g. 75">
      
      <label id="lblHeight">Height (cm) / ÿßŸÑÿ∑ŸàŸÑ</label>
      <input type="number" id="inputHeight" class="sidebar-input" placeholder="e.g. 175">
      
      <button class="calc-btn" onclick="calculateHealthRisk()" id="btnAnalyze">Analyze Health / ÿ™ÿ≠ŸÑŸäŸÑ</button>
      
      <div id="analysisResult" class="result-box"></div>
    </div>
  </div>

  <div class="user-card">
    <i class="fas fa-user-circle"></i>
    <h2 id="titleText">User: <span id="currentUserName">Unknown</span></h2>
    
    <div class="top-actions">
      <button class="icon-btn whatsapp-btn" id="whatsappBtn" onclick="sendWhatsAppReport()" title="Send Report to WhatsApp">
        <i class="fab fa-whatsapp"></i>
      </button>
      <button class="icon-btn active" id="voiceToggle" onclick="toggleHoverVoice()" title="Toggle Voice Guide">
        <i class="fas fa-volume-up"></i>
      </button>
      <button class="icon-btn" onclick="toggleFullScreen()" title="Full Screen">
        <i class="fas fa-expand"></i>
      </button>
      <div id="connectionStatus" class="status-dot" title="Online"></div>
    </div>
  </div>

  <div class="ai-card">
    <div class="ai-icon"><i class="fas fa-robot"></i></div>
    <div class="ai-content">
      <h3 id="aiTitle">AI Health Analysis</h3>
      <p id="aiText">Waiting for measurements to generate analysis...</p>
    </div>
  </div>

  <div class="measure-container">
    <div class="measure-btn temp" id="tempBtn" onclick="goToTemperature()">
      <i class="fas fa-thermometer-half"></i> <span>Temperature</span>
    </div>
    <div class="measure-btn pulse" id="pulseBtn" onclick="goToPulse()">
      <i class="fas fa-heartbeat"></i> <span>Pulse Rate</span>
    </div>
    <div class="measure-btn pressure" id="bpBtn" onclick="goToPressure()">
      <i class="fas fa-stethoscope"></i> <span>Blood Pressure</span>
    </div>
    <div class="measure-btn oxygen" id="oxygenBtn" onclick="goToOxygen()">
      <i class="fas fa-lungs"></i> <span>Oxygen (SpO2)</span>
    </div>
    <div class="measure-btn vision" id="visionBtn" onclick="goToVisionPage()">
      <i class="fas fa-eye"></i> <span>Vision Test</span>
    </div>
  </div>

  <div class="history-bar" id="historyBtn" onclick="goToHistory()">
    <i class="fas fa-file-medical-alt"></i>
    <span>View History & Reports</span>
  </div>

  <button class="close-btn" id="exitBtn" onclick="closeMeasurements()">
    <i class="fas fa-sign-out-alt"></i> Exit Dashboard
  </button>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAOwMQhsRM2PdD_FLjW_8Oi1WlFS3EO5pY",
      authDomain: "smart-a76a0.firebaseapp.com",
      databaseURL: "https://smart-a76a0-default-rtdb.firebaseio.com",
      projectId: "smart-a76a0",
      storageBucket: "smart-a76a0.firebasestorage.app",
      messagingSenderId: "343693501983",
      appId: "1:343693501983:web:10ea3fce9d990a2455172a"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const currentUserId = localStorage.getItem("selectedUserId");
    const userSpan = document.getElementById('currentUserName');
    if(currentUserId) userSpan.innerText = currentUserId; else userSpan.innerText = "Guest";

    // --- SMART SIDEBAR LOGIC (NEW) ---
    function toggleSidebar(show) {
      const sidebar = document.getElementById("smartSidebar");
      const overlay = document.getElementById("sidebarOverlay");
      if(show) {
        sidebar.classList.add("active");
        overlay.classList.add("active");
      } else {
        sidebar.classList.remove("active");
        overlay.classList.remove("active");
      }
    }

    function calculateHealthRisk() {
      const weight = parseFloat(document.getElementById("inputWeight").value);
      const height = parseFloat(document.getElementById("inputHeight").value);
      const resultBox = document.getElementById("analysisResult");
      const lang = localStorage.getItem("language") || "en";

      if(!weight || !height) {
        resultBox.style.display = "block";
        resultBox.style.borderLeftColor = "#ff416c";
        resultBox.innerText = lang === "ar" ? "Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸàÿ≤ŸÜ ŸàÿßŸÑÿ∑ŸàŸÑ ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠." : "Please enter valid Weight and Height.";
        return;
      }

      // 1. BMI Calc
      const h_m = height / 100;
      const bmi = (weight / (h_m * h_m)).toFixed(1);
      
      let status = "";
      let color = "";
      
      if(bmi < 18.5) { status = lang==="ar"?"ŸÜÿ≠ÿßŸÅÿ©":"Underweight"; color="#3498db"; }
      else if(bmi < 25) { status = lang==="ar"?"Ÿàÿ≤ŸÜ ŸÖÿ´ÿßŸÑŸä":"Normal"; color="#2ecc71"; }
      else if(bmi < 30) { status = lang==="ar"?"Ÿàÿ≤ŸÜ ÿ≤ÿßÿ¶ÿØ":"Overweight"; color="#f1c40f"; }
      else { status = lang==="ar"?"ÿ≥ŸÖŸÜÿ©":"Obese"; color="#e74c3c"; }

      // 2. Risk Analysis (Connecting with real data)
      let riskMsg = "";
      const currentBP = parseInt(currentData.bp) || 0; // Using currentData from Firebase
      const currentPulse = parseInt(currentData.bpm) || 0;

      if(bmi >= 30) {
        if(currentBP > 130) riskMsg = lang==="ar" ? "‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±: ÿßŸÑÿ≥ŸÖŸÜÿ© ŸÖÿπ ÿ∂ÿ∫ÿ∑ ÿßŸÑÿØŸÖ ÿßŸÑŸÖÿ±ÿ™ŸÅÿπ ÿ™ÿ≤ŸäÿØ ÿÆÿ∑ÿ± ÿßŸÑŸÇŸÑÿ®." : "‚ö†Ô∏è Warning: Obesity + High BP increases cardiovascular risk.";
        else if(currentPulse > 100) riskMsg = lang==="ar" ? "‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±: ÿßŸÑÿ≥ŸÖŸÜÿ© ÿ™ÿ≥ÿ®ÿ® ÿ•ÿ¨ŸáÿßÿØÿßŸã ŸÑÿπÿ∂ŸÑÿ© ÿßŸÑŸÇŸÑÿ®." : "‚ö†Ô∏è Warning: Obesity is stressing your heart rate.";
        else riskMsg = lang==="ar" ? "ŸÜÿµŸäÿ≠ÿ©: ÿ•ŸÜŸÇÿßÿµ ÿßŸÑŸàÿ≤ŸÜ Ÿäÿ≠ÿ≥ŸÜ ÿµÿ≠ÿ™ŸÉ ÿßŸÑÿπÿßŸÖÿ©." : "Tip: Weight loss will improve overall vitals.";
      } else if (bmi < 18.5) {
         riskMsg = lang==="ar" ? "ŸÜÿµŸäÿ≠ÿ©: ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ™ÿ∫ÿ∞Ÿäÿ© ÿßŸÑÿ≥ŸÑŸäŸÖÿ© ŸÑÿ™ŸÇŸàŸäÿ© ÿßŸÑŸÖŸÜÿßÿπÿ©." : "Tip: Ensure proper nutrition to boost immunity.";
      } else {
         riskMsg = lang==="ar" ? "ÿ≠ÿßŸÅÿ∏ ÿπŸÑŸâ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿµÿ≠Ÿä ÿßŸÑŸÖŸÖÿ™ÿßÿ≤! ‚úÖ" : "Keep up the great healthy lifestyle! ‚úÖ";
      }

      // Display
      resultBox.style.display = "block";
      resultBox.style.borderLeftColor = color;
      resultBox.innerHTML = `
        <strong>BMI: ${bmi}</strong> (${status})<br><br>
        ${riskMsg}
      `;
      
      // Voice feedback
      if(voiceEnabled) {
         const utterance = new SpeechSynthesisUtterance(lang==="ar" ? `ŸÖÿ§ÿ¥ÿ± ŸÉÿ™ŸÑÿ© ÿßŸÑÿ¨ÿ≥ŸÖ ŸáŸà ${bmi}. ${status}` : `Your BMI is ${bmi}. You are ${status}`);
         utterance.lang = lang==="ar"?'ar-SA':'en-US';
         window.speechSynthesis.speak(utterance);
      }
    }

    // --- DATA & AI LOGIC ---
    let currentData = { temp: "--", bpm: "--", bp: "--", spo2: "--" };

    function updateAIAnalysis() {
      if(!currentUserId) return;
      const userRef = db.ref("current users/" + currentUserId);
      const lang = localStorage.getItem("language") || "en";

      userRef.limitToLast(1).once("value").then((snapshot) => {
        if(snapshot.exists()) {
          snapshot.forEach((child) => {
            const data = child.val();
            currentData = {
                temp: data.temperature || "--",
                bpm: data.bpm || "--",
                bp: data.pressure || "--",
                spo2: data.spo2 || "--"
            };

            const temp = parseFloat(data.temperature) || 0;
            const bpm = parseInt(data.bpm) || 0;
            const spo2 = parseFloat(data.spo2) || 0;
            
            let analysis = "";
            let status = "normal"; 

            if (temp > 38 && bpm > 100) {
              analysis = lang === "ar" ? "ÿ™ÿ≠ÿ∞Ÿäÿ±: ŸÖÿ§ÿ¥ÿ±ÿßÿ™ ÿ≠ŸÖŸâ. ÿßÿ≥ÿ™ÿ¥ÿ± ÿ∑ÿ®Ÿäÿ®." : "Warning: Fever signs. Consult doctor.";
              status = "danger";
            } else if (spo2 > 0 && spo2 < 95) {
              analysis = lang === "ar" ? "ÿ™ÿ≠ÿ∞Ÿäÿ±: ŸÜŸÇÿµ ÿ£ŸÉÿ≥ÿ¨ŸäŸÜ." : "Warning: Low Oxygen.";
              status = "danger";
            } else {
               analysis = lang === "ar" ? "ÿßŸÑŸÖÿ§ÿ¥ÿ±ÿßÿ™ ÿßŸÑÿ≠ŸäŸàŸäÿ© ŸÖÿ≥ÿ™ŸÇÿ±ÿ©." : "Vital signs are stable.";
               status = "normal";
            }

            document.getElementById("aiText").innerText = analysis;
            const card = document.querySelector(".ai-card");
            if(status === "danger") card.style.borderColor = "#ff416c";
            else card.style.borderColor = "#00ff88";
          });
        }
      });
    }

    // --- OTHER UTILS (Active Ping, Toast, Voice, etc.) ---
    async function checkInternetConnection() { try { await fetch("https://www.google.com/favicon.ico?"+new Date().getTime(),{mode:"no-cors"});return true;}catch(e){return false;}}
    async function updateStatus(){const d=document.getElementById('connectionStatus');if(await checkInternetConnection()){d.classList.remove('offline');d.title="Online";}else{d.classList.add('offline');d.title="Offline";showToast("Connection Lost!","error");}}
    setInterval(updateStatus,3000);

    function showToast(msg,type="info"){const c=document.getElementById("toastContainer");const t=document.createElement("div");t.className=`toast toast-${type}`;t.innerHTML=`<i class="fas fa-info-circle"></i><span>${msg}</span>`;c.appendChild(t);setTimeout(()=>t.remove(),3000);}
    
    function sendWhatsAppReport(){
        let p="20"+currentUserId.substring(1);
        let m=`üè• *Bioscan Report*%0ATemp: ${currentData.temp}%0APulse: ${currentData.bpm}%0ABP: ${currentData.bp}%0AOx: ${currentData.spo2}`;
        window.open(`https://wa.me/${p}?text=${m}`,'_blank');
    }
    
    function findHospitals(){window.open("https://www.google.com/maps/search/hospitals+near+me/","_blank");}
    function toggleFullScreen(){if(!document.fullscreenElement)document.documentElement.requestFullscreen();else if(document.exitFullscreen)document.exitFullscreen();}
    function closeMeasurements(){localStorage.removeItem("selectedUserId");window.location.href="index.html";}
    
    // Auto Logout
    let idle=0; setInterval(()=>{idle++;if(idle>=90)closeMeasurements();},1000);
    document.onmousemove=document.onkeypress=()=>{idle=0;};

    // Hover Voice
    let voiceEnabled=true;
    function toggleHoverVoice(){voiceEnabled=!voiceEnabled;document.getElementById('voiceToggle').classList.toggle('active');}
    function setupHoverVoice(){
        const map={'analyzeBtn':{ar:'ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ¨ÿ≥ŸÖ ÿßŸÑÿ∞ŸÉŸä',en:'Smart Body Analysis'},'hospitalBtn':{ar:'ÿ£ŸÇÿ±ÿ® ŸÖÿ≥ÿ™ÿ¥ŸÅŸâ',en:'Nearest Hospital'},'tempBtn':{ar:'ŸÇŸäÿßÿ≥ ÿßŸÑÿ≠ÿ±ÿßÿ±ÿ©',en:'Measure Temperature'}};
        Object.keys(map).forEach(id=>{
            const b=document.getElementById(id);
            if(b){b.onmouseenter=()=>{if(voiceEnabled){const u=new SpeechSynthesisUtterance(localStorage.getItem('language')==='ar'?map[id].ar:map[id].en);u.lang=localStorage.getItem('language')==='ar'?'ar-SA':'en-US';window.speechSynthesis.speak(u);}};b.onmouseleave=()=>{window.speechSynthesis.cancel();}}
        });
    }

    // Nav
    function goToTemperature(){window.location.href="temp.html";}
    function goToPulse(){window.location.href="pulse.html";}
    function goToPressure(){window.location.href="pressure.html";}
    function goToOxygen(){window.location.href="oxygen.html";}
    function goToVisionPage(){window.location.href="instruction.html";}
    function goToHistory(){window.location.href="history.html";}

    // Language
    const lang = localStorage.getItem("language") || "en";
    function applyLanguage(){
        if(lang==="ar"){
            document.body.style.direction="rtl";
            document.getElementById("titleText").innerHTML=`ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: <span>${currentUserId}</span>`;
            document.getElementById("aiTitle").innerText="ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ∞ŸÉŸä";
            document.getElementById("sidebarTitle").innerHTML='<i class="fas fa-brain"></i> ÿßŸÑŸÅÿ≠ÿµ ÿßŸÑÿ∞ŸÉŸä';
            document.getElementById("lblWeight").innerText="ÿßŸÑŸàÿ≤ŸÜ (ŸÉÿ¨ŸÖ)";
            document.getElementById("lblHeight").innerText="ÿßŸÑÿ∑ŸàŸÑ (ÿ≥ŸÖ)";
            document.getElementById("btnAnalyze").innerText="ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨";
            document.getElementById("hospitalBtn").title="ÿ£ŸÇÿ±ÿ® ŸÖÿ≥ÿ™ÿ¥ŸÅŸâ";
            document.getElementById("analyzeBtn").title="ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ¨ÿ≥ŸÖ";
            // Update Grid Buttons
            document.querySelector("#tempBtn span").innerText="ÿØÿ±ÿ¨ÿ© ÿßŸÑÿ≠ÿ±ÿßÿ±ÿ©";
            document.querySelector("#pulseBtn span").innerText="ŸÜÿ®ÿ∂ ÿßŸÑŸÇŸÑÿ®";
            document.querySelector("#bpBtn span").innerText="ÿ∂ÿ∫ÿ∑ ÿßŸÑÿØŸÖ";
            document.querySelector("#oxygenBtn span").innerText="ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ£ŸÉÿ≥ÿ¨ŸäŸÜ";
            document.querySelector("#visionBtn span").innerText="ŸÅÿ≠ÿµ ÿßŸÑŸÜÿ∏ÿ±";
            document.querySelector("#historyBtn span").innerText="ÿßŸÑÿ≥ÿ¨ŸÑ ŸàÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±";
            document.querySelector("#exitBtn").innerHTML='<i class="fas fa-sign-out-alt"></i> ÿÆÿ±Ÿàÿ¨';
        }
    }

    applyLanguage();
    window.onload = () => { updateAIAnalysis(); setupHoverVoice(); };
  </script>
</body>
</html>
