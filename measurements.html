<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Bioscan | Command Center</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Orbitron:wght@400;500;700&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* --- 1. THEME VARIABLES --- */
    :root {
      --primary-neon: #00f2ff;
      --secondary-neon: #7000ff;
      --bg-dark: #020408;
      --glass-panel: rgba(8, 15, 25, 0.92);
      --border-color: rgba(0, 242, 255, 0.4);
      --text-main: #e0f7fa;
      --error: #ff2a2a;
      --success: #00ff88;
      --warning: #f39c12;
      
      /* Colors */
      --temp-color: #ff9f43;
      --pulse-color: #ff4757;
      --bp-color: #a29bfe;
      --ox-color: #48dbfb;
      --vision-color: #1dd1a1;
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0; padding: 0;
      font-family: 'Rajdhani', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-main);
      min-height: 100vh;
      overflow-x: hidden;
      display: flex; flex-direction: column; align-items: center;
      padding-top: 85px; 
      padding-bottom: 90px;
    }

    /* --- 2. SKELETON LOADING --- */
    .skeleton {
        color: transparent !important;
        background: linear-gradient(90deg, rgba(255,255,255,0.05), rgba(255,255,255,0.15), rgba(255,255,255,0.05));
        background-size: 200% 100%; animation: shimmer 1.5s infinite linear;
        border-radius: 5px; display: inline-block; min-width: 60px; min-height: 20px;
    }
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

    /* --- 3. BIO BACKGROUND --- */
    #bio-background {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
        overflow: hidden; background: radial-gradient(circle at center, #0f1c2e 0%, #000000 100%);
    }
    .bio-symbol {
        position: absolute; color: var(--primary-neon); opacity: 0.15;
        animation: floatBio 20s linear infinite; pointer-events: none;
    }
    @keyframes floatBio {
        0% { transform: translateY(110vh) rotate(0deg) scale(0.8); opacity: 0; }
        50% { opacity: 0.2; }
        100% { transform: translateY(-10vh) rotate(360deg) scale(1.2); opacity: 0; }
    }

    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: #050b14; }
    ::-webkit-scrollbar-thumb { background: var(--primary-neon); border-radius: 10px; }

    /* --- 4. HEADER (PC DEFAULT) --- */
    .user-card { 
      position: fixed; top: 0; left: 0; width: 100%; height: 75px;
      background: rgba(5, 10, 18, 0.98); backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--primary-neon); 
      box-shadow: 0 0 25px rgba(0, 242, 255, 0.15); z-index: 100;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 20px; margin: 0; border-radius: 0;
    }
    .user-left { display: flex; align-items: center; gap: 12px; }
    .user-avatar { font-size: 1.8rem; color: var(--primary-neon); filter: drop-shadow(0 0 8px var(--primary-neon)); flex-shrink: 0; }
    .user-info { display: flex; flex-direction: column; overflow: hidden; }
    .user-info h2 { margin: 0; font-family: 'Orbitron', sans-serif; font-size: 0.7rem; color: #888; letter-spacing: 1px; white-space: nowrap; }
    .user-info span { font-size: 1rem; color: #fff; font-weight: 700; letter-spacing: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    .top-actions { display: flex; align-items: center; gap: 10px; }
    .icon-btn { 
      background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); 
      color: var(--primary-neon); width: 38px; height: 38px; border-radius: 8px;
      cursor: pointer; transition: 0.3s; font-size: 1rem;
      display: flex; justify-content: center; align-items: center;
    }
    .icon-btn:hover { background: var(--primary-neon); color: #000; box-shadow: 0 0 15px var(--primary-neon); }
    .icon-btn.active { background: var(--success); color: #000; box-shadow: 0 0 15px var(--success); border-color: var(--success); }
    .icon-btn.listening { background: var(--error); color: #fff; animation: pulseRed 1s infinite; border-color: var(--error); }
    @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(255, 65, 108, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 65, 108, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 65, 108, 0); } }
    .whatsapp-btn { color: #25D366; border-color: #25D366; }
    .whatsapp-btn:hover { background: #25D366; color: #fff; box-shadow: 0 0 15px #25D366; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: var(--success); box-shadow: 0 0 10px var(--success); margin-left: 5px; }
    .status-dot.offline { background-color: var(--error); box-shadow: 0 0 10px var(--error); animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0.5; } }
    #langBtn { font-family: 'Orbitron', sans-serif; font-weight: bold; font-size: 0.75rem; width: 38px; }

    /* --- 5. AI CONSOLE --- */
    .ai-card { 
      width: 95%; max-width: 900px; margin-top: 10px;
      background: linear-gradient(135deg, rgba(10, 20, 35, 0.95), rgba(5, 10, 20, 0.95));
      border: 1px solid var(--primary-neon); border-radius: 20px; 
      padding: 20px; margin-bottom: 20px; 
      display: flex; flex-direction: column; gap: 15px; 
      box-shadow: 0 0 20px rgba(0, 242, 255, 0.1); 
      position: relative; overflow: hidden; transition: all 0.5s ease;
    }
    
    .ai-header { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; width: 100%; }
    .ai-brand { display: flex; align-items: center; gap: 12px; }
    .ai-icon { 
      font-size: 1.5rem; color: var(--primary-neon); 
      background: rgba(0, 242, 255, 0.1); width: 40px; height: 40px; 
      border-radius: 10px; display: flex; justify-content: center; align-items: center; 
      border: 1px solid var(--primary-neon); animation: pulseAI 2s infinite;
    }
    .ai-title h3 { margin: 0; font-family: 'Orbitron', sans-serif; font-size: 1rem; color: var(--primary-neon); letter-spacing: 1px; }
    .ai-title p { margin: 2px 0 0; font-size: 0.7rem; color: #888; }

    #lastReadingTime {
        font-size: 0.65rem; color: var(--primary-neon); font-family: 'Orbitron', sans-serif;
        background: rgba(0, 242, 255, 0.1); padding: 4px 8px; border-radius: 12px; border: 1px solid rgba(0, 242, 255, 0.2);
    }

    .ai-advice-container { 
        display: flex; gap: 10px; width: 100%; 
        overflow-x: auto; padding-bottom: 5px; scroll-behavior: smooth;
    }
    .advice-box {
        background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
        border-radius: 12px; padding: 12px; 
        min-width: 140px; flex: 0 0 auto;
        display: flex; flex-direction: column; align-items: center; text-align: center; gap: 8px;
        transition: 0.3s;
    }
    .advice-box:hover { background: rgba(255,255,255,0.07); transform: translateY(-2px); border-color: var(--primary-neon); }
    .advice-icon { font-size: 1.5rem; padding-bottom: 5px; }
    .advice-content h4 { margin: 0 0 3px 0; font-size: 0.9rem; color: #fff; font-family: 'Cairo', sans-serif; }
    .advice-content p { margin: 0; font-size: 0.8rem; color: #ccc; line-height: 1.3; font-family: 'Cairo', sans-serif; }

    @keyframes pulseAI { 0% { box-shadow: 0 0 0 0 rgba(0, 242, 255, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(0, 242, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 242, 255, 0); } }

    /* --- 6. MODULES --- */
    .measure-container { 
      display: grid; grid-template-columns: repeat(2, 1fr); 
      gap: 15px; width: 95%; max-width: 900px; margin-bottom: 20px; 
    }
    
    .measure-btn { 
      background: var(--glass-panel); backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; 
      padding: 15px 5px; cursor: pointer; position: relative; overflow: hidden; height: 140px;
      display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;
      transition: 0.4s;
    }
    .measure-btn:hover { transform: translateY(-5px); background: rgba(20, 30, 45, 0.95); }
    
    .temp { border-bottom: 3px solid var(--temp-color); } .temp i { color: var(--temp-color); filter: drop-shadow(0 0 8px var(--temp-color)); }
    .pulse { border-bottom: 3px solid var(--pulse-color); } .pulse i { color: var(--pulse-color); animation: heartBeat 1.5s infinite; }
    .pressure { border-bottom: 3px solid var(--bp-color); } .pressure i { color: var(--bp-color); }
    .oxygen { border-bottom: 3px solid var(--ox-color); } .oxygen i { color: var(--ox-color); animation: breathe 3s infinite ease-in-out; }
    
    @keyframes heartBeat { 0% { transform: scale(1); } 15% { transform: scale(1.2); } 30% { transform: scale(1); } 45% { transform: scale(1.1); } 60% { transform: scale(1); } }
    @keyframes breathe { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }

    .measure-btn i { font-size: 2rem; margin-bottom: 5px; }
    .measure-btn span { 
        font-size: 1.1rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;
        text-shadow: none; 
    }
    .temp span { color: #d35400; } 
    .pulse span { color: #c0392b; } 
    .pressure span { color: #8e44ad; } 
    .oxygen span { color: #008b8b; } 
    
    .value-display { font-family: 'Orbitron', sans-serif; font-size: 1.3rem; font-weight: 700; color: #fff; margin-top: 5px; text-shadow: 0 0 10px rgba(255,255,255,0.2); }

    /* SAVE BUTTON */
    .save-session-btn {
        width: 95%; max-width: 900px; padding: 15px; border: none; border-radius: 12px;
        background: linear-gradient(90deg, #11998e, #38ef7d);
        color: #fff; font-family: 'Orbitron', sans-serif; font-size: 1rem; letter-spacing: 1px; font-weight: bold;
        cursor: pointer; transition: 0.3s; margin-bottom: 20px;
        box-shadow: 0 0 20px rgba(56, 239, 125, 0.4); text-align: center;
        display: flex; align-items: center; justify-content: center; gap: 10px;
        animation: glowGreen 3s infinite ease-in-out;
    }
    .save-session-btn:hover { transform: scale(1.02); }
    @keyframes glowGreen { 0%, 100% { box-shadow: 0 0 20px rgba(56, 239, 125, 0.4); } 50% { box-shadow: 0 0 40px rgba(56, 239, 125, 0.7); } }

    /* --- 7. ACTION DOCK --- */
    .dock-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 95%; max-width: 900px; margin-bottom: 20px; }
    .dock-btn {
        background: linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.06));
        border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;
        padding: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;
        cursor: pointer; transition: 0.3s; flex-direction: column; text-align: center;
    }
    .dock-btn:hover { transform: scale(1.02); }
    .vision-dock { border-bottom: 2px solid var(--vision-color); } .vision-dock i { font-size: 1.5rem; color: var(--vision-color); }
    .history-dock { border-bottom: 2px solid var(--secondary-neon); } .history-dock i { font-size: 1.5rem; color: var(--secondary-neon); }
    .dock-text { margin-top: 5px; }
    .dock-title { display: block; color: #fff; font-family: 'Orbitron', sans-serif; font-size: 0.8rem; }
    .dock-sub { display: none; }

    .close-btn { 
      background: rgba(255, 42, 42, 0.1); color: var(--error); border: 1px solid var(--error);
      padding: 10px 20px; border-radius: 50px; font-size: 0.85rem; font-family: 'Orbitron', sans-serif; 
      cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 8px; margin-top: 10px;
    }
    .close-btn:hover { background: var(--error); color: #fff; box-shadow: 0 0 25px var(--error); transform: scale(1.05); }

    /* --- 8. FABs --- */
    .fab-container { position: fixed; bottom: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 15px; }
    .fab-right { right: 20px; align-items: flex-end; }
    .fab-left { left: 20px; align-items: flex-start; }

    .sos-wrapper { position: relative; width: 60px; height: 60px; margin-top: 5px; }
    .sos-fab { width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #ff416c, #ff0000); color: white; border: 2px solid rgba(255,255,255,0.2); box-shadow: 0 0 20px rgba(255, 0, 0, 0.6); cursor: pointer; display: flex; align-items: center; justify-content: center; font-family: 'Orbitron', sans-serif; font-weight: bold; font-size: 14px; animation: sosPulse 2s infinite; }
    @keyframes sosPulse { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(255, 0, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); } }
    .sos-settings-btn { position: absolute; top: -5px; right: -5px; width: 24px; height: 24px; background: #111; border-radius: 50%; color: var(--error); border: 1px solid var(--error); font-size: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1002; }

    .hospital-fab, .analyze-fab { width: 50px; height: 50px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; backdrop-filter: blur(5px); }
    .hospital-fab { background: linear-gradient(135deg, #00d2ff, #3a7bd5); box-shadow: 0 0 10px rgba(0, 210, 255, 0.4); }
    .analyze-fab { background: linear-gradient(135deg, #6c5ce7, #a29bfe); box-shadow: 0 0 10px rgba(108, 92, 231, 0.5); }

    /* Modals & Sidebar */
    .sidebar-overlay, .custom-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 4000; display: none; justify-content: center; align-items: center; opacity: 0; transition: 0.3s; }
    .sidebar-overlay.active, .custom-modal-overlay.active { display: flex; opacity: 1; }
    
    .sidebar { position: fixed; top: 0; left: -360px; width: 85%; max-width: 320px; height: 100%; background: #0b101a; border-right: 1px solid var(--primary-neon); box-shadow: 10px 0 50px rgba(0,0,0,0.8); z-index: 4001; transition: left 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); padding: 30px 20px; }
    .sidebar.active { left: 0; }
    .sidebar-header { border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
    .sidebar-header h3 { color: var(--primary-neon); margin: 0; font-family: 'Orbitron', sans-serif; font-size: 1.2rem; }
    .close-sidebar { background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; }
    .sidebar-input { width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; margin-bottom: 15px; text-align: center; font-size: 1.1rem; }
    .calc-btn { width: 100%; padding: 12px; background: var(--primary-neon); color: #000; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; font-family: 'Orbitron', sans-serif; }
    .result-box { margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 8px; border-left: 3px solid var(--primary-neon); display: none; }

    .custom-modal-box { background: #0b101a; border: 1px solid var(--primary-neon); padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 0 60px rgba(0, 242, 255, 0.2); transform: scale(0.9); transition: 0.3s; z-index: 4002; }
    .custom-modal-overlay.active .custom-modal-box { transform: scale(1); }
    .modal-icon { font-size: 2.5rem; margin-bottom: 15px; color: var(--primary-neon); }
    .modal-input { width: 100%; padding: 12px; margin-bottom: 20px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; color: #fff; text-align: center; font-size: 1.2rem; }
    .modal-actions { display: flex; justify-content: center; gap: 10px; }
    .modal-btn { padding: 10px 25px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
    .btn-confirm { background: var(--primary-neon); color: #000; }
    .btn-danger { background: var(--error); color: #fff; }
    .btn-cancel { background: transparent; border: 1px solid #555; color: #aaa; }

    /* Toast */
    .toast-container { position: fixed; top: 90px; right: 20px; z-index: 5000; display: flex; flex-direction: column; gap: 10px; }
    .toast { background: rgba(5, 11, 20, 0.95); color: white; padding: 12px 20px; border-radius: 12px; display: flex; align-items: center; gap: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.6); border-left: 4px solid; animation: slideIn 0.4s ease, fadeOut 0.5s ease 4s forwards; }
    @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
    @keyframes fadeOut { to { opacity: 0; } }
    .toast-error { border-color: var(--error); } .toast-error i { color: var(--error); }
    .toast-info { border-color: var(--primary-neon); } .toast-info i { color: var(--primary-neon); }
    .toast-success { border-color: var(--success); } .toast-success i { color: var(--success); }

    /* MOBILE SPECIFIC FIXES */
    @media screen and (max-width: 768px) {
      .user-card { 
          padding: 0 10px; /* Less Padding */
          height: 65px; 
          gap: 10px; /* Space between ID and Buttons */
      }
      .user-avatar { font-size: 1.4rem; }
      
      .user-info h2 { font-size: 0.6rem; }
      .user-info span { 
          font-size: 0.85rem; 
          letter-spacing: 0.5px; 
      }
      
      .top-actions { gap: 5px; } /* Tighter Buttons */
      .icon-btn { width: 32px; height: 32px; font-size: 0.85rem; }
      #langBtn { width: 32px; font-size: 0.65rem; }

      .measure-container { grid-template-columns: repeat(2, 1fr); gap: 12px; }
      .measure-btn { height: 150px; }
      .dock-container { grid-template-columns: 1fr; }
      .fab-right { right: 20px; bottom: 20px; }
      .fab-left { left: 20px; bottom: 20px; }
    }
  </style>
</head>
<body>

  <div id="bio-background"></div>
  <div class="toast-container" id="toastContainer"></div>

  <div class="user-card">
    <div class="user-left">
        <div class="user-avatar"><i class="fas fa-user"></i></div>
        <div class="user-info">
            <h2>USER ID</h2>
            <span id="currentUserName">Loading...</span>
        </div>
    </div>
    <div class="top-actions">
      <button class="icon-btn" id="langBtn" onclick="toggleLanguage()" title="Switch Language">
        AR
      </button>
      
      <button class="icon-btn" id="micBtn" onclick="startListening()" title="Voice Commands">
        <i class="fas fa-microphone"></i>
      </button>
      <button class="icon-btn whatsapp-btn" id="whatsappBtn" onclick="sendWhatsAppReport()" title="Send Report">
        <i class="fab fa-whatsapp"></i>
      </button>
      <button class="icon-btn active" id="voiceToggle" onclick="toggleHoverVoice()" title="Voice Guide">
        <i class="fas fa-volume-up"></i>
      </button>
      <button class="icon-btn" onclick="toggleFullScreen()" title="Full Screen">
        <i class="fas fa-expand"></i>
      </button>
      <div id="connectionStatus" class="status-dot" title="Online"></div>
    </div>
  </div>

  <div class="ai-card">
    <div class="ai-header">
        <div class="ai-brand">
            <div class="ai-icon"><i class="fas fa-robot"></i></div>
            <div class="ai-title">
                <h3 id="aiTitle">AI DIAGNOSTICS</h3>
                <p>Real-time Health Analysis</p>
            </div>
        </div>
        <div id="lastReadingTime">Last updated: --</div>
    </div>
    <div class="ai-content">
      <div id="aiText">System Initializing... Awaiting sensor data.</div>
    </div>
  </div>

  <div class="measure-container">
    <div class="measure-btn temp" id="tempBtn" onclick="goToTemperature()">
      <i class="fas fa-thermometer-half"></i> <span id="lblTemp">Temperature</span>
      <div class="value-display skeleton" id="tempValue">--</div>
    </div>
    <div class="measure-btn pulse" id="pulseBtn" onclick="goToPulse()">
      <i class="fas fa-heartbeat"></i> <span id="lblPulse">Pulse Rate</span>
      <div class="value-display skeleton" id="pulseValue">--</div>
    </div>
    <div class="measure-btn pressure" id="bpBtn" onclick="goToPressure()">
      <i class="fas fa-stethoscope"></i> <span id="lblBp">Blood Pressure</span>
      <div class="value-display skeleton" id="bpValue">--</div>
    </div>
    <div class="measure-btn oxygen" id="oxygenBtn" onclick="goToOxygen()">
      <i class="fas fa-lungs"></i> <span id="lblO2">Oxygen (SpO2)</span>
      <div class="value-display skeleton" id="spo2Value">--</div>
    </div>
  </div>

  <button class="save-session-btn" onclick="saveCurrentSession()">
      <i class="fas fa-save"></i> <span id="saveBtnText">SAVE ALL READINGS</span>
  </button>

  <div class="dock-container">
      <div class="dock-btn vision-dock" id="visionBtn" onclick="goToVisionPage()">
          <i class="fas fa-eye"></i>
          <div class="dock-text">
              <span class="dock-title" id="lblVision">VISION TEST</span>
              <span class="dock-sub" id="subVision">Start eye exam</span>
          </div>
      </div>
      <div class="dock-btn history-dock" id="historyBtn" onclick="goToHistory()">
          <i class="fas fa-file-medical-alt"></i>
          <div class="dock-text">
              <span class="dock-title" id="lblHistory">HISTORY LOGS</span>
              <span class="dock-sub" id="subHistory">View previous data</span>
          </div>
      </div>
  </div>

  <button class="close-btn" id="exitBtn" onclick="closeMeasurements()">
    <i class="fas fa-power-off"></i> <span id="lblExit">TERMINATE SESSION</span>
  </button>

  <div class="fab-container fab-right">
    <button class="hospital-fab" id="hospitalBtn" onclick="findHospitals()" title="Nearest Hospitals"><i class="fas fa-hospital"></i></button>
    <div class="sos-wrapper">
        <button class="sos-settings-btn" onclick="openContactModal()" title="Settings"><i class="fas fa-cog"></i></button>
        <button class="sos-fab" id="sosBtn" onclick="triggerSOS()">SOS</button>
    </div>
  </div>

  <div class="fab-container fab-left">
    <button class="analyze-fab" id="analyzeBtn" onclick="toggleSidebar(true)"><i class="fas fa-chart-pie"></i></button>
  </div>

  <div class="custom-modal-overlay" id="contactModal">
      <div class="custom-modal-box">
          <div class="modal-icon"><i class="fas fa-address-book"></i></div>
          <h3 class="modal-title" id="contactTitle">Emergency Contact</h3>
          <p id="contactText" class="modal-text" style="color:#aaa;">Enter phone number</p>
          <input type="number" id="emergencyInput" class="modal-input" placeholder="010xxxxxxxx">
          <div class="modal-actions"><button class="modal-btn btn-cancel" onclick="closeModals()">Cancel</button><button class="modal-btn btn-confirm" onclick="saveEmergencyContact()">Save</button></div>
      </div>
  </div>

  <div class="custom-modal-overlay" id="confirmModal">
      <div class="custom-modal-box">
          <div class="modal-icon warning" style="color:var(--error);"><i class="fas fa-exclamation-triangle"></i></div>
          <h3 class="modal-title" id="confirmTitle">Emergency Alert</h3>
          <p id="confirmText" class="modal-text" style="color:#aaa;">Confirm SOS?</p>
          <div class="modal-actions"><button class="modal-btn btn-cancel" onclick="closeModals()">Cancel</button><button class="modal-btn btn-danger" onclick="executeSOS()">YES, SEND HELP</button></div>
      </div>
  </div>

  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar(false)"></div>
  <div class="sidebar" id="smartSidebar">
    <div class="sidebar-header"><h3 id="sidebarTitle"><i class="fas fa-brain"></i> SMART CHECK</h3><button class="close-sidebar" onclick="toggleSidebar(false)">√ó</button></div>
    <div class="sidebar-content">
      <label id="lblWeight" style="color:#aaa; display:block; margin-bottom:5px;">Weight (kg)</label><input type="number" id="inputWeight" class="sidebar-input" placeholder="e.g. 75">
      <label id="lblHeight" style="color:#aaa; display:block; margin-bottom:5px;">Height (cm)</label><input type="number" id="inputHeight" class="sidebar-input" placeholder="e.g. 175">
      <button class="calc-btn" onclick="calculateHealthRisk()" id="btnAnalyze">ANALYZE DATA</button>
      <div id="analysisResult" class="result-box"></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

  <script>
    // --- 1. SETUP BACKGROUND ---
    function createBioBackground() {
        const container = document.getElementById('bio-background');
        const icons = ['fa-dna', 'fa-heartbeat', 'fa-notes-medical', 'fa-pills', 'fa-virus', 'fa-microscope', 'fa-user-md', 'fa-syringe', 'fa-lungs', 'fa-brain'];
        const count = 30; 
        for (let i = 0; i < count; i++) {
            const el = document.createElement('i');
            el.classList.add('fas', icons[Math.floor(Math.random() * icons.length)], 'bio-symbol');
            el.style.left = Math.random() * 100 + 'vw';
            const size = Math.random() * 2 + 0.5;
            el.style.fontSize = size + 'rem';
            el.style.opacity = Math.random() * 0.2;
            el.style.animationDuration = (Math.random() * 20 + 15) + 's';
            el.style.animationDelay = (Math.random() * 10) + 's';
            container.appendChild(el);
        }
    }
    createBioBackground();

    // --- 2. CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyAOwMQhsRM2PdD_FLjW_8Oi1WlFS3EO5pY",
      authDomain: "smart-a76a0.firebaseapp.com",
      databaseURL: "https://smart-a76a0-default-rtdb.firebaseio.com",
      projectId: "smart-a76a0",
      messagingSenderId: "343693501983",
      appId: "1:343693501983:web:10ea3fce9d990a2455172a"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth(); 
    auth.signInAnonymously().catch(console.error);

    const PATIENT_DATA_PATH = 'PatientData';
    const currentUserId = localStorage.getItem("selectedUserId");
    const userSpan = document.getElementById('currentUserName');
    if(!currentUserId) window.location.href="index.html"; 
    else userSpan.innerText = currentUserId;

    // --- 3. VOICE & UI LOGIC ---
    function toggleSidebar(show) {
      const sidebar = document.getElementById("smartSidebar");
      const overlay = document.getElementById("sidebarOverlay");
      if(show) { 
          sidebar.classList.add("active"); 
          overlay.style.display = "block"; setTimeout(() => overlay.classList.add("active"), 10);
      } else { 
          sidebar.classList.remove("active"); overlay.classList.remove("active");
          setTimeout(() => overlay.style.display = "none", 300);
      }
    }

    function startListening() {
        if (!('webkitSpeechRecognition' in window)) { showToast("Voice not supported", "error"); return; }
        const recognition = new webkitSpeechRecognition();
        recognition.lang = currentLang === "ar" ? "ar-SA" : "en-US";
        recognition.start();
        const btn = document.getElementById('micBtn'); btn.classList.add('listening');
        recognition.onresult = (event) => {
            const cmd = event.results[0][0].transcript.toLowerCase();
            showToast(`Heard: "${cmd}"`, "info");
            if(cmd.includes('temp') || cmd.includes('ÿ≠ÿ±ÿßÿ±ÿ©')) goToTemperature();
            else if(cmd.includes('pulse') || cmd.includes('ŸÜÿ®ÿ∂')) goToPulse();
            else if(cmd.includes('pressure') || cmd.includes('ÿ∂ÿ∫ÿ∑')) goToPressure();
            else if(cmd.includes('oxygen') || cmd.includes('ÿßŸÉÿ≥ÿ¨ŸäŸÜ')) goToOxygen();
            else if(cmd.includes('vision') || cmd.includes('ŸÜÿ∏ÿ±')) goToVisionPage();
            else if(cmd.includes('history') || cmd.includes('ÿ≥ÿ¨ŸÑ')) goToHistory();
            else if(cmd.includes('emergency') || cmd.includes('ÿ∑Ÿàÿßÿ±ÿ¶')) triggerSOS();
            btn.classList.remove('listening');
        };
        recognition.onend = () => btn.classList.remove('listening');
    }

    // --- 4. LANGUAGE LOGIC ---
    let currentLang = 'en'; 

    function toggleLanguage() {
        currentLang = currentLang === 'en' ? 'ar' : 'en';
        localStorage.setItem("language", currentLang); 
        applyLanguage();
    }

    function applyLanguage() {
        const isAr = currentLang === 'ar';
        document.body.classList.toggle('rtl', isAr);
        document.getElementById('langBtn').innerText = isAr ? 'EN' : 'AR'; 

        const texts = {
            en: {
                uid: "USER ID", aiT: "AI DIAGNOSTICS", aiSub: "Real-time Health Analysis",
                temp: "Temperature", pulse: "Pulse Rate", bp: "Blood Pressure", ox: "Oxygen (SpO2)",
                vision: "VISION TEST", vSub: "Start eye exam", hist: "HISTORY LOGS", hSub: "View previous data",
                save: "SAVE ALL READINGS", exit: "TERMINATE SESSION",
                sbTitle: "SMART CHECK", w: "Weight (kg)", h: "Height (cm)", calc: "ANALYZE DATA",
                conTitle: "Emergency Contact", conTxt: "Enter phone number",
                sosTitle: "Emergency Alert", sosTxt: "Confirm SOS?",
                saveBtn: "Save", cancel: "Cancel", yes: "YES, SEND HELP"
            },
            ar: {
                uid: "ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ", aiT: "ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ∞ŸÉŸä", aiSub: "ÿ™ÿ≠ŸÑŸäŸÑ ÿµÿ≠Ÿä ŸÅŸàÿ±Ÿä",
                temp: "ÿØÿ±ÿ¨ÿ© ÿßŸÑÿ≠ÿ±ÿßÿ±ÿ©", pulse: "ŸÜÿ®ÿ∂ ÿßŸÑŸÇŸÑÿ®", bp: "ÿ∂ÿ∫ÿ∑ ÿßŸÑÿØŸÖ", ox: "ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ£ŸÉÿ≥ÿ¨ŸäŸÜ",
                vision: "ŸÅÿ≠ÿµ ÿßŸÑŸÜÿ∏ÿ±", vSub: "ÿ®ÿØÿ° ÿßŸÑŸÅÿ≠ÿµ", hist: "ÿ≥ÿ¨ŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™", hSub: "ÿπÿ±ÿ∂ ÿßŸÑŸÇÿ±ÿßÿ°ÿßÿ™ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©",
                save: "ÿ≠ŸÅÿ∏ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÇÿ±ÿßÿ°ÿßÿ™", exit: "ÿ•ŸÜŸáÿßÿ° ÿßŸÑÿ¨ŸÑÿ≥ÿ©",
                sbTitle: "ÿßŸÑŸÅÿ≠ÿµ ÿßŸÑÿ∞ŸÉŸä", w: "ÿßŸÑŸàÿ≤ŸÜ (ŸÉÿ¨ŸÖ)", h: "ÿßŸÑÿ∑ŸàŸÑ (ÿ≥ŸÖ)", calc: "ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨",
                conTitle: "ÿ¨Ÿáÿ© ÿßÿ™ÿµÿßŸÑ ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶", conTxt: "ÿ£ÿØÿÆŸÑ ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ",
                sosTitle: "ÿ™ŸÜÿ®ŸäŸá ÿ∑Ÿàÿßÿ±ÿ¶", sosTxt: "ŸáŸÑ ÿ™ŸàÿØ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßÿ≥ÿ™ÿ∫ÿßÿ´ÿ©ÿü",
                saveBtn: "ÿ≠ŸÅÿ∏", cancel: "ÿ•ŸÑÿ∫ÿßÿ°", yes: "ŸÜÿπŸÖÿå ÿ£ÿ±ÿ≥ŸÑ ÿßŸÑŸÖÿ≥ÿßÿπÿØÿ©"
            }
        };

        const t = isAr ? texts.ar : texts.en;

        document.querySelector(".user-info h2").innerText = t.uid;
        document.getElementById("aiTitle").innerText = t.aiT;
        document.querySelector(".ai-title p").innerText = t.aiSub;
        
        document.getElementById("lblTemp").innerText = t.temp;
        document.getElementById("lblPulse").innerText = t.pulse;
        document.getElementById("lblBp").innerText = t.bp;
        document.getElementById("lblO2").innerText = t.ox;
        
        document.getElementById("lblVision").innerText = t.vision;
        document.getElementById("subVision").innerText = t.vSub;
        document.getElementById("lblHistory").innerText = t.hist;
        document.getElementById("subHistory").innerText = t.hSub;
        
        document.getElementById("saveBtnText").innerText = t.save;
        document.getElementById("lblExit").innerText = t.exit;
        
        document.getElementById("sidebarTitle").innerHTML = `<i class="fas fa-brain"></i> ${t.sbTitle}`;
        document.getElementById("lblWeight").innerText = t.w;
        document.getElementById("lblHeight").innerText = t.h;
        document.getElementById("btnAnalyze").innerText = t.calc;
        
        document.getElementById("contactTitle").innerText = t.conTitle;
        document.getElementById("contactText").innerText = t.conTxt;
        document.querySelector("#contactModal .btn-confirm").innerText = t.saveBtn;
        document.querySelector("#contactModal .btn-cancel").innerText = t.cancel;
        
        document.getElementById("confirmTitle").innerText = t.sosTitle;
        document.getElementById("confirmText").innerText = t.sosTxt;
        document.querySelector("#confirmModal .btn-danger").innerText = t.yes;
        document.querySelector("#confirmModal .btn-cancel").innerText = t.cancel;

        updateAIAnalysis();
    }

    // --- 5. DATA & SAVING ---
    let currentData = { temp: "--", bpm: "--", bp: "--", spo2: "--" };
    let lastTimestamp = "--";

    function saveCurrentSession() {
        if (currentData.temp === "--" && currentData.bpm === "--") {
            showToast(currentLang === "ar" ? "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿ≠ŸÅÿ∏!" : "No data to save!", "error");
            return;
        }
        const readableDate = new Date().toLocaleString('en-US'); 
        const historyRef = db.ref(PATIENT_DATA_PATH + '/' + currentUserId + '/History');
        historyRef.push({
            timestamp: readableDate,
            sortKey: firebase.database.ServerValue.TIMESTAMP,
            temperature: currentData.temp,
            bpm: currentData.bpm,
            pressure: currentData.bp,
            spo2: currentData.spo2
        }).then(() => {
            showToast(currentLang === "ar" ? "ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ¨ŸÑÿ≥ÿ© ÿ®ŸÜÿ¨ÿßÿ≠" : "Session Saved Successfully", "success");
        }).catch(err => {
            showToast("Save Error", "error");
        });
    }

    // --- 6. AI LOGIC ---
    function updateAIAnalysis() {
      if(!currentUserId) return;
      const userRef = db.ref(PATIENT_DATA_PATH + '/' + currentUserId);
      userRef.on("value", (snapshot) => {
        if(snapshot.exists()) {
            const data = snapshot.val();
            const sensorDataString = data.SensorData || "No measurement recorded yet";
            const sensorValues = extractSensorValues(sensorDataString);
            
            currentData = {
                temp: sensorValues.temp || "--",
                bpm: sensorValues.bpm || "--",
                bp: sensorValues.bp || "--",
                spo2: sensorValues.spo2 || "--"
            };
            lastTimestamp = data.Timestamp || "--";

            ['bpValue', 'spo2Value', 'tempValue', 'pulseValue'].forEach((id, i) => {
                const vals = [currentData.bp, currentData.spo2, currentData.temp, currentData.bpm];
                const units = ['', '%', '¬∞C', ' bpm'];
                if(vals[i] !== "--") {
                    const el = document.getElementById(id);
                    el.classList.remove('skeleton'); el.innerText = vals[i] + units[i];
                }
            });

            document.getElementById('lastReadingTime').innerText = (currentLang === 'ar' ? 'ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´: ' : 'Last updated: ') + lastTimestamp;
            
            const temp = parseFloat(currentData.temp) || 0;
            const bpm = parseInt(currentData.bpm) || 0;
            const spo2 = parseFloat(currentData.spo2) || 0;
            let sys = 0; if(currentData.bp && currentData.bp.includes('/')) sys = parseInt(currentData.bp.split('/')[0]);

            let statusColor = "#00ff88"; 
            let adviceList = [];
            let headerMsg = currentLang === "ar" ? "‚úÖ ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑÿπÿßŸÖÿ© ŸÖÿ≥ÿ™ŸÇÿ±ÿ©." : "‚úÖ General condition is stable.";

            if (sensorDataString === "No measurement recorded yet") {
                headerMsg = currentLang === "ar" ? "‚è≥ ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ®ÿØÿ° ÿßŸÑŸÇŸäÿßÿ≥ÿßÿ™..." : "‚è≥ Waiting for measurements...";
            } else {
                const isAr = currentLang === "ar";
                
                if(sys > 140) {
                    statusColor = "#ff416c";
                    headerMsg = isAr ? "‚ö†Ô∏è ÿ∂ÿ∫ÿ∑ ÿßŸÑÿØŸÖ ŸÖÿ±ÿ™ŸÅÿπ" : "‚ö†Ô∏è High Blood Pressure";
                    adviceList.push({icon: "fa-carrot", title: isAr?"ÿ∫ÿ∞ÿßÿ°":"Diet", text: isAr?"ŸÇŸÑŸÑ ÿßŸÑÿµŸàÿØŸäŸàŸÖÿå ÿ™ŸÜÿßŸàŸÑ ÿßŸÑŸÖŸàÿ≤ ŸàÿßŸÑÿ≥ÿ®ÿßŸÜÿÆ":"Cut Sodium, eat Bananas/Spinach"});
                    adviceList.push({icon: "fa-mug-hot", title: isAr?"ŸÖÿ¥ÿ±Ÿàÿ®":"Drink", text: isAr?"ŸÉÿ±ŸÉÿØŸäŸá ÿ®ÿßÿ±ÿØ ÿ£Ÿà ÿπÿµŸäÿ± ÿ®ŸÜÿ¨ÿ±":"Cold Hibiscus or Beet Juice"});
                    adviceList.push({icon: "fa-bed", title: isAr?"ÿ±ÿßÿ≠ÿ©":"Rest", text: isAr?"ÿßÿ≥ÿ™ÿ±ÿÆŸê Ÿàÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ™Ÿàÿ™ÿ± ŸÅŸàÿ±ÿßŸã":"Relax immediately, avoid stress"});
                } 
                else if (sys > 0 && sys < 90) {
                     statusColor = "#f1c40f";
                     headerMsg = isAr ? "‚ö†Ô∏è ÿ∂ÿ∫ÿ∑ ÿßŸÑÿØŸÖ ŸÖŸÜÿÆŸÅÿ∂" : "‚ö†Ô∏è Low Blood Pressure";
                     adviceList.push({icon: "fa-cookie", title: isAr?"ÿ∫ÿ∞ÿßÿ°":"Diet", text: isAr?"ÿ™ŸÜÿßŸàŸÑ Ÿàÿ¨ÿ®ÿ© ÿÆŸÅŸäŸÅÿ© ŸÖÿßŸÑÿ≠ÿ© (ÿ¨ÿ®ŸÜ/ŸÖŸÉÿ≥ÿ±ÿßÿ™)":"Eat salty snacks (cheese/nuts)"});
                     adviceList.push({icon: "fa-coffee", title: isAr?"ŸÖÿ¥ÿ±Ÿàÿ®":"Drink", text: isAr?"ÿßÿ¥ÿ±ÿ® ŸÇŸáŸàÿ© ÿ£Ÿà ÿ≥Ÿàÿßÿ¶ŸÑ ŸÉÿ´Ÿäÿ±ÿ©":"Drink Coffee or fluids"});
                }

                if(temp > 37.5) {
                    statusColor = "#ff416c";
                    headerMsg = isAr ? "üå°Ô∏è ÿ≠ÿ±ÿßÿ±ÿ© ŸÖÿ±ÿ™ŸÅÿπÿ© (ÿ≠ŸÖŸâ)" : "üå°Ô∏è High Fever";
                    adviceList.push({icon: "fa-snowflake", title: isAr?"ÿ•ÿ¨ÿ±ÿßÿ°":"Action", text: isAr?"ÿßÿ≥ÿ™ÿÆÿØŸÖ ŸÉŸÖÿßÿØÿßÿ™ ÿ®ÿßÿ±ÿØÿ© ÿπŸÑŸâ ÿßŸÑÿ¨ÿ®ŸäŸÜ":"Apply cold compresses"});
                    adviceList.push({icon: "fa-glass-water", title: isAr?"ŸÖÿ¥ÿ±Ÿàÿ®":"Drink", text: isAr?"ÿßÿ¥ÿ±ÿ® ŸÖÿßÿ° Ÿàÿπÿµÿßÿ¶ÿ± ŸÑÿ™ÿπŸàŸäÿ∂ ÿßŸÑÿ≥Ÿàÿßÿ¶ŸÑ":"Hydrate with water & juices"});
                }

                if(spo2 > 0 && spo2 < 95) {
                    statusColor = "#ff416c";
                    headerMsg = isAr ? "ü´Å ŸÜŸÇÿµ ŸÅŸä ÿßŸÑÿ£ŸÉÿ≥ÿ¨ŸäŸÜ" : "ü´Å Low Oxygen Level";
                    adviceList.push({icon: "fa-wind", title: isAr?"ÿ®Ÿäÿ¶ÿ©":"Env", text: isAr?"ÿßŸÅÿ™ÿ≠ ÿßŸÑŸÜŸàÿßŸÅÿ∞ ŸÑÿ™ÿ¨ÿØŸäÿØ ÿßŸÑŸáŸàÿßÿ°":"Open windows for fresh air"});
                    adviceList.push({icon: "fa-lungs", title: isAr?"ÿ™ŸÖÿ±ŸäŸÜ":"Exercise", text: isAr?"ÿÆÿ∞ ÿ¥ŸáŸäŸÇÿßŸã ÿπŸÖŸäŸÇÿßŸã Ÿàÿ≤ŸÅŸäÿ±ÿßŸã ÿ®ÿ®ÿ∑ÿ°":"Take deep breaths slowly"});
                }
                
                if(adviceList.length === 0 && sensorDataString !== "No measurement recorded yet") {
                    adviceList.push({icon: "fa-glass-water", title: isAr?"ŸÜÿµŸäÿ≠ÿ©":"Tip", text: isAr?"ÿßÿ¥ÿ±ÿ® 8 ÿ£ŸÉŸàÿßÿ® ŸÖÿßÿ° ŸäŸàŸÖŸäÿßŸã":"Drink 8 cups of water"});
                    adviceList.push({icon: "fa-person-walking", title: isAr?"ŸÜÿ¥ÿßÿ∑":"Active", text: isAr?"ÿßŸÖÿ¥Ÿê ŸÑŸÖÿØÿ© 30 ÿØŸÇŸäŸÇÿ©":"Walk for 30 mins"});
                    adviceList.push({icon: "fa-apple-whole", title: isAr?"ÿ∫ÿ∞ÿßÿ°":"Diet", text: isAr?"ÿ™ŸÜÿßŸàŸÑ ÿßŸÑŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑŸÅŸàÿßŸÉŸá":"Eat more fruits"});
                }
            }

            let finalHtml = `<strong style="color:${statusColor}; font-size:1.1rem; display:block; margin-bottom:10px;">${headerMsg}</strong>`;
            if(adviceList.length > 0) {
                finalHtml += `<div class="ai-advice-container">`;
                adviceList.forEach(tip => {
                    finalHtml += `
                    <div class="advice-box">
                        <div class="advice-icon" style="color:${statusColor}"><i class="fas ${tip.icon}"></i></div>
                        <div class="advice-content">
                            <h4>${tip.title}</h4>
                            <p>${tip.text}</p>
                        </div>
                    </div>`;
                });
                finalHtml += `</div>`;
            }

            document.getElementById("aiText").innerHTML = finalHtml;
            document.querySelector(".ai-card").style.borderColor = statusColor;
            document.querySelector(".ai-card").style.boxShadow = `0 0 40px ${statusColor}30`;
        }
      });
    }

    // --- UTILS ---
    async function checkInternetConnection() { try { await fetch("https://www.google.com/favicon.ico?"+new Date().getTime(),{mode:"no-cors"});return true;}catch(e){return false;}}
    async function updateStatus(){const d=document.getElementById('connectionStatus');if(await checkInternetConnection()){d.classList.remove('offline');d.title="Online";}else{d.classList.add('offline');d.title="Offline";}}
    setInterval(updateStatus,3000);

    function showToast(msg,type="info"){const c=document.getElementById("toastContainer");const t=document.createElement("div");t.className=`toast toast-${type}`;t.innerHTML=`<i class="fas fa-info-circle"></i><span>${msg}</span>`;c.appendChild(t);setTimeout(()=>t.remove(),3000);}

    function sendWhatsAppReport(){
        let phone = currentUserId; if (phone.startsWith('0')) phone = '20' + phone.substring(1);
        let m=`üè• *Bioscan Report*%0A- Temp: ${currentData.temp}%0A- Pulse: ${currentData.bpm}%0A- BP: ${currentData.bp}%0A- Ox: ${currentData.spo2}`;
        window.open(`https://wa.me/${phone}?text=${m}`,'_blank');
    }
    
    function findHospitals(){window.open("https://www.google.com/maps/search/hospitals+near+me","_blank");}
    function toggleFullScreen(){if(!document.fullscreenElement)document.documentElement.requestFullscreen();else if(document.exitFullscreen)document.exitFullscreen();}
    function closeMeasurements(){localStorage.removeItem("selectedUserId");window.location.href="index.html";}
    
    let idle=0; setInterval(()=>{idle++;if(idle>=120)closeMeasurements();},1000);
    document.onmousemove=document.onkeypress=document.ontouchstart=document.onclick=()=>{idle=0;};

    let voiceEnabled=true;
    function toggleHoverVoice(){voiceEnabled=!voiceEnabled;document.getElementById('voiceToggle').classList.toggle('active');}
    function setupHoverVoice(){
        const map={
            'analyzeBtn':{ar:'ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ¨ÿ≥ŸÖ',en:'Body Analysis'}, 'hospitalBtn':{ar:'ÿ£ŸÇÿ±ÿ® ŸÖÿ≥ÿ™ÿ¥ŸÅŸâ',en:'Nearest Hospital'},
            'sosBtn':{ar:'ŸÜÿØÿßÿ° ÿßÿ≥ÿ™ÿ∫ÿßÿ´ÿ©',en:'SOS Emergency'}, 'tempBtn':{ar:'ÿ≠ÿ±ÿßÿ±ÿ©',en:'Temperature'},
            'pulseBtn':{ar:'ŸÜÿ®ÿ∂',en:'Pulse'}, 'bpBtn':{ar:'ÿ∂ÿ∫ÿ∑',en:'Pressure'}, 'oxygenBtn':{ar:'ÿ£ŸÉÿ≥ÿ¨ŸäŸÜ',en:'Oxygen'},
            'visionBtn':{ar:'ŸÜÿ∏ÿ±',en:'Vision'}, 'historyBtn':{ar:'ÿßŸÑÿ≥ÿ¨ŸÑ',en:'History'}
        };
        Object.keys(map).forEach(id=>{
            const b=document.getElementById(id);
            if(b){
                b.onmouseenter=()=>{
                    if(!voiceEnabled) return; window.speechSynthesis.cancel();
                    const u=new SpeechSynthesisUtterance(currentLang==='ar'?map[id].ar:map[id].en);
                    u.lang=currentLang==='ar'?'ar-SA':'en-US'; window.speechSynthesis.speak(u);
                };
                b.onmouseleave=()=>{ window.speechSynthesis.cancel(); }
            }
        });
    }

    function extractSensorValues(sensorString) {
        const values = {};
        if (sensorString && sensorString !== "No measurement recorded yet") {
            sensorString.split(',').forEach(item => {
                const parts = item.trim().split('=');
                if (parts.length === 2) {
                    const key = parts[0].trim().toLowerCase();
                    const value = parts[1].trim();
                    if (key.includes('temp')) values.temp = value;
                    else if (key === 'hr' || key.includes('pulse')) values.bpm = value;
                    else if (key === 'bp' || key.includes('pressure')) values.bp = value;
                    else if (key.includes('o2') || key.includes('spo2')) values.spo2 = value;
                }
            });
        }
        return values;
    }

    function calculateHealthRisk() {
      const weight = parseFloat(document.getElementById("inputWeight").value);
      const height = parseFloat(document.getElementById("inputHeight").value);
      const resultBox = document.getElementById("analysisResult");
      const lang = currentLang;

      if(!weight || !height) {
        resultBox.style.display = "block"; resultBox.style.borderLeftColor = "#ff416c";
        resultBox.innerText = lang === "ar" ? "Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™." : "Enter valid data."; return;
      }
      const h_m = height / 100; const bmi = (weight / (h_m * h_m)).toFixed(1); const waterNeed = (weight * 0.035).toFixed(1);
      let status="", color="", dietTip="", exerciseTip="";
      if(bmi<18.5){ status=lang==="ar"?"ŸÜÿ≠ÿßŸÅÿ©":"Underweight"; color="#3498db"; dietTip=lang==="ar"?"ü•ë ÿ£ŸÉÿ´ÿ± ŸÖŸÜ ÿßŸÑŸÖŸÉÿ≥ÿ±ÿßÿ™":"ü•ë Eat nuts"; exerciseTip=lang==="ar"?"üèãÔ∏è‚Äç‚ôÇÔ∏è ÿ™ŸÖÿßÿ±ŸäŸÜ ŸÖŸÇÿßŸàŸÖÿ©":"üèãÔ∏è‚Äç‚ôÇÔ∏è Strength training"; }
      else if(bmi<25){ status=lang==="ar"?"ŸÖÿ´ÿßŸÑŸä":"Healthy"; color="#2ecc71"; dietTip=lang==="ar"?"ü•ó ÿ≠ÿßŸÅÿ∏ ÿπŸÑŸâ ÿßŸÑÿ≥ŸÑÿ∑ÿ©":"ü•ó Eat salads"; exerciseTip=lang==="ar"?"üèÉ‚Äç‚ôÇÔ∏è ŸÖÿ¥Ÿä ŸäŸàŸÖŸä":"üèÉ‚Äç‚ôÇÔ∏è Daily walk"; }
      else if(bmi<30){ status=lang==="ar"?"ÿ≤ÿßÿ¶ÿØ":"Overweight"; color="#f1c40f"; dietTip=lang==="ar"?"üìâ ŸÇŸÑŸÑ ÿßŸÑÿ≥ŸÉÿ±":"üìâ Cut sugar"; exerciseTip=lang==="ar"?"üö¥‚Äç‚ôÇÔ∏è ÿ±ŸÉŸàÿ® ÿßŸÑÿØÿ±ÿßÿ¨ÿ©":"üö¥‚Äç‚ôÇÔ∏è Cycling"; }
      else{ status=lang==="ar"?"ÿ≥ŸÖŸÜÿ©":"Obese"; color="#e74c3c"; dietTip=lang==="ar"?"üö´ ŸÑÿß ŸÑŸÑŸÖŸÇŸÑŸäÿßÿ™":"üö´ No fried food"; exerciseTip=lang==="ar"?"üö∂‚Äç‚ôÇÔ∏è ŸÖÿ¥Ÿä ÿÆŸÅŸäŸÅ":"üö∂‚Äç‚ôÇÔ∏è Light walking"; }

      resultBox.style.display="block"; resultBox.style.borderLeftColor=color;
      resultBox.innerHTML=`<strong style="color:${color}; font-size:1.1rem;">BMI: ${bmi} (${status})</strong><br><div style="margin-top:10px; font-size:0.9rem; color:#eee;">üíß ${waterNeed} L<br>üçé <b>${lang==="ar"?"ÿ∫ÿ∞ÿßÿ°":"Diet"}:</b> ${dietTip}<br>üí™ <b>${lang==="ar"?"ÿ±Ÿäÿßÿ∂ÿ©":"Gym"}:</b> ${exerciseTip}</div>`;
      if(voiceEnabled){const u=new SpeechSynthesisUtterance(lang==="ar"?`ŸÖÿ§ÿ¥ÿ± ŸÉÿ™ŸÑÿ© ÿßŸÑÿ¨ÿ≥ŸÖ ${bmi}`:`BMI is ${bmi}`);u.lang=lang==="ar"?'ar-SA':'en-US';window.speechSynthesis.speak(u);}
    }

    // Modal & Sidebar
    function triggerSOS(){const s=localStorage.getItem("sosContactNumber"); if(!s) openContactModal(); else openConfirmModal();}
    function openContactModal(){document.getElementById('contactModal').classList.add('active');}
    function saveEmergencyContact(){const n=document.getElementById('emergencyInput').value; if(n.length<5) return; localStorage.setItem("sosContactNumber",n); closeModals();}
    function openConfirmModal(){document.getElementById('confirmModal').classList.add('active');}
    function closeModals(){document.getElementById('contactModal').classList.remove('active'); document.getElementById('confirmModal').classList.remove('active');}
    
    function executeSOS(){
        closeModals(); 
        const lang = currentLang;
        showToast(lang==="ar"?"ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ...":"Locating...", "info");
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(sendPosition, (err) => {
                showToast("GPS Error: " + err.message, "error");
            });
        } else {
            showToast("GPS not supported", "error");
        }
    }

    function sendPosition(position) {
        const lat = position.coords.latitude;
        const long = position.coords.longitude;
        const mapLink = `https://www.google.com/maps?q=${lat},${long}`;
        const lang = currentLang;
        
        let rawPhone = localStorage.getItem("sosContactNumber");
        let cleanPhone = rawPhone.replace(/\D/g, ''); 
        if (cleanPhone.startsWith('01')) cleanPhone = '20' + cleanPhone.substring(1); 

        let msg = "";
        if(lang === "ar") {
            msg = `üö® *ÿßÿ≥ÿ™ÿ∫ÿßÿ´ÿ© ÿ∑ÿßÿ±ÿ¶ÿ©!* üö®\nÿ£ÿ≠ÿ™ÿßÿ¨ ŸÑŸÑŸÖÿ≥ÿßÿπÿØÿ© ŸÅŸàÿ±ÿßŸã.\nüìç *ÿßŸÑŸÖŸàŸÇÿπ:* ${mapLink}\nüå°Ô∏è *ÿßŸÑÿ≠ÿ±ÿßÿ±ÿ©:* ${currentData.temp}\n‚ù§Ô∏è *ÿßŸÑŸÜÿ®ÿ∂:* ${currentData.bpm}`;
        } else {
            msg = `üö® *EMERGENCY SOS!* üö®\nI need help immediately.\nüìç *Location:* ${mapLink}\nüå°Ô∏è *Temp:* ${currentData.temp}\n‚ù§Ô∏è *Pulse:* ${currentData.bpm}`;
        }
        
        const finalUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(msg)}`;
        window.open(finalUrl, '_blank');
    }

    function goToTemperature(){window.location.href="temp.html";}
    function goToPulse(){window.location.href="pulse.html";}
    function goToPressure(){window.location.href="pressure.html";}
    function goToOxygen(){window.location.href="oxygen.html";}
    function goToVisionPage(){window.location.href="instruction.html";}
    function goToHistory(){window.location.href="history.html";}

    // Init Logic
    window.onload = () => { 
        updateAIAnalysis(); 
        if ('speechSynthesis' in window) {
            window.speechSynthesis.onvoiceschanged = () => { setupHoverVoice(); };
            setTimeout(setupHoverVoice, 500);
        }
    };
  </script>
</body>
</html>
