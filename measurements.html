<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bioscan | Dashboard</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    /* --- CSS Styles --- */
    :root {
      --bg-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --text-color: #ffffff;
      --history-color: #a18cd1;
      --ai-color: #00d2ff;
      --error-color: #ff416c;
      --success-color: #00ff88;
      --whatsapp-color: #25D366;
    }
    ::-webkit-scrollbar { width: 10px; }
    ::-webkit-scrollbar-track { background: #1a1a1a; }
    ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, var(--ai-color), var(--history-color)); border-radius: 10px; border: 2px solid #1a1a1a; }
    ::-webkit-scrollbar-thumb:hover { background: var(--success-color); }
    body { font-family: 'Poppins', sans-serif; background: var(--bg-gradient); background-size: 400% 400%; animation: gradientBG 15s ease infinite; min-height: 100vh; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; color: var(--text-color); box-sizing: border-box; overflow-x: hidden; }
    @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    
    .user-card { background: var(--glass-bg); backdrop-filter: blur(10px); border: 1px solid var(--glass-border); padding: 10px 30px; border-radius: 50px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 15px; width: 100%; max-width: 900px; box-sizing: border-box; animation: slideDown 0.8s ease; }
    @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .user-card i.fa-user-circle { font-size: 1.5rem; color: #00d2ff; }
    .user-card h2 { margin: 0; font-size: 1.1rem; font-weight: 400; flex-grow: 1; }
    .user-card span { font-weight: 600; color: #00d2ff; text-transform: uppercase; }
    
    .top-actions { display: flex; align-items: center; gap: 10px; }
    .icon-btn { background: transparent; border: none; color: white; cursor: pointer; font-size: 1.2rem; transition: 0.3s; padding: 5px; opacity: 0.8; }
    .icon-btn:hover { transform: scale(1.2); opacity: 1; color: var(--primary-color); }
    .icon-btn.active { color: var(--success-color); text-shadow: 0 0 10px var(--success-color); }
    .whatsapp-btn { color: var(--whatsapp-color) !important; }
    .whatsapp-btn:hover { text-shadow: 0 0 10px var(--whatsapp-color); }
    
    .status-dot { width: 12px; height: 12px; border-radius: 50%; background-color: var(--success-color); box-shadow: 0 0 10px var(--success-color); transition: all 0.3s ease; margin-left: 15px; }
    .status-dot.offline { background-color: var(--error-color) !important; box-shadow: 0 0 15px var(--error-color) !important; animation: blinkRed 1s infinite; }
    @keyframes blinkRed { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    
    .ai-card { width: 100%; max-width: 900px; background: linear-gradient(135deg, rgba(0, 210, 255, 0.1), rgba(58, 123, 213, 0.1)); border: 1px solid var(--ai-color); border-radius: 20px; padding: 20px; margin-bottom: 30px; display: flex; align-items: flex-start; gap: 20px; box-shadow: 0 0 20px rgba(0, 210, 255, 0.15); position: relative; overflow: hidden; box-sizing: border-box; }
    .ai-icon { font-size: 2.5rem; color: var(--ai-color); background: rgba(0, 0, 0, 0.2); width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; animation: pulseAI 2s infinite; flex-shrink: 0; }
    @keyframes pulseAI { 0% { box-shadow: 0 0 0 0 rgba(0, 210, 255, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(0, 210, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 210, 255, 0); } }
    .ai-content h3 { margin: 0 0 5px 0; font-size: 1.1rem; color: var(--ai-color); }
    .ai-content p { margin: 0; font-size: 0.95rem; line-height: 1.5; color: #eee; }
    .ai-content ul { padding-left: 20px; margin: 5px 0; }
    .ai-content li { margin-bottom: 5px; color: #ddd; }
    
    .measure-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; width: 100%; max-width: 900px; margin-bottom: 30px; }
    .measure-btn { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 25px 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); position: relative; overflow: hidden; height: 160px; }
    .measure-btn:hover { transform: translateY(-10px); box-shadow: 0 15px 30px rgba(0,0,0,0.4); border-color: rgba(255,255,255,0.4); }
    .measure-btn i { font-size: 2.5rem; transition: 0.3s; }
    .measure-btn span { font-size: 1rem; font-weight: 600; text-align: center; color: #fff; }
    .temp { border-bottom: 4px solid #ff7e5f; } .temp i { color: #ff7e5f; }
    .pulse { border-bottom: 4px solid #ff416c; } .pulse i { color: #ff416c; }
    .pressure { border-bottom: 4px solid #6a11cb; } .pressure i { color: #6a11cb; }
    .oxygen { border-bottom: 4px solid #00c6ff; } .oxygen i { color: #00c6ff; }
    .vision { border-bottom: 4px solid #43e97b; } .vision i { color: #43e97b; }
    
    .history-bar { width: 100%; max-width: 900px; background: linear-gradient(90deg, rgba(161, 140, 209, 0.1), rgba(251, 194, 235, 0.1)); border: 1px solid rgba(161, 140, 209, 0.4); border-radius: 20px; padding: 20px; display: flex; align-items: center; justify-content: center; gap: 20px; cursor: pointer; margin-bottom: 40px; transition: 0.3s; backdrop-filter: blur(10px); box-sizing: border-box; }
    .history-bar:hover { transform: scale(1.02); border-color: var(--history-color); box-shadow: 0 0 25px rgba(161, 140, 209, 0.3); }
    .history-bar i { font-size: 2rem; color: var(--history-color); }
    .history-bar span { font-size: 1.2rem; font-weight: 600; color: #fff; text-transform: uppercase; }
    
    .close-btn { background: linear-gradient(45deg, #cb2d3e, #ef473a); color: white; border: none; padding: 12px 40px; border-radius: 50px; font-size: 16px; font-family: 'Poppins', sans-serif; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(239, 71, 58, 0.4); transition: 0.3s; display: flex; align-items: center; gap: 10px; margin-top: auto; }
    
    /* --- FAB BUTTONS --- */
    .fab-container { position: fixed; bottom: 30px; z-index: 1000; display: flex; flex-direction: column; gap: 15px; align-items: center; }
    .fab-right { right: 30px; }
    .fab-left { left: 30px; }

    .sos-wrapper { position: relative; }
    .sos-settings-btn {
        position: absolute; top: -5px; right: -5px;
        width: 25px; height: 25px; background: #333; border-radius: 50%;
        color: #fff; font-size: 12px; display: flex; align-items: center; justify-content: center;
        border: 2px solid #ff416c; cursor: pointer; z-index: 1001;
    }

    .sos-fab {
        width: 70px; height: 70px; border-radius: 50%;
        background: linear-gradient(135deg, #ff0000, #cc0000);
        color: white; border: 3px solid rgba(255,255,255,0.3);
        box-shadow: 0 0 20px rgba(255, 0, 0, 0.6);
        cursor: pointer; display: flex; align-items: center; justify-content: center;
        font-size: 24px; font-weight: bold;
        transition: 0.3s;
        animation: sos-pulse 1.5s infinite;
    }
    .sos-fab:active { transform: scale(0.9); }
    @keyframes sos-pulse {
        0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); transform: scale(1); }
        70% { box-shadow: 0 0 0 15px rgba(255, 0, 0, 0); transform: scale(1.05); }
        100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); transform: scale(1); }
    }

    .hospital-fab {
        width: 55px; height: 55px; border-radius: 50%;
        background: linear-gradient(135deg, #00d2ff, #3a7bd5);
        color: white; border: none;
        box-shadow: 0 4px 15px rgba(0, 210, 255, 0.4);
        cursor: pointer; display: flex; align-items: center; justify-content: center;
        font-size: 22px; transition: 0.3s;
    }
    .hospital-fab:hover { transform: scale(1.1); background: linear-gradient(135deg, #3a7bd5, #00d2ff); }

    .analyze-fab {
        width: 65px; height: 65px; border-radius: 50%;
        background: linear-gradient(135deg, #6c5ce7, #a29bfe);
        color: white; border: none;
        box-shadow: 0 4px 15px rgba(108, 92, 231, 0.5);
        cursor: pointer; display: flex; align-items: center; justify-content: center;
        font-size: 28px; transition: 0.3s;
        animation: float-fab 3s ease-in-out infinite;
    }
    .analyze-fab:hover { transform: scale(1.1); }
    @keyframes float-fab { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

    /* --- CUSTOM MODALS --- */
    .custom-modal-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
        z-index: 4000; display: none; align-items: center; justify-content: center;
        opacity: 0; transition: opacity 0.3s;
    }
    .custom-modal-overlay.active { display: flex; opacity: 1; }
    
    .custom-modal-box {
        background: rgba(20, 30, 48, 0.95); border: 1px solid var(--ai-color);
        padding: 30px; border-radius: 20px; width: 90%; max-width: 400px;
        text-align: center; box-shadow: 0 0 30px rgba(0, 210, 255, 0.2);
        transform: scale(0.8); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .custom-modal-overlay.active .custom-modal-box { transform: scale(1); }
    
    .modal-icon { font-size: 3rem; margin-bottom: 15px; color: var(--ai-color); }
    .modal-icon.warning { color: var(--error-color); }
    .modal-title { font-size: 1.4rem; color: #fff; margin-bottom: 10px; font-weight: 600; }
    .modal-text { color: #ccc; margin-bottom: 25px; line-height: 1.5; font-size: 0.95rem; }
    
    .modal-input {
        width: 100%; padding: 12px; margin-bottom: 20px;
        background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3);
        border-radius: 10px; color: white; font-size: 1.1rem; text-align: center;
        box-sizing: border-box;
    }
    .modal-input:focus { outline: none; border-color: var(--success-color); }

    .modal-actions { display: flex; justify-content: center; gap: 15px; }
    .modal-btn {
        padding: 10px 25px; border: none; border-radius: 50px; font-weight: 600; cursor: pointer;
        transition: 0.3s; font-family: 'Poppins', sans-serif;
    }
    .btn-confirm { background: linear-gradient(45deg, #00d2ff, #3a7bd5); color: white; }
    .btn-danger { background: linear-gradient(45deg, #ff416c, #ff4b2b); color: white; }
    .btn-cancel { background: rgba(255,255,255,0.1); color: #ccc; }
    .modal-btn:hover { transform: scale(1.05); filter: brightness(1.1); }

    .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1999; display: none; opacity: 0; transition: opacity 0.3s; }
    .sidebar-overlay.active { display: block; opacity: 1; }
    .sidebar { position: fixed; top: 0; left: -350px; width: 320px; height: 100%; background: rgba(15, 32, 39, 0.95); backdrop-filter: blur(15px); border-right: 1px solid var(--ai-color); box-shadow: 5px 0 30px rgba(0,0,0,0.5); z-index: 2000; transition: left 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; }
    .sidebar.active { left: 0; }
    .sidebar-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 20px; }
    .sidebar-header h3 { margin: 0; color: var(--ai-color); font-size: 1.3rem; display: flex; gap: 10px; align-items: center; }
    .close-sidebar { background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; transition: 0.3s; }
    .close-sidebar:hover { color: var(--error-color); transform: rotate(90deg); }
    .sidebar-content label { display: block; color: #ccc; margin-bottom: 5px; font-size: 0.9rem; text-align: left; }
    .sidebar-input { width: 100%; padding: 12px; margin-bottom: 15px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; font-size: 1rem; box-sizing: border-box; }
    .sidebar-input:focus { outline: none; border-color: var(--ai-color); }
    .calc-btn { width: 100%; padding: 12px; background: var(--ai-color); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.3s; }
    .calc-btn:hover { background: #3a7bd5; transform: scale(1.02); }
    .result-box { margin-top: 25px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px; border-left: 4px solid var(--ai-color); font-size: 0.95rem; line-height: 1.5; color: #eee; display: none; }
    
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; }
    .toast { background: rgba(16, 30, 40, 0.95); color: white; padding: 15px 25px; border-radius: 12px; display: flex; align-items: center; gap: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); border-left: 5px solid; animation: slideIn 0.4s ease, fadeOut 0.5s ease 4s forwards; }
    @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    .toast-error { border-color: var(--error-color); } .toast-error i { color: var(--error-color); }
    .toast-info { border-color: var(--ai-color); } .toast-info i { color: var(--ai-color); }

    @media screen and (max-width: 768px) {
      body { padding: 10px; }
      header { padding: 5px 0; }
      .user-card, .ai-card { padding: 15px; flex-direction: column; align-items: flex-start; gap: 10px; }
      .user-card .top-actions { width: 100%; justify-content: space-between; margin-top: 10px; }
      .measure-container { grid-template-columns: repeat(2, 1fr); gap: 10px; }
      .measure-btn { height: 110px; padding: 10px; }
      .fab-right { right: 20px; bottom: 20px; }
      .fab-left { left: 20px; bottom: 20px; }
      .sidebar { width: 85%; }
    }
  </style>
</head>
<body>

  <div class="toast-container" id="toastContainer"></div>

  <div class="fab-container fab-right">
    <button class="hospital-fab" id="hospitalBtn" onclick="findHospitals()" title="Nearest Hospitals">
      <i class="fas fa-hospital"></i>
    </button>
    
    <div class="sos-wrapper">
        <button class="sos-settings-btn" onclick="openContactModal()" title="Edit SOS Number">
            <i class="fas fa-cog"></i>
        </button>
        <button class="sos-fab" id="sosBtn" onclick="triggerSOS()" title="EMERGENCY HELP">
          SOS
        </button>
    </div>
  </div>

  <div class="fab-container fab-left">
    <button class="analyze-fab" id="analyzeBtn" onclick="toggleSidebar(true)" title="Smart Body Analysis">
      <i class="fas fa-chart-pie"></i>
    </button>
  </div>

  <div class="custom-modal-overlay" id="contactModal">
      <div class="custom-modal-box">
          <div class="modal-icon"><i class="fas fa-address-book"></i></div>
          <h3 class="modal-title" id="contactTitle">Setup Emergency Contact</h3>
          <p class="modal-text" id="contactText">Please enter the phone number to receive SOS alerts.</p>
          <input type="number" id="emergencyInput" class="modal-input" placeholder="201000000000">
          <div class="modal-actions">
              <button class="modal-btn btn-cancel" onclick="closeModals()">Cancel</button>
              <button class="modal-btn btn-confirm" onclick="saveEmergencyContact()">Save & Continue</button>
          </div>
      </div>
  </div>

  <div class="custom-modal-overlay" id="confirmModal">
      <div class="custom-modal-box">
          <div class="modal-icon warning"><i class="fas fa-exclamation-triangle"></i></div>
          <h3 class="modal-title" id="confirmTitle">Emergency Alert</h3>
          <p class="modal-text" id="confirmText">Are you sure you want to send an emergency SOS?</p>
          <div class="modal-actions">
              <button class="modal-btn btn-cancel" onclick="closeModals()">Cancel</button>
              <button class="modal-btn btn-danger" onclick="executeSOS()">YES, SEND HELP</button>
          </div>
      </div>
  </div>

  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar(false)"></div>
  <div class="sidebar" id="smartSidebar">
    <div class="sidebar-header">
      <h3 id="sidebarTitle"><i class="fas fa-brain"></i> Smart Check</h3>
      <button class="close-sidebar" onclick="toggleSidebar(false)">√ó</button>
    </div>
    <div class="sidebar-content">
      <label id="lblWeight">Weight (kg) / ÿßŸÑŸàÿ≤ŸÜ</label>
      <input type="number" id="inputWeight" class="sidebar-input" placeholder="e.g. 75">
      <label id="lblHeight">Height (cm) / ÿßŸÑÿ∑ŸàŸÑ</label>
      <input type="number" id="inputHeight" class="sidebar-input" placeholder="e.g. 175">
      <button class="calc-btn" onclick="calculateHealthRisk()" id="btnAnalyze">Analyze Health / ÿ™ÿ≠ŸÑŸäŸÑ</button>
      <div id="analysisResult" class="result-box"></div>
    </div>
  </div>

  <div class="user-card">
    <i class="fas fa-user-circle"></i>
    <h2 id="titleText">User: <span id="currentUserName">Unknown</span></h2>
    <div class="top-actions">
      <button class="icon-btn whatsapp-btn" id="whatsappBtn" onclick="sendWhatsAppReport()" title="Send Report to WhatsApp">
        <i class="fab fa-whatsapp"></i>
      </button>
      <button class="icon-btn active" id="voiceToggle" onclick="toggleHoverVoice()" title="Toggle Voice Guide">
        <i class="fas fa-volume-up"></i>
      </button>
      <button class="icon-btn" onclick="toggleFullScreen()" title="Full Screen">
        <i class="fas fa-expand"></i>
      </button>
      <div id="connectionStatus" class="status-dot" title="Online"></div>
    </div>
  </div>

  <div class="ai-card">
    <div class="ai-icon"><i class="fas fa-robot"></i></div>
    <div class="ai-content">
      <h3 id="aiTitle">AI Health Analysis</h3>
      <div id="aiText">Waiting for measurements...</div>
    </div>
    <div id="lastReadingTime" style="position: absolute; bottom: 8px; right: 20px; font-size: 0.8rem; color: #aaa;">Last updated: --</div>
  </div>

  <div class="measure-container">
    <div class="measure-btn temp" id="tempBtn" onclick="goToTemperature()">
      <i class="fas fa-thermometer-half"></i> <span>Temperature</span>
      <div id="tempValue" style="font-weight: 700; color: #fff; font-size: 1.1rem; position: absolute; bottom: 5px;">--</div>
    </div>
    <div class="measure-btn pulse" id="pulseBtn" onclick="goToPulse()">
      <i class="fas fa-heartbeat"></i> <span>Pulse Rate</span>
      <div id="pulseValue" style="font-weight: 700; color: #fff; font-size: 1.1rem; position: absolute; bottom: 5px;">--</div>
    </div>
    <div class="measure-btn pressure" id="bpBtn" onclick="goToPressure()">
      <i class="fas fa-stethoscope"></i> <span>Blood Pressure</span>
      <div id="bpValue" style="font-weight: 700; color: #fff; font-size: 1.1rem; position: absolute; bottom: 5px;">--</div>
    </div>
    <div class="measure-btn oxygen" id="oxygenBtn" onclick="goToOxygen()">
      <i class="fas fa-lungs"></i> <span>Oxygen (SpO2)</span>
      <div id="spo2Value" style="font-weight: 700; color: #fff; font-size: 1.1rem; position: absolute; bottom: 5px;">--</div>
    </div>
    <div class="measure-btn vision" id="visionBtn" onclick="goToVisionPage()">
      <i class="fas fa-eye"></i> <span>Vision Test</span>
    </div>
  </div>

  <div class="history-bar" id="historyBtn" onclick="goToHistory()">
    <i class="fas fa-file-medical-alt"></i>
    <span>View History & Reports</span>
  </div>

  <button class="close-btn" id="exitBtn" onclick="closeMeasurements()">
    <i class="fas fa-sign-out-alt"></i> Exit Dashboard
  </button>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAOwMQhsRM2PdD_FLjW_8Oi1WlFS3EO5pY",
      authDomain: "smart-a76a0.firebaseapp.com",
      databaseURL: "https://smart-a76a0-default-rtdb.firebaseio.com",
      projectId: "smart-a76a0",
      messagingSenderId: "343693501983",
      appId: "1:343693501983:web:10ea3fce9d990a2455172a"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth(); 
    
    auth.signInAnonymously().catch(console.error);

    const PATIENT_DATA_PATH = 'PatientData';
    const currentUserId = localStorage.getItem("selectedUserId");
    const userSpan = document.getElementById('currentUserName');
    
    if(!currentUserId) window.location.href="index.html"; 
    else userSpan.innerText = currentUserId;

    // --- SIDEBAR ---
    function toggleSidebar(show) {
      const sidebar = document.getElementById("smartSidebar");
      const overlay = document.getElementById("sidebarOverlay");
      if(show) { sidebar.classList.add("active"); overlay.classList.add("active"); }
      else { sidebar.classList.remove("active"); overlay.classList.remove("active"); }
    }

    // --- SOS LOGIC (FIXED MESSAGE) ---
    function triggerSOS() {
        const savedNumber = localStorage.getItem("sosContactNumber");
        if (!savedNumber) { openContactModal(); } else { openConfirmModal(); }
    }

    function openContactModal() {
        const lang = localStorage.getItem("language") || "en";
        document.getElementById('contactTitle').innerText = lang === "ar" ? "ÿ•ÿπÿØÿßÿØ ÿ¨Ÿáÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ ŸÑŸÑÿ∑Ÿàÿßÿ±ÿ¶" : "Setup Emergency Contact";
        document.getElementById('contactText').innerText = lang === "ar" ? "ÿ£ÿØÿÆŸÑ ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ (ŸÖÿπ ŸÉŸàÿØ ÿßŸÑÿØŸàŸÑÿ©)" : "Enter phone number (with country code).";
        const saved = localStorage.getItem("sosContactNumber");
        if(saved) document.getElementById('emergencyInput').value = saved;
        document.getElementById('contactModal').classList.add('active');
    }

    function saveEmergencyContact() {
        const num = document.getElementById('emergencyInput').value;
        const lang = localStorage.getItem("language") || "en";
        if (num.length < 5) {
            showToast(lang==="ar"?"ÿ±ŸÇŸÖ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠!":"Invalid Number!", "error");
            return;
        }
        localStorage.setItem("sosContactNumber", num);
        closeModals();
        showToast(lang==="ar"?"ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ±ŸÇŸÖ":"Contact Saved", "info");
    }

    function openConfirmModal() {
        const lang = localStorage.getItem("language") || "en";
        document.getElementById('confirmTitle').innerText = lang === "ar" ? "ÿ™ŸÜÿ®ŸäŸá ÿ∑Ÿàÿßÿ±ÿ¶" : "Emergency Alert";
        document.getElementById('confirmText').innerText = lang === "ar" ? "ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ÿ±ÿ≥ÿßŸÑ ŸÜÿØÿßÿ° ÿßÿ≥ÿ™ÿ∫ÿßÿ´ÿ©ÿü" : "Are you sure you want to send SOS?";
        document.getElementById('confirmModal').classList.add('active');
    }

    function closeModals() {
        document.getElementById('contactModal').classList.remove('active');
        document.getElementById('confirmModal').classList.remove('active');
    }

    function executeSOS() {
        closeModals();
        const lang = localStorage.getItem("language") || "en";
        if (navigator.geolocation) {
            showToast(lang==="ar"?"ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ...":"Locating...", "info");
            navigator.geolocation.getCurrentPosition(sendPosition, showError);
        } else {
            alert(lang === "ar" ? "ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿß ŸäÿØÿπŸÖ GPS." : "Geolocation not supported.");
        }
    }

    function sendPosition(position) {
        const lat = position.coords.latitude;
        const long = position.coords.longitude;
        // Correct Google Maps Link
        const mapLink = `https://www.google.com/maps?q=$${lat},${long}`;
        const lang = localStorage.getItem("language") || "en";
        const contact = localStorage.getItem("sosContactNumber");
        
        let msg = "";
        if(lang === "ar") {
            msg = `üö® *ÿßÿ≥ÿ™ÿ∫ÿßÿ´ÿ© ÿ∑ÿßÿ±ÿ¶ÿ©!* üö®\nÿ£ÿ≠ÿ™ÿßÿ¨ ŸÑŸÑŸÖÿ≥ÿßÿπÿØÿ© ŸÅŸàÿ±ÿßŸã.\nüìç *ŸÖŸàŸÇÿπŸä:* ${mapLink}\nüå°Ô∏è *ÿßŸÑÿ≠ÿ±ÿßÿ±ÿ©:* ${currentData.temp}\n‚ù§Ô∏è *ÿßŸÑŸÜÿ®ÿ∂:* ${currentData.bpm}`;
        } else {
            msg = `üö® *EMERGENCY SOS!* üö®\nI need help immediately.\nüìç *Location:* ${mapLink}\nüå°Ô∏è *Temp:* ${currentData.temp}\n‚ù§Ô∏è *Pulse:* ${currentData.bpm}`;
        }
        
        // Correct Encoding for WhatsApp (Fixes the "Not sending" issue)
        const encodedMsg = encodeURIComponent(msg);
        window.open(`https://wa.me/${contact}?text=${encodedMsg}`, '_blank');
    }

    function showError(error) {
        const lang = localStorage.getItem("language") || "en";
        showToast(lang === "ar" ? "ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ" : "Location Error", "error");
    }

    // --- DATA & AI ---
    function extractSensorValues(sensorString) {
        const values = {};
        if (sensorString && sensorString !== "No measurement recorded yet") {
            sensorString.split(',').forEach(item => {
                const parts = item.trim().split('=');
                if (parts.length === 2) {
                    const key = parts[0].trim().toLowerCase();
                    const value = parts[1].trim();
                    if (key.includes('temp')) values.temp = value;
                    else if (key === 'hr' || key.includes('pulse')) values.bpm = value;
                    else if (key === 'bp' || key.includes('pressure')) values.bp = value;
                    else if (key.includes('o2') || key.includes('spo2')) values.spo2 = value;
                }
            });
        }
        return values;
    }

    // --- RESTORED: DETAILED BMI LOGIC ---
    function calculateHealthRisk() {
      const weight = parseFloat(document.getElementById("inputWeight").value);
      const height = parseFloat(document.getElementById("inputHeight").value);
      const resultBox = document.getElementById("analysisResult");
      const lang = localStorage.getItem("language") || "en";

      if(!weight || !height) {
        resultBox.style.display = "block";
        resultBox.style.borderLeftColor = "#ff416c";
        resultBox.innerText = lang === "ar" ? "Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™." : "Enter valid data.";
        return;
      }

      const h_m = height / 100;
      const bmi = (weight / (h_m * h_m)).toFixed(1);
      const waterNeed = (weight * 0.035).toFixed(1);

      let status = "", color = "", dietTip = "", exerciseTip = "";
      if(bmi < 18.5) { 
          status = lang==="ar"?"ŸÜÿ≠ÿßŸÅÿ©":"Underweight"; color="#3498db"; 
          dietTip = lang==="ar"?"ÿ™ŸÜÿßŸàŸÑ Ÿàÿ¨ÿ®ÿßÿ™ ÿ∫ŸÜŸäÿ© ÿ®ÿßŸÑÿ®ÿ±Ÿàÿ™ŸäŸÜ." : "Eat protein-rich meals.";
      } else if(bmi < 25) { 
          status = lang==="ar"?"Ÿàÿ≤ŸÜ ŸÖÿ´ÿßŸÑŸä":"Healthy"; color="#2ecc71"; 
          dietTip = lang==="ar"?"ÿ≠ÿßŸÅÿ∏ ÿπŸÑŸâ ŸÜÿ∏ÿßŸÖ ÿ∫ÿ∞ÿßÿ¶Ÿä ŸÖÿ™Ÿàÿßÿ≤ŸÜ." : "Maintain balanced diet.";
      } else if(bmi < 30) { 
          status = lang==="ar"?"Ÿàÿ≤ŸÜ ÿ≤ÿßÿ¶ÿØ":"Overweight"; color="#f1c40f"; 
          dietTip = lang==="ar"?"ŸÇŸÑŸÑ ÿßŸÑÿ≥ŸÉÿ±Ÿäÿßÿ™ ŸàÿßŸÑÿØŸáŸàŸÜ." : "Reduce sugar/fats.";
      } else { 
          status = lang==="ar"?"ÿ≥ŸÖŸÜÿ©":"Obese"; color="#e74c3c"; 
          dietTip = lang==="ar"?"ÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ£ÿ∑ÿπŸÖÿ© ÿßŸÑŸÖŸÇŸÑŸäÿ©." : "Avoid fried foods.";
      }

      const waterMsg = lang==="ar" ? `üíß ÿßÿ≠ÿ™Ÿäÿßÿ¨ ÿßŸÑŸÖÿßÿ°: ${waterNeed} ŸÑÿ™ÿ±` : `üíß Water Need: ${waterNeed} L`;

      resultBox.style.display = "block";
      resultBox.style.borderLeftColor = color;
      resultBox.innerHTML = `<strong style="color:${color}">BMI: ${bmi} (${status})</strong><br><small>${waterMsg}</small><br><small>üçé ${dietTip}</small>`;
      
      if(voiceEnabled) {
         const utterance = new SpeechSynthesisUtterance(lang==="ar" ? `ŸÖÿ§ÿ¥ÿ± ŸÉÿ™ŸÑÿ© ÿßŸÑÿ¨ÿ≥ŸÖ ${bmi}` : `BMI is ${bmi}`);
         utterance.lang = lang==="ar"?'ar-SA':'en-US';
         window.speechSynthesis.speak(utterance);
      }
    }

    let currentData = { temp: "--", bpm: "--", bp: "--", spo2: "--" };
    let lastTimestamp = "--";

    // --- RESTORED: DETAILED AI ANALYSIS LOGIC (BP, Temp, O2 Advice) ---
    function updateAIAnalysis() {
      if(!currentUserId) return;
      const userRef = db.ref(PATIENT_DATA_PATH + '/' + currentUserId);
      userRef.on("value", (snapshot) => {
        if(snapshot.exists()) {
            const data = snapshot.val();
            const sensorDataString = data.SensorData || "No measurement recorded yet";
            const sensorValues = extractSensorValues(sensorDataString);
            
            currentData = {
                temp: sensorValues.temp || "--",
                bpm: sensorValues.bpm || "--",
                bp: sensorValues.bp || "--",
                spo2: sensorValues.spo2 || "--"
            };
            lastTimestamp = data.Timestamp || "--";

            document.getElementById('bpValue').innerText = currentData.bp;
            document.getElementById('spo2Value').innerText = currentData.spo2 + (currentData.spo2 !== '--' ? '%' : '');
            document.getElementById('tempValue').innerText = currentData.temp + (currentData.temp !== '--' ? '¬∞C' : '');
            document.getElementById('pulseValue').innerText = currentData.bpm + (currentData.bpm !== '--' ? ' bpm' : '');
            document.getElementById('lastReadingTime').innerText = (localStorage.getItem("language") === 'ar' ? 'ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´: ' : 'Last updated: ') + lastTimestamp;
            
            const temp = parseFloat(currentData.temp) || 0;
            const bpm = parseInt(currentData.bpm) || 0;
            const spo2 = parseFloat(currentData.spo2) || 0;
            let sys = 0;
            if(currentData.bp && currentData.bp.includes('/')) sys = parseInt(currentData.bp.split('/')[0]);

            let statusColor = "#00ff88"; 
            let adviceList = [];
            let headerMsg = localStorage.getItem("language") === "ar" ? "ÿßŸÑÿ≠ÿßŸÑÿ© ŸÖÿ≥ÿ™ŸÇÿ±ÿ©." : "Condition stable.";

            if (sensorDataString === "No measurement recorded yet") {
                headerMsg = localStorage.getItem("language") === "ar" ? "ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÇŸäÿßÿ≥ÿßÿ™..." : "Waiting for data...";
            } else {
                // 1. High BP
                if(sys > 140) {
                    statusColor = "#ff416c";
                    headerMsg = localStorage.getItem("language") === "ar" ? "‚ö†Ô∏è ÿ∂ÿ∫ÿ∑ ŸÖÿ±ÿ™ŸÅÿπ" : "‚ö†Ô∏è High BP";
                    adviceList.push(localStorage.getItem("language")==="ar" ? "ÿßÿ¥ÿ±ÿ® ŸÉÿ±ŸÉÿØŸäŸá ÿ®ÿßÿ±ÿØ." : "Drink Hibiscus.");
                    adviceList.push(localStorage.getItem("language")==="ar" ? "ŸÇŸÑŸÑ ÿßŸÑŸÖŸÑÿ≠." : "Reduce Salt.");
                }
                // 2. High Temp
                if(temp > 37.5) {
                    statusColor = "#ff416c";
                    headerMsg = localStorage.getItem("language") === "ar" ? "‚ö†Ô∏è ÿ≠ÿ±ÿßÿ±ÿ© ŸÖÿ±ÿ™ŸÅÿπÿ©" : "‚ö†Ô∏è High Temp";
                    adviceList.push(localStorage.getItem("language")==="ar" ? "ÿßÿ≥ÿ™ÿÆÿØŸÖ ŸÉŸÖÿßÿØÿßÿ™ ÿ®ÿßÿ±ÿØÿ©." : "Use cool compress.");
                    adviceList.push(localStorage.getItem("language")==="ar" ? "ÿßÿ¥ÿ±ÿ® ÿ≥Ÿàÿßÿ¶ŸÑ ÿ®ŸÉÿ´ÿ±ÿ©." : "Drink fluids.");
                }
                // 3. Low Oxygen
                if(spo2 > 0 && spo2 < 95) {
                    statusColor = "#ff416c";
                    headerMsg = localStorage.getItem("language") === "ar" ? "‚ö†Ô∏è ÿ£ŸÉÿ≥ÿ¨ŸäŸÜ ŸÖŸÜÿÆŸÅÿ∂" : "‚ö†Ô∏è Low Oxygen";
                    adviceList.push(localStorage.getItem("language")==="ar" ? "ÿ™ŸÜŸÅÿ≥ ÿ®ÿπŸÖŸÇ ŸÅŸä ÿßŸÑŸáŸàÿßÿ° ÿßŸÑÿ∑ŸÑŸÇ." : "Deep breath fresh air.");
                }
                
                if(adviceList.length === 0 && sensorDataString !== "No measurement recorded yet") {
                    adviceList.push(localStorage.getItem("language")==="ar" ? "ÿßÿ≥ÿ™ŸÖÿ± ŸÅŸä ÿ¥ÿ±ÿ® ÿßŸÑŸÖÿßÿ°." : "Keep hydrating.");
                }
            }

            // Build List HTML
            let finalHtml = `<strong>${headerMsg}</strong>`;
            if(adviceList.length > 0) {
                finalHtml += `<ul>`;
                adviceList.forEach(tip => finalHtml += `<li>${tip}</li>`);
                finalHtml += `</ul>`;
            }

            document.getElementById("aiText").innerHTML = finalHtml;
            document.querySelector(".ai-card").style.borderColor = statusColor;
        }
      });
    }

    // --- UTILS ---
    async function checkInternetConnection() { try { await fetch("https://www.google.com/favicon.ico?"+new Date().getTime(),{mode:"no-cors"});return true;}catch(e){return false;}}
    async function updateStatus(){const d=document.getElementById('connectionStatus');if(await checkInternetConnection()){d.classList.remove('offline');d.title="Online";}else{d.classList.add('offline');d.title="Offline";}}
    setInterval(updateStatus,3000);

    function showToast(msg,type="info"){const c=document.getElementById("toastContainer");const t=document.createElement("div");t.className=`toast toast-${type}`;t.innerHTML=`<i class="fas fa-info-circle"></i><span>${msg}</span>`;c.appendChild(t);setTimeout(()=>t.remove(),3000);}

    function sendWhatsAppReport(){
        let phone = currentUserId; 
        if (phone.startsWith('0')) phone = '20' + phone.substring(1);
        let m=`üè• *Bioscan Report*%0A- Temp: ${currentData.temp}%0A- Pulse: ${currentData.bpm}%0A- BP: ${currentData.bp}%0A- Ox: ${currentData.spo2}`;
        window.open(`https://wa.me/${phone}?text=${m}`,'_blank');
    }
    
    function findHospitals(){window.open("http://maps.google.com/maps?q=nearest+hospitals","_blank");}
    function toggleFullScreen(){if(!document.fullscreenElement)document.documentElement.requestFullscreen();else if(document.exitFullscreen)document.exitFullscreen();}
    function closeMeasurements(){localStorage.removeItem("selectedUserId");window.location.href="index.html";}
    
    let idle=0; setInterval(()=>{idle++;if(idle>=90)closeMeasurements();},1000);
    document.onmousemove=document.onkeypress=document.ontouchstart=document.onclick=()=>{idle=0;};

    // --- HOVER VOICE & LANG ---
    let voiceEnabled=true;
    function toggleHoverVoice(){voiceEnabled=!voiceEnabled;document.getElementById('voiceToggle').classList.toggle('active');}
    function setupHoverVoice(){
        const map={
            'analyzeBtn':{ar:'ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ¨ÿ≥ŸÖ',en:'Body Analysis'},
            'hospitalBtn':{ar:'ÿ£ŸÇÿ±ÿ® ŸÖÿ≥ÿ™ÿ¥ŸÅŸâ',en:'Nearest Hospital'},
            'sosBtn':{ar:'ŸÜÿØÿßÿ° ÿßÿ≥ÿ™ÿ∫ÿßÿ´ÿ©',en:'SOS Emergency'},
            'tempBtn':{ar:'ÿ≠ÿ±ÿßÿ±ÿ©',en:'Temperature'},
            'pulseBtn':{ar:'ŸÜÿ®ÿ∂',en:'Pulse'},
            'bpBtn':{ar:'ÿ∂ÿ∫ÿ∑',en:'Pressure'},
            'oxygenBtn':{ar:'ÿ£ŸÉÿ≥ÿ¨ŸäŸÜ',en:'Oxygen'},
            'visionBtn':{ar:'ŸÜÿ∏ÿ±',en:'Vision'},
            'historyBtn':{ar:'ÿßŸÑÿ≥ÿ¨ŸÑ',en:'History'}
        };
        Object.keys(map).forEach(id=>{
            const b=document.getElementById(id);
            if(b){
                b.onmouseenter=()=>{
                    if(!voiceEnabled) return;
                    window.speechSynthesis.cancel();
                    const u=new SpeechSynthesisUtterance(localStorage.getItem('language')==='ar'?map[id].ar:map[id].en);
                    u.lang=localStorage.getItem('language')==='ar'?'ar-SA':'en-US';
                    window.speechSynthesis.speak(u);
                };
                b.onmouseleave=()=>{ window.speechSynthesis.cancel(); }
            }
        });
    }

    function goToTemperature(){window.location.href="temp.html";}
    function goToPulse(){window.location.href="pulse.html";}
    function goToPressure(){window.location.href="pressure.html";}
    function goToOxygen(){window.location.href="oxygen.html";}
    function goToVisionPage(){window.location.href="instruction.html";}
    function goToHistory(){window.location.href="history.html";}

    const lang = localStorage.getItem("language") || "en";
    function applyLanguage(){
        if(lang==="ar"){
            document.body.style.direction="rtl";
            document.getElementById("titleText").innerHTML=`ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: <span>${currentUserId}</span>`;
            document.getElementById("aiTitle").innerText="ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ∞ŸÉŸä";
            document.getElementById("sidebarTitle").innerHTML='<i class="fas fa-brain"></i> ÿßŸÑŸÅÿ≠ÿµ ÿßŸÑÿ∞ŸÉŸä';
            document.getElementById("lblWeight").innerText="ÿßŸÑŸàÿ≤ŸÜ (ŸÉÿ¨ŸÖ)";
            document.getElementById("lblHeight").innerText="ÿßŸÑÿ∑ŸàŸÑ (ÿ≥ŸÖ)";
            document.getElementById("btnAnalyze").innerText="ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨";
            document.getElementById("hospitalBtn").title="ÿ£ŸÇÿ±ÿ® ŸÖÿ≥ÿ™ÿ¥ŸÅŸâ";
            document.getElementById("analyzeBtn").title="ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ¨ÿ≥ŸÖ";
            document.getElementById("sosBtn").title="ÿ∑Ÿàÿßÿ±ÿ¶";
            document.querySelector("#tempBtn span").innerText="ÿØÿ±ÿ¨ÿ© ÿßŸÑÿ≠ÿ±ÿßÿ±ÿ©";
            document.querySelector("#pulseBtn span").innerText="ŸÜÿ®ÿ∂ ÿßŸÑŸÇŸÑÿ®";
            document.querySelector("#bpBtn span").innerText="ÿ∂ÿ∫ÿ∑ ÿßŸÑÿØŸÖ";
            document.querySelector("#oxygenBtn span").innerText="ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ£ŸÉÿ≥ÿ¨ŸäŸÜ";
            document.querySelector("#visionBtn span").innerText="ŸÅÿ≠ÿµ ÿßŸÑŸÜÿ∏ÿ±";
            document.querySelector("#historyBtn span").innerText="ÿßŸÑÿ≥ÿ¨ŸÑ ŸàÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±";
            document.querySelector("#exitBtn").innerHTML='<i class="fas fa-sign-out-alt"></i> ÿÆÿ±Ÿàÿ¨';
        }
    }

    applyLanguage();
    window.onload = () => { 
        updateAIAnalysis(); 
        if ('speechSynthesis' in window) {
            window.speechSynthesis.onvoiceschanged = () => { setupHoverVoice(); };
            setTimeout(setupHoverVoice, 500);
        }
    };
  </script>
</body>
</html>
