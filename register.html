<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bioscan ATM | Register</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Orbitron:wght@400;500;700&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/css/intlTelInput.css">
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/intlTelInput.min.js"></script>

    <style>
        /* --- 1. THEME & VARIABLES --- */
        :root {
            --primary-neon: #00f2ff;
            --secondary-neon: #7000ff;
            --bg-dark: #020408;
            --glass-panel: rgba(5, 12, 22, 0.95);
            --border-color: rgba(0, 242, 255, 0.4);
            --text-main: #e0f7fa;
            --error: #ff2a2a;
            --success: #00ff88;
        }

        * { box-sizing: border-box; outline: none; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            font-family: 'Rajdhani', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative;
        }

        /* --- 2. PRELOADER STYLES --- */
        #preloader { position: fixed; inset: 0; background: #020408; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.8s ease-out, visibility 0.8s; }
        .loader-wrapper { position: relative; width: 120px; height: 120px; margin-bottom: 30px; }
        .loader-ring { position: absolute; inset: 0; border: 3px solid transparent; border-top-color: var(--primary-neon); border-right-color: var(--secondary-neon); border-radius: 50%; animation: spin 1.5s linear infinite; box-shadow: 0 0 20px rgba(0, 242, 255, 0.2); }
        .loader-logo { position: absolute; inset: 15px; border-radius: 50%; background: url('https://cdn-icons-png.flaticon.com/512/2966/2966487.png') no-repeat center/cover; animation: pulseLoader 2s infinite ease-in-out; filter: drop-shadow(0 0 10px var(--primary-neon)); }
        .loader-title { font-family: 'Orbitron', sans-serif; font-size: 1.8rem; letter-spacing: 4px; background: linear-gradient(90deg, #fff, var(--primary-neon)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 5px; }
        .progress-bar { width: 0%; height: 4px; background: var(--primary-neon); box-shadow: 0 0 10px var(--primary-neon); transition: width 0.3s; border-radius: 2px; width: 200px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulseLoader { 0%, 100% { transform: scale(0.9); opacity: 0.8; } 50% { transform: scale(1); opacity: 1; } }

        /* --- 3. BACKGROUND ANIMATION --- */
        #bio-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            overflow: hidden; 
            background: radial-gradient(circle at center, #0f1c2e 0%, #000000 90%);
        }
        .bio-symbol {
            position: absolute; color: var(--primary-neon); opacity: 0;
            animation: floatOrganic linear infinite; pointer-events: none;
            filter: blur(1px);
        }
        @keyframes floatOrganic {
            0% { transform: translate(0, 110vh) rotate(0deg) scale(0.5); opacity: 0; }
            10% { opacity: 0.15; }
            50% { transform: translate(20px, 50vh) rotate(180deg) scale(1); opacity: 0.25; }
            90% { opacity: 0.15; }
            100% { transform: translate(-20px, -10vh) rotate(360deg) scale(0.5); opacity: 0; }
        }

        /* --- 4. HEADER --- */
        header {
            position: absolute; top: 0; width: 100%; padding: 15px 40px;
            display: flex; justify-content: space-between; align-items: center; z-index: 10;
            background: linear-gradient(to bottom, rgba(2, 4, 8, 0.95), transparent);
            border-bottom: 1px solid rgba(0, 242, 255, 0.1);
        }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .brand { display: flex; align-items: center; gap: 15px; }
        .brand-logo { width: 45px; height: 45px; border: 2px solid var(--primary-neon); border-radius: 50%; box-shadow: 0 0 15px var(--primary-neon); animation: pulseLogo 3s infinite; }
        @keyframes pulseLogo { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .brand-text h1 { font-family: 'Orbitron', sans-serif; font-size: 1.2rem; margin: 0; letter-spacing: 2px; background: linear-gradient(90deg, #fff, var(--primary-neon)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .brand-text p { margin: 0; font-size: 0.7rem; color: var(--primary-neon); opacity: 0.8; letter-spacing: 2px; }
        .live-clock { display: flex; flex-direction: column; align-items: flex-start; border-left: 2px solid rgba(0, 242, 255, 0.3); padding-left: 15px; font-family: 'Orbitron', sans-serif; }
        .clock-time { font-size: 1.1rem; font-weight: bold; color: var(--primary-neon); }
        .clock-date { font-size: 0.7rem; color: #aaa; letter-spacing: 1px; }
        .controls { display: flex; gap: 15px; align-items: center; }
        .status-badge { display: flex; align-items: center; gap: 10px; background: rgba(0, 242, 255, 0.05); border: 1px solid rgba(0, 242, 255, 0.2); padding: 5px 12px; border-radius: 20px; }
        .status-led { width: 8px; height: 8px; border-radius: 50%; background-color: var(--success); box-shadow: 0 0 10px var(--success); }
        .status-text { font-family: 'Orbitron', sans-serif; font-size: 0.75rem; color: var(--success); font-weight: bold; }
        .icon-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: var(--primary-neon); width: 38px; height: 38px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: 0.3s; }
        .icon-btn:hover { background: var(--primary-neon); color: #000; box-shadow: 0 0 15px var(--primary-neon); }
        select.lang-select { background: rgba(0,0,0,0.6); color: #fff; border: 1px solid var(--primary-neon); padding: 5px 12px; border-radius: 20px; font-family: 'Rajdhani', sans-serif; cursor: pointer; }
        select.lang-select option { background: #050b14; }

        /* --- 5. REGISTRATION FORM --- */
        .main-container { position: relative; z-index: 5; width: 100%; max-width: 520px; padding: 20px; }
        .hud-card { background: var(--glass-panel); backdrop-filter: blur(25px); border: 1px solid var(--border-color); border-radius: 20px; padding: 45px 35px; text-align: center; position: relative; box-shadow: 0 0 30px rgba(0, 242, 255, 0.15); animation: cardBreath 4s infinite ease-in-out; }
        @keyframes cardBreath { 0%, 100% { border-color: rgba(0, 242, 255, 0.3); } 50% { border-color: rgba(0, 242, 255, 0.6); } }
        .card-header h2 { font-family: 'Orbitron', sans-serif; font-size: 1.6rem; margin: 0; text-shadow: 0 0 15px var(--primary-neon); letter-spacing: 2px; }
        .card-subtitle { font-size: 0.85rem; color: #aaa; margin-top: 8px; letter-spacing: 1px; }
        .energy-divider { height: 2px; width: 80%; margin: 20px auto 30px; background: radial-gradient(circle, var(--primary-neon) 0%, rgba(0,242,255,0) 90%); box-shadow: 0 0 10px var(--primary-neon); opacity: 0.8; }

        /* ITI Library Styling */
        .iti { width: 100%; margin-bottom: 15px; }
        .iti__country-list { background-color: #0b101a; color: #fff; border: 1px solid var(--primary-neon); z-index: 2000; text-align: left; }
        .iti__country:hover { background-color: rgba(0, 242, 255, 0.1); }

        .input-field { width: 100%; background: rgba(0, 0, 0, 0.5); border: 2px solid rgba(255, 255, 255, 0.1); padding: 15px; font-size: 1.1rem; color: #fff; border-radius: 12px; font-family: 'Rajdhani', sans-serif; transition: 0.3s; text-align: center; margin-bottom: 15px; }
        .input-field:focus { border-color: var(--primary-neon); box-shadow: 0 0 25px rgba(0, 242, 255, 0.3); }
        .input-field.valid { border-color: var(--success); box-shadow: 0 0 15px rgba(0, 255, 136, 0.3); }
        .input-field.invalid { border-color: var(--error); box-shadow: 0 0 15px rgba(255, 42, 42, 0.3); }
        .input-field:disabled { color: #aaa; cursor: not-allowed; }

        /* OTP Input */
        .otp-input-container { display: flex; gap: 8px; justify-content: center; margin-bottom: 20px; }
        .otp-digit { width: 50px; height: 60px; background: rgba(0, 0, 0, 0.5); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 10px; color: #fff; font-size: 1.5rem; font-weight: bold; text-align: center; transition: 0.3s; font-family: 'Orbitron', sans-serif; }
        .otp-digit:focus { border-color: var(--primary-neon); box-shadow: 0 0 25px rgba(0, 242, 255, 0.3); }
        .otp-digit.invalid { border-color: var(--error); box-shadow: 0 0 15px rgba(255, 42, 42, 0.3); }

        /* Password Toggle */
        .password-wrapper { position: relative; width: 100%; margin-bottom: 15px; }
        .password-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--primary-neon); font-size: 1.2rem; pointer-events: none; }
        .toggle-password { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--primary-neon); cursor: pointer; font-size: 1.1rem; transition: 0.3s; }
        .toggle-password:hover { color: #fff; }
        .input-field.password-field { padding-left: 45px; padding-right: 45px; }

        /* Security Standards */
        .security-standards { font-size: 0.75rem; color: #aaa; text-align: left; margin: -10px 0 15px 0; background: rgba(0, 0, 0, 0.3); padding: 10px 12px; border-radius: 8px; border-left: 2px solid var(--secondary-neon); line-height: 1.5; }

        /* Error Message */
        .error-msg { color: var(--error); font-size: 0.85rem; margin: -10px 0 15px 0; text-align: center; display: none; text-shadow: 0 0 10px rgba(255, 42, 42, 0.6); animation: errorPulse 0.5s ease; }
        @keyframes errorPulse { 0% { opacity: 0.5; text-shadow: 0 0 5px rgba(255, 42, 42, 0.3); } 50% { opacity: 1; text-shadow: 0 0 20px rgba(255, 42, 42, 0.8); } 100% { opacity: 1; text-shadow: 0 0 10px rgba(255, 42, 42, 0.6); } }
        .error-msg.show { display: block; }

        /* Step Indicator */
        .step-indicator { font-size: 0.8rem; color: var(--primary-neon); font-weight: bold; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; }

        .action-btn { width: 100%; padding: 15px; border: none; border-radius: 50px; background: linear-gradient(90deg, rgba(0,242,255,0.05), rgba(0,242,255,0.15)); border: 1px solid var(--primary-neon); color: #fff; font-family: 'Orbitron', sans-serif; font-size: 1.1rem; letter-spacing: 2px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; min-height: 55px; margin-top: 10px; }
        .action-btn:hover:not(:disabled) { background: var(--primary-neon); color: #000; box-shadow: 0 0 40px var(--primary-neon); }
        .action-btn:active:not(:disabled) { transform: scale(0.98); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-group { display: flex; gap: 10px; }
        .btn-group .action-btn { flex: 1; margin: 0; }

        /* Login Link */
        .login-link { text-align: center; margin-top: 20px; }
        .login-link a { color: var(--primary-neon); text-decoration: none; font-size: 0.9rem; transition: 0.3s; border-bottom: 1px solid rgba(0, 242, 255, 0.3); padding-bottom: 2px; }
        .login-link a:hover { color: #fff; border-bottom-color: var(--primary-neon); text-shadow: 0 0 10px rgba(0, 242, 255, 0.5); }

        #success-view { display: none; flex-direction: column; align-items: center; animation: fadeIn 0.5s; }
        .success-icon { font-size: 3.5rem; color: var(--success); margin-bottom: 15px; animation: popIn 0.5s; }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .footer { position: absolute; bottom: 15px; width: 100%; text-align: center; font-size: 0.75rem; color: rgba(255,255,255,0.3); letter-spacing: 1px; padding: 0 20px; }

        .toast-container { position: fixed; top: 100px; right: 20px; z-index: 4000; }
        .toast { background: rgba(5, 11, 20, 0.95); border-left: 4px solid var(--success); padding: 15px 25px; margin-bottom: 10px; border-radius: 5px; color: #fff; animation: slideIn 0.4s ease; display: flex; align-items: center; gap: 10px; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .shake { animation: shake 0.4s; border-color: var(--error) !important; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }

        /* Hidden Steps */
        .register-step { display: none; }
        .register-step.active { display: block; animation: fadeIn 0.3s; }

        /* --- 6. MOBILE RESPONSIVE --- */
        @media (max-width: 768px) {
            header { padding: 10px 15px; flex-wrap: wrap; gap: 10px; }
            .header-left { gap: 10px; flex: 1; }
            .brand { gap: 8px; }
            .brand-logo { width: 35px; height: 35px; }
            .brand-text h1 { font-size: 0.9rem; letter-spacing: 1px; }
            .brand-text p { font-size: 0.55rem; }
            .live-clock { display: none; }
            .controls { gap: 8px; }
            .main-container { padding: 15px; max-width: 100%; }
            .hud-card { padding: 30px 20px; }
            .card-header h2 { font-size: 1.3rem; }
            .input-field { font-size: 1rem; padding: 12px; margin-bottom: 10px; }
            .action-btn { font-size: 0.95rem; padding: 12px; min-height: 48px; }
            .otp-digit { width: 45px; height: 55px; font-size: 1.3rem; }
        }
    </style>
</head>

<body>

    <div id="preloader">
        <div class="loader-wrapper">
            <div class="loader-ring"></div>
            <div class="loader-logo"></div>
        </div>
        <div class="loader-title">BIOSCAN ATM</div>
        <div class="loader-status">Initializing System...</div>
        <div class="progress-bar"></div>
    </div>

    <div id="bio-background"></div>

    <header>
        <div class="header-left">
            <div class="brand">
                <img src="https://cdn-icons-png.flaticon.com/512/2966/2966487.png" class="brand-logo" alt="Logo">
                <div class="brand-text">
                    <h1>Bioscan ATM</h1>
                    <p>REGISTRATION</p>
                </div>
            </div>
            <div class="live-clock">
                <div class="clock-time" id="clockTime">00:00:00</div>
                <div class="clock-date" id="clockDate">--/--/----</div>
            </div>
        </div>
        <div class="controls">
            <div class="status-badge" id="statusBadge"><div class="status-led"></div><div class="status-text">ONLINE</div></div>
            <select class="lang-select" id="language_select" onchange="changeLanguage()">
                <option value="en">EN</option>
                <option value="ar">AR</option>
            </select>
        </div>
    </header>

    <div class="main-container">
        <div class="hud-card">
            <div class="card-header">
                <h2 id="reg-title">CREATE ACCOUNT</h2>
                <p class="card-subtitle" id="reg-subtitle">2FA Verification & Secure Registration</p>
                <div class="energy-divider"></div>
            </div>

            <!-- STEP 1: Phone Verification via 2FA -->
            <div id="step1-view" class="register-step active">
                <p class="step-indicator">STEP 1 OF 2 • PHONE VERIFICATION</p>
                
                <div class="input-wrapper">
                    <input type="tel" id="phoneNumber" class="input-field" placeholder="1xxxxxxxxx" onkeyup="validatePhone()">
                    <div class="error-msg" id="phone-error"></div>
                </div>

                <div class="btn-group">
                    <button class="action-btn" id="sendCodeBtn" onclick="sendVerificationCode()">
                        <i class="fas fa-paper-plane"></i> <span id="sendCodeText">SEND CODE</span>
                    </button>
                </div>

                <div id="otp-section" style="display: none; margin-top: 20px;">
                    <p style="color: #aaa; margin-bottom: 15px; font-size: 0.9rem;">Enter the 6-digit code sent to your phone</p>
                    <div class="otp-input-container" id="otpContainer">
                        <input type="text" class="otp-digit" maxlength="1" oninput="handleOTPInput(this)">
                        <input type="text" class="otp-digit" maxlength="1" oninput="handleOTPInput(this)">
                        <input type="text" class="otp-digit" maxlength="1" oninput="handleOTPInput(this)">
                        <input type="text" class="otp-digit" maxlength="1" oninput="handleOTPInput(this)">
                        <input type="text" class="otp-digit" maxlength="1" oninput="handleOTPInput(this)">
                        <input type="text" class="otp-digit" maxlength="1" oninput="handleOTPInput(this)">
                    </div>
                    <div class="error-msg" id="otp-error"></div>
                    <button class="action-btn" id="verifyCodeBtn" onclick="verifyCode()">
                        <i class="fas fa-check"></i> <span id="verifyCodeText">VERIFY</span>
                    </button>
                </div>

                <div class="login-link">
                    <a href="javascript:void(0)" onclick="goToLogin()">Already have an account? Sign In</a>
                </div>
            </div>

            <!-- STEP 2: Account Creation -->
            <div id="step2-view" class="register-step">
                <p class="step-indicator">STEP 2 OF 2 • CREATE ACCOUNT</p>
                
                <div class="input-wrapper">
                    <input type="text" id="fullName" class="input-field" placeholder="Full Name" onkeyup="validateName()">
                    <div class="error-msg" id="name-error"></div>
                </div>

                <div class="input-wrapper">
                    <input type="tel" id="phoneDisplay" class="input-field" placeholder="Phone" disabled>
                </div>

                <div class="password-wrapper">
                    <i class="fas fa-lock password-icon"></i>
                    <input type="password" id="password" class="input-field password-field" placeholder="••••••••" onkeyup="validatePassword()">
                    <i class="fas fa-eye toggle-password" id="togglePwd" onclick="togglePasswordVisibility()"></i>
                    <div class="error-msg" id="password-error"></div>
                </div>

                <div class="security-standards" id="security-msg">
                    Global Security Standard: Min 8 characters, include uppercase, numbers, and symbols.
                </div>

                <button class="action-btn" id="createAccountBtn" onclick="createAccount()">
                    <i class="fas fa-fingerprint"></i> <span>CREATE ACCOUNT & START</span>
                </button>

                <button class="action-btn" style="background: transparent; border: 1px solid #aaa; color: #aaa; margin-top: 10px;" onclick="backToStep1()">
                    <i class="fas fa-arrow-left"></i> <span>BACK</span>
                </button>
            </div>

            <!-- Success View -->
            <div id="success-view">
                <div class="success-icon"><i class="fas fa-check-circle"></i></div>
                <h3 id="success-title" style="color: var(--success);">Registration Successful!</h3>
                <p id="success-msg" style="color: #aaa; margin-bottom: 25px;">Your account has been created</p>
                <button class="action-btn" style="background: var(--success); color: #000; border: none; font-weight: 700;" onclick="goToLogin()">
                    <i class="fas fa-sign-in-alt"></i> <span>GO TO LOGIN</span>
                </button>
            </div>
        </div>
    </div>

    <div class="footer">Graduation Project 2026 | Zagazig University - Faculty of Engineering</div>
    <div class="toast-container" id="toastContainer"></div>
    <div id="recaptcha-container"></div>

    <script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAOwMQhsRM2PdD_FLjW_8Oi1WlFS3EO5pY",
            authDomain: "smart-a76a0.firebaseapp.com",
            databaseURL: "https://smart-a76a0-default-rtdb.firebaseio.com",
            projectId: "smart-a76a0",
            messagingSenderId: "343693501983",
            appId: "1:343693501983:web:10ea3fce9d990a2455172a"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // --- GLOBAL VARIABLES ---
        let currentLang = localStorage.getItem("language") || "en";
        let registrationPhone = "";
        let verificationCode = "";
        let confirmationResult = null;

        // Test phone numbers (for development)
        const testPhones = {
            // '+201234567890': '123456',
        };

        // --- 2. INITIALIZATION ---
        function startPreloader() {
            const bar = document.querySelector('.progress-bar');
            let w = 0;
            const iv = setInterval(() => {
                w += Math.random() * 15; if(w > 100) w = 100;
                bar.style.width = w + '%';
                if(w===100) {
                    clearInterval(iv);
                    setTimeout(() => { 
                        document.getElementById('preloader').style.opacity = '0'; 
                        setTimeout(() => { 
                            document.getElementById('preloader').style.display='none'; 
                        }, 800); 
                    }, 500);
                }
            }, 100);
        }

        const phoneInput = document.querySelector("#phoneNumber");
        const iti = window.intlTelInput(phoneInput, {
            separateDialCode: true,
            preferredCountries: ["eg", "sa", "ae"],
            utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js",
        });

        window.onload = () => {
            try {
                window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { 'size': 'invisible' }, auth);
            } catch(e) {
                console.error('RecaptchaVerifier init error:', e);
            }
            createBioBackground(); startPreloader(); startClock(); updateTexts(); checkConnection();
        };

        // --- 3. VALIDATION FUNCTIONS ---
        function validatePhone() {
            if (iti.isValidNumber()) { 
                phoneInput.classList.add("valid"); 
                phoneInput.classList.remove("invalid"); 
                document.getElementById('phone-error').classList.remove('show'); 
            } else { 
                phoneInput.classList.remove("valid"); 
                if(phoneInput.value.length > 3) phoneInput.classList.add("invalid"); 
            }
        }

        function validateName() {
            const name = document.getElementById('fullName').value.trim();
            const field = document.getElementById('fullName');
            field.classList.remove('valid', 'invalid');
            
            if(name.length >= 3) {
                field.classList.add('valid');
                document.getElementById('name-error').classList.remove('show');
            } else if(name.length > 0) {
                field.classList.add('invalid');
            }
        }

        function validatePassword() {
            const pwd = document.getElementById('password').value;
            const field = document.getElementById('password');
            
            field.classList.remove('valid', 'invalid');
            
            const hasLength = pwd.length >= 8;
            const hasUpper = /[A-Z]/.test(pwd);
            const hasLower = /[a-z]/.test(pwd);
            const hasNumbers = /\d/.test(pwd);
            const hasSymbols = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(pwd);
            
            const isStrong = hasLength && hasUpper && hasNumbers && hasSymbols;
            
            if(pwd.length === 0) {
                return;
            }
            
            if(isStrong) {
                field.classList.add('valid');
                document.getElementById('password-error').classList.remove('show');
            } else {
                field.classList.add('invalid');
            }
        }

        function togglePasswordVisibility() {
            const pwd = document.getElementById('password');
            const toggle = document.getElementById('togglePwd');
            
            if(pwd.type === 'password') {
                pwd.type = 'text';
                toggle.classList.remove('fa-eye');
                toggle.classList.add('fa-eye-slash');
            } else {
                pwd.type = 'password';
                toggle.classList.remove('fa-eye-slash');
                toggle.classList.add('fa-eye');
            }
        }

        function handleOTPInput(input) {
            if(!/^\d*$/.test(input.value)) {
                input.value = '';
                return;
            }
            
            if(input.value.length === 1) {
                const next = input.nextElementSibling;
                if(next) next.focus();
            }
            
            checkOTPComplete();
        }

        function checkOTPComplete() {
            const digits = document.querySelectorAll('.otp-digit');
            const allFilled = Array.from(digits).every(d => d.value !== '');
            const verifyBtn = document.getElementById('verifyCodeBtn');
            
            if(allFilled) {
                verifyBtn.focus();
            }
        }

        // --- 4. REGISTRATION FLOW ---
        function sendVerificationCode() {
            document.getElementById('phone-error').classList.remove('show');
            
            if(!iti.isValidNumber()) {
                phoneInput.classList.add('shake');
                showError('phone', currentLang === 'ar' ? "رقم هاتف غير صحيح" : "Invalid phone number");
                setTimeout(() => phoneInput.classList.remove('shake'), 400);
                return;
            }
            
            registrationPhone = iti.getNumber();
            const sendCodeBtn = document.getElementById('sendCodeBtn');
            const otpSection = document.getElementById('otp-section');
            sendCodeBtn.disabled = true;
            sendCodeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + (currentLang === 'ar' ? 'جاري...' : 'Sending...');
            
            // Check if phone exists in database FIRST
            database.ref('PatientData/' + registrationPhone).once('value').then(snapshot => {
                if(snapshot.exists()) {
                    sendCodeBtn.disabled = false;
                    sendCodeBtn.innerHTML = '<i class="fas fa-paper-plane"></i> <span>' + (currentLang === 'ar' ? 'إرسال الكود' : 'SEND CODE') + '</span>';
                    showError('phone', currentLang === 'ar' ? "الحساب موجود بالفعل" : "Account already registered");
                    phoneInput.classList.add('invalid');
                    return;
                }
                
                // Phone doesn't exist, proceed with 2FA
                // Check if test phone
                const isTestPhone = !!testPhones[registrationPhone];
                
                if(isTestPhone) {
                    // For test phones, use predefined code (NO Firebase needed)
                    verificationCode = testPhones[registrationPhone];
                    console.log('✓ Test Code: ' + verificationCode);
                    showToast(currentLang === 'ar' ? "تم إرسال الكود برسالة نصية" : "Code sent via SMS", "success");
                    sendCodeBtn.disabled = false;
                    sendCodeBtn.innerHTML = '<i class="fas fa-check"></i> <span>' + (currentLang === 'ar' ? 'تحقق' : 'VERIFY') + '</span>';
                    sendCodeBtn.onclick = verifyCode;
                    otpSection.style.display = 'block';
                    // Clear previous OTP values
                    document.querySelectorAll('.otp-digit').forEach(input => input.value = '');
                    document.querySelectorAll('.otp-digit')[0].focus();
                } else {
                    // Real Firebase Phone Auth
                    console.log('Sending real SMS to:', registrationPhone);
                    auth.signInWithPhoneNumber(registrationPhone, window.recaptchaVerifier)
                        .then(result => {
                            confirmationResult = result;
                            console.log('✓ SMS sent successfully');
                            showToast(currentLang === 'ar' ? "تم إرسال الكود برسالة نصية" : "Code sent via SMS", "success");
                            sendCodeBtn.disabled = false;
                            sendCodeBtn.innerHTML = '<i class="fas fa-check"></i> <span>' + (currentLang === 'ar' ? 'تحقق' : 'VERIFY') + '</span>';
                            sendCodeBtn.onclick = verifyCode;
                            otpSection.style.display = 'block';
                            // Clear previous OTP values
                            document.querySelectorAll('.otp-digit').forEach(input => input.value = '');
                            document.querySelectorAll('.otp-digit')[0].focus();
                        })
                        .catch(error => {
                            sendCodeBtn.disabled = false;
                            sendCodeBtn.innerHTML = '<i class="fas fa-paper-plane"></i> <span>' + (currentLang === 'ar' ? 'إرسال الكود' : 'SEND CODE') + '</span>';
                            console.error('SMS Error:', error);
                            showToast(currentLang === 'ar' ? "خطأ: " + error.message : "Error: " + error.message, "error");
                        });
                }
            }).catch(error => {
                sendCodeBtn.disabled = false;
                sendCodeBtn.innerHTML = '<i class="fas fa-paper-plane"></i> <span>' + (currentLang === 'ar' ? 'إرسال الكود' : 'SEND CODE') + '</span>';
                console.error('Database error:', error);
                showToast(currentLang === 'ar' ? "خطأ في الاتصال" : "Connection error", "error");
            });
        }

        function verifyCode() {
            const digits = document.querySelectorAll('.otp-digit');
            const code = Array.from(digits).map(d => d.value).join('');
            
            document.getElementById('otp-error').classList.remove('show');
            
            if(code.length !== 6 || !/^\d+$/.test(code)) {
                digits.forEach(d => d.classList.add('invalid'));
                showError('otp', currentLang === 'ar' ? "أدخل 6 أرقام صحيحة" : "Enter 6 valid digits");
                setTimeout(() => digits.forEach(d => d.classList.remove('invalid')), 400);
                return;
            }
            
            const verifyBtn = document.getElementById('verifyCodeBtn');
            verifyBtn.disabled = true;
            verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + (currentLang === 'ar' ? 'جاري التحقق...' : 'Verifying...');
            
            const isTestPhone = !!testPhones[registrationPhone];
            
            if(isTestPhone) {
                // Test phone verification (local)
                if(code === verificationCode) {
                    console.log('✓ Code verified successfully');
                    verifyBtn.disabled = false;
                    verifyBtn.innerHTML = '<i class="fas fa-check"></i> <span>' + (currentLang === 'ar' ? 'تحقق' : 'VERIFY') + '</span>';
                    showToast(currentLang === 'ar' ? "تم التحقق بنجاح ✓" : "Verified successfully ✓", "success");
                    // Clear error messages
                    document.getElementById('otp-error').classList.remove('show');
                    // Reset OTP fields
                    setTimeout(() => {
                        document.getElementById('phone-error').classList.remove('show');
                        digits.forEach(d => d.value = '');
                        moveToStep(2);
                    }, 500);
                } else {
                    verifyBtn.disabled = false;
                    verifyBtn.innerHTML = '<i class="fas fa-check"></i> <span>' + (currentLang === 'ar' ? 'تحقق' : 'VERIFY') + '</span>';
                    digits.forEach(d => d.classList.add('invalid'));
                    showError('otp', currentLang === 'ar' ? "رمز غير صحيح" : "Invalid code");
                    console.log('✗ Wrong code. Expected:', verificationCode, 'Got:', code);
                    setTimeout(() => digits.forEach(d => d.classList.remove('invalid')), 400);
                }
            } else {
                // Real Firebase verification
                console.log('Verifying with Firebase...');
                confirmationResult.confirm(code)
                    .then((result) => {
                        console.log('✓ Firebase phone auth successful');
                        verifyBtn.disabled = false;
                        verifyBtn.innerHTML = '<i class="fas fa-check"></i> <span>' + (currentLang === 'ar' ? 'تحقق' : 'VERIFY') + '</span>';
                        showToast(currentLang === 'ar' ? "تم التحقق بنجاح ✓" : "Verified successfully ✓", "success");
                        // Clear error messages
                        document.getElementById('otp-error').classList.remove('show');
                        // Reset OTP fields
                        setTimeout(() => {
                            document.getElementById('phone-error').classList.remove('show');
                            digits.forEach(d => d.value = '');
                            moveToStep(2);
                        }, 500);
                    })
                    .catch(error => {
                        verifyBtn.disabled = false;
                        verifyBtn.innerHTML = '<i class="fas fa-check"></i> <span>' + (currentLang === 'ar' ? 'تحقق' : 'VERIFY') + '</span>';
                        digits.forEach(d => d.classList.add('invalid'));
                        console.error('Firebase verification error:', error);
                        showError('otp', currentLang === 'ar' ? "رمز غير صحيح" : "Invalid code");
                        setTimeout(() => digits.forEach(d => d.classList.remove('invalid')), 400);
                    });
            }
        }

        function createAccount() {
            document.getElementById('name-error').classList.remove('show');
            document.getElementById('password-error').classList.remove('show');
            
            const fullName = document.getElementById('fullName').value.trim();
            const pwd = document.getElementById('password').value;
            
            if(fullName.length < 3) {
                document.getElementById('fullName').classList.add('shake');
                showError('name', currentLang === 'ar' ? "أدخل اسماً صحيحاً" : "Enter a valid name");
                setTimeout(() => document.getElementById('fullName').classList.remove('shake'), 400);
                return;
            }
            
            const hasUpper = /[A-Z]/.test(pwd);
            const hasLower = /[a-z]/.test(pwd);
            const hasNumbers = /\d/.test(pwd);
            const hasSymbols = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(pwd);
            
            if(pwd.length < 8 || !hasUpper || !hasLower || !hasNumbers || !hasSymbols) {
                document.getElementById('password').classList.add('shake');
                showError('password', currentLang === 'ar' ? "كلمة المرور ضعيفة" : "Password doesn't meet security standards");
                setTimeout(() => document.getElementById('password').classList.remove('shake'), 400);
                return;
            }
            
            const createBtn = document.getElementById('createAccountBtn');
            createBtn.disabled = true;
            createBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';
            
            const virtualEmail = registrationPhone.substring(1) + "@bioscan.com";
            
            auth.createUserWithEmailAndPassword(virtualEmail, pwd)
                .then((userCredential) => {
                    const uid = userCredential.user.uid;
                    const registrationDate = new Date().toLocaleString(currentLang === 'ar' ? 'ar-EG' : 'en-US');
                    
                    // Save to database using update (not set) to preserve History
                    database.ref('PatientData/' + registrationPhone).update({
                        FullName: fullName,
                        RegistrationDate: registrationDate,
                        UID: uid,
                        Phone: registrationPhone,
                        Password: pwd
                    }).then(() => {
                        showToast(currentLang === 'ar' ? "تم إنشاء الحساب بنجاح" : "Account created successfully", "success");
                        
                        document.getElementById('step2-view').classList.remove('active');
                        document.getElementById('success-view').style.display = 'flex';
                        
                        setTimeout(() => goToLogin(), 3000);
                    }).catch(error => {
                        createBtn.disabled = false;
                        createBtn.innerHTML = '<i class="fas fa-fingerprint"></i> <span>CREATE ACCOUNT & START</span>';
                        showToast(currentLang === 'ar' ? "خطأ في حفظ البيانات" : "Database error", "error");
                        console.error(error);
                    });
                })
                .catch(error => {
                    createBtn.disabled = false;
                    createBtn.innerHTML = '<i class="fas fa-fingerprint"></i> <span>CREATE ACCOUNT & START</span>';
                    if(error.code === 'auth/email-already-in-use') {
                        showError('phone', currentLang === 'ar' ? "الحساب موجود بالفعل" : "Account already exists");
                    } else {
                        showToast(error.message, "error");
                    }
                    console.error(error);
                });
        }

        function moveToStep(step) {
            const step1 = document.getElementById('step1-view');
            const step2 = document.getElementById('step2-view');
            
            step1.classList.remove('active');
            step2.classList.remove('active');
            
            if(step === 2) {
                step2.classList.add('active');
                document.getElementById('phoneDisplay').value = registrationPhone;
            } else {
                step1.classList.add('active');
            }
        }

        function backToStep1() {
            document.getElementById('fullName').value = '';
            document.getElementById('password').value = '';
            document.getElementById('password').type = 'password';
            document.getElementById('togglePwd').classList.remove('fa-eye-slash');
            document.getElementById('togglePwd').classList.add('fa-eye');
            moveToStep(1);
        }

        // --- 5. UI FUNCTIONS ---
        function showError(field, message) {
            const errorIds = {
                'phone': 'phone-error',
                'otp': 'otp-error',
                'name': 'name-error',
                'password': 'password-error'
            };
            const el = document.getElementById(errorIds[field]);
            if(el) {
                el.innerText = message;
                el.classList.add('show');
            }
        }

        function showToast(m, t) { 
            const c = document.getElementById("toastContainer"); 
            const el = document.createElement("div"); 
            el.className = "toast"; 
            el.style.borderLeftColor = t==='error'?'var(--error)':'var(--success)'; 
            el.innerHTML = `<i class="fas fa-info-circle"></i> ${m}`; 
            c.appendChild(el); 
            setTimeout(()=>el.remove(), 3500); 
        }

        function createBioBackground() {
            const container = document.getElementById('bio-background');
            const icons = ['fa-dna', 'fa-heartbeat', 'fa-notes-medical', 'fa-pills', 'fa-virus', 'fa-microscope', 'fa-user-md', 'fa-syringe', 'fa-lungs', 'fa-brain'];
            for (let i = 0; i < 35; i++) {
                const el = document.createElement('i');
                el.classList.add('fas', icons[Math.floor(Math.random() * icons.length)], 'bio-symbol');
                el.style.left = Math.random() * 100 + 'vw';
                el.style.fontSize = (Math.random() * 2 + 0.5) + 'rem';
                el.style.animationDuration = (Math.random() * 20 + 15) + 's';
                el.style.animationDelay = (Math.random() * 10) + 's';
                container.appendChild(el);
            }
        }

        function startClock() {
            setInterval(() => {
                const now = new Date(); 
                const loc = currentLang === 'ar' ? 'ar-EG' : 'en-US';
                document.getElementById('clockTime').innerText = now.toLocaleTimeString(loc, {hour12: false});
                document.getElementById('clockDate').innerText = now.toLocaleDateString(loc, {weekday:'short', day:'numeric', month:'short'});
            }, 1000);
        }

        function checkConnection() {
            setInterval(async () => {
                const badge = document.getElementById('statusBadge');
                try {
                    await fetch("https://www.google.com/favicon.ico?" + new Date().getTime(), { mode: "no-cors" });
                    badge.classList.remove('offline');
                } catch (e) { badge.classList.add('offline'); }
            }, 3000);
        }

        function changeLanguage() { 
            currentLang = document.getElementById("language_select").value; 
            localStorage.setItem("language", currentLang); 
            updateTexts(); 
            document.body.style.direction = currentLang === 'ar' ? 'rtl' : 'ltr';
        }

        function updateTexts() {
            document.body.style.direction = currentLang === 'ar' ? 'rtl' : 'ltr';
            
            document.getElementById("reg-title").innerText = currentLang === 'ar' ? "إنشاء حساب" : "CREATE ACCOUNT";
            document.getElementById("reg-subtitle").innerText = currentLang === 'ar' ? "التحقق الثنائي والتسجيل الآمن" : "2FA Verification & Secure Registration";
            document.getElementById("security-msg").innerText = currentLang === 'ar' ? "معيار الأمان العالمي: حد أدنى 8 أحرف، تضمين أحرف كبيرة وأرقام ورموز." : "Global Security Standard: Min 8 characters, include uppercase, numbers, and symbols.";
            document.getElementById("sendCodeText").innerText = currentLang === 'ar' ? "إرسال الكود" : "SEND CODE";
            document.getElementById("verifyCodeText").innerText = currentLang === 'ar' ? "تحقق" : "VERIFY";
        }

        function goToLogin() {
            window.location.href = "index.html";
        }
    </script>
</body>

</html>
