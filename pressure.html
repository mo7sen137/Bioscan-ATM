<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Bioscan | Blood Pressure</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Orbitron:wght@400;500;700&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  /* --- THEME VARIABLES --- */
  :root { 
    --primary-neon: #a29bfe;
    --secondary-neon: #fd79a8;
    --bg-dark: #020408;
    --glass-panel: rgba(8, 15, 25, 0.92);
    --border-color: rgba(162, 155, 254, 0.3);
    --text-main: #e0f7fa;
    --error: #ff2a2a;
    --success: #00ff88;
    --sys-color: #00f2ff;
    --dia-color: #ff00ff;
  }

  * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'Rajdhani', sans-serif;
    background-color: var(--bg-dark);
    color: var(--text-main);
    margin: 0; padding: 0;
    min-height: 100vh;
    overflow-x: hidden;
    padding-top: 80px;
  }

  /* RTL Support */
  body.rtl { font-family: 'Cairo', sans-serif; direction: rtl; }

  /* --- ANIMATED BACKGROUND --- */
  #bio-background {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
    overflow: hidden; background: radial-gradient(circle at center, #0f1c2e 0%, #000000 100%);
  }
  .bio-symbol {
    position: absolute; color: var(--primary-neon); opacity: 0.12;
    animation: floatData 30s linear infinite; pointer-events: none;
  }
  @keyframes floatData {
    0% { transform: translateY(110vh) rotate(0deg) scale(0.5); opacity: 0; }
    20% { opacity: 0.15; }
    80% { opacity: 0.15; }
    100% { transform: translateY(-10vh) rotate(360deg) scale(1.3); opacity: 0; }
  }

  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: #050b14; }
  ::-webkit-scrollbar-thumb { background: var(--primary-neon); border-radius: 10px; }

  /* --- HEADER BAR --- */
  .user-card { 
    position: fixed; top: 0; left: 0; width: 100%; height: 75px;
    background: rgba(5, 10, 18, 0.98); backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--primary-neon); 
    box-shadow: 0 0 25px rgba(162, 155, 254, 0.15); z-index: 100;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 25px;
  }
  
  .header-title { display: flex; flex-direction: column; }
  .header-title h2 { 
    margin: 0; font-family: 'Orbitron', sans-serif; 
    color: var(--primary-neon); font-size: 1.3rem; 
    letter-spacing: 1.5px; text-shadow: 0 0 10px var(--primary-neon);
  }

  .back-btn { 
    background: rgba(255,255,255,0.05); border: 1px solid var(--primary-neon);
    color: var(--primary-neon); padding: 8px 18px; border-radius: 50px;
    cursor: pointer; font-size: 0.9rem; transition: 0.3s;
    display: flex; align-items: center; gap: 8px;
    font-family: 'Orbitron', sans-serif; font-weight: 600;
  }
  .back-btn:hover { 
    background: var(--primary-neon); color: #000; 
    box-shadow: 0 0 20px var(--primary-neon); transform: translateY(-2px);
  }

  /* Header Actions */
  .header-actions {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .header-btn {
    background: rgba(255,255,255,0.05);
    border: 1px solid var(--primary-neon);
    color: var(--primary-neon);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1rem;
    transition: 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .header-btn:hover {
    background: var(--primary-neon);
    color: #000;
    box-shadow: 0 0 15px var(--primary-neon);
    transform: translateY(-2px);
  }

  #langBtn {
    width: 45px;
    font-size: 0.75rem;
    font-weight: 700;
    font-family: 'Orbitron', sans-serif;
  }

  /* --- MAIN CONTAINER --- */
  .container { 
    display: flex; flex-direction: column; align-items: center;
    width: 100%; max-width: 1200px; margin: 0 auto;
    padding: 30px 20px; min-height: calc(100vh - 80px);
  }

  /* --- NEON GLOWING CARD --- */
  .measurement-card {
    background: var(--glass-panel);
    backdrop-filter: blur(25px);
    border: 1px solid var(--border-color);
    border-radius: 25px;
    padding: 35px;
    width: 100%; max-width: 550px;
    margin: 0 auto;
    box-shadow: 0 0 30px rgba(162, 155, 254, 0.2), inset 0 0 20px rgba(162, 155, 254, 0.05);
    animation: cardPulse 4s infinite ease-in-out;
    position: relative;
    overflow: hidden;
  }

  @keyframes cardPulse {
    0%, 100% { 
      box-shadow: 0 0 30px rgba(162, 155, 254, 0.2), inset 0 0 20px rgba(162, 155, 254, 0.05);
      border-color: rgba(162, 155, 254, 0.3);
    }
    50% { 
      box-shadow: 0 0 50px rgba(162, 155, 254, 0.4), inset 0 0 30px rgba(162, 155, 254, 0.1);
      border-color: rgba(162, 155, 254, 0.6);
    }
  }

  /* SOS Critical State */
  .critical-state {
    animation: sosFlash 1s infinite !important;
    border: 2px solid var(--error) !important;
  }
  @keyframes sosFlash {
    0%, 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
    50% { box-shadow: 0 0 60px 30px rgba(255, 0, 0, 0.5); background: rgba(50, 0, 0, 0.3); }
  }

  .sos-banner { 
    display: none; background: var(--error); color: white; 
    font-weight: bold; padding: 12px; border-radius: 15px; 
    margin-bottom: 20px; text-align: center;
    animation: blink 0.5s infinite alternate;
    font-family: 'Orbitron', sans-serif; font-size: 1rem;
  }
  @keyframes blink { from { opacity: 1; } to { opacity: 0.7; } }

  /* --- GAUGE DESIGN --- */
  .gauge-container {
    position: relative; width: 260px; height: 260px; 
    margin: 20px auto;
    display: flex; justify-content: center; align-items: center;
  }

  .gauge-scale {
    position: absolute; inset: 0; border-radius: 50%;
    background: repeating-conic-gradient(
      from 0deg, 
      rgba(162, 155, 254, 0.2) 0deg 1deg, 
      transparent 1deg 10deg
    );
    mask-image: radial-gradient(transparent 62%, black 62%);
    -webkit-mask-image: radial-gradient(transparent 62%, black 62%);
    opacity: 0.6;
  }

  .scale-label { 
    position: absolute; font-size: 0.9rem; 
    color: var(--primary-neon); font-weight: bold;
    font-family: 'Orbitron', sans-serif;
    text-shadow: 0 0 8px var(--primary-neon);
    z-index: 10;
  }
  .label-0 { bottom: 8%; left: 18%; }
  .label-150 { top: -5%; left: 50%; transform: translateX(-50%); }
  .label-300 { bottom: 8%; right: 18%; }

  .gauge-track {
    position: absolute; inset: 18px; border-radius: 50%;
    border: 12px solid rgba(30, 30, 30, 0.8);
    box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.9),
                0 0 20px rgba(162, 155, 254, 0.1);
  }

  .hand-container {
    position: absolute; inset: 0;
    transition: transform 1.8s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .dot {
    position: absolute; top: 12px; left: 50%; 
    transform: translateX(-50%);
    border-radius: 50%;
  }
  
  .sys-dot {
    width: 22px; height: 22px; 
    background: var(--sys-color);
    box-shadow: 0 0 20px var(--sys-color), 0 0 40px var(--sys-color);
    z-index: 2;
  }
  
  .dia-dot {
    width: 16px; height: 16px; 
    background: var(--dia-color);
    box-shadow: 0 0 18px var(--dia-color);
    top: 28px;
    z-index: 2;
  }

  .center-display {
    position: absolute; width: 130px; height: 130px;
    background: radial-gradient(circle, #1a1a1a, #0a0a0a);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    border: 2px solid rgba(162, 155, 254, 0.2);
    box-shadow: 0 0 25px rgba(0, 0, 0, 0.9), inset 0 0 15px rgba(162, 155, 254, 0.1);
  }
  .center-display i {
    font-size: 3.5rem;
    background: linear-gradient(135deg, var(--sys-color), var(--dia-color));
    -webkit-background-clip: text; 
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 0 8px var(--sys-color));
    animation: pulseHeart 2.5s infinite;
  }
  @keyframes pulseHeart { 
    0%, 100% { transform: scale(1); opacity: 0.85; } 
    50% { transform: scale(1.15); opacity: 1; filter: drop-shadow(0 0 18px var(--dia-color)); } 
  }

  /* --- PRESSURE DISPLAY --- */
  .pressure-box { 
    background: rgba(0, 0, 0, 0.5); 
    border-radius: 18px; padding: 22px; margin: 25px 0; 
    border: 1px solid rgba(162, 155, 254, 0.2);
    display: flex; justify-content: center; align-items: center; gap: 18px;
    box-shadow: 0 0 15px rgba(162, 155, 254, 0.1);
  }
  .reading-part { display: flex; flex-direction: column; align-items: center; }
  .reading-label { 
    font-size: 0.75rem; color: #888; 
    text-transform: uppercase; letter-spacing: 1.5px;
    font-family: 'Orbitron', sans-serif;
  }
  .reading-val { 
    font-size: 2.2rem; font-weight: 700; 
    font-family: 'Orbitron', sans-serif;
    margin-top: 5px;
  }
  .sys-val { color: var(--sys-color); text-shadow: 0 0 15px var(--sys-color); }
  .dia-val { color: var(--dia-color); text-shadow: 0 0 15px var(--dia-color); }
  .divider { font-size: 2.2rem, 0 0 15px rgba(162, 155, 254, 0.1); }
  .unit { font-size: 0.8rem; color: #666; font-family: 'Orbitron', sans-serif; }

  /* --- INSTRUCTIONS --- */
  .instructions-list { 
    list-style: none; padding: 0; 
    text-align: left; margin: 25px 0;
  }
  .instructions-list li { 
    margin-bottom: 14px; display: flex; 
    align-items: center; gap: 12px; 
    font-size: 1rem; color: #ccc;
  }
  .instructions-list li i { 
    color: var(--primary-neon); width: 28px; 
    text-align: center; font-size: 1.1rem;
  }
  
  /* --- ACTION BUTTONS --- */
  .actions-row { 
    display: flex; gap: 12px; 
    justify-content: center; flex-wrap: wrap; 
    margin-top: 25px;
  }
  .action-btn { 
    padding: 14px 24px; border-radius: 50px; 
    border: none; cursor: pointer; 
    font-size: 0.95rem; font-weight: 600; 
    font-family: 'Rajdhani', sans-serif; 
    transition: 0.3s; 
    display: flex; align-items: center; 
    justify-content: center; gap: 10px;
  }
  .save-btn { 
    flex: 2; 
    background: linear-gradient(135deg, #11998e, #38ef7d); 
    color: white; 
    box-shadow: 0 4px 20px rgba(56, 239, 125, 0.3);
  }
  .advice-btn { 
    flex: 2; 
    background: linear-gradient(135deg, #6a11cb, #2575fc); 
    color: white; 
    box-shadow: 0 4px 20px rgba(106, 17, 203, 0.3);
  }
  .voice-btn { 
    flex: 1; 
    background: rgba(255,255,255,0.08); 
    border: 1px solid var(--primary-neon); 
    color: var(--primary-neon);
  }
  .action-btn:hover { 
    transform: translateY(-3px); 
    filter: brightness(1.2); 
  }
  .voice-btn:hover { 
    background: var(--primary-neon); 
    color: #000; 
    box-shadow: 0 0 20px var(--primary-neon);
  }

  .advice-box { 
    background: rgba(0, 0, 0, 0.6); 
    padding: 18px; border-radius: 15px; 
    margin-top: 20px; display: none; 
    font-size: 1.05rem; color: #fff; 
    border-left: 4px solid var(--primary-neon); 
    animation: slideDown 0.5s ease;
  }
  @keyframes slideDown { 
    from { opacity: 0; transform: translateY(-10px); } 
    to { opacity: 1; transform: translateY(0); } 
  }

  /* --- MODAL --- */
  .confirm-modal { 
    position: fixed; inset: 0; 
    background: rgba(0,0,0,0.9); 
    backdrop-filter: blur(10px); 
    z-index: 5000; display: none; 
    justify-content: center; align-items: center; 
    opacity: 0; transition: opacity 0.3s ease;
  }
  .confirm-modal.active { display: flex; opacity: 1; }
  
  .confirm-content { 
    background: linear-gradient(145deg, #0e1621, #1a2332); 
    border: 2px solid var(--primary-neon); 
    border-radius: 25px; width: 90%; max-width: 420px; 
    padding: 35px; text-align: center; 
    box-shadow: 0 0 60px rgba(162, 155, 254, 0.4); 
    transform: scale(0.8); transition: transform 0.3s ease;
  }
  .confirm-modal.active .confirm-content { transform: scale(1); }
  
  .success-icon { 
    font-size: 4.5rem; color: var(--success); 
    margin-bottom: 20px; 
    animation: popIn 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    filter: drop-shadow(0 0 15px var(--success));
  }
  @keyframes popIn { 
    0% { transform: scale(0); } 
    80% { transform: scale(1.2); } 
    100% { transform: scale(1); } 
  }
  
  .confirm-title { 
    font-size: 1.6rem; margin-bottom: 12px; 
    color: var(--primary-neon); 
    font-family: 'Orbitron', sans-serif;
  }
  .confirm-text { 
    color: #ccc; margin-bottom: 28px; 
    font-size: 1rem;
  }
  .confirm-btn { 
    background: var(--primary-neon); 
    color: #000; border: none; 
    padding: 13px 35px; border-radius: 50px; 
    font-weight: 700; cursor: pointer; 
    font-size: 1.05rem; transition: 0.3s;
    font-family: 'Orbitron', sans-serif;
  }
  .confirm-btn:hover { 
    transform: scale(1.08); 
    box-shadow: 0 0 25px var(--primary-neon); 
  }

  /* --- RESPONSIVE --- */
  @media (max-width: 600px) {
    body { padding-top: 70px; }
    
    .user-card { 
      height: 60px; 
      padding: 0 12px;
    }
    
    .header-title h2 { 
      font-size: 1rem; 
      letter-spacing: 1px;
    }
    
    .back-btn { 
      padding: 6px 12px;
      font-size: 0.8rem;
    }
    .back-btn span { display: none; }

    .container {
      padding: 20px 12px;
    }

    .measurement-card {
      width: calc(100% - 20px);
      max-width: 480px;
      padding: 25px 18px;
    }

    .gauge-container {
      width: 200px;
      height: 200px;
    }

    .gauge-track { inset: 14px; border-width: 10px; }
    .sys-dot { width: 18px; height: 18px; }
    .dia-dot { width: 14px; height: 14px; top: 24px; }
    .center-display { width: 110px; height: 110px; }
    .center-display i { font-size: 2.8rem; }
    .scale-label { font-size: 0.75rem; z-index: 10; }
    .label-0 { bottom: 5%; left: 15%; }
    .label-150 { top: -8%; }
    .label-300 { bottom: 5%; right: 15%; }

    .pressure-box {
      padding: 16px;
      margin: 18px 0;
    }

    .reading-val {
      font-size: 1.8rem;
    }

    .reading-label {
      font-size: 0.65rem;
    }

    .instructions-list li {
      font-size: 0.9rem;
    }

    .actions-row {
      flex-direction: column;
      gap: 10px;
    }

    .action-btn {
      width: 100%;
      padding: 13px 20px;
    }

    .confirm-content {
      width: calc(100% - 30px);
      padding: 28px 20px;
    }
  }

  @media (max-width: 400px) {
    .user-card { height: 55px; }
    .header-title h2 { font-size: 0.9rem; }
    .measurement-card { width: calc(100% - 16px); padding: 20px 15px; }
    .gauge-container { width: 180px; height: 180px; }
    .reading-val { font-size: 1.6rem; }
    
    .scale-label { font-size: 0.7rem; }
    .label-0 { left: 12%; }
    .label-300 { right: 12%; }
    .label-150 { top: -10%; }
  }
</style>
</head>
<body>

<div id="bio-background"></div>

<audio id="alarmSound" loop>
  <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
</audio>

<header class="user-card">
  <button id="backBtn" class="back-btn" onclick="goBack()">
    <i class="fas fa-arrow-left"></i> <span>Back</span>
  </button>
  <div class="header-title">
    <h2 id="headerTitle">BLOOD PRESSURE</h2>
  </div>
  <div class="header-actions">
    <button class="header-btn" id="langBtn" onclick="toggleLanguage()">EN</button>
    <button class="header-btn" onclick="toggleFullscreen()">
      <i class="fas fa-expand"></i>
    </button>
  </div>
</header>

<div class="container">
  <div id="sosBanner" class="sos-banner">
    <i class="fas fa-exclamation-triangle"></i> CRITICAL ALERT
  </div>
  
  <div class="measurement-card" id="mainCard">
    
    <div class="gauge-container">
      <div class="gauge-scale"></div>
      <span class="scale-label label-0">0</span>
      <span class="scale-label label-150">150</span>
      <span class="scale-label label-300">300</span>

      <div class="gauge-track"></div>
      
      <div class="hand-container" id="sysContainer" style="transform: rotate(-135deg);">
        <div class="dot sys-dot"></div>
      </div>
      
      <div class="hand-container" id="diaContainer" style="transform: rotate(-135deg);">
        <div class="dot dia-dot"></div>
      </div>

      <div class="center-display">
        <i class="fas fa-heartbeat"></i>
      </div>
    </div>

    <div class="pressure-box">
      <div class="reading-part">
        <span class="reading-label">SYS</span>
        <span class="reading-val sys-val" id="sysVal">--</span>
      </div>
      <div class="divider">/</div>
      <div class="reading-part">
        <span class="reading-label">DIA</span>
        <span class="reading-val dia-val" id="diaVal">--</span>
      </div>
      <span class="unit">mmHg</span>
    </div>
    
    <h3 id="instrTitle" style="color: var(--primary-neon); font-weight: 500; margin-bottom: 18px; font-family: 'Orbitron', sans-serif; font-size: 1.1rem;">
      INSTRUCTIONS
    </h3>
    <ul class="instructions-list" id="instructions">
      <li><i class="fas fa-chair"></i> Sit calmly and relax</li>
      <li><i class="fas fa-hand-holding-heart"></i> Rest your arm comfortably</li>
    </ul>
    
    <div class="actions-row">
      <button class="action-btn save-btn" onclick="saveMeasurement()">
        <i class="fas fa-save"></i> <span id="saveBtnText">Save Reading</span>
      </button>
      <button class="action-btn advice-btn" onclick="showAdvice()">
        <i class="fas fa-user-md"></i> <span id="btnText">Medical Advice</span>
      </button>
      <button class="action-btn voice-btn" onclick="speakResult()">
        <i class="fas fa-volume-up"></i>
      </button>
    </div>
    <div class="advice-box" id="adviceBox"></div>
  </div>
</div>

<div id="confirmModal" class="confirm-modal">
  <div class="confirm-content">
    <div class="success-icon"><i class="fas fa-check-circle"></i></div>
    <h3 class="confirm-title" id="modalTitle">Success!</h3>
    <p class="confirm-text" id="modalText">Measurement saved successfully.</p>
    <button class="confirm-btn" onclick="closeConfirmModal()">OK</button>
  </div>
</div>

<script>
  // --- 1. ANIMATED BACKGROUND ---
  function createBioBackground() {
    const container = document.getElementById('bio-background');
    const icons = [
      'fa-heartbeat', 'fa-heart-pulse', 'fa-stethoscope', 
      'fa-syringe', 'fa-notes-medical', 'fa-briefcase-medical',
      'fa-capsules', 'fa-prescription-bottle', 'fa-dna',
      'fa-lungs', 'fa-hand-holding-heart', 'fa-heart-circle-plus'
    ];
    for (let i = 0; i < 20; i++) {
      const el = document.createElement('i');
      el.classList.add('fas', icons[Math.floor(Math.random() * icons.length)], 'bio-symbol');
      el.style.left = Math.random() * 100 + 'vw';
      el.style.fontSize = (Math.random() * 2 + 1.2) + 'rem';
      el.style.animationDuration = (Math.random() * 20 + 25) + 's';
      el.style.animationDelay = (Math.random() * 8) + 's';
      container.appendChild(el);
    }
  }
  createBioBackground();

  // --- 2. CONFIG ---
  const firebaseConfig = {
    apiKey: "AIzaSyAOwMQhsRM2PdD_FLjW_8Oi1WlFS3EO5pY",
    authDomain: "smart-a76a0.firebaseapp.com",
    databaseURL: "https://smart-a76a0-default-rtdb.firebaseio.com",
    projectId: "smart-a76a0",
    messagingSenderId: "343693501983",
    appId: "1:343693501983:web:10ea3fce9d990a2455172a"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();
  auth.signInAnonymously().catch(console.error);

  const sysValBox = document.getElementById("sysVal");
  const diaValBox = document.getElementById("diaVal");
  const adviceBox = document.getElementById("adviceBox");
  const sosBanner = document.getElementById("sosBanner");
  const mainCard = document.getElementById("mainCard");
  const alarmSound = document.getElementById("alarmSound");
  
  const sysContainer = document.getElementById("sysContainer");
  const diaContainer = document.getElementById("diaContainer");

  const userId = localStorage.getItem("selectedUserId");
  const PATIENT_DATA_PATH = "PatientData";
  let isCritical = false;

  // --- 3. GAUGE LOGIC ---
  function updatePressureUI(valString) {
    if(!valString) return;
    
    const parts = valString.split('/');
    const systolic = parseInt(parts[0]);
    const diastolic = parseInt(parts[1]);
    
    if(!isNaN(systolic) && !isNaN(diastolic)) {
      sysValBox.innerText = systolic;
      diaValBox.innerText = diastolic;

      const maxScale = 300;
      let sysAngle = (systolic / maxScale * 270) - 135;
      let diaAngle = (diastolic / maxScale * 270) - 135;
      
      sysContainer.style.transform = `rotate(${sysAngle}deg)`;
      diaContainer.style.transform = `rotate(${diaAngle}deg)`;

      if (systolic > 160 || systolic < 80) triggerSOS();
      else clearSOS();
    }
  }

  if (userId) {
    db.ref(PATIENT_DATA_PATH + "/" + userId + "/SensorData").on("value", snapshot => {
      const str = snapshot.val() || "";
      if(str && str.includes("BP=")) {
        const parts = str.split(",");
        const bpPart = parts.find(p => p.trim().startsWith("BP="));
        if(bpPart) {
          const val = bpPart.split("=")[1];
          if(val && val.includes('/')) updatePressureUI(val);
        }
      }
    });
  }

  // --- 4. SAVE ---
  function saveMeasurement() {
    const s = sysValBox.innerText;
    const d = diaValBox.innerText;
    if (s === "--" || d === "--") {
      alert("No pressure reading available!");
      return;
    }
    const fullVal = `${s}/${d}`;
    
    if (!userId) { 
      alert("No user selected!");
      window.location.href = "index.html"; 
      return; 
    }
    
    let sessionId = localStorage.getItem("currentSessionId");
    if (!sessionId) { 
      sessionId = Date.now().toString(); 
      localStorage.setItem("currentSessionId", sessionId); 
    }

    const timestamp = new Date().toLocaleString();
    
    db.ref(`${PATIENT_DATA_PATH}/${userId}/History/${sessionId}`).update({
      pressure: fullVal,
      createdAt: timestamp
    });
    
    db.ref(`${PATIENT_DATA_PATH}/${userId}/SensorData`).once('value').then(snapshot => {
      let currentStr = snapshot.val() || "";
      if (currentStr.includes("BP=")) {
        currentStr = currentStr.replace(/BP=[^,]+/, `BP=${fullVal}`);
      } else if (currentStr === "No measurement recorded yet" || !currentStr) {
        currentStr = `BP=${fullVal}`;
      } else {
        currentStr = currentStr ? `${currentStr}, BP=${fullVal}` : `BP=${fullVal}`;
      }
      
      db.ref(`${PATIENT_DATA_PATH}/${userId}`).update({ 
        SensorData: currentStr, 
        Timestamp: timestamp 
      }).then(() => {
        console.log("Saved successfully!");
        showConfirmModal();
      }).catch(err => {
        console.error("Save error:", err);
        alert("Failed to save!");
      });
    });
  }

  function showConfirmModal() {
    const isAr = localStorage.getItem("language") === "ar";
    document.getElementById("modalTitle").innerText = isAr ? "ÿ™ŸÖ ÿ®ŸÜÿ¨ÿßÿ≠!" : "Success!";
    document.getElementById("modalText").innerText = isAr ? "ÿ™ŸÖ ÿ≠ŸÅÿ∏ ŸÇŸäÿßÿ≥ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿ®ŸÜÿ¨ÿßÿ≠." : "Blood Pressure saved successfully.";
    document.querySelector(".confirm-btn").innerText = isAr ? "ÿ≠ÿ≥ŸÜÿßŸã" : "OK";
    const modal = document.getElementById("confirmModal");
    modal.style.display = "flex";
    setTimeout(() => modal.classList.add("active"), 10);
  }
  
  function closeConfirmModal() {
    const modal = document.getElementById("confirmModal");
    modal.classList.remove("active");
    setTimeout(() => modal.style.display = "none", 300);
  }

  // --- 5. SOS ---
  function triggerSOS() { 
    if(isCritical) return; 
    isCritical = true; 
    mainCard.classList.add("critical-state"); 
    sosBanner.style.display = "block"; 
    alarmSound.play().catch(e=>console.log("Audio error:", e)); 
    const lang = localStorage.getItem("language") || "en"; 
    sosBanner.innerHTML = lang === "ar" 
      ? '<i class="fas fa-exclamation-triangle"></i> ÿÆÿ∑ÿ±: ÿ∂ÿ∫ÿ∑ ÿ≠ÿ±ÿ¨!' 
      : '<i class="fas fa-exclamation-triangle"></i> CRITICAL ALERT!'; 
  }
  
  function clearSOS() { 
    if(!isCritical) return; 
    isCritical = false; 
    mainCard.classList.remove("critical-state"); 
    sosBanner.style.display = "none"; 
    alarmSound.pause(); 
    alarmSound.currentTime = 0; 
  }
  
  function speakResult() {
    let s = sysValBox.innerText;
    let d = diaValBox.innerText;
    if (s === "--" || d === "--") {
      alert("No reading to speak!");
      return;
    }
    const lang = localStorage.getItem("language") || "en";
    let text = (lang === "ar") 
      ? `ÿ∂ÿ∫ÿ∑ ÿßŸÑÿØŸÖ ${s} ÿπŸÑŸâ ${d}` 
      : `Blood pressure is ${s} over ${d}`;
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = lang === "ar" ? "ar-SA" : "en-US";
    window.speechSynthesis.speak(utterance);
  }

  function showAdvice() {
    let val = parseInt(sysValBox.innerText);
    const lang = localStorage.getItem("language") || "en";
    let txt = "";
    if (isNaN(val)) {
      txt = lang === "ar" ? "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™." : "No data available.";
    } else if (val > 140) { 
      txt = lang === "ar" ? "ÿ∂ÿ∫ÿ∑ ŸÖÿ±ÿ™ŸÅÿπ! ŸÇŸÑŸÑ ÿßŸÑŸÖŸÑÿ≠." : "High Pressure! Reduce salt intake."; 
      adviceBox.style.borderLeftColor = "#ff0000"; 
    } else { 
      txt = lang === "ar" ? "ÿ∂ÿ∫ÿ∑ ÿ∑ÿ®ŸäÿπŸä." : "Normal Pressure."; 
      adviceBox.style.borderLeftColor = "var(--primary-neon)"; 
    }
    adviceBox.innerText = txt; 
    adviceBox.style.display = "block";
  }

  function goBack() { 
    clearSOS(); 
    window.location.href = "measurements.html"; 
  }

  // --- 6. RTL SUPPORT ---
  const lang = localStorage.getItem("language") || "en";
  
  function applyLanguage(language) {
    const isAr = language === "ar";
    
    if (isAr) {
      document.body.classList.add("rtl");
      document.getElementById("headerTitle").innerText = "ŸÇŸäÿßÿ≥ ÿ∂ÿ∫ÿ∑ ÿßŸÑÿØŸÖ";
      document.getElementById("backBtn").innerHTML = '<span>ÿπŸàÿØÿ©</span> <i class="fas fa-arrow-right"></i>';
      document.getElementById("instrTitle").innerText = "ÿ™ÿπŸÑŸäŸÖÿßÿ™ ÿßŸÑŸÇŸäÿßÿ≥";
      document.getElementById("btnText").innerText = "ÿßŸÑŸÜÿµŸäÿ≠ÿ© ÿßŸÑÿ∑ÿ®Ÿäÿ©";
      document.getElementById("saveBtnText").innerText = "ÿ≠ŸÅÿ∏ ÿßŸÑŸÇŸäÿßÿ≥";
      document.getElementById("instructions").innerHTML = `
        <li><i class="fas fa-chair"></i> ÿßÿ¨ŸÑÿ≥ ÿ®ŸáÿØŸàÿ° Ÿàÿßÿ≥ÿ™ÿ±ÿÆŸê</li>
        <li><i class="fas fa-hand-holding-heart"></i> ÿßÿ±ÿ≠ ÿ∞ÿ±ÿßÿπŸÉ ÿ®ÿ¥ŸÉŸÑ ŸÖÿ±Ÿäÿ≠</li>
      `;
      document.getElementById("langBtn").innerText = "ÿπ";
    } else {
      document.body.classList.remove("rtl");
      document.getElementById("headerTitle").innerText = "BLOOD PRESSURE";
      document.getElementById("backBtn").innerHTML = '<i class="fas fa-arrow-left"></i> <span>Back</span>';
      document.getElementById("instrTitle").innerText = "INSTRUCTIONS";
      document.getElementById("btnText").innerText = "Medical Advice";
      document.getElementById("saveBtnText").innerText = "Save Reading";
      document.getElementById("instructions").innerHTML = `
        <li><i class="fas fa-chair"></i> Sit calmly and relax</li>
        <li><i class="fas fa-hand-holding-heart"></i> Rest your arm comfortably</li>
      `;
      document.getElementById("langBtn").innerText = "EN";
    }
  }

  function toggleLanguage() {
    const currentLang = localStorage.getItem("language") || "en";
    const newLang = currentLang === "en" ? "ar" : "en";
    localStorage.setItem("language", newLang);
    applyLanguage(newLang);
  }

  function toggleFullscreen() {
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen().then(() => {
        localStorage.setItem('isFullscreen', 'true');
      }).catch(err => {
        console.log("Fullscreen error:", err);
      });
    } else {
      if (document.exitFullscreen) {
        document.exitFullscreen().then(() => {
          localStorage.removeItem('isFullscreen');
        });
      }
    }
  }

  window.addEventListener('load', () => {
    if (localStorage.getItem('isFullscreen') === 'true') {
      document.documentElement.requestFullscreen().catch(err => {
        console.log("Auto-fullscreen error:", err);
      });
    }
  });

  document.addEventListener('fullscreenchange', () => {
    if (!document.fullscreenElement) {
      localStorage.removeItem('isFullscreen');
    }
  });

  function goBack() { 
    clearSOS(); 
    window.location.href = "measurements.html"; 
  }

  // --- 7. LOG FOR DEBUGGING ---
  console.log("User ID:", userId);
  console.log("Firebase initialized");
</script>

<div style="position: fixed; bottom: 10px; left: 10px; z-index: 9999; display: flex; gap: 5px;">
  <button onclick="updatePressureUI('180/110')" style="background: red; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer;">üö® High</button>
  <button onclick="updatePressureUI('120/80')" style="background: green; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer;">‚úÖ Normal</button>
</div>
</body>
</html>
