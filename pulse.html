<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bioscan | Pulse Rate</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
  /* --- CSS Styles --- */
  :root { --primary-color: #ff416c; --danger-color: #ff0000; --bg-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364); --glass-bg: rgba(255, 255, 255, 0.1); --glass-border: rgba(255, 255, 255, 0.2); --text-color: #ffffff; }
  body { font-family: 'Poppins', sans-serif; background: var(--bg-gradient); background-size: 400% 400%; animation: gradientBG 15s ease infinite; min-height: 100vh; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; color: var(--text-color); overflow-x: hidden; transition: background 0.5s; }
  @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
  
  @keyframes sos-flash { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); border-color: red; } 50% { box-shadow: 0 0 50px 20px rgba(255, 0, 0, 0.5); border-color: #ff4d4d; background: rgba(50, 0, 0, 0.6); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); border-color: red; } }
  .critical-state { animation: sos-flash 1s infinite; border: 2px solid red !important; }
  .critical-bg { background: radial-gradient(circle, #3a0000, #000) !important; }

  header { width: 100%; background: rgba(15, 32, 39, 0.9); backdrop-filter: blur(10px); padding: 15px 0; display: flex; justify-content: center; align-items: center; position: relative; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); z-index: 100; }
  header h1 { font-size: 1.4rem; margin: 0; font-weight: 600; letter-spacing: 1px; color: var(--primary-color); text-transform: uppercase; pointer-events: none; }
  .back-btn { position: absolute; left: 20px; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--primary-color); color: white; padding: 8px 15px; border-radius: 50px; cursor: pointer; font-size: 14px; transition: 0.3s; display: flex; align-items: center; gap: 5px; z-index: 1000; }
  .back-btn:hover { background: var(--primary-color); color: #fff; box-shadow: 0 0 15px rgba(255, 65, 108, 0.5); }
  
  .container { display: flex; flex-direction: column; justify-content: center; align-items: center; flex-grow: 1; width: 100%; padding: 20px; }
  .card { background: var(--glass-bg); backdrop-filter: blur(16px); border: 1px solid var(--glass-border); border-radius: 25px; padding: 40px; width: 100%; max-width: 500px; text-align: center; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); transition: 0.3s; }
  .sos-banner { display: none; background: red; color: white; font-weight: bold; padding: 10px; border-radius: 10px; margin-bottom: 15px; animation: blink 0.5s infinite alternate; }
  @keyframes blink { from { opacity: 1; } to { opacity: 0.7; } }

  .icon-container { margin-bottom: 20px; position: relative; height: 100px; display: flex; align-items: center; justify-content: center; }
  
  #heartIcon { 
    font-size: 6rem; 
    background: -webkit-linear-gradient(#ff4b2b, #ff416c); 
    -webkit-background-clip: text; 
    -webkit-text-fill-color: transparent; 
    filter: drop-shadow(0 0 15px rgba(255, 65, 108, 0.6)); 
    animation-name: pumping; 
    animation-timing-function: ease-in-out; 
    animation-iteration-count: infinite;
  }

  @keyframes pumping { 
    0% { transform: scale(1); } 
    15% { transform: scale(1.25); filter: drop-shadow(0 0 25px rgba(255, 65, 108, 0.9)); }
    30% { transform: scale(1); } 
    45% { transform: scale(1.15); filter: drop-shadow(0 0 20px rgba(255, 65, 108, 0.8)); }
    60% { transform: scale(1); } 
    100% { transform: scale(1); } 
  }
  
  .pulse-box { background: rgba(0, 0, 0, 0.3); border-radius: 15px; padding: 20px; margin: 20px 0; border: 1px solid rgba(255, 65, 108, 0.3); position: relative; }
  #pulseValue { font-size: 3rem; font-weight: 700; color: #fff; text-shadow: 0 0 15px var(--primary-color); }
  .unit { font-size: 1.5rem; color: var(--primary-color); }
  
  /* Sound Toggle Button */
  .sound-toggle {
    position: absolute; top: 10px; right: 10px;
    background: rgba(255,255,255,0.1); border: none; color: #aaa;
    width: 35px; height: 35px; border-radius: 50%; cursor: pointer;
    display: flex; align-items: center; justify-content: center; transition: 0.3s;
    z-index: 10; font-size: 16px;
  }
  .sound-toggle:hover { background: rgba(255,255,255,0.2); color: white; }
  .sound-toggle.active { background: var(--primary-color); color: white; box-shadow: 0 0 15px var(--primary-color); animation: pulseBtn 1s infinite; }
  @keyframes pulseBtn { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

  .instructions-list { list-style: none; padding: 0; text-align: left; margin-bottom: 30px; }
  .instructions-list li { margin-bottom: 12px; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; color: #e0e0e0; }
  .instructions-list li i { color: var(--primary-color); width: 25px; text-align: center; }
  
  .actions-row { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
  .advice-btn, .voice-btn, .save-btn { padding: 12px 20px; border-radius: 50px; border: none; cursor: pointer; font-size: 16px; font-weight: 600; font-family: 'Poppins', sans-serif; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
  .advice-btn { flex: 2; background: linear-gradient(45deg, #ff416c, #ff4b2b); color: white; box-shadow: 0 4px 15px rgba(255, 65, 108, 0.4); }
  .save-btn { flex: 2; background: linear-gradient(45deg, #11998e, #38ef7d); color: white; box-shadow: 0 4px 15px rgba(56, 239, 125, 0.4); }
  .voice-btn { flex: 1; background: rgba(255,255,255,0.1); border: 1px solid var(--primary-color); color: var(--primary-color); }
  .advice-btn:hover, .voice-btn:hover, .save-btn:hover { transform: translateY(-3px); }
  .voice-btn:hover { background: var(--primary-color); color: white; }
  .advice-box { background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 15px; margin-top: 20px; display: none; font-size: 1.1rem; color: #fff; border-left: 4px solid var(--primary-color); animation: slideDown 0.5s ease; }
  @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

  .confirm-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 5000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; }
  .confirm-modal.active { display: flex; opacity: 1; }
  .confirm-content { background: linear-gradient(145deg, #152229, #1c2e36); border: 2px solid var(--primary-color); border-radius: 25px; width: 90%; max-width: 400px; padding: 30px; text-align: center; box-shadow: 0 0 50px rgba(255, 65, 108, 0.3); transform: scale(0.8); transition: transform 0.3s ease; }
  .confirm-modal.active .confirm-content { transform: scale(1); }
  .success-icon { font-size: 4rem; color: var(--primary-color); margin-bottom: 20px; animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
  @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }
  .confirm-title { font-size: 1.5rem; margin-bottom: 10px; color: #fff; }
  .confirm-text { color: #ccc; margin-bottom: 25px; font-size: 0.95rem; }
  .confirm-btn { background: var(--primary-color); color: #fff; border: none; padding: 12px 30px; border-radius: 50px; font-weight: 700; cursor: pointer; font-size: 1rem; transition: 0.3s; }
  .confirm-btn:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(255, 65, 108, 0.6); }
</style>
</head>
<body>

<div id="confirmModal" class="confirm-modal">
  <div class="confirm-content">
    <div class="success-icon"><i class="fas fa-check-circle"></i></div>
    <h3 class="confirm-title" id="modalTitle">Success!</h3>
    <p class="confirm-text" id="modalText">Measurement saved successfully.</p>
    <button class="confirm-btn" onclick="closeConfirmModal()">OK</button>
  </div>
</div>

<audio id="alarmSound" loop>
  <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
</audio>
<audio id="beatSound" preload="auto">
  <source src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3" type="audio/mpeg">
</audio>

<header>
  <button id="backBtn" class="back-btn" onclick="goBack()">
    <i class="fas fa-arrow-left"></i> <span>Back</span>
  </button>
  <h1 id="headerTitle">Pulse Rate</h1>
</header>

<div class="container">
  <div id="sosBanner" class="sos-banner"><i class="fas fa-exclamation-triangle"></i> CRITICAL HEART RATE!</div>
  
  <div class="card" id="mainCard">
    <div class="icon-container">
        <i class="fas fa-heartbeat" id="heartIcon" style="animation-duration: 1s;"></i>
    </div>
    
    <div class="pulse-box">
      <button class="sound-toggle" id="soundBtn" onclick="toggleBeep()" title="Toggle Heart Sound">
        <i class="fas fa-volume-mute" id="soundIcon"></i>
      </button>
      <span id="pulseValue">--</span> <span class="unit">BPM</span>
    </div>
    
    <h3 id="instrTitle" style="color: var(--primary-color); font-weight: 400; margin-bottom: 15px;">Instructions</h3>
    <ul class="instructions-list" id="instructions">
      <li><i class="fas fa-fingerprint"></i> Place finger steadily.</li>
      <li><i class="fas fa-hand-paper"></i> Do not move.</li>
    </ul>
    
    <div class="actions-row">
      <button class="save-btn" id="saveBtn" onclick="saveMeasurement()">
        <i class="fas fa-save"></i> <span id="saveBtnText">Save</span>
      </button>
      <button class="advice-btn" id="adviceBtn" onclick="showAdvice()">
        <i class="fas fa-user-md"></i> <span id="btnText">Medical Advice</span>
      </button>
      <button class="voice-btn" onclick="speakResult()"><i class="fas fa-volume-up"></i></button>
    </div>
    <div class="advice-box" id="adviceBox"></div>
  </div>
</div>

<script>
  // --- 1. Config ---
  const firebaseConfig = {
    apiKey: "AIzaSyAOwMQhsRM2PdD_FLjW_8Oi1WlFS3EO5pY",
    authDomain: "smart-a76a0.firebaseapp.com",
    databaseURL: "https://smart-a76a0-default-rtdb.firebaseio.com",
    projectId: "smart-a76a0",
    messagingSenderId: "343693501983",
    appId: "1:343693501983:web:10ea3fce9d990a2455172a"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();
  auth.signInAnonymously().catch(console.error);

  const pulseBox = document.getElementById("pulseValue");
  const adviceBox = document.getElementById("adviceBox");
  const sosBanner = document.getElementById("sosBanner");
  const mainCard = document.getElementById("mainCard");
  const heartIcon = document.getElementById("heartIcon");
  
  const alarmSound = document.getElementById("alarmSound");
  const beatSound = document.getElementById("beatSound");
  
  const userId = localStorage.getItem("selectedUserId");
  const PATIENT_DATA_PATH = "PatientData";
  
  let isCritical = false;
  let beepEnabled = false;
  let beepInterval = null;

  // --- 2. Live Reading & Logic ---
  function updatePulseUI(val) {
      if(isNaN(val)) return;
      pulseBox.innerText = val;

      // 1. SOS Logic
      if (val > 120 || val < 50) triggerSOS();
      else clearSOS();

      // 2. Animation Speed
      const duration = 60 / val; 
      heartIcon.style.animationDuration = `${duration}s`;

      // 3. Sound Logic (Only plays if enabled)
      clearInterval(beepInterval);
      if(beepEnabled && !isCritical) {
          beepInterval = setInterval(() => {
              // Forced replay logic
              beatSound.pause();
              beatSound.currentTime = 0;
              beatSound.play().catch(e => console.log("User must interact with page first"));
          }, duration * 1000);
      }
  }

  // --- SOUND TOGGLE ---
  function toggleBeep() {
      beepEnabled = !beepEnabled;
      const btn = document.getElementById("soundBtn");
      const icon = document.getElementById("soundIcon");
      const currentBPM = parseInt(pulseBox.innerText);

      if(beepEnabled) {
          btn.classList.add("active");
          icon.className = "fas fa-volume-up";
          // Try playing once immediately to "unlock" audio context
          beatSound.play().catch(e => alert("Please click anywhere on the page first!"));
          
          if(!isNaN(currentBPM)) updatePulseUI(currentBPM);
      } else {
          btn.classList.remove("active");
          icon.className = "fas fa-volume-mute";
          clearInterval(beepInterval);
      }
  }

  if (userId) {
    db.ref(PATIENT_DATA_PATH + "/" + userId + "/SensorData").on("value", snapshot => {
       const str = snapshot.val() || "";
       if(str && (str.includes("HR=") || str.includes("Pulse="))) {
           const parts = str.split(",");
           const hrPart = parts.find(p => p.trim().startsWith("HR=") || p.trim().startsWith("Pulse="));
           if(hrPart) {
               const val = parseInt(hrPart.split("=")[1]);
               updatePulseUI(val);
           }
       }
    });
  }

  // --- 3. Save Function ---
  function saveMeasurement() {
    const val = pulseBox.innerText;
    if (val === "--" || val === "") return;
    if (!userId) { window.location.href = "index.html"; return; }
    
    let sessionId = localStorage.getItem("currentSessionId");
    if (!sessionId) { sessionId = Date.now().toString(); localStorage.setItem("currentSessionId", sessionId); }

    const timestamp = new Date().toLocaleString();
    db.ref(`${PATIENT_DATA_PATH}/${userId}/History/${sessionId}`).update({
        bpm: val,
        createdAt: timestamp
    });
    
    db.ref(`${PATIENT_DATA_PATH}/${userId}/SensorData`).once('value').then(snapshot => {
        let currentStr = snapshot.val() || "";
        if (currentStr.includes("HR=")) currentStr = currentStr.replace(/HR=[^,]+/, `HR=${val}`);
        else if (currentStr === "No measurement recorded yet") currentStr = `HR=${val}`;
        else currentStr = currentStr ? `${currentStr}, HR=${val}` : `HR=${val}`;
        
        db.ref(`${PATIENT_DATA_PATH}/${userId}`).update({ SensorData: currentStr, Timestamp: timestamp })
          .then(() => showConfirmModal());
    });
  }

  // --- Helpers ---
  function showConfirmModal() {
      const isAr = localStorage.getItem("language") === "ar";
      document.getElementById("modalTitle").innerText = isAr ? "ÿ™ŸÖ ÿ®ŸÜÿ¨ÿßÿ≠!" : "Success!";
      document.getElementById("modalText").innerText = isAr ? "ÿ™ŸÖ ÿ≠ŸÅÿ∏ ŸÇŸäÿßÿ≥ ÿßŸÑŸÜÿ®ÿ∂ ÿ®ŸÜÿ¨ÿßÿ≠." : "Pulse measurement saved successfully.";
      document.querySelector(".confirm-btn").innerText = isAr ? "ÿ≠ÿ≥ŸÜÿßŸã" : "OK";
      const modal = document.getElementById("confirmModal");
      modal.style.display = "flex";
      setTimeout(() => modal.classList.add("active"), 10);
  }
  function closeConfirmModal() {
      const modal = document.getElementById("confirmModal");
      modal.classList.remove("active");
      setTimeout(() => modal.style.display = "none", 300);
  }

  function triggerSOS() { if(isCritical) return; isCritical = true; clearInterval(beepInterval); document.body.classList.add("critical-bg"); mainCard.classList.add("critical-state"); sosBanner.style.display = "block"; alarmSound.play().catch(e=>{}); const lang = localStorage.getItem("language") || "en"; sosBanner.innerText = lang === "ar" ? "üö® ÿÆÿ∑ÿ±: ŸÜÿ®ÿ∂ ÿ∫Ÿäÿ± ÿ∑ÿ®ŸäÿπŸä!" : "üö® CRITICAL HEART RATE!"; }
  function clearSOS() { if(!isCritical) return; isCritical = false; document.body.classList.remove("critical-bg"); mainCard.classList.remove("critical-state"); sosBanner.style.display = "none"; alarmSound.pause(); alarmSound.currentTime = 0; if(beepEnabled && !isNaN(parseInt(pulseBox.innerText))) updatePulseUI(parseInt(pulseBox.innerText)); }
  
  function speakResult() {
    let bpm = parseInt(pulseBox.innerText);
    const lang = localStorage.getItem("language") || "en";
    let text = (lang === "ar") ? `ŸÜÿ®ÿ∂ŸÉ ${bpm} ÿØŸÇÿ© ŸÅŸä ÿßŸÑÿØŸÇŸäŸÇÿ©` : `Your heart rate is ${bpm} beats per minute`;
    if(!isNaN(bpm)) window.speechSynthesis.speak(new SpeechSynthesisUtterance(text));
  }

  function showAdvice() {
    let bpm = parseInt(pulseBox.innerText);
    const lang = localStorage.getItem("language") || "en";
    let txt = "";
    if (isNaN(bpm)) txt = lang === "ar" ? "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™." : "No data.";
    else if (bpm > 100) { txt = lang === "ar" ? "ŸÜÿ®ÿ∂ ÿ≥ÿ±Ÿäÿπ! ÿßÿ≥ÿ™ÿ±ÿ≠." : "High pulse! Relax."; adviceBox.style.borderLeftColor = "#ff9900"; }
    else { txt = lang === "ar" ? "ŸÜÿ®ÿ∂ ÿ∑ÿ®ŸäÿπŸä." : "Normal pulse."; adviceBox.style.borderLeftColor = "#00ff88"; }
    adviceBox.innerText = txt; adviceBox.style.display = "block";
  }

  function goBack() { clearSOS(); clearInterval(beepInterval); window.location.href = "measurements.html"; }

  const lang = localStorage.getItem("language") || "en";
  if (lang === "ar") {
    document.body.style.direction = "rtl";
    document.getElementById("headerTitle").innerText = "ŸÇŸäÿßÿ≥ ÿßŸÑŸÜÿ®ÿ∂";
    document.getElementById("backBtn").innerHTML = '<i class="fas fa-arrow-right"></i> <span>ÿπŸàÿØÿ©</span>';
    document.getElementById("backBtn").style.left="auto"; document.getElementById("backBtn").style.right="20px";
    document.getElementById("instrTitle").innerText = "ÿ™ÿπŸÑŸäŸÖÿßÿ™ ÿßŸÑŸÇŸäÿßÿ≥";
    document.getElementById("btnText").innerText = "ÿßŸÑŸÜÿµŸäÿ≠ÿ© ÿßŸÑÿ∑ÿ®Ÿäÿ©";
    document.getElementById("saveBtnText").innerText = "ÿ≠ŸÅÿ∏ ÿßŸÑŸÇŸäÿßÿ≥";
    document.getElementById("instructions").innerHTML = `<li><i class="fas fa-fingerprint"></i> ÿ∂ÿπ ÿ•ÿµÿ®ÿπŸÉ ÿ®ÿ´ÿ®ÿßÿ™.</li><li><i class="fas fa-hand-paper"></i> ŸÑÿß ÿ™ÿ™ÿ≠ÿ±ŸÉ.</li>`;
  }
</script>

<div style="position: fixed; bottom: 10px; left: 10px; z-index: 9999; display: flex; gap: 5px;">
  <button onclick="updatePulseUI(140)" style="background: red; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer;">üö® Fast (140)</button>
  <button onclick="updatePulseUI(60)" style="background: green; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer;">‚úÖ Slow (60)</button>
</div>
</body>
</html>
