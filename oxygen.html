<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bioscan | Oxygen (SpO‚ÇÇ)</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
  /* --- CSS Styles --- */
  :root { --primary-color: #00c6ff; --secondary-color: #0072ff; --danger-color: #ff0000; --bg-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364); --glass-bg: rgba(255, 255, 255, 0.1); --glass-border: rgba(255, 255, 255, 0.2); --text-color: #ffffff; }
  body { font-family: 'Poppins', sans-serif; background: var(--bg-gradient); background-size: 400% 400%; animation: gradientBG 15s ease infinite; min-height: 100vh; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; color: var(--text-color); overflow-x: hidden; transition: background 0.5s; }
  @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
  
  /* SOS Styles */
  @keyframes sos-flash { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); border-color: red; } 50% { box-shadow: 0 0 50px 20px rgba(255, 0, 0, 0.5); border-color: #ff4d4d; background: rgba(50, 0, 0, 0.6); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); border-color: red; } }
  .critical-state { animation: sos-flash 1s infinite; border: 2px solid red !important; }
  .critical-bg { background: radial-gradient(circle, #3a0000, #000) !important; }

  header { width: 100%; background: rgba(15, 32, 39, 0.9); backdrop-filter: blur(10px); padding: 15px 0; display: flex; justify-content: center; align-items: center; position: relative; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); z-index: 100; }
  header h1 { font-size: 1.4rem; margin: 0; font-weight: 600; letter-spacing: 1px; color: var(--primary-color); text-transform: uppercase; pointer-events: none; }
  .back-btn { position: absolute; left: 20px; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--primary-color); color: white; padding: 8px 15px; border-radius: 50px; cursor: pointer; font-size: 14px; transition: 0.3s; display: flex; align-items: center; gap: 5px; z-index: 1000; }
  .back-btn:hover { background: var(--primary-color); color: #000; box-shadow: 0 0 15px rgba(0, 198, 255, 0.5); }
  
  .container { display: flex; flex-direction: column; justify-content: center; align-items: center; flex-grow: 1; width: 100%; padding: 20px; }
  .card { background: var(--glass-bg); backdrop-filter: blur(16px); border: 1px solid var(--glass-border); border-radius: 25px; padding: 40px; width: 100%; max-width: 500px; text-align: center; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); transition: 0.3s; }
  .sos-banner { display: none; background: red; color: white; font-weight: bold; padding: 10px; border-radius: 10px; margin-bottom: 15px; animation: blink 0.5s infinite alternate; }
  @keyframes blink { from { opacity: 1; } to { opacity: 0.7; } }

  /* --- LIQUID OXYGEN ANIMATION --- */
  .oxygen-visual {
    position: relative; width: 200px; height: 200px; margin: 0 auto 30px;
    border-radius: 50%; border: 4px solid rgba(255,255,255,0.1);
    box-shadow: 0 0 20px rgba(0, 198, 255, 0.3);
    overflow: hidden; background: rgba(0,0,0,0.3);
  }

  .liquid {
    position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; /* Dynamic */
    background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
    box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
    transition: height 1s ease-in-out, background 0.3s;
    z-index: 1;
  }

  /* The Wave Effect */
  .liquid::before, .liquid::after {
    content: ""; position: absolute; width: 200%; height: 200%;
    top: -150%; left: -50%; border-radius: 40%;
    background: rgba(255, 255, 255, 0.1);
    animation: wave 6s linear infinite;
  }
  .liquid::after {
    top: -155%; left: -45%; background: rgba(255, 255, 255, 0.2);
    animation: wave 10s linear infinite;
  }
  @keyframes wave { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  /* Bubbles Animation */
  .bubbles span {
    position: absolute; bottom: -20px;
    background: rgba(255, 255, 255, 0.3); border-radius: 50%;
    animation: rise 4s infinite ease-in; z-index: 2;
  }
  .bubbles span:nth-child(1) { width: 10px; height: 10px; left: 20%; animation-duration: 3s; }
  .bubbles span:nth-child(2) { width: 15px; height: 15px; left: 50%; animation-duration: 5s; animation-delay: 1s; }
  .bubbles span:nth-child(3) { width: 8px; height: 8px; left: 70%; animation-duration: 4s; animation-delay: 2s; }
  @keyframes rise { 0% { bottom: -20px; opacity: 0; } 50% { opacity: 1; } 100% { bottom: 100%; opacity: 0; } }

  /* Center Icon (Floating) */
  .center-icon {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      font-size: 4rem; color: rgba(255,255,255,0.8); z-index: 3;
      filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));
      animation: floatIcon 3s ease-in-out infinite;
  }
  @keyframes floatIcon { 0%, 100% { transform: translate(-50%, -50%); } 50% { transform: translate(-50%, -55%); } }

  /* Danger State for Liquid */
  .oxygen-visual.danger .liquid {
      background: linear-gradient(45deg, #ff416c, #ff0000);
  }
  /* -------------------------------- */

  .ox-box { background: rgba(0, 0, 0, 0.3); border-radius: 15px; padding: 20px; margin: 20px 0; border: 1px solid rgba(0, 198, 255, 0.3); }
  #oxValue { font-size: 3rem; font-weight: 700; color: #fff; text-shadow: 0 0 15px var(--primary-color); }
  .unit { font-size: 1.5rem; color: var(--primary-color); }
  
  .instructions-list { list-style: none; padding: 0; text-align: left; margin-bottom: 30px; }
  .instructions-list li { margin-bottom: 12px; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; color: #e0e0e0; }
  .instructions-list li i { color: var(--primary-color); width: 25px; text-align: center; }
  
  .actions-row { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
  .advice-btn, .voice-btn, .save-btn { padding: 12px 20px; border-radius: 50px; border: none; cursor: pointer; font-size: 16px; font-weight: 600; font-family: 'Poppins', sans-serif; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
  .advice-btn { flex: 2; background: linear-gradient(45deg, #00c6ff, #0072ff); color: white; box-shadow: 0 4px 15px rgba(0, 198, 255, 0.4); }
  .save-btn { flex: 2; background: linear-gradient(45deg, #11998e, #38ef7d); color: white; box-shadow: 0 4px 15px rgba(56, 239, 125, 0.4); }
  .voice-btn { flex: 1; background: rgba(255,255,255,0.1); border: 1px solid var(--primary-color); color: var(--primary-color); }
  .advice-btn:hover, .voice-btn:hover, .save-btn:hover { transform: translateY(-3px); }
  .voice-btn:hover { background: var(--primary-color); color: white; }
  .advice-box { background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 15px; margin-top: 20px; display: none; font-size: 1.1rem; color: #fff; border-left: 4px solid var(--primary-color); animation: slideDown 0.5s ease; }
  @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

  /* Modal */
  .confirm-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 5000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; }
  .confirm-modal.active { display: flex; opacity: 1; }
  .confirm-content { background: linear-gradient(145deg, #152229, #1c2e36); border: 2px solid var(--primary-color); border-radius: 25px; width: 90%; max-width: 400px; padding: 30px; text-align: center; box-shadow: 0 0 50px rgba(0, 198, 255, 0.3); transform: scale(0.8); transition: transform 0.3s ease; }
  .confirm-modal.active .confirm-content { transform: scale(1); }
  .success-icon { font-size: 4rem; color: var(--primary-color); margin-bottom: 20px; animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
  @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }
  .confirm-title { font-size: 1.5rem; margin-bottom: 10px; color: #fff; }
  .confirm-text { color: #ccc; margin-bottom: 25px; font-size: 0.95rem; }
  .confirm-btn { background: var(--primary-color); color: #000; border: none; padding: 12px 30px; border-radius: 50px; font-weight: 700; cursor: pointer; font-size: 1rem; transition: 0.3s; }
  .confirm-btn:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(0, 198, 255, 0.6); color: #fff; }

  /* --- MOBILE RESPONSIVE --- */
  @media (max-width: 768px) {
    header { padding: 10px 15px; }
    header h1 { font-size: 1.1rem; letter-spacing: 0.5px; }
    .back-btn { left: 10px; padding: 6px 12px; font-size: 13px; }
    .back-btn span { display: none; }
    
    .container { padding: 15px 10px; }
    .card { padding: 25px 20px; border-radius: 20px; max-width: 100%; }
    
    .oxygen-visual { width: 170px; height: 170px; margin: 0 auto 25px; }
    .center-icon { font-size: 3.5rem; }
    .liquid::before, .liquid::after { width: 180%; height: 180%; }
    
    .ox-box { padding: 15px; margin: 18px 0; }
    #oxValue { font-size: 2.5rem; }
    .unit { font-size: 1.2rem; }
    
    .sos-banner { font-size: 0.9rem; padding: 8px; margin-bottom: 12px; }
    
    h3 { font-size: 1.1rem; margin-bottom: 12px; }
    
    .instructions-list { margin-bottom: 20px; }
    .instructions-list li { font-size: 0.85rem; margin-bottom: 10px; gap: 8px; }
    .instructions-list li i { width: 20px; font-size: 0.9rem; }
    
    .actions-row { gap: 8px; }
    .advice-btn, .save-btn, .voice-btn { padding: 10px 16px; font-size: 14px; border-radius: 40px; }
    .voice-btn { flex: 0.8; min-width: 45px; }
    
    .advice-box { font-size: 0.95rem; padding: 12px; margin-top: 15px; }
    
    .confirm-content { padding: 25px 20px; width: 92%; max-width: 350px; }
    .success-icon { font-size: 3rem; margin-bottom: 15px; }
    .confirm-title { font-size: 1.3rem; }
    .confirm-text { font-size: 0.85rem; margin-bottom: 20px; }
    .confirm-btn { padding: 10px 25px; font-size: 0.95rem; }
  }

  @media (max-width: 480px) {
    header h1 { font-size: 1rem; }
    .back-btn { padding: 5px 10px; font-size: 12px; }
    
    .card { padding: 20px 15px; }
    
    .oxygen-visual { width: 150px; height: 150px; margin: 0 auto 20px; }
    .center-icon { font-size: 3rem; }
    
    .ox-box { padding: 12px; margin: 15px 0; }
    #oxValue { font-size: 2.2rem; }
    .unit { font-size: 1.1rem; }
    
    .instructions-list li { font-size: 0.8rem; }
    
    .advice-btn, .save-btn { padding: 9px 14px; font-size: 13px; }
    .voice-btn { padding: 9px 12px; }
    
    .confirm-content { padding: 20px 15px; }
    .success-icon { font-size: 2.5rem; }
    .confirm-title { font-size: 1.2rem; }
    .confirm-text { font-size: 0.8rem; }
  }
</style>
</head>
<body>

<div id="confirmModal" class="confirm-modal">
  <div class="confirm-content">
    <div class="success-icon"><i class="fas fa-check-circle"></i></div>
    <h3 class="confirm-title" id="modalTitle">Success!</h3>
    <p class="confirm-text" id="modalText">Measurement saved successfully.</p>
    <button class="confirm-btn" onclick="closeConfirmModal()">OK</button>
  </div>
</div>

<audio id="alarmSound" loop>
  <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
</audio>

<header>
  <button id="backBtn" class="back-btn" onclick="goBack()">
    <i class="fas fa-arrow-left"></i> <span>Back</span>
  </button>
  <h1 id="headerTitle">Blood Oxygen <span style="font-size:0.8em; opacity:0.8;">(SpO‚ÇÇ)</span></h1>
</header>

<div class="container">
  <div id="sosBanner" class="sos-banner"><i class="fas fa-exclamation-triangle"></i> CRITICAL: LOW OXYGEN!</div>
  
  <div class="card" id="mainCard">
    
    <div class="oxygen-visual" id="oxygenVisual">
        <div class="liquid" id="oxLiquid"></div>
        <div class="center-icon"><i class="fas fa-lungs"></i></div>
        <div class="bubbles">
            <span></span><span></span><span></span>
        </div>
    </div>

    <div class="ox-box">
      <span id="oxValue">--</span> <span class="unit">%</span>
    </div>
    
    <h3 id="instrTitle" style="color: var(--primary-color); font-weight: 400; margin-bottom: 15px;">Instructions</h3>
    <ul class="instructions-list" id="instructions">
      <li><i class="fas fa-fingerprint"></i> Place finger on sensor.</li>
      <li><i class="fas fa-hand-holding"></i> Keep hand steady.</li>
      <li><i class="fas fa-exclamation-circle"></i> Avoid movement.</li>
    </ul>
    
    <div class="actions-row">
      <button class="save-btn" id="saveBtn" onclick="saveMeasurement()">
        <i class="fas fa-save"></i> <span id="saveBtnText">Save</span>
      </button>
      <button class="advice-btn" id="adviceBtn" onclick="showAdvice()">
        <i class="fas fa-user-md"></i> <span id="btnText">Medical Advice</span>
      </button>
      <button class="voice-btn" onclick="speakResult()"><i class="fas fa-volume-up"></i></button>
    </div>
    <div class="advice-box" id="adviceBox"></div>
  </div>
</div>

<script>
  // --- 1. Config ---
  const firebaseConfig = {
    apiKey: "AIzaSyAOwMQhsRM2PdD_FLjW_8Oi1WlFS3EO5pY",
    authDomain: "smart-a76a0.firebaseapp.com",
    databaseURL: "https://smart-a76a0-default-rtdb.firebaseio.com",
    projectId: "smart-a76a0",
    messagingSenderId: "343693501983",
    appId: "1:343693501983:web:10ea3fce9d990a2455172a"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();
  auth.signInAnonymously().catch(console.error);

  const oxBox = document.getElementById("oxValue");
  const oxLiquid = document.getElementById("oxLiquid");
  const oxVisual = document.getElementById("oxygenVisual");
  const adviceBox = document.getElementById("adviceBox");
  const sosBanner = document.getElementById("sosBanner");
  const mainCard = document.getElementById("mainCard");
  const alarmSound = document.getElementById("alarmSound");
  const userId = localStorage.getItem("selectedUserId");
  const PATIENT_DATA_PATH = "PatientData";
  let isCritical = false;

  // --- 2. Live Logic & Animation ---
  function updateOxygenUI(val) {
      if(isNaN(val)) return;
      oxBox.innerText = val;
      
      // Update Liquid Height
      // 100% -> Full height (100%)
      // 0% -> Empty (0%)
      // Since normal range is 90-100, we want it to look full mostly.
      // Let's map it directly but ensure min height of 10%
      let height = val;
      if(height > 100) height = 100;
      if(height < 10) height = 10;
      
      oxLiquid.style.height = height + "%";

      // Color Change for Critical Low
      if (val < 90) {
          oxVisual.classList.add('danger');
          triggerSOS();
      } else {
          oxVisual.classList.remove('danger');
          clearSOS();
      }
  }

  if (userId) {
    db.ref(PATIENT_DATA_PATH + "/" + userId + "/SensorData").on("value", snapshot => {
       const str = snapshot.val() || "";
       if(str && (str.includes("SpO2=") || str.includes("O2="))) {
           const parts = str.split(",");
           const oxPart = parts.find(p => p.trim().startsWith("SpO2=") || p.trim().startsWith("O2="));
           if(oxPart) {
               const val = parseFloat(oxPart.split("=")[1]);
               updateOxygenUI(val);
           }
       }
    });
  }

  // --- 3. Save Function ---
  function saveMeasurement() {
    const val = oxBox.innerText;
    if (val === "--" || val === "") return;
    if (!userId) { window.location.href = "index.html"; return; }
    
    let sessionId = localStorage.getItem("currentSessionId");
    if (!sessionId) { sessionId = Date.now().toString(); localStorage.setItem("currentSessionId", sessionId); }

    const timestamp = new Date().toLocaleString();

    db.ref(`${PATIENT_DATA_PATH}/${userId}/History/${sessionId}`).update({
        spo2: val,
        createdAt: timestamp
    });
    
    db.ref(`${PATIENT_DATA_PATH}/${userId}/SensorData`).once('value').then(snapshot => {
        let currentStr = snapshot.val() || "";
        if (currentStr.includes("SpO2=")) currentStr = currentStr.replace(/SpO2=[^,]+/, `SpO2=${val}`);
        else if (currentStr === "No measurement recorded yet") currentStr = `SpO2=${val}`;
        else currentStr = currentStr ? `${currentStr}, SpO2=${val}` : `SpO2=${val}`;
        
        db.ref(`${PATIENT_DATA_PATH}/${userId}`).update({ SensorData: currentStr, Timestamp: timestamp })
          .then(() => showConfirmModal());
    });
  }

  function showConfirmModal() {
      const isAr = localStorage.getItem("language") === "ar";
      document.getElementById("modalTitle").innerText = isAr ? "ÿ™ŸÖ ÿ®ŸÜÿ¨ÿßÿ≠!" : "Success!";
      document.getElementById("modalText").innerText = isAr ? "ÿ™ŸÖ ÿ≠ŸÅÿ∏ ŸÇŸäÿßÿ≥ ÿßŸÑÿ£ŸÉÿ≥ÿ¨ŸäŸÜ ÿ®ŸÜÿ¨ÿßÿ≠." : "Oxygen measurement saved successfully.";
      document.querySelector(".confirm-btn").innerText = isAr ? "ÿ≠ÿ≥ŸÜÿßŸã" : "OK";
      const modal = document.getElementById("confirmModal");
      modal.style.display = "flex";
      setTimeout(() => modal.classList.add("active"), 10);
  }
  function closeConfirmModal() {
      const modal = document.getElementById("confirmModal");
      modal.classList.remove("active");
      setTimeout(() => modal.style.display = "none", 300);
  }

  function triggerSOS() { if(isCritical) return; isCritical = true; document.body.classList.add("critical-bg"); mainCard.classList.add("critical-state"); sosBanner.style.display = "block"; alarmSound.play().catch(e=>{}); const lang = localStorage.getItem("language") || "en"; sosBanner.innerText = lang === "ar" ? "üö® ÿÆÿ∑ÿ±: ŸÜŸÇÿµ ÿ≠ÿßÿØ ŸÅŸä ÿßŸÑÿ£ŸÉÿ≥ÿ¨ŸäŸÜ!" : "üö® CRITICAL: LOW OXYGEN LEVEL!"; }
  function clearSOS() { if(!isCritical) return; isCritical = false; document.body.classList.remove("critical-bg"); mainCard.classList.remove("critical-state"); sosBanner.style.display = "none"; alarmSound.pause(); alarmSound.currentTime = 0; }
  
  function speakResult() {
    let ox = parseFloat(oxBox.innerText);
    const lang = localStorage.getItem("language") || "en";
    let text = (lang === "ar") ? `ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ£ŸÉÿ≥ÿ¨ŸäŸÜ ${ox}` : `Oxygen level is ${ox} percent`;
    if(!isNaN(ox)) window.speechSynthesis.speak(new SpeechSynthesisUtterance(text));
  }

  function showAdvice() {
    let ox = parseFloat(oxBox.innerText);
    const lang = localStorage.getItem("language") || "en";
    let txt = "";
    if (isNaN(ox)) txt = lang === "ar" ? "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™." : "No data.";
    else if (ox < 90) { txt = lang === "ar" ? "ŸÜŸÇÿµ ÿ≠ÿßÿØ!" : "Critical Low!"; adviceBox.style.borderLeftColor = "#ff0000"; }
    else { txt = lang === "ar" ? "ŸÖŸÖÿ™ÿßÿ≤." : "Excellent."; adviceBox.style.borderLeftColor = "#00ff88"; }
    adviceBox.innerText = txt; adviceBox.style.display = "block";
  }

  function goBack() { clearSOS(); window.location.href = "measurements.html"; }

  const lang = localStorage.getItem("language") || "en";
  if (lang === "ar") {
    document.body.style.direction = "rtl";
    document.getElementById("headerTitle").innerText = "ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ£ŸÉÿ≥ÿ¨ŸäŸÜ";
    document.getElementById("backBtn").innerHTML = '<i class="fas fa-arrow-right"></i> <span>ÿπŸàÿØÿ©</span>';
    document.getElementById("backBtn").style.left="auto"; document.getElementById("backBtn").style.right="20px";
    document.getElementById("instrTitle").innerText = "ÿ™ÿπŸÑŸäŸÖÿßÿ™ ÿßŸÑŸÇŸäÿßÿ≥";
    document.getElementById("btnText").innerText = "ÿßŸÑŸÜÿµŸäÿ≠ÿ© ÿßŸÑÿ∑ÿ®Ÿäÿ©";
    document.getElementById("saveBtnText").innerText = "ÿ≠ŸÅÿ∏ ÿßŸÑŸÇŸäÿßÿ≥";
    document.getElementById("instructions").innerHTML = `<li><i class="fas fa-fingerprint"></i> ÿ∂ÿπ ÿ•ÿµÿ®ÿπŸÉ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ.</li><li><i class="fas fa-hand-holding"></i> ÿ≠ÿßŸÅÿ∏ ÿπŸÑŸâ ÿ´ÿ®ÿßÿ™ŸÉ.</li>`;
  }
</script>

<div style="position: fixed; bottom: 10px; left: 10px; z-index: 9999; display: flex; gap: 5px;">
  <button onclick="updateOxygenUI(85)" style="background: red; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer;">üö® Low (85%)</button>
  <button onclick="updateOxygenUI(98)" style="background: green; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer;">‚úÖ Good (98%)</button>
</div>
</body>
</html>
